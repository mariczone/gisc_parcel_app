"use strict";(self.webpackChunkparcel_app=self.webpackChunkparcel_app||[]).push([[5881],{76269:(St,Le,S)=>{S.d(Le,{L:()=>de,b:()=>W});var B=S(62208),P=S(67831),ne=S(99770),y=S(4794),he=S(78925),A=S(35283),_e=S(3090),xe=S(82793),se=S(71850),k=S(95285),j=S(69960),re=S(65787),$=S(17625),J=S(22355),Q=S(16396);function W(ae){const be=new J.kG;be.include(A.H),be.include(_e.R,ae),be.include(he.f5,ae),be.attributes.add(Q.T.UV0,"vec2");const{vertex:Ae,fragment:ye}=be;return Ae.uniforms.add([new j.N("viewport",(X,D)=>D.camera.fullViewport),new re.p("lineSize",(X,D)=>Math.ceil(X.size)*D.camera.pixelRatio),new k.A("pixelToNDC",(X,D)=>(0,P.s)(q,2/D.camera.fullViewport[2],2/D.camera.fullViewport[3])),new re.p("borderSize",(X,D)=>(0,B.pC)(X.borderColor)?D.camera.pixelRatio:0),new k.A("screenOffset",(X,D)=>(0,P.s)(q,X.screenOffset[0]*D.camera.pixelRatio,X.screenOffset[1]*D.camera.pixelRatio))]),be.varyings.add("coverageSampling","vec4"),be.varyings.add("lineSizes","vec2"),ae.hasMultipassGeometry&&be.varyings.add("depth","float"),ae.hasScreenSizePerspective&&(0,se.m8)(Ae),Ae.code.add($.H`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${ae.occlusionTestEnabled?$.H`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${ae.hasScreenSizePerspective?$.H`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:$.H`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${ae.hasMultipassGeometry?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${ae.depthHudEnabled?ae.depthHudAlignStartEnabled?$.H`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:$.H`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${ae.hasScreenSizePerspective?$.H`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:$.H`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),ye.uniforms.add([new j.N("uColor",X=>I(X.color)),new j.N("borderColor",X=>I(X.borderColor))]),ae.hasMultipassGeometry&&(ye.include(xe.S,ae),ye.uniforms.add(new k.A("inverseViewport",(X,D)=>D.inverseViewport))),ye.code.add($.H`
    void main() {
      ${ae.hasMultipassGeometry?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${ae.depthHudEnabled?$.H`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:$.H`
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),be}function I(ae){return(0,B.pC)(ae)?ae:y.Z}const q=(0,ne.a)(),de=Object.freeze(Object.defineProperty({__proto__:null,build:W},Symbol.toStringTag,{value:"Module"}))},62718:(St,Le,S)=>{S.d(Le,{L:()=>X,b:()=>ye});var B=S(81805),P=S(52382),ne=S(13934),y=S(78925),he=S(39645),A=S(54120),_e=S(50823),xe=S(10109),se=S(67022),k=S(33726),j=S(19278),re=S(99198),$=S(95285),J=S(69960),Q=S(65787),W=S(17625),I=S(63123),q=S(22355),de=S(35387),ae=S(44835),be=S(16396),Ae=S(46359);function ye(D){const z=new q.kG,L=D.hasMultipassTerrain&&(D.output===ne.H.Color||D.output===ne.H.Alpha),w=D.space===Ae.I9.World;D.hasTip&&w&&z.extensions.add("GL_OES_standard_derivatives"),z.include(he.U,D),z.include(_e.Q,D),D.output===ne.H.Depth&&z.include(A.F,D);const{vertex:U,fragment:Z}=z;return Z.include(j.n),(0,re.Sv)(U,D),z.attributes.add(be.T.POSITION,"vec3"),z.attributes.add(be.T.UV0,"vec2"),z.attributes.add(be.T.AUXPOS1,"vec3"),z.varyings.add("vColor","vec4"),z.varyings.add("vpos","vec3"),z.varyings.add("vUV","vec2"),z.varyings.add("vSize","float"),(0,P.Lm)(z),L&&z.varyings.add("depth","float"),D.hasTip&&z.varyings.add("vLineWidth","float"),U.uniforms.add([new $.A("nearFar",(Y,K)=>K.camera.nearFar),new J.N("viewport",(Y,K)=>K.camera.fullViewport)]),U.code.add(W.H`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),U.code.add(W.H`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
float interpolation = (-vnp - pos.z) / (prev.z - pos.z);
prev = mix(pos, prev, interpolation);
}
}`),w?(z.attributes.add(be.T.NORMAL,"vec3"),(0,re._8)(U),U.constants.add("tiltThreshold","float",.7),U.code.add(W.H`vec3 perpendicular(vec3 v) {
vec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;
vec3 n2 = cross(v, n);
vec3 forward = vec3(0.0, 0.0, 1.0);
float tiltDot = dot(forward, n);
return abs(tiltDot) < tiltThreshold ? n : n2;
}`)):U.code.add(W.H`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}`),U.code.add(W.H`
      #define vecN ${w?"vec3":"vec2"}

      vecN normalizedSegment(vecN pos, vecN prev) {
        vecN segment = pos - prev;
        float segmentLen = length(segment);

        // normalize or zero if too short
        return (segmentLen > 0.001) ? segment / segmentLen : ${w?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)"};
      }

      vecN displace(vecN pos, vecN prev, float displacementLen) {
        vecN segment = normalizedSegment(pos, prev);

        vecN displacementDirU = perpendicular(segment);
        vecN displacementDirV = segment;

        ${D.anchor===Ae.i5.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":""}

        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);
      }
    `),D.space===Ae.I9.Screen&&(U.uniforms.add(new I.g("inverseProjectionMatrix",(Y,K)=>K.camera.inverseProjectionMatrix)),U.code.add(W.H`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),U.code.add(W.H`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),U.uniforms.add(new Q.p("perScreenPixelRatio",(Y,K)=>K.camera.perScreenPixelRatio)),U.code.add(W.H`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${D.hasCap?"\n                if(prev.z > posLeft.z) {\n                  vec2 diff = posLeft.xy - posRight.xy;\n                  planeOrigin.xy += perpendicular(diff) / 2.0;\n                }\n              ":""};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),U.uniforms.add(new Q.p("pixelRatio",(Y,K)=>K.camera.pixelRatio)),(0,P.bA)(z),U.code.add(W.H`void main(void) {
if (uv0.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
float lineWidth = getLineWidth();
float screenMarkerSize = getScreenMarkerSize();
vec4 pos  = view * vec4(position.xyz, 1.0);
vec4 prev = view * vec4(auxpos1.xyz, 1.0);
clip(pos, prev);`),w?(D.hideOnShortSegments&&U.code.add(W.H`if (areWorldMarkersHidden(pos, prev)) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
return;
}`),U.code.add(W.H`pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));
vec4 displacedPosScreen = projectAndScale(pos);`)):(U.code.add(W.H`vec4 posScreen = projectAndScale(pos);
vec4 prevScreen = projectAndScale(prev);
vec4 displacedPosScreen = posScreen;
displacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);`),D.space===Ae.I9.Screen&&U.code.add(W.H`vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));
vec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));
vec3 lineLeft = pos.xyz + (pos.xyz - lineRight);
pos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);
displacedPosScreen = projectAndScale(pos);`)),U.code.add(W.H`
        ${L?"depth = pos.z;":""}
        linearDepth = calculateLinearDepth(nearFar,pos.z);

        // Convert back into NDC
        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        ${w?"":"vUV *= displacedPosScreen.w;"}

        ${D.hasTip?"vLineWidth = lineWidth;":""}

        vSize = screenMarkerSize;
        vColor = getColor();

        // Use camera space for slicing
        vpos = pos.xyz;

        gl_Position = displacedPosScreen;
      }
    }
  `),L&&z.include(xe.l,D),z.include(y.f5,D),Z.uniforms.add([new J.N("intrinsicColor",Y=>Y.color),new de.A("tex",Y=>Y.texture)]),Z.include(k.Y),z.constants.add("texelSize","float",1/B.vT),Z.code.add(W.H`float markerAlpha(vec2 samplePos) {
samplePos += vec2(0.5, -0.5) * texelSize;
float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
float distance = sdf * vSize;
distance -= 0.5;
return clamp(0.5 - distance, 0.0, 1.0);
}`),D.hasTip&&(z.constants.add("relativeMarkerSize","float",B.Ch/B.vT),z.constants.add("relativeTipLineWidth","float",B.Hl),Z.code.add(W.H`
    float tipAlpha(vec2 samplePos) {
      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker
      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);
      samplePos *= vSize;

      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;
      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);

      ${w?"halfTipLineWidth *= fwidth(samplePos.y);":""}

      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);
      return clamp(0.5 - distance, 0.0, 1.0);
    }
  `)),z.constants.add("symbolAlphaCutoff","float",se.b),Z.code.add(W.H`
  void main() {
    discardBySlice(vpos);
    ${L?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    ${w?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;"}

    ${D.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);"}

    ${D.output===ne.H.ObjectAndLayerIdColor?W.H`finalColor.a = 1.0;`:""}

    if (finalColor.a < symbolAlphaCutoff) {
      discard;
    }

    ${D.output===ne.H.Alpha?W.H`gl_FragColor = vec4(finalColor.a);`:""}
    ${D.output===ne.H.Color?W.H`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${D.output===ne.H.Color&&D.transparencyPassType===ae.A.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${D.output===ne.H.Highlight?W.H`gl_FragColor = vec4(1.0);`:""}
    ${D.output===ne.H.Depth?W.H`outputDepth(linearDepth);`:""}
  }
  `),z}const X=Object.freeze(Object.defineProperty({__proto__:null,build:ye},Symbol.toStringTag,{value:"Module"}))},24079:(St,Le,S)=>{S.d(Le,{P:()=>ye,b:()=>Ae});var B=S(52382),P=S(13934),ne=S(78925),y=S(24255),he=S(68565),A=S(54120),_e=S(62952),xe=S(54662),se=S(13146),k=S(31166),j=S(10109),re=S(96395),$=S(7025),J=S(72968),Q=S(33726),W=S(99198),I=S(97139),q=S(65787),de=S(17625),ae=S(22355),be=S(44835);function Ae(X){const D=new ae.kG,{vertex:z,fragment:L}=D;switch((0,W.Sv)(z,X),D.varyings.add("vpos","vec3"),D.include(he.W,X),X.output!==P.H.Color&&X.output!==P.H.Alpha||(D.include(y.w,X),D.include(J.XE,X),D.include(B.qj,X),D.varyings.add("vnormal","vec3"),D.varyings.add("vcolor","vec4"),X.hasMultipassTerrain&&D.varyings.add("depth","float"),z.code.add(de.H`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${X.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${X.output===P.H.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),D.include(j.l,X),X.output){case P.H.Alpha:D.include(ne.f5,X),L.uniforms.add(new q.p("opacity",w=>w.opacity)),L.code.add(de.H`
      void main() {
        discardBySlice(vpos);
        ${X.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `);break;case P.H.Color:D.include(ne.f5,X),D.include(se.XP,X),D.include(xe.K,X),D.include(J.XE,X),D.include(re.k,X),(0,W.hY)(L,X),(0,se.PN)(L),(0,se.sC)(L),L.uniforms.add([z.uniforms.get("localOrigin"),new I.J("ambient",w=>w.ambient),new I.J("diffuse",w=>w.diffuse),new I.J("specular",w=>w.specular),new q.p("opacity",w=>w.opacity)]),L.include(Q.Y),(0,k.F1)(L),L.code.add(de.H`
        void main() {
          discardBySlice(vpos);
          ${X.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          shadingParams.viewDirection = normalize(vpos - cameraPosition);
          shadingParams.normalView = vnormal;
          vec3 normal = shadingNormal(shadingParams);
          float ssao = evaluateAmbientOcclusionInverse();

          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
          ${X.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":X.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
          float combinedOpacity = vcolor.a * opacity;
          albedo += 0.25 * specular; // don't completely ignore specular for now

          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
          gl_FragColor = vec4(shadedColor, combinedOpacity);
          gl_FragColor = highlightSlice(gl_FragColor, vpos);
          ${X.transparencyPassType===be.A.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
        }
      `);break;case P.H.Depth:case P.H.Shadow:case P.H.ShadowHighlight:case P.H.ShadowExcludeHighlight:D.include(y.w,X),(0,B.Zu)(D),D.varyings.add("depth","float"),z.code.add(de.H`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),D.include(ne.f5,X),D.include(A.F,X),L.code.add(de.H`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`);break;case P.H.Normal:D.include(y.w,X),D.include($.n,X),(0,W._8)(z),D.varyings.add("vnormal","vec3"),z.code.add(de.H`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),D.include(ne.f5,X),L.code.add(de.H`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`);break;case P.H.Highlight:D.include(y.w,X),D.include($.n,X),D.varyings.add("vnormal","vec3"),z.code.add(de.H`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),D.include(ne.f5,X),D.include(_e.bA,X),L.code.add(de.H`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return D}const ye=Object.freeze(Object.defineProperty({__proto__:null,build:Ae},Symbol.toStringTag,{value:"Module"}))},66401:(St,Le,S)=>{S.d(Le,{P:()=>X,b:()=>Ae});var B=S(52382),P=S(13934),ne=S(78925),y=S(24255),he=S(58173),A=S(54120),_e=S(62952),xe=S(10109),se=S(67022),k=S(33726),j=S(99198),re=S(69960),$=S(65787),J=S(17625),Q=S(22355),W=S(44835),I=S(16396),q=S(95402);const de=.70710678118,ae=de;function Ae(D){const z=new Q.kG,L=D.hasMultipassTerrain&&(D.output===P.H.Color||D.output===P.H.Alpha);D.draped||z.extensions.add("GL_OES_standard_derivatives");const{vertex:w,fragment:U}=z;(0,j.Sv)(w,D),z.include(y.w,D),z.include(he.c,D),D.draped?w.uniforms.add(new $.p("worldToScreenRatio",(K,ce)=>1/ce.screenToPCSRatio)):z.attributes.add(I.T.BOUNDINGRECT,"mat3"),z.attributes.add(I.T.POSITION,"vec3"),z.attributes.add(I.T.UVMAPSPACE,"vec4"),z.varyings.add("vpos","vec3"),z.varyings.add("vuv","vec2"),L&&z.varyings.add("depth","float");const Z=D.style===q.b.ForwardDiagonal||D.style===q.b.BackwardDiagonal||D.style===q.b.DiagonalCross;Z&&w.code.add(J.H`
      const mat2 rotate45 = mat2(${J.H.float(de)}, ${J.H.float(-ae)},
                                 ${J.H.float(ae)}, ${J.H.float(de)});
    `),D.draped||((0,j.hY)(w,D),w.uniforms.add(new $.p("worldToScreenPerDistanceRatio",(K,ce)=>1/ce.camera.perScreenPixelRatio)),w.code.add(J.H`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),w.code.add(J.H`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),w.code.add(J.H`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${J.H.float(.08715574274)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),w.code.add(J.H`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${Z?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${Z?" * rotate45":""};

      ${D.draped?"":J.H`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${J.H.float(D.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `);const Y=D.output===P.H.Depth;return Y&&(z.include(A.F,D),(0,B.Zu)(z),(0,B.Lm)(z)),w.code.add(J.H`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${L?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${Y?J.H`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:J.H`transformPosition(proj, view, vpos);`}
    }
  `),z.include(ne.f5,D),U.include(k.Y),D.draped&&U.uniforms.add(new $.p("texelSize",(K,ce)=>1/ce.camera.pixelRatio)),D.output===P.H.Highlight&&z.include(_e.bA,D),L&&z.include(xe.l,D),D.output!==P.H.Highlight&&(U.code.add(J.H`
      const float lineWidth = ${J.H.float(D.lineWidth)};
      const float spacing = ${J.H.float(D.patternSpacing)};
      const float spacingINV = ${J.H.float(1/D.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),D.draped||U.code.add(J.H`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),U.uniforms.add(new re.N("uColor",K=>K.color)),U.code.add(J.H`
    void main() {
      discardBySlice(vpos);
      ${L?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${D.hasVertexColors?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${D.output!==P.H.Highlight?J.H`color.a *= ${function ye(D){function z(L){return D.draped?J.H`coverage(vuv.${L}, texelSize)`:J.H`sample(vuv.${L})`}switch(D.style){case q.b.ForwardDiagonal:case q.b.Horizontal:return z("y");case q.b.BackwardDiagonal:case q.b.Vertical:return z("x");case q.b.DiagonalCross:case q.b.Cross:return J.H`
        1.0 - (1.0 - ${z("x")}) * (1.0 - ${z("y")})
      `;default:return"0.0"}}(D)};`:""}

      ${D.output===P.H.ObjectAndLayerIdColor?J.H`color.a = 1.0;`:""}

      if (color.a < ${J.H.float(se.b)}) {
        discard;
      }

      ${D.output===P.H.Alpha?J.H`gl_FragColor = vec4(color.a);`:""}

      ${D.output===P.H.Color?J.H`gl_FragColor = color; ${D.transparencyPassType===W.A.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${D.output===P.H.Highlight?J.H`outputHighlight();`:""}
      ${D.output===P.H.Depth?J.H`outputDepth(linearDepth);`:""};
    }
  `),z}const X=Object.freeze(Object.defineProperty({__proto__:null,build:Ae},Symbol.toStringTag,{value:"Module"}))},36592:(St,Le,S)=>{S.d(Le,{Q:()=>he});var B=S(85931),P=S(62208),ne=S(77029),y=S(14259);class he{constructor(L=9,w){this._compareMinX=se,this._compareMinY=k,this._toBBox=U=>U,this._maxEntries=Math.max(4,L||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),w&&("function"==typeof w?this._toBBox=w:this._initFormat(w)),this.clear()}destroy(){this.clear(),q.prune(),de.prune(),ae.prune(),be.prune()}all(L){this._all(this._data,L)}search(L,w){let U=this._data;const Z=this._toBBox;if(W(L,U))for(q.clear();U;){for(let Y=0,K=U.children.length;Y<K;Y++){const ce=U.children[Y],ve=U.leaf?Z(ce):ce;W(L,ve)&&(U.leaf?w(ce):Q(L,ve)?this._all(ce,w):q.push(ce))}U=q.pop()}}collides(L){let w=this._data;const U=this._toBBox;if(!W(L,w))return!1;for(q.clear();w;){for(let Z=0,Y=w.children.length;Z<Y;Z++){const K=w.children[Z],ce=w.leaf?U(K):K;if(W(L,ce)){if(w.leaf||Q(L,ce))return!0;q.push(K)}}w=q.pop()}return!1}load(L){if(!L.length)return this;if(L.length<this._minEntries){for(let U=0,Z=L.length;U<Z;U++)this.insert(L[U]);return this}let w=this._build(L.slice(0,L.length),0,L.length-1,0);if(this._data.children.length)if(this._data.height===w.height)this._splitRoot(this._data,w);else{if(this._data.height<w.height){const U=this._data;this._data=w,w=U}this._insert(w,this._data.height-w.height-1,!0)}else this._data=w;return this}insert(L){return L&&this._insert(L,this._data.height-1),this}clear(){return this._data=new X([]),this}remove(L){if(!L)return this;let w,U=this._data,Z=null,Y=0,K=!1;const ce=this._toBBox(L);for(ae.clear(),be.clear();U||ae.length>0;){if(U||(U=(0,P.j0)(ae.pop()),Z=ae.data[ae.length-1],Y=be.pop()??0,K=!0),U.leaf&&(w=(0,B.cq)(U.children,L,U.children.length,U.indexHint),-1!==w))return U.children.splice(w,1),ae.push(U),this._condense(ae),this;K||U.leaf||!Q(U,ce)?Z?(Y++,U=Z.children[Y],K=!1):U=null:(ae.push(U),be.push(Y),Y=0,Z=U,U=U.children[0])}return this}toJSON(){return this._data}fromJSON(L){return this._data=L,this}_all(L,w){let U=L;for(de.clear();U;){if(!0===U.leaf)for(const Z of U.children)w(Z);else de.pushArray(U.children);U=de.pop()??null}}_build(L,w,U,Z){const Y=U-w+1;let K=this._maxEntries;if(Y<=K){const Me=new X(L.slice(w,U+1));return A(Me,this._toBBox),Me}Z||(Z=Math.ceil(Math.log(Y)/Math.log(K)),K=Math.ceil(Y/K**(Z-1)));const ce=new D([]);ce.height=Z;const ve=Math.ceil(Y/K),Je=ve*Math.ceil(Math.sqrt(K));I(L,w,U,Je,this._compareMinX);for(let Me=w;Me<=U;Me+=Je){const st=Math.min(Me+Je-1,U);I(L,Me,st,ve,this._compareMinY);for(let Rt=Me;Rt<=st;Rt+=ve){const bs=Math.min(Rt+ve-1,st);ce.children.push(this._build(L,Rt,bs,Z-1))}}return A(ce,this._toBBox),ce}_chooseSubtree(L,w,U,Z){for(;Z.push(w),!0!==w.leaf&&Z.length-1!==U;){let Y,K=1/0,ce=1/0;for(let ve=0,Je=w.children.length;ve<Je;ve++){const Me=w.children[ve],st=j(Me),Rt=$(L,Me)-st;Rt<ce?(ce=Rt,K=st<K?st:K,Y=Me):Rt===ce&&st<K&&(K=st,Y=Me)}w=Y||w.children[0]}return w}_insert(L,w,U){const Y=U?L:(0,this._toBBox)(L);ae.clear();const K=this._chooseSubtree(Y,this._data,w,ae);for(K.children.push(L),xe(K,Y);w>=0&&ae.data[w].children.length>this._maxEntries;)this._split(ae,w),w--;this._adjustParentBBoxes(Y,ae,w)}_split(L,w){const U=L.data[w],Z=U.children.length,Y=this._minEntries;this._chooseSplitAxis(U,Y,Z);const K=this._chooseSplitIndex(U,Y,Z);if(!K)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const ce=U.children.splice(K,U.children.length-K),ve=U.leaf?new X(ce):new D(ce);ve.height=U.height,A(U,this._toBBox),A(ve,this._toBBox),w?L.data[w-1].children.push(ve):this._splitRoot(U,ve)}_splitRoot(L,w){this._data=new D([L,w]),this._data.height=L.height+1,A(this._data,this._toBBox)}_chooseSplitIndex(L,w,U){let Z,Y,K;Z=Y=1/0;for(let ce=w;ce<=U-w;ce++){const ve=_e(L,0,ce,this._toBBox),Je=_e(L,ce,U,this._toBBox),Me=J(ve,Je),st=j(ve)+j(Je);Me<Z?(Z=Me,K=ce,Y=st<Y?st:Y):Me===Z&&st<Y&&(Y=st,K=ce)}return K}_chooseSplitAxis(L,w,U){const Z=L.leaf?this._compareMinX:se,Y=L.leaf?this._compareMinY:k;this._allDistMargin(L,w,U,Z)<this._allDistMargin(L,w,U,Y)&&L.children.sort(Z)}_allDistMargin(L,w,U,Z){L.children.sort(Z);const Y=this._toBBox,K=_e(L,0,w,Y),ce=_e(L,U-w,U,Y);let ve=re(K)+re(ce);for(let Je=w;Je<U-w;Je++){const Me=L.children[Je];xe(K,L.leaf?Y(Me):Me),ve+=re(K)}for(let Je=U-w-1;Je>=w;Je--){const Me=L.children[Je];xe(ce,L.leaf?Y(Me):Me),ve+=re(ce)}return ve}_adjustParentBBoxes(L,w,U){for(let Z=U;Z>=0;Z--)xe(w.data[Z],L)}_condense(L){for(let w=L.length-1;w>=0;w--){const U=L.data[w];if(0===U.children.length)if(w>0){const Z=L.data[w-1],Y=Z.children;Y.splice((0,B.cq)(Y,U,Y.length,Z.indexHint),1)}else this.clear();else A(U,this._toBBox)}}_initFormat(L){const w=["return a"," - b",";"];this._compareMinX=new Function("a","b",w.join(L[0])),this._compareMinY=new Function("a","b",w.join(L[1])),this._toBBox=new Function("a","return {minX: a"+L[0]+", minY: a"+L[1]+", maxX: a"+L[2]+", maxY: a"+L[3]+"};")}}function A(z,L){_e(z,0,z.children.length,L,z)}function _e(z,L,w,U,Z){Z||(Z=new X([])),Z.minX=1/0,Z.minY=1/0,Z.maxX=-1/0,Z.maxY=-1/0;for(let Y,K=L;K<w;K++)Y=z.children[K],xe(Z,z.leaf?U(Y):Y);return Z}function xe(z,L){z.minX=Math.min(z.minX,L.minX),z.minY=Math.min(z.minY,L.minY),z.maxX=Math.max(z.maxX,L.maxX),z.maxY=Math.max(z.maxY,L.maxY)}function se(z,L){return z.minX-L.minX}function k(z,L){return z.minY-L.minY}function j(z){return(z.maxX-z.minX)*(z.maxY-z.minY)}function re(z){return z.maxX-z.minX+(z.maxY-z.minY)}function $(z,L){return(Math.max(L.maxX,z.maxX)-Math.min(L.minX,z.minX))*(Math.max(L.maxY,z.maxY)-Math.min(L.minY,z.minY))}function J(z,L){const w=Math.max(z.minX,L.minX),U=Math.max(z.minY,L.minY),Z=Math.min(z.maxX,L.maxX),Y=Math.min(z.maxY,L.maxY);return Math.max(0,Z-w)*Math.max(0,Y-U)}function Q(z,L){return z.minX<=L.minX&&z.minY<=L.minY&&L.maxX<=z.maxX&&L.maxY<=z.maxY}function W(z,L){return L.minX<=z.maxX&&L.minY<=z.maxY&&L.maxX>=z.minX&&L.maxY>=z.minY}function I(z,L,w,U,Z){const Y=[L,w];for(;Y.length;){const K=(0,P.j0)(Y.pop()),ce=(0,P.j0)(Y.pop());if(K-ce<=U)continue;const ve=ce+Math.ceil((K-ce)/U/2)*U;(0,y.q)(z,ve,ce,K,Z),Y.push(ce,ve,ve,K)}}const q=new ne.Z,de=new ne.Z,ae=new ne.Z,be=new ne.Z({deallocator:void 0});class Ae{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class ye extends Ae{constructor(){super(...arguments),this.height=1,this.indexHint=new B.SO}}class X extends ye{constructor(L){super(),this.children=L,this.leaf=!0}}class D extends ye{constructor(L){super(),this.children=L,this.leaf=!1}}},77044:(St,Le,S)=>{S.d(Le,{Y:()=>ne});var B=S(62208);function P(k,j){return k?j?4:3:j?3:2}function ne(k,j,re,$,J){if((0,B.Wi)(j)||!j.lengths.length)return null;const Q="upperLeft"===J?.originPosition?-1:1;k.lengths.length&&(k.lengths.length=0),k.coords.length&&(k.coords.length=0);const W=k.coords,I=[],q=re?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],{lengths:de,coords:ae}=j,be=P(re,$);let Ae=0;for(const ye of de){const X=y(q,ae,Ae,ye,re,$,Q);X&&I.push(X),Ae+=ye*be}if(I.sort((ye,X)=>{let D=Q*ye[2]-Q*X[2];return 0===D&&re&&(D=ye[4]-X[4]),D}),I.length){let ye=6*I[0][2];W[0]=I[0][0]/ye,W[1]=I[0][1]/ye,re&&(ye=6*I[0][4],W[2]=0!==ye?I[0][3]/ye:0),(W[0]<q[0]||W[0]>q[1]||W[1]<q[2]||W[1]>q[3]||re&&(W[2]<q[4]||W[2]>q[5]))&&(W.length=0)}if(!W.length){const ye=j.lengths[0]?function he(k,j,re,$,J){const Q=P($,J);let W=j,I=j+Q,q=0,de=0,ae=0,be=0;for(let Ae=0,ye=re-1;Ae<ye;Ae++,W+=Q,I+=Q){const X=k[W],D=k[W+1],z=k[W+2],L=k[I],w=k[I+1],U=k[I+2],Z=$?_e(X,D,z,L,w,U):A(X,D,L,w);if(Z)if(q+=Z,$){const Y=se(X,D,z,L,w,U);de+=Z*Y[0],ae+=Z*Y[1],be+=Z*Y[2]}else{const Y=xe(X,D,L,w);de+=Z*Y[0],ae+=Z*Y[1]}}return q>0?$?[de/q,ae/q,be/q]:[de/q,ae/q]:re>0?$?[k[j],k[j+1],k[j+2]]:[k[j],k[j+1]]:null}(ae,0,de[0],re,$):null;if(!ye)return null;W[0]=ye[0],W[1]=ye[1],re&&ye.length>2&&(W[2]=ye[2])}return k}function y(k,j,re,$,J,Q,W=1){const I=P(J,Q);let q=re,de=re+I,ae=0,be=0,Ae=0,ye=0,X=0;for(let z=0,L=$-1;z<L;z++,q+=I,de+=I){const w=j[q],U=j[q+1],Z=j[q+2],Y=j[de],K=j[de+1],ce=j[de+2];let ve=w*K-Y*U;ye+=ve,ae+=(w+Y)*ve,be+=(U+K)*ve,J&&(ve=w*ce-Y*Z,Ae+=(Z+ce)*ve,X+=ve),w<k[0]&&(k[0]=w),w>k[1]&&(k[1]=w),U<k[2]&&(k[2]=U),U>k[3]&&(k[3]=U),J&&(Z<k[4]&&(k[4]=Z),Z>k[5]&&(k[5]=Z))}if(ye*W>0&&(ye*=-1),X*W>0&&(X*=-1),!ye)return null;const D=[ae,be,.5*ye];return J&&(D[3]=Ae,D[4]=.5*X),D}function A(k,j,re,$){const J=re-k,Q=$-j;return Math.sqrt(J*J+Q*Q)}function _e(k,j,re,$,J,Q){const W=$-k,I=J-j,q=Q-re;return Math.sqrt(W*W+I*I+q*q)}function xe(k,j,re,$){return[k+.5*(re-k),j+.5*($-j)]}function se(k,j,re,$,J,Q){return[k+.5*($-k),j+.5*(J-j),re+.5*(Q-re)]}},92794:(St,Le,S)=>{S.d(Le,{n:()=>he});var B=S(62208),P=S(77044),ne=S(66385),y=S(88071);const he={getObjectId:A=>A.objectId,getAttributes:A=>A.attributes,getAttribute:(A,_e)=>A.attributes[_e],cloneWithGeometry:(A,_e)=>new ne.u_(_e,A.attributes,null,A.objectId),getGeometry:A=>A.geometry,getCentroid:(A,_e)=>((0,B.Wi)(A.centroid)&&(A.centroid=(0,P.Y)(new y.Z,A.geometry,_e.hasZ,_e.hasM)),A.centroid)}},39236:(St,Le,S)=>{S.d(Le,{Z:()=>he});var B=S(26584),P=S(63290),ne=S(62208),y=S(7848);function he(se,k,j,re,$){if((0,ne.Wi)(se))return null;const J=se.referencesGeometry()&&$?function _e(se,k,j){const{transform:re,hasZ:$,hasM:J}=j;A.has(k)||A.set(k,function xe(se){const k={};switch(se){case"esriGeometryPoint":return(j,re,$,J)=>(0,y.U1)(re,k,j,$,J);case"esriGeometryPolygon":return(j,re,$,J)=>(0,y.Ie)(re,k,j,$,J);case"esriGeometryPolyline":return(j,re,$,J)=>(0,y.G6)(re,k,j,$,J);case"esriGeometryMultipoint":return(j,re,$,J)=>(0,y.J9)(re,k,j,$,J);default:return P.Z.getLogger("esri.views.2d.support.arcadeOnDemand").error(new B.Z("mapview-arcade",`Unable to handle geometryType: ${se}`)),j=>j}}(k));const Q=A.get(k)(se.geometry,re,$,J);return{...se,geometry:Q}}(k,re,$):k,Q=se.repurposeFeature(J);try{return se.evaluate({...j,$feature:Q})}catch(W){return P.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",W),null}}const A=new Map},25881:(St,Le,S)=>{S.r(Le),S.d(Le,{default:()=>ep});var B=S(15861),P=S(17626),ne=S(26584),y=S(62208),he=S(32917),A=S(77712),xe=(S(90912),S(85931)),se=S(76898),k=S(54024),j=S(10699),re=S(36947);const $=c=>{let a=class extends c{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(l){super.postscript(l),(0,re.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}_validateHeightModelInfo(){var l=this;return(0,B.Z)(function*(){const h=new AbortController,d=h.signal;l.handles.add((0,k.kB)(()=>h.abort())),yield(0,he.N1)(()=>l.view.defaultsFromMap?.heightModelInfoReady,d),(0,j.k_)(d);const u=(0,re.Wt)(l.layer,l.view.heightModelInfo,l.supportsHeightUnitConversion);if(u)throw u})()}canResume(){const l=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!l||!l.minScale||!l.maxScale||l.minScale>=l.maxScale)}getSuspendInfo(){const l=super.getSuspendInfo(),h=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return h&&h.minScale&&h.maxScale&&h.minScale<h.maxScale&&(l.outsideScaleRange=!0),l}};return(0,P._)([(0,A.Cb)()],a.prototype,"view",void 0),(0,P._)([(0,A.Cb)()],a.prototype,"slicePlaneEnabled",void 0),a=(0,P._)([(0,se.j)("esri.views.3d.layers.LayerView3D")],a),a};S(29132);var Q=S(38114),W=S(60507),I=S(81468),q=S(79112),de=S(74746),ae=S(65234);function Ae(){return(Ae=(0,B.Z)(function*(c,a,l,h,d){const{elevationProvider:u,renderCoordsHelper:p,spatialReference:g}=c,{elevationInfo:_}=a,v=(0,de.WI)(_,!0),b=yield(0,de.kr)(v,g,d);(0,j.k_)(d);const C=[],x=new Set,R=new Set;for(const{objectId:O,points:M}of h){const F=l(O);if((0,y.Wi)(F)){for(const N of M)C.push(N[2]);x.add(O)}else{F.isDraped&&R.add(O),ye.setFromElevationInfo((0,W.Jn)(F.graphic.geometry,_)),ye.updateFeatureExpressionInfoContext(b,F.graphic,a),X.spatialReference=c.spatialReference;for(const{x:N,y:te,z:ee}of M)X.x=N,X.y=te,X.z=ee??0,(0,I.qZ)(X,u,ye,p,D),C.push(D.z)}}return{elevations:C,drapedObjectIds:R,failedObjectIds:x}})).apply(this,arguments)}const ye=new q.o,X=(0,Q.Tx)(0,0,0,ae.Z.WGS84),D=new I.Lm;var z=S(88879),L=S(74333),w=S(80542),U=S(84682),Z=S(44917),Y=S(84786),K=S(91558),ce=S(81808);function ve(c,a){if(!c||c.symbol)return null;const l=a&&a.renderer;return c&&(0,y.pC)(l)&&l.getObservationRenderer?l.getObservationRenderer(c):l}function st(c,a){return Rt.apply(this,arguments)}function Rt(){return(Rt=(0,B.Z)(function*(c,a){if((0,y.pC)(c.symbol))return c.symbol;const l=ve(c,a);return(0,y.pC)(l)?l.getSymbolAsync(c,a):null})).apply(this,arguments)}function Ss(){return(Ss=(0,B.Z)(function*(c,a){const l=ve(c,a),h=yield st(c,a);if(!h)return null;const d={renderer:l,symbol:h};if(!l||!("visualVariables"in l)||!l.visualVariables)return d;const u=(0,ce.getVisualVariableValues)(l,c,a)??[],p=["proportional","proportional","proportional"];for(const{variable:g,value:_}of u)if("color"===g.type)d.color=K.Z.toUnitRGBA(_);else if("size"===g.type)if("outline"===g.target)d.outlineSize=_;else{const v=g.axis,b=g.useSymbolValue?"symbol-value":_;"width"===v?p[0]=b:"depth"===v?p[1]=b:"height"===v?p[2]=b:p[0]=p[1]="width-and-depth"===v?b:p[2]=b}else"opacity"===g.type?d.opacity=_:"rotation"===g.type&&"tilt"===g.axis?d.tilt=_:"rotation"===g.type&&"roll"===g.axis?d.roll=_:"rotation"===g.type&&(d.heading=_);return(isFinite(p[0])||isFinite(p[1])||isFinite(p[2]))&&(d.size=p),d})).apply(this,arguments)}var ol=S(96854),ll=S(62600),De=S(4794);const hl=De.Z;S(4832),S(49067),S(96794),S(69747),S(40425),S(69357),S(40342);var Ga=S(73640),si=(S(33474),S(20383),S(14517)),Cs=S(8314),Tr=S(72392),bi=S(63290),za=S(88159),xs=S(77029),dl=S(50618),E=S(84161),G=S(28093),Se=S(55915),V=S(5548),ze=S(65401),Va=S(37053),ai=S(70137);function Fa(c){return(0,y.Wi)(c)||"simple"===c.type||"unique-value"===c.type||"class-breaks"===c.type||"dictionary"===c.type||"heatmap"===c.type}function Ps(c,a){if(!a)return null;let l;if(l=Array.isArray(a)?a:[a],l.length>0){const h=l.map(u=>u.details.symbol.type||u.details.symbol.declaredClass).filter(u=>!!u);h.sort();const d=[];return h.forEach((u,p)=>{0!==p&&u===h[p-1]||d.push(u)}),new ne.Z("renderer-conversion-3d:unsupported-symbols",`Renderer contains symbols (${d.join(", ")}) which are not supported in 3D`,{renderer:c,symbolErrors:l})}return null}var Es=S(46679),yl=S(9260),fl=S(40445),_l=S(36687),vl=S(69852),bl=S(89673),Sl=S(2252),Os=S(8080),Ba=S(24837);const Cl=vl.Z.fromSimpleMarkerSymbol(Os.xA),xl=fl.Z.fromSimpleLineSymbol(Os.CJ),Pl=bl.Z.fromSimpleFillSymbol(Os.z3),El=new _l.Z({symbolLayers:[new yl.Z({material:{color:Ba.SQ},edges:new Sl.Z({size:"1px",color:Ba.X1})})]});function Ol(c){if((0,y.Wi)(c))return null;switch(c.type){case"mesh":return El;case"point":case"multipoint":return Cl;case"polyline":return xl;case"polygon":case"extent":return Pl}return null}var at,xt,c,Ct=S(84259);S(72854);class Rl{constructor(a,l){this.spatialReference=a,this._view=l}getElevation(a,l,h){return this._view.elevationProvider.getElevation(a,l,0,this.spatialReference,h)}queryElevation(a,l,h,d,u){var p=this;return(0,B.Z)(function*(){return p._view.elevationProvider.queryElevation(a,l,0,p.spatialReference,u,h,d)})()}}(c=at||(at={}))[c.GRAPHIC=0]="GRAPHIC",c[c.LABEL=1]="LABEL",c[c._COUNT=2]="_COUNT",function(c){c[c.USER_SETTING=0]="USER_SETTING",c[c.SCALE_RANGE=1]="SCALE_RANGE",c[c.FILTER=2]="FILTER",c[c.DECONFLICTION=3]="DECONFLICTION",c[c._COUNT=4]="_COUNT"}(xt||(xt={}));var Ar=S(61885),Tl=S(66385),Al=S(88071),zi=S(92794);const Na=(0,V.Ue)();let Vt=class extends si.Z{constructor(c){super(c),this.events=new Ar.Z,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.featureAdapter={getAttribute:(a,l)=>"graphic"in a?a.graphic.attributes[l]:zi.n.getAttribute(a,l),getAttributes:a=>"graphic"in a?a.graphic.attributes:zi.n.getAttributes(a),getObjectId:a=>"graphic"in a?(0,Q.MS)(a.graphic,this.objectIdField)??void 0:zi.n.getObjectId(a),getGeometry:a=>"graphic"in a?a.getAsOptimizedGeometry(this.hasZ,this.hasM):zi.n.getGeometry(a),getCentroid:(a,l)=>{if("graphic"in a){let h=null;(0,y.pC)(a.centroid)?h=a.centroid:"point"===a.graphic.geometry.type&&(0,Se.nF)(a.graphic.geometry,ja,this.viewSpatialReference)&&(h=ja);const d=new Array(2+(l.hasZ?1:0)+(l.hasM?1:0));return(0,y.Wi)(h)?(d[0]=0,d[1]=0,d[2]=0,d[3]=0):(d[0]=h.x,d[1]=h.y,l.hasZ&&(d[2]=h.hasZ?h.z:0),l.hasM&&(d[l.hasZ?3:2]=h.hasM?h.m:0)),new Al.Z([],d)}return zi.n.getCentroid(a,l)},cloneWithGeometry:(a,l)=>"graphic"in a?new Tl.u_(l,this.featureAdapter.getAttributes(a),null,this.featureAdapter.getObjectId(a)):zi.n.cloneWithGeometry(a,l)}}forEachInBounds(c,a){this.getSpatialIndex().forEachInBounds(c,a)}forEachBounds(c,a){const l=this.getSpatialIndex();for(const h of c){const d=this.featureAdapter.getObjectId(h);(0,y.pC)(l.getBounds(d,Na))&&a(Na)}}};(0,P._)([(0,A.Cb)({constructOnly:!0})],Vt.prototype,"getSpatialIndex",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Vt.prototype,"forEach",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Vt.prototype,"hasZ",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Vt.prototype,"hasM",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Vt.prototype,"objectIdField",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Vt.prototype,"viewSpatialReference",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Vt.prototype,"featureSpatialReference",void 0),Vt=(0,P._)([(0,se.j)("esri.views.3d.layers.graphics.Graphics3DFeatureStore")],Vt);const ja={type:"point",x:0,y:0,hasZ:!1,hasM:!1,spatialReference:null};class Ll{constructor(a,l,h){this.graphic=a,this.renderingInfo=l,this.layer=h}}class Il{constructor(a,l){this.scheduler=a,this.schedule=l,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}}var Lr=S(59213),Ir=S(9824),Qe=S(23841),oe=S(99770),Be=S(28347),we=S(43703),Ne=S(67225),ht=S(93605),Wa=S(53929),ni=S(44968);function Rs(c){return(0,y.pC)(c.mapPositions)}var T=S(16396);function Ha(c,a,l,h,d){const u=c.stageObject,p=u.geometries;let g=0;for(const _ of p){if(!Rs(_))continue;const{update:v,averageGeometrySampledElevation:b}=Ya(_,a,l,h,d);g+=b,v&&u.geometryVertexAttrsUpdated(_)}return g/p.length}function sr(c,a,l,h,d){const u=c.stageObject,p=a.centerPointInElevationSR;let g=0;u.metadata?.usesVerticalDistanceToGround?(h(p,ut),(0,Ne.CV)(u,ut.verticalDistanceToGround),g=ut.sampledElevation):(h(p,ut),"absolute-height"!==a.mode&&(g=ut.sampledElevation));const _=(0,Be.c)(Dl,u.transformation),v=(0,E.s)(Za,_[12],_[13],_[14]);ht.Z.TESTS_DISABLE_OPTIMIZATIONS?(dt[0]=p.x,dt[1]=p.y,dt[2]=ut.z,(0,Se.Bm)(p.spatialReference,dt,_,d.spatialReference)&&(u.transformation=_)):d.setAltitudeOfTransformation(ut.z,_);const b=Ts/d.unitInMeters;return(Math.abs(_[12]-v[0])>=b||Math.abs(_[13]-v[1])>=b||Math.abs(_[14]-v[2])>=b)&&(u.transformation=_),g}const Dl=(0,we.c)();function wl(c,a,l,h,d){const u=c.graphics3DSymbolLayer.lodRenderer;if((0,y.Wi)(u))return 0;const p=a.centerPointInElevationSR;h(p,ut);const g="absolute-height"!==a.mode?ut.sampledElevation:0,_=u.instanceData,v=c.instanceIndex,b=Ul;_.getGlobalTransform(v,b);const C=(0,E.s)(Za,b[12],b[13],b[14]);ht.Z.TESTS_DISABLE_OPTIMIZATIONS?(dt[0]=p.x,dt[1]=p.y,dt[2]=ut.z,(0,Se.Bm)(p.spatialReference,dt,b,d.spatialReference)&&_.setGlobalTransform(v,b)):d.setAltitudeOfTransformation(ut.z,b);const x=Ts/d.unitInMeters;return(ht.Z.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(b[12]-C[0])>=x||Math.abs(b[13]-C[1])>=x||Math.abs(b[14]-C[2])>=x)&&_.setGlobalTransform(v,b),g}function Ml(c,a,l,h,d){const u=c.stageObject,p=u.geometries;if(0===p.length)return 0;let g=0,_=null,v=0,b=!1;for(const C of p){if(!Rs(C))continue;const x=C.vertexAttributes.get(T.T.POSITION);if(x!==_){const{update:R,averageGeometrySampledElevation:O}=Ya(C,a,l,h,d);v=O,_=x,b=R}b&&u.geometryVertexAttrsUpdated(C),g+=v}return g/p.length}const Ts=.01,dt=(0,G.c)(),Tt=(0,G.c)(),Vi=(0,G.c)(),Ul=(0,we.c)(),Za=(0,G.c)(),ut=new I.Lm;function Ya(c,a,l,h,d){let u=!1;const p=c.shaderTransformation,g=a.requiresSampledElevationInfo;Tt[0]=p[12],Tt[1]=p[13],Tt[2]=p[14],c.invalidateBoundingInfo();const _=c.getMutableAttribute(T.T.POSITION),v=_.data,b=_.size,C=v.length/b,x=new Wa.sb(c.mapPositions,l);let R=0,O=0;for(let M=0;M<C;M++){if(Vi[0]=v[R],Vi[1]=v[R+1],Vi[2]=v[R+2],h(x,ut),g&&(O+=ut.sampledElevation),ht.Z.TESTS_DISABLE_OPTIMIZATIONS)v[R]=x.array[x.offset],v[R+1]=x.array[x.offset+1],v[R+2]=ut.z,(0,Se.CM)(v,l,R,v,d.spatialReference,R,1),v[R]-=Tt[0],v[R+1]-=Tt[1],v[R+2]-=Tt[2],u=!0;else{dt[0]=v[R]+Tt[0],dt[1]=v[R+1]+Tt[1],dt[2]=v[R+2]+Tt[2],d.setAltitude(dt,ut.z),v[R]=dt[0]-Tt[0],v[R+1]=dt[1]-Tt[1],v[R+2]=dt[2]-Tt[2];const F=Ts/d.unitInMeters;(Math.abs(Vi[0]-v[R])>=F||Math.abs(Vi[1]-v[R+1])>=F||Math.abs(Vi[2]-v[R+2])>=F)&&(u=!0)}R+=b,x.offset+=3}return O/=C,{update:u,averageGeometrySampledElevation:O}}var As=S(97126),Pe=S(42743),Ls=S(17803);class Gl{constructor(a,l,h){this.baseMaterial=a,this.edgeMaterials=l,this.properties=h}}class Ft{get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}constructor(a,l,h,d,u,p,g,_=null){this.graphics3DSymbolLayer=a,this.stageObject=l,this._uniqueGeometries=h,this._uniqueMaterials=d,this._sharedResource=u,this.elevationAligner=p,this.elevationContext=g,this._edgeState=_,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(a,l){this._stageLayer=l,this._stage=a,a.addMany(this._uniqueMaterials),a.addMany(this._uniqueGeometries),a.add(this.stageObject)}destroy(){const a=this._stage;this._stageLayer&&(a.removeMany(this._uniqueMaterials),a.removeMany(this._uniqueGeometries)),a.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const l=this._stage.renderer.ensureEdgeView();l.hasObject(this.stageObject)&&l.removeObject(this.stageObject),this.stageObject.dispose(),(0,y.pC)(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(a,l){if((0,y.Wi)(this._edgeState))return;const h=$a(this._edgeState.baseMaterial);let d=!1;for(const u of this._edgeState.edgeMaterials)u.objectTransparency!==h&&(u.objectTransparency=h,d=!0);d&&this._resetEdgeObject(l),this._stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[a])}slicePlaneEnabledChanged(a,l){(0,y.Wi)(this._edgeState)||(this._stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:a},!l),this._edgeState.properties.hasSlicePlane=a)}setVisibility(a){if(null!=this._stage&&this._visible!==a&&(this._visible=a,this.stageObject.visible=a,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),(0,y.pC)(this._edgeState))){const l=this._stage.renderer.ensureEdgeView();l.hasObject(this.stageObject)?l.updateObjectVisibility(this.stageObject,a):a&&this._addOrUpdateEdgeObject(l,!1)}}get visible(){return this._visible}alignWithElevation(a,l,h,d){null!=this.elevationAligner&&((0,y.pC)(h)&&(0,de.aO)(this.elevationContext.featureExpressionInfoContext,h),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,(0,y.Wg)(a.spatialReference),(p,g)=>(0,I.qZ)(p,a,this.elevationContext,l,g),l),this._resetEdgeObject(d))}alignWithAbsoluteElevation(a,l,h){this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,(u,p)=>{p.sampledElevation=a,p.verticalDistanceToGround=0,p.z=a},l),this._resetEdgeObject(h)}getCenterObjectSpace(a=(0,G.c)()){return(0,E.c)(a,(0,As.g)(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(a=(0,V.Ue)()){const l=this.stageObject.boundingVolumeObjectSpace;return(0,V.op)(a,l.min),(0,V.Tn)(a,l.max),a}computeAttachmentOrigin(a){if(this.useObjectOriginAsAttachmentOrigin){const l=this.stageObject.transformation;a.render.origin[0]+=l[12],a.render.origin[1]+=l[13],a.render.origin[2]+=l[14],a.render.num++}else for(const l of this.stageObject.geometries)l.computeAttachmentOrigin(kt)&&((0,E.m)(kt,kt,this.stageObject.transformation),(0,E.a)(a.render.origin,a.render.origin,kt),a.render.num++)}getProjectedBoundingBox(a,l,h,d,u){var p=this;return(0,B.Z)(function*(){const g=p.getBoundingBoxObjectSpace(u),_=zl,v=(0,V.wp)(g)?1:_.length;for(let C=0;C<v;C++){const x=_[C];oi[0]=g[x[0]],oi[1]=g[x[1]],oi[2]=g[x[2]],(0,E.m)(oi,oi,p.stageObject.transformation),Si[3*C+0]=oi[0],Si[3*C+1]=oi[1],Si[3*C+2]=oi[2]}if(!a(Si,0,v))return null;(0,V.cS)(g);let b=null;p.calculateRelativeScreenBounds&&(b=p.calculateRelativeScreenBounds());for(let C=0;C<3*v;C+=3){for(let x=0;x<3;x++)g[x]=Math.min(g[x],Si[C+x]),g[x+3]=Math.max(g[x+3],Si[C+x]);b&&h.push({location:Si.slice(C,C+3),screenSpaceBoundingRect:b})}if(l&&l.service&&"absolute-height"!==p.elevationContext.mode){(0,V.be)(g,kt);const C="relative-to-scene"===p.elevationContext.mode?"scene":"ground";let x=0;if(l.useViewElevation)x=(0,y.Pt)(l.service.getElevation(kt[0],kt[1],C),0);else try{const R=(0,Ne.Si)(g,l.service.spatialReference,l);x=(0,y.Pt)(yield l.service.queryElevation(kt[0],kt[1],d,R,C),0)}catch{}(0,V.cv)(g,0,0,-p.alignedSampledElevation+x)}return g})()}addObjectState(a,l){a===Pe.V_.Highlight&&l.addObject(this.stageObject,this.stageObject.highlight()),a===Pe.V_.MaskOccludee&&l.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(a){a.removeObject(this.stageObject)}_resetEdgeObject(a){if((0,y.Wi)(this._edgeState))return;const l=this._stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(l,a):l.removeObject(this.stageObject)}_addOrUpdateEdgeObject(a,l){const h=this._edgeState;if((0,y.Wi)(h))return;const d=$a(h.baseMaterial);for(const u of h.edgeMaterials)u.objectTransparency=d;a.addOrUpdateObject3D(this.stageObject,h.edgeMaterials,h.properties,!l).then(()=>this._stageLayer?.sync())}}function $a(c){return c.isVisible()?c.parameters.transparent?Ls.i.TRANSPARENT:Ls.i.OPAQUE:Ls.i.INVISIBLE}const Si=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],oi=(0,G.c)(),kt=(0,G.c)(),zl=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];class Ka{constructor(a,l=null){this.labelText=l,this.elevationOffset=(0,y.Pt)(a,0)}}var Ue,ft;!function(c){c[c.Recreate_Symbol=0]="Recreate_Symbol",c[c.Recreate_Graphics=1]="Recreate_Graphics",c[c.Fast_Update=2]="Fast_Update"}(Ue||(Ue={}));class Is{constructor(a){this.schedule=a,this._abortController=null,this._loadStatus=ft.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(a,l){return this._loadStatus===ft.LOADED?(a&&a(),(0,y.Pt)(this._loader,Promise.resolve())):this._loadStatus===ft.FAILED?(l&&l(this._loadError),(0,y.Pt)(this._loader,Promise.resolve())):((0,y.Wi)(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=ft.LOADED},h=>{throw this._loadError=h,this._abortController=null,this._loadStatus=ft.FAILED,!(0,j.D_)(h)&&this.logger&&h.message&&this.logger.warn(h.message),h})),this._loader.then(a,l).catch(()=>{}),this._loader)}abortLoad(){(0,y.pC)(this._abortController)?this._abortController=(0,y.IM)(this._abortController):this._loadStatus===ft.LOADING&&(this._loadStatus=ft.FAILED),this._loader=null}}!function(c){c[c.LOADING=0]="LOADING",c[c.LOADED=1]="LOADED",c[c.FAILED=2]="FAILED"}(ft||(ft={}));var Dr=S(94573),ka=S(48521),Pt=S(57521);class Qa{constructor(a,l=null){this.geometry=a,this.textures=l}}function wr(c){const a=[];return c.levels.forEach(l=>l.components.forEach(h=>a.push(h.geometry.material))),(0,xe.Tw)(a)}function qa(c){const a=new Array;return c.levels.forEach(l=>{l.components.forEach(h=>{(0,y.pC)(h.textures)&&a.push(...h.textures)})}),(0,xe.Tw)(a)}function en(c){const a=c.components.map(l=>l.geometry);return(0,xe.Tw)(a)}function tn(c){const a=[];return c.levels.forEach(l=>{l.components.forEach(h=>{a.push(h.geometry)})}),(0,xe.Tw)(a)}function rn(c,a){const l=(h,d,u=!1)=>({levels:h.map(p=>{const g=d(p.tesselation);return u&&(0,Pt.Cr)(g),{components:[new Qa(g)],faceCount:g.indexCount/3,minScreenSpaceRadius:p.minScreenSpaceRadius}})});switch(c){case"sphere":return l([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],h=>(0,Pt.mj)(a,.5,h,!0));case"cube":return l([{tesselation:0,minScreenSpaceRadius:0}],()=>(0,Pt.IG)(a,1));case"cone":return l(ws,h=>(0,Pt.QL)(a,1,.5,h,!1),!0);case"inverted-cone":return l(ws,h=>(0,Pt.QL)(a,1,.5,h,!0),!0);case"cylinder":return l(ws,h=>(0,Pt.nb)(a,1,.5,h,[0,0,1],[0,0,.5]));case"tetrahedron":return l([{tesselation:0,minScreenSpaceRadius:0}],()=>(0,Pt.AW)(a,1),!0);case"diamond":return l([{tesselation:0,minScreenSpaceRadius:0}],()=>(0,Pt.B2)(a,1),!0);default:return}}const ws=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];var Ms=S(2180);const Us={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function Gs(c){let a=0,l=0,h=0,d=!1,u=0;const p={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const g of c)(0,y.Wi)(g)||(a+=g.primitivesPerFeature,l+=g.primitivesPerCoordinate,h+=g.drawCallsPerFeature,p.bytesPerFeature+=g.memory.bytesPerFeature,p.bytesPerFeatureLabel+=g.memory.bytesPerFeatureLabel,p.bytesPerCoordinate+=g.memory.bytesPerCoordinate,p.resourceBytes+=g.memory.resourceBytes,p.draped.bytesPerFeature+=g.memory.bytesPerFeature,p.draped.bytesPerFeatureLabel+=g.memory.bytesPerFeatureLabel,p.draped.bytesPerCoordinate+=g.memory.bytesPerCoordinate,d=d||g.estimated,++u);return{primitivesPerFeature:a,primitivesPerCoordinate:l,drawCallsPerFeature:h,estimated:d,memory:p,numComplexities:u}}const sn={};function an(c,a){const l=nn(c,a),h=(0,Ms.eU)(a)?2:0;switch(a.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:h,estimated:!1,memory:l};case"fill":return"mesh-3d"===c.type?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:h,estimated:!1,memory:l}:(0,y.pC)(a.outline)&&a.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:l}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:l};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:l};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:l};case"object":return a.resource&&a.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:l}:{...Nl(a.resource&&a.resource.primitive||ka.S),memory:l};case"path":{let d=0,u=0;switch(a.profile){case"circle":d=10;break;case"quad":d=4;break;default:return void(0,Dr.Bg)(a.profile)}switch(a.join??"simple"){case"round":u=3;break;case"miter":case"bevel":u=1;break;default:return}const p=2*d,g=d*u*2;let _=-2*g-p;switch(a.cap){case"none":break;case"butt":case"square":_+=2*(d-1);break;case"round":_+=2*(2*d*2+d);break;default:return}return{primitivesPerFeature:_,primitivesPerCoordinate:g+p,drawCallsPerFeature:0,estimated:!1,memory:l}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:l};default:return}}function nn(c,a){const l="point-3d"===c.type;switch(a.type){case"extrude":return a.edges&&a.edges.size>0?pt.EXTRUDE_EDGES:pt.EXTRUDE;case"fill":return(0,y.pC)(a.outline)&&a.outline.size>0?pt.FILL_OUTLINE:pt.FILL;case"water":return pt.FILL;case"line":return"round"===a.join?pt.LINE_ROUND:pt.LINE_MITER;case"path":switch(a.join){case"round":switch(a.profile){case"circle":return pt.PATH_ROUND_CIRCLE;case"quad":return pt.PATH_ROUND_QUAD;default:return void(0,Dr.Bg)(a.profile)}case"miter":case"bevel":switch(a.profile){case"circle":return pt.PATH_MITER_CIRCLE;case"quad":return pt.PATH_MITER_QUAD;default:return void(0,Dr.Bg)(a.profile)}default:return}case"object":return l?pt.OBJECT_POINT:pt.OBJECT_POLYGON;case"icon":case"text":return l?pt.ICON_POINT:pt.ICON_POLYGON;default:return}}function Nl(c){let a=sn[c];return a||(a={primitivesPerFeature:en(rn(c,null).levels[0]).reduce((h,d)=>h+d.indices.get(T.T.POSITION).length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},sn[c]=a,a)}const pt={ICON_POINT:{bytesPerFeature:3293.7707557538765,bytesPerFeatureLabel:1020.2764,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:2213.51585392203,bytesPerFeatureLabel:1008.84664,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:4745.397589234022,bytesPerFeatureLabel:1006.5440666666666,bytesPerCoordinate:3.8971910718981526,resourceBytes:0,draped:{bytesPerFeature:3711.9299672493826,bytesPerFeatureLabel:991.1003999999999,bytesPerCoordinate:3.916858016273668}},OBJECT_POINT:{bytesPerFeature:1751.6405617660876,bytesPerFeatureLabel:1024.7827699999998,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:1751.6405617660876,bytesPerFeatureLabel:1024.7827699999998,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:3265.877223973855,bytesPerFeatureLabel:1002.3207366666666,bytesPerCoordinate:4.003101524580855,resourceBytes:0,draped:{bytesPerFeature:3265.877223973855,bytesPerFeatureLabel:1002.3207366666666,bytesPerCoordinate:4.003101524580855}},LINE_MITER:{bytesPerFeature:5757.019675077085,bytesPerFeatureLabel:998.6150266666667,bytesPerCoordinate:24.456810187064043,resourceBytes:0,draped:{bytesPerFeature:4101.480288021862,bytesPerFeatureLabel:1007.7540599999999,bytesPerCoordinate:18.25629912730874}},LINE_ROUND:{bytesPerFeature:5770.95297166408,bytesPerFeatureLabel:1017.77396,bytesPerCoordinate:24.60919037084966,resourceBytes:0,draped:{bytesPerFeature:4089.5796612121826,bytesPerFeatureLabel:987.8320266666666,bytesPerCoordinate:18.43599029126731}},PATH_MITER_CIRCLE:{bytesPerFeature:36120.81813311945,bytesPerFeatureLabel:977.3815,bytesPerCoordinate:2713.2216607858863,resourceBytes:0,draped:{bytesPerFeature:36120.81813311945,bytesPerFeatureLabel:977.3815,bytesPerCoordinate:2713.2216607858863}},PATH_ROUND_CIRCLE:{bytesPerFeature:23268.96777866874,bytesPerFeatureLabel:985.2637,bytesPerCoordinate:5284.873051323177,resourceBytes:0,draped:{bytesPerFeature:23268.96777866874,bytesPerFeatureLabel:985.2637,bytesPerCoordinate:5284.873051323177}},PATH_MITER_QUAD:{bytesPerFeature:24548.629753007182,bytesPerFeatureLabel:964.6924,bytesPerCoordinate:2114.107276663994,resourceBytes:0,draped:{bytesPerFeature:24548.629753007182,bytesPerFeatureLabel:964.6924,bytesPerCoordinate:2114.107276663994}},PATH_ROUND_QUAD:{bytesPerFeature:34316.219663191616,bytesPerFeatureLabel:975.7985,bytesPerCoordinate:3331.3952550120293,resourceBytes:0,draped:{bytesPerFeature:34316.219663191616,bytesPerFeatureLabel:975.7985,bytesPerCoordinate:3331.3952550120293}},FILL:{bytesPerFeature:6141.501452970723,bytesPerFeatureLabel:1008.2056066666665,bytesPerCoordinate:9.669541106191478,resourceBytes:0,draped:{bytesPerFeature:4615.812654782311,bytesPerFeatureLabel:1004.2114200000001,bytesPerCoordinate:7.378043214430644}},FILL_OUTLINE:{bytesPerFeature:9038.575581319641,bytesPerFeatureLabel:1017.9996066666668,bytesPerCoordinate:14.96569682175086,resourceBytes:0,draped:{bytesPerFeature:6369.386021594582,bytesPerFeatureLabel:1008.9863733333334,bytesPerCoordinate:10.25287774000214}},EXTRUDE:{bytesPerFeature:20071.2337049912,bytesPerFeatureLabel:1019.49468,bytesPerCoordinate:49.39369614206849,resourceBytes:0,draped:{bytesPerFeature:20071.2337049912,bytesPerFeatureLabel:1019.49468,bytesPerCoordinate:49.39369614206849}},EXTRUDE_EDGES:{bytesPerFeature:22300.21739345088,bytesPerFeatureLabel:1017.4348466666665,bytesPerCoordinate:49.40242281963031,resourceBytes:0,draped:{bytesPerFeature:22300.21739345088,bytesPerFeatureLabel:1017.4348466666665,bytesPerCoordinate:49.40242281963031}}},Fi=bi.Z.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Bt extends Is{constructor(a,l,h,d){super(h.schedule),this.symbol=a,this.symbolLayer=l,this._context=h,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=Fi,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this._renderPriority=d.renderPriority,this._renderPriorityStep=d.renderPriorityStep,this._elevationContext=new q.o,this.complexity=this.computeComplexity(),this._ignoreDrivers=d.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=on(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(a){if(this._ignoreDrivers)return!1;const l=this._drivenProperties,h=on(a);return h.color!==l.color||h.opacity!==l.opacity||h.opacityAlwaysOpaque!==l.opacityAlwaysOpaque||h.size!==l.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(a,l,h,d){const p="polygons"in a?a.polygons:null,g=`${d} geometry failed to be created`;let _=null;a.projectionSuccess?!this._logGeometryValidationWarnings(l,h,d)&&p&&0===p.length&&"rings"===h&&l.length>0&&l[0].length>2&&(_=`${g} (filled rings should use clockwise winding - try reversing the order of vertices)`):_=`${g} (failed to project geometry to view spatial reference)`,_&&Fi.warnOncePerTick(_)}_logGeometryValidationWarnings(a,l,h){const d=`${h} geometry failed to be created`;return!a.length||1===a.length&&!a[0].length?(Fi.warnOncePerTick(`${d} (no ${l} were defined)`),!0):!(Array.isArray(a)&&Array.isArray(a[0])||(Fi.warnOncePerTick(`${d} (${l} should be defined as a 2D array)`),0))}_validateGeometry(a,l=null,h=null){if((0,y.pC)(l)&&!l.includes(a.type))return this.logger.warn("unsupported geometry type for "+h+` symbol: ${a.type}`),!1;if("point"===a.type){const d=a;if(!isFinite(d.x)||!isFinite(d.y))return Fi.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return jl}_defaultElevationInfoZ(){return Wl}_updateElevationContext(){(0,y.pC)(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(a){return a.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(a,l=this.getDefaultElevationInfo(a)){return this._elevationContext.mode||l.mode}setElevationInfoOverride(a){this._elevationInfoOverride=a,this._updateElevationContext()}setGraphicElevationContext(a,l){const h=(0,y.Wg)(a.geometry),d=this.getDefaultElevationInfo(h);l.unit=null!=this._elevationContext.unit?this._elevationContext.unit:d.unit,l.mode=this.getGeometryElevationMode(h,d),l.offsetMeters=(0,y.Pt)(this._elevationContext.meterUnitOffset,(0,y.Pt)(d.offset,0));const u=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===l.mode;return u&&(l.mode="relative-to-ground",l.offsetMeters=0),l.updateFeatureExpressionInfoContext(u?de.O$:this._elevationContext.featureExpressionInfoContext,a,this._context.layer),l}prepareSymbolLayerPatch(a){}updateGeometry(a,l){return!1}onRemoveGraphic(a){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(a,l=ln){let h=1;return this.draped||(h*=this._getLayerOpacity()),this._drivenProperties.opacity||((0,y.pC)(a)?h*=a.a:l.hasIntrinsicColor||(h=0)),h}_getCombinedOpacityAndColor(a,l=ln){const h=this._getCombinedOpacity(a,l);if(this._drivenProperties.color)return(0,Ne.Uu)(null,h);const d=(0,y.pC)(a)?K.Z.toUnitRGB(a):G.O;return(0,Ne.Uu)(d,h)}_getVertexOpacityAndColor(a,l=null){const u=(0,Ne.Uu)(this._drivenProperties.color?a.color:null,this._drivenProperties.opacity?a.opacity:null);return(0,y.pC)(l)&&(u[0]*=l,u[1]*=l,u[2]*=l,u[3]*=l),u}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return an(this.symbol,this.symbolLayer)}globalPropertyChanged(a,l,h){switch(a){case"opacity":return this.layerOpacityChanged(l,h),!0;case"elevationInfo":{const d=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(l,h,d)!==I.lO.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(l,h);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(a,l,h){let d=I.lO.UPDATE;return a.forEach(u=>{const p=l(u);(0,y.pC)(p)?(this.setGraphicElevationContext(u.graphic,p.elevationContext),p.needsElevationUpdates=h(p.elevationContext.mode)):d=I.lO.RECREATE}),d}applyRendererDiff(a,l){return Ue.Recreate_Symbol}getFastUpdateAttrValues(a){if(!this._fastUpdates.enabled)return null;const l=this._fastUpdates.visualVariables,h=l.size?Xt(l.size.field,a):0,d=l.color?Xt(l.color.field,a):0,u=l.opacity?Xt(l.opacity.field,a):0;return(0,De.f)(h,d,u,0)}get draped(){return this._draped}ensureDrapedStatus(a){return null==this._draped?(this._draped=a,!0):(a!==this.draped&&Fi.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){return{drivenProperties:this._drivenProperties,getVisVarFields:()=>({size:this._fastUpdates?.visualVariables?.size?.field??null,color:this._fastUpdates?.visualVariables?.color?.field??null,opacity:this._fastUpdates?.visualVariables?.opacity?.field??null,rotation:this._fastUpdates?.visualVariables?.rotation?.field??null})}}}function Xt(c,a){const l=null!=c?a.attributes[c]:0;return null!=l&&isFinite(l)?l:0}function on(c){const a={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return c&&"visualVariables"in c&&c.visualVariables&&c.visualVariables.forEach(l=>{switch(l.type){case"color":if(a.color=!0,l.stops)for(let h=0;h<l.stops.length;h++){const d=l.stops[h].color;d&&(a.opacity=!0,d.a<1&&(a.opacityAlwaysOpaque=!1))}break;case"opacity":a.opacity=!0,a.opacityAlwaysOpaque=!1;break;case"size":a.size=!0}}),a}const jl={mode:"on-the-ground",offset:0,unit:"meters"},Wl={mode:"absolute-height",offset:0,unit:"meters"},ln={hasIntrinsicColor:!1};var cn=S(25748),Ci=S(97272);function zs(c,a,l,h,d,u){const p=c.clippingExtent;if((0,Se.KC)(a,li,c.elevationProvider.spatialReference),(0,y.pC)(p)&&!(0,V.BD)(p,li))return null;(0,Se.KC)(a,li,c.renderCoordsHelper.spatialReference);const g=c.localOriginFactory.getOrigin(li),_=new Ci.T({castShadow:!1,metadata:{layerUid:c.layer.uid,graphicUid:d,usesVerticalDistanceToGround:!0}});return l.shaderTransformer=u,l.localOrigin=g,_.addGeometry(l),{object:_,sampledElevation:(0,I.bD)(_,a,c.elevationProvider,c.renderCoordsHelper,h)}}function ar(c,a,l){const h=c.elevationContext,d=l.spatialReference;(0,Se.KC)(a,li,d),h.centerPointInElevationSR=(0,Q.Tx)(li[0],li[1],a.hasZ?li[2]:0,(0,y.pC)(d)?d:null)}function nr(c){switch(c.type){case"point":return c;case"polygon":case"extent":return(0,Ne.zE)(c);case"polyline":{const a=c.paths[0];if(!a||0===a.length)return null;const l=(0,cn.n8)(a,(0,cn.ok)(a)/2);return(0,Q.Tx)(l[0],l[1],l[2],c.spatialReference)}case"mesh":return c.origin}return null}const li=(0,G.c)();var Oe=S(94255),xi=S(24425),Bi=S(9545),Ni=S(19625),pe=S(13934),Mr=S(3090),Vs=S(60881),Pi=S(40723),je=S(5894),ji=S(42037),ci=S(59617),Ur=S(651),Gr=S(91056),zr=S(39114),Vr=S(12407),Hl=S(76269),Et=S(67969),$e=S(2078);class Fr extends Gr.A{initializeConfiguration(a,l){l.spherical=a.viewingMode===ci.JY.Global}initializeProgram(a){return new Vr.$(a.rctx,Fr.shader.get().build(this.configuration),zr.i)}setPipelineState(a){const l=a?Et.wb.ALWAYS:Et.wb.LESS;return(0,$e.sm)(this.configuration.depthHudEnabled?{depthTest:{func:l},depthWrite:$e.LZ}:{blending:(0,$e.wK)(Et.zi.ONE,Et.zi.SRC_ALPHA,Et.zi.ONE_MINUS_SRC_ALPHA,Et.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:l},colorWrite:$e.BK})}initializePipeline(){return this.setPipelineState(this.configuration.hasMultipassGeometry)}}Fr.shader=new Ur.J(Hl.L,()=>S.e(3807).then(S.bind(S,43807)));var me=S(87601),Fs=S(41528);class At extends Fs.W{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=Mr.d.World,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.hasMultipassGeometry=!1}}(0,P._)([(0,me.o)({count:Mr.d.COUNT})],At.prototype,"screenCenterOffsetUnitsEnabled",void 0),(0,P._)([(0,me.o)()],At.prototype,"spherical",void 0),(0,P._)([(0,me.o)()],At.prototype,"occlusionTestEnabled",void 0),(0,P._)([(0,me.o)()],At.prototype,"hasVerticalOffset",void 0),(0,P._)([(0,me.o)()],At.prototype,"hasScreenSizePerspective",void 0),(0,P._)([(0,me.o)()],At.prototype,"depthHudEnabled",void 0),(0,P._)([(0,me.o)()],At.prototype,"depthHudAlignStartEnabled",void 0),(0,P._)([(0,me.o)()],At.prototype,"hasSlicePlane",void 0),(0,P._)([(0,me.o)()],At.prototype,"hasMultipassGeometry",void 0),(0,P._)([(0,me.o)({constValue:!0})],At.prototype,"hasSliceInVertexProgram",void 0),(0,P._)([(0,me.o)({constValue:!1})],At.prototype,"isDraped",void 0);class Ei extends Pi.F5{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(a){super(a,new hn),this._configuration=new At,this._uniqueMaterialIdentifier=Ei.uniqueMaterialIdentifier(this.parameters)}getPassParameters(){return this.parameters}getConfiguration(a,l){const h=l?.slot!==je.r.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=(0,y.pC)(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=(0,y.pC)(this.parameters.screenSizePerspective),this._configuration.depthHudEnabled=h,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled="screen"===this.parameters.centerOffsetUnits?Mr.d.Screen:Mr.d.World,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasMultipassGeometry=l.multipassGeometry.enabled,this._configuration}intersect(){}requiresSlot(a,l){if(l===pe.H.Color)switch(a){case je.r.LINE_CALLOUTS:case je.r.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(a){return new Zl(a)}createBufferWriter(){return new $l}validateParameters(a){const l=Ei.uniqueMaterialIdentifier(a);l!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=l)}static uniqueMaterialIdentifier(a){return JSON.stringify({screenOffset:a.screenOffset||[0,0],centerOffsetUnits:a.centerOffsetUnits||"world"})}}class Zl extends Vs.Z{beginSlot(a){return this.ensureTechnique(Fr,a)}}class hn extends Pi.Mt{constructor(){super(...arguments),this.screenOffset=oe.Z,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const Yl=(0,Ni.U$)().vec3f(T.T.POSITION).vec3f(T.T.NORMAL).vec2f(T.T.UV0).vec4f(T.T.AUXPOS1),dn=[(0,Bi.f)(0,0),(0,Bi.f)(1,0),(0,Bi.f)(0,1),(0,Bi.f)(1,0),(0,Bi.f)(1,1),(0,Bi.f)(0,1)];class $l{constructor(){this.vertexBufferLayout=Yl}allocate(a){return this.vertexBufferLayout.createBuffer(a)}elementCount(a){return 6*a.indices.get(T.T.POSITION).length}write(a,l,h,d,u){(0,ji.ho)(h.indices.get(T.T.POSITION),h.vertexAttributes.get(T.T.POSITION).data,a,d.position,u,6),(0,ji.s5)(h.indices.get(T.T.NORMAL),h.vertexAttributes.get(T.T.NORMAL).data,l,d.normal,u,6),(0,ji.SW)(h.indices.get(T.T.AUXPOS1),h.vertexAttributes.get(T.T.AUXPOS1).data,d.auxpos1,u,6);for(let p=0;p<dn.length;++p)d.uv0.setVec(u+p,dn[p])}}class Br extends Bt{constructor(a,l){super(a,null,l,Xl),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}doLoad(){var a=this;return(0,B.Z)(function*(){a._material=new Ei(a._materialParameters),a._context.stage.add(a._material)})()}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(a){const l=this._materialParameters;return l.screenOffset=a.screenOffset||oe.Z,l.centerOffsetUnits=a.centerOffsetUnits||"world",l}get _materialParameters(){const a=new hn,l=this.symbol,h=l.callout;if(a.color=(0,y.pC)(h.color)?K.Z.toUnitRGBA(h.color):[0,0,0,0],a.color[3]*=this._getLayerOpacity(),a.size=(0,Qe.F2)(h.size||0),l.verticalOffset){const{screenLength:p,minWorldLength:g,maxWorldLength:_}=l.verticalOffset;a.verticalOffset={screenLength:(0,Qe.F2)(p),minWorldLength:g||0,maxWorldLength:(0,y.pC)(_)?_:1/0}}a.borderColor=(0,y.pC)(h.border)&&(0,y.pC)(h.border.color)?K.Z.toUnitRGBA(h.border.color):null;const d="object"===l.symbolLayers.getItemAt(0).type,u="label-3d"===l.type;return a.occlusionTest=!d,a.shaderPolygonOffset=d?0:void 0,a.depthHUDAlignStart=u,a.hasSlicePlane=this._context.slicePlaneEnabled,a.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,a}_defaultElevationInfoNoZ(){return kl}createGraphics3DGraphic(a){const l=a.renderingInfo,h=a.graphic,d=this.setGraphicElevationContext(h,new q.o,l.elevationOffset||0),u=l.symbol,p="on-the-ground"===this._elevationContext.mode&&("cim"===u.type||!u.symbolLayers.some(_=>"object"===_.type||"text"===_.type));if("label-3d"!==u.type&&p||"point-3d"===u.type&&u.symbolLayers.every(_=>"text"===_.type&&!(0,Ir.as)(_)))return null;const g=(0,Ne.zE)(h.geometry);return(0,y.Wi)(g)?null:this._createAs3DShape(g,d,l,h.uid)}layerOpacityChanged(){(0,y.pC)(this._material)&&this._material.setParameters(this._materialParameters)}layerElevationInfoChanged(a,l,h){const u=(0,I.GC)(Br.elevationModeChangeTypes,h,this._elevationContext.mode);return u!==I.lO.UPDATE||a.forEach(p=>{const g=l(p);(0,y.pC)(g)&&this.updateGraphicElevationContext(p.graphic,g)}),u}slicePlaneEnabledChanged(){return(0,y.Wi)(this._material)||this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}setGraphicElevationContext(a,l,h=0){const d=super.setGraphicElevationContext(a,l);return d.addOffsetRenderUnits(h),d}updateGraphicElevationContext(a,l){this.setGraphicElevationContext(a,l.elevationContext,(0,y.pC)(l.metadata)?l.metadata.elevationOffset:0),l.needsElevationUpdates=(0,I.Xf)(l.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:Us.memory}}_createVertexData(a){const{translation:l,centerOffset:h}=a,d=new Oe.a(l?[l[0],l[1],l[2]]:[0,0,0],3,!0),u=new Oe.a(h?[h[0],h[1],h[2],h[3]]:[0,0,0,1],4,!0);return[[T.T.POSITION,d],[T.T.NORMAL,new Oe.a([0,0,1],3,!0)],[T.T.AUXPOS1,u]]}_getOrCreateMaterial(a){const l=this._perInstanceMaterialParameters(a),h=Ei.uniqueMaterialIdentifier(l);if((0,y.pC)(this._material)&&h===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if((0,y.pC)(a.materialCollection)){let d=a.materialCollection.get(h);return(0,y.Wi)(d)&&(d=new Ei(l),a.materialCollection.add(h,d)),{material:d,isUnique:!1}}return{material:new Ei(l),isUnique:!0}}_createAs3DShape(a,l,h,d){const p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:d,layerUid:this._context.layer.uid}),g=this._getOrCreateMaterial(h),_=new ni.Z(g.material,this._createVertexData(h),Kl,null,xi.U.Point,p),v=zs(this._context,a,_,l,d);if((0,y.Wi)(v))return null;const b=new Ft(this,v.object,[_],g.isUnique?[g.material]:null,null,sr,l);return b.metadata=new Ka(h.elevationOffset),b.alignedSampledElevation=v.sampledElevation,b.needsElevationUpdates=(0,I.Xf)(l.mode),ar(b,a,this._context.elevationProvider),b}}Br.elevationModeChangeTypes={definedChanged:I.lO.UPDATE,staysOnTheGround:I.lO.UPDATE,onTheGroundChanged:I.lO.RECREATE};const Bs=[0],Kl=[[T.T.POSITION,Bs],[T.T.NORMAL,Bs],[T.T.AUXPOS1,Bs]],kl={mode:"relative-to-ground",offset:0},Xl={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};class Jl{constructor(a,l,h=(0,G.c)(),d=(0,De.c)(),u=(0,oe.a)(),p="world",g=0,_=null){this.renderer=a,this.symbol=l,this.translation=h,this.centerOffset=d,this.screenOffset=u,this.centerOffsetUnits=p,this.elevationOffset=g,this.materialCollection=_}}const un=bi.Z.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory"),ql={line:Br};var ec=S(27306),tc=S(27899),Ee=S(67831),Ns=S(37118),ic=S(82054);const pn=new tc.Z(Array,c=>(0,V.t8)(c,V.xE),null,10,5),rc=(0,ze.Ue)();class sc{get labelLayers(){return this._labelLayers}get extent(){return this._extent}constructor(a,l,h,d,u){this.graphic=a,this.graphics3DSymbol=l,this.layers=h,this._labelLayers=new Array,this._auxiliaryLayers=new Array,this._visibilityFlags=function ac(c,a){const l=new Array(c);for(let h=0;h<l.length;h++)l[h]=new Array(a);return l}(at._COUNT,xt._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++l.referenced,this._featureExpressionFeature=u?(0,de.Tz)(u,a,d):null;for(const p of h)(0,y.pC)(p)&&(this.isElevationSource=this.isElevationSource||p.isElevationSource)}initialize(a,l){this._layer=l,this._stage=a,this._forEachSymbolLayerGraphic(h=>{h.initialize(a,l),h.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(a=>a.destroy()),this.layers=null,this._auxiliaryLayers=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic(a=>a.destroy()),this._labelLayers.length=0}addLabelGraphic(a,l,h){this._labelLayers.push(a),a.initialize(l,h),a.setVisibility(this.isVisible(at.LABEL))}addAuxiliaryGraphic(a){this._auxiliaryLayers.push(a),this._layer&&(a.initialize(this._stage,this._layer),a.setVisibility(this.isVisible()))}get isDraped(){let a=!1;return this._forEachSymbolLayerGraphic(l=>{"draped"===l.type&&(a=!0)}),a}isVisible(a=at.GRAPHIC,l){for(let h=0;h<=a;h++){const d=this._visibilityFlags[h];for(let u=0;u<d.length;++u)if(!1===d[u]&&u!==l)return!1}return!0}hasVisibilityFlag(a,l){return null!=this._visibilityFlags[l][a]}setVisibilityFlag(a,l,h){const d=this.isVisible(h);this._visibilityFlags[h][a]=l;const u=this.isVisible(h);if(d===u)return!1;if(h===at.LABEL)this._forEachLabelGraphic(p=>p.setVisibility(u));else{this._forEachSymbolLayerGraphic(g=>g.setVisibility(u));const p=this.isVisible(at.LABEL);this._forEachLabelGraphic(g=>g.setVisibility(p))}return!0}clearVisibilityFlag(a,l=at.GRAPHIC){return this.setVisibilityFlag(a,void 0,l)}computeExtent(a){if(!this._extent){const l=this.graphic.geometry;if((0,y.Wi)(l))return!1;this._extent=(0,ze.Ue)(),(0,Q.TF)(l,this._extent);const h=l.spatialReference;if(!(0,Va.fS)(h,a)&&!(0,Se.dH)(this._extent,h,this._extent,a))return this._extent=null,!1}return!0}getAsOptimizedGeometry(a,l){return(0,y.pC)(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===a&&this._optimizedGeometry.hasM===l||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,a,l),this._optimizedGeometry.hasZ=a,this._optimizedGeometry.hasM=l),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(a,l,h){let d=a.geometry;return"mesh"!==d.type&&"extent"!==d.type||(d=Ns.Z.fromExtent("mesh"===d.type?d.extent:d)),(0,ic.GH)(d,l,h)}get usedMemory(){let a=(0,ec.f2)(this.graphic.attributes);return this._forEachSymbolLayerGraphic(l=>{const h=l.graphics3DSymbolLayer.complexity;if((0,y.Wi)(h))return;const d="draped"===l.type?h.memory.draped:h.memory;a+=d.bytesPerFeature,d.bytesPerCoordinate&&(a+=(0,Q.R3)(this.graphic.geometry)*d.bytesPerCoordinate)}),a}computeAttachmentOrigin(){const a={render:{origin:(0,G.c)(),num:0},draped:{origin:(0,oe.a)(),num:0}};for(const l of this.layers)(0,y.Wi)(l)||l.computeAttachmentOrigin(a);return a.render.num>1&&(0,E.g)(a.render.origin,a.render.origin,1/a.render.num),a.draped.num>1&&(0,Ee.b)(a.draped.origin,a.draped.origin,1/a.draped.num),a}getProjectedBoundingBox(a,l,h,d,u){var p=this;return(0,B.Z)(function*(){return u||(u={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),u.boundingBox?(0,V.cS)(u.boundingBox):u.boundingBox=(0,V.cS)(),u.requiresDrapedElevation=!1,yield(0,Lr.Ed)(p.layers,function(){var g=(0,B.Z)(function*(_){if((0,y.Wi)(_))return;const v="draped"===_.type?l:a,b=pn.acquire(),C=yield _.getProjectedBoundingBox(v,h,u.screenSpaceObjects,d,b);isFinite(C[2])&&isFinite(C[5])||(u.requiresDrapedElevation=!0),C&&(0,V.TC)(u.boundingBox,b),pn.release(b)});return function(_){return g.apply(this,arguments)}}()),(0,V.sU)(u.boundingBox)||(0,ze.sU)((0,V.y8)(u.boundingBox,rc))?u:null})()}needsElevationUpdates(){for(const a of this.layers)if((0,y.pC)(a)&&("object3d"===a.type||"lod-instance"===a.type)&&a.needsElevationUpdates)return!0;for(const a of this._labelLayers)if(a&&a.needsElevationUpdates)return!0;return!1}alignWithElevation(a,l,h){this._forEachRenderedGraphic(d=>{"object3d"!==d.type&&"lod-instance"!==d.type||d.alignWithElevation(a,l,this._featureExpressionFeature,h)})}alignWithAbsoluteElevation(a,l,h){this._forEachRenderedGraphic(d=>{"object3d"===d.type&&d.alignWithAbsoluteElevation(a,l,h)})}addObjectStateSet(a,l){this._forEachSymbolLayerGraphic(h=>h.addObjectState(a,l))}removeObjectState(a){this._forEachSymbolLayerGraphic(l=>l.removeObjectState(a))}_forEachGraphicList(a,l){a.forEach(h=>h&&l(h))}_forEachSymbolLayerGraphic(a){this._forEachGraphicList(this.layers,a),this._forEachGraphicList(this._auxiliaryLayers,a)}_forEachLabelGraphic(a){this._forEachGraphicList(this._labelLayers,a)}_forEachRenderedGraphic(a){this._forEachSymbolLayerGraphic(a),this._forEachLabelGraphic(a)}}var js=S(58817),Ws=S(16730),or=S(11915),Oi=S(30217),Nr=S(550),Ie=S(60479),lr=S(79800),Hs=S(82141),Zs=S(2004);function gn(c){const a=[[T.T.POSITION,c.indices]],l=[[T.T.POSITION,new Oe.a(c.attributeData.position,3,!0)]];return(0,y.pC)(c.attributeData.color)&&(l.push([T.T.COLOR,new Oe.a(c.attributeData.color,4,!0)]),a.push([T.T.COLOR,new Array(c.indices.length).fill(0)])),(0,y.pC)(c.attributeData.uvMapSpace)&&(l.push([T.T.UVMAPSPACE,new Oe.a(c.attributeData.uvMapSpace,4,!0)]),a.push([T.T.UVMAPSPACE,c.indices])),(0,y.pC)(c.attributeData.boundingRect)&&(l.push([T.T.BOUNDINGRECT,new Oe.a(c.attributeData.boundingRect,9,!0)]),a.push([T.T.BOUNDINGRECT,c.indices])),new ni.Z(c.material,l,a,c.mapPositions,xi.U.Mesh,c.attributeData.objectAndLayerIdColor)}function mn(c){const a=[[T.T.POSITION,c.indices],[T.T.UV0,c.indices]],l=[[T.T.POSITION,new Oe.a(c.attributeData.position,3,!0)],[T.T.UV0,new Oe.a(c.attributeData.uv0,2,!0)]];return new ni.Z(c.material,l,a,c.mapPositions)}function cr(c){switch(c.type){case"extent":if(c instanceof Zs.Z)return Ns.Z.fromExtent(c);break;case"polygon":return c}return null}class jr{constructor(a,l,h){this.renderData=a,this.layerUid=l,this.graphicUid=h,this.outGeometries=new Array}}var Wr=S(85334),yn=S(46021),tt=S(6040);function Ys(c,a,l,h){const d=(0,Wr.Mk)(c.rings,!!c.hasZ,Wr.ZI.CCW_IS_HOLE),u=(0,tt.bg)(d.position.length),p=(0,I.rR)(d.position,c.spatialReference,0,u,0,d.position,0,d.position.length/3,a,l,h),g=null!=p;return new lc(d.position,u,vn(d.polygons,d.position,u),_n(d.outlines,d.position,u),g,p)}function fn(c,a){const l=(0,Wr.Mk)(c.rings,!1,Wr.ZI.CCW_IS_HOLE),h=(0,Se.CM)(l.position,c.spatialReference,0,l.position,a,0,l.position.length/3);for(let d=2;d<l.position.length;d+=3)l.position[d]=yn.Rn;return{position:l.position,polygons:vn(l.polygons,l.position),outlines:_n(l.outlines,l.position),projectionSuccess:h}}function _n(c,a,l=null){return c.filter(({count:h})=>h>1).map(({index:h,count:d})=>{const u=3*h,p=3*d;return(0,y.pC)(l)?new bn(h,d,(0,tt.Rq)(a,u,p),(0,tt.Rq)(l,u,p)):new $s(h,d,(0,tt.Rq)(a,u,p))})}function vn(c,a,l=null){const h=((0,y.pC)(l),new Array);for(const{index:d,count:u,holeIndices:p,pathLengths:g}of c){if(u<=1)continue;const _=3*d,v=3*u,b=p.map(x=>x-d),C=(0,y.pC)(l)?new nc(d,u,(0,tt.Rq)(a,3*d,3*u),(0,tt.Rq)(l,_,v),b,g):new oc(d,u,(0,tt.Rq)(a,3*d,3*u),b,g);h.push(C)}return h}class $s{constructor(a,l,h){this.index=a,this.count=l,this.position=h}}class bn extends $s{constructor(a,l,h,d){super(a,l,h),this.mapPositions=d}}class nc extends bn{constructor(a,l,h,d,u,p){super(a,l,h,d),this.holeIndices=u,this.pathLengths=p}}class oc extends $s{constructor(a,l,h,d,u){super(a,l,h),this.holeIndices=d,this.pathLengths=u}}class lc{constructor(a,l,h,d,u,p){this.position=a,this.mapPositions=l,this.polygons=h,this.outlines=d,this.projectionSuccess=u,this.sampledElevation=p}}var hr=S(28523);const cc=["polygon","extent"];function Sn(c,a,l,h,d,u){const p=new Array(a.length).fill(0),g=[[T.T.POSITION,new Oe.a(h.positions,3,!0)],[T.T.NORMAL,new Oe.a(h.normals,3,!0)],[T.T.COLOR,new Oe.a(d,4,!0)],[T.T.SIZE,new Oe.a(h.heights,1,!0)]];return new ni.Z(c,g,[[T.T.POSITION,a],[T.T.NORMAL,a],[T.T.COLOR,p]],h.elevation,xi.U.Mesh,u,l)}function dc(c,a,l,h,d,u,p,g,_,v,b,C,x){let O=0,M=2*h.count;!function uc(c,a,l,h,d,u,p,g,_,v,b,C,x,R,O,M,F){(0,E.c)(gt,M);const H=O>0?1:-1;let N=3*l,te=0,ee=3*te,le=h,fe=3*le;for(let ge=0;ge<h;++ge)F&&(gt[0]=c[N+0],gt[1]=c[N+1],gt[2]=c[N+2],(0,E.n)(gt,gt)),g[ee+0]=c[N+0],g[ee+1]=c[N+1],g[ee+2]=c[N+2],_[ee+0]=a[N+0],_[ee+1]=a[N+1],_[ee+2]=a[N+2],v[ee+0]=-H*gt[0],v[ee+1]=-H*gt[1],v[ee+2]=-H*gt[2],b[te]=0,g[fe+0]=c[N+0]+O*gt[0],g[fe+1]=c[N+1]+O*gt[1],g[fe+2]=c[N+2]+O*gt[2],_[fe+0]=a[N+0],_[fe+1]=a[N+1],_[fe+2]=a[N+2],v[fe+0]=H*gt[0],v[fe+1]=H*gt[1],v[fe+2]=H*gt[2],b[le]=O,ee+=3,fe+=3,N+=3,te+=1,le+=1;N=3*u,ee=0,fe=3*R;const Ce=O<0?Tn:Rn,ie=O<0?Rn:Tn;for(let ge=0;ge<p;++ge)x[ee+0]=d[N+Ce[0]],x[ee+1]=d[N+Ce[1]],x[ee+2]=d[N+Ce[2]],C[fe+0]=d[N+ie[0]]+h,C[fe+1]=d[N+ie[1]]+h,C[fe+2]=d[N+ie[2]]+h,ee+=3,fe+=3,N+=3}(c,a,h.index,h.count,l,0,l.length/3,d,u,p,g,_,v,M,b,C,x);let F=2*h.count;M=0,Cn(d,u,g,p,O,h.pathLengths[0],h.count,F,_,M,b),F+=4*h.pathLengths[0],M+=2*h.pathLengths[0],O+=h.pathLengths[0];for(let H=1;H<h.pathLengths.length;++H)Cn(d,u,g,p,O,h.pathLengths[H],h.count,F,_,M,b),F+=4*h.pathLengths[H],M+=2*h.pathLengths[H],O+=h.pathLengths[H]}function Hr(c,a,l,h,d,u,p){h[u]=h[p],c[0+(u*=3)]=c[0+(p*=3)],c[u+1]=c[p+1],c[u+2]=c[p+2],a[u+0]=a[p+0],a[u+1]=a[p+1],a[u+2]=a[p+2],l[u+0]=d[0],l[u+1]=d[1],l[u+2]=d[2]}const dr=(0,G.c)();function Cn(c,a,l,h,d,u,p,g,_,v,b){let C=d,x=d+1,R=d+p,O=d+p+1,M=g,F=g+1,H=g+2*u,N=g+2*u+1;b<0&&(C=d+p+1,O=d),v*=3;for(let te=0;te<u;++te)te===u-1&&(b>0?(x=d,O=d+p):(x=d,C=d+p)),pc(c,C,x,R,dr),Hr(c,a,h,l,dr,M,C),Hr(c,a,h,l,dr,F,x),Hr(c,a,h,l,dr,H,R),Hr(c,a,h,l,dr,N,O),_[v++]=M,_[v++]=H,_[v++]=N,_[v++]=M,_[v++]=N,_[v++]=F,C++,x++,R++,O++,M+=2,F+=2,H+=2,N+=2}const Ks=(0,G.c)(),xn=(0,G.c)(),Pn=(0,G.c)(),En=(0,G.c)(),On=(0,G.c)();function pc(c,a,l,h,d){a*=3,l*=3,h*=3,(0,E.s)(Ks,c[a++],c[a++],c[a++]),(0,E.s)(xn,c[l++],c[l++],c[l++]),(0,E.s)(Pn,c[h++],c[h++],c[h++]),(0,E.b)(En,xn,Ks),(0,E.b)(On,Pn,Ks),(0,E.f)(d,On,En),(0,E.n)(d,d)}const Wi=(0,G.c)();function gc(c,a,l,h,d){const u=c.stageObject,p=u.geometries,g=p.length,_="absolute-height"!==a.mode;let v=0;const b=u.transformation,C=(0,Be.p)((0,we.c)(),b);for(let x=0;x<g;x+=2){const R=p[x];if(!Rs(R))continue;const O=R.getMutableAttribute(T.T.POSITION).data,M=R.vertexAttributes.get(T.T.SIZE).data,F=new Wa.sb(R.mapPositions),H=O.length/3;let N=0,te=!1,ee=0;for(let le=0;le<H;le++){Wi[0]=O[N],Wi[1]=O[N+1],Wi[2]=O[N+2],h(F,Zr),_&&(ee+=Zr.sampledElevation),ht.Z.TESTS_DISABLE_OPTIMIZATIONS?((0,E.s)(_t,F.array[F.offset+0],F.array[F.offset+1],Zr.z+M[N/3]),(0,y.pC)(l)&&d.toRenderCoords(_t,l,_t),(0,E.m)(_t,_t,C)):((0,E.s)(_t,O[N+0],O[N+1],O[N+2]),(0,E.m)(_t,_t,b),d.setAltitude(_t,Zr.z+M[N/3]),(0,E.m)(_t,_t,C)),O[N]=_t[0],O[N+1]=_t[1],O[N+2]=_t[2];const fe=mc/d.unitInMeters;(Math.abs(Wi[0]-O[N])>=fe||Math.abs(Wi[1]-O[N+1])>=fe||Math.abs(Wi[2]-O[N+2])>=fe)&&(te=!0),F.offset+=3,N+=3}te&&(R.invalidateBoundingInfo(),u.geometryVertexAttrsUpdated(p[x]),p[x+1].invalidateBoundingInfo(),u.geometryVertexAttrsUpdated(p[x+1])),v+=ee/H}return v/g}const _t=(0,G.c)(),gt=(0,G.c)(),Zr=new I.Lm,Rn=[0,2,1],Tn=[0,1,2],mc=.01;class yc{constructor(a,l,h,d){this.positions=a,this.elevation=l,this.normals=h,this.heights=d}}var fc=S(21726),Hi=S(993),_c=S(33215),vc=S(86606),bc=S(39236),ur=S(54840);class Yr{constructor(a,l,h,d){this.graphics3DSymbolLayer=a,this.renderGeometries=l,this.boundingBox=h,this._drapeSourceRenderer=d,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(a){this.stage=a}setVisibility(a){if(null!=this.stage&&this._visible!==a){if(this._visible=a,a&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,ur.T.ADD);if(a||this._addedToStage){for(const l of this.renderGeometries)l.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,ur.$.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,ur.T.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(a=(0,G.c)()){return(0,E.s)(a,0,0,0)}getBoundingBoxObjectSpace(a=(0,V.Ue)()){return(0,V.cS)(a)}addObjectState(a,l){a===Pe.V_.Highlight&&(this.renderGeometries.forEach(h=>{const d=h.geometry.addHighlight();l.addRenderGeometry(h,d,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,ur.$.HIGHLIGHT))}removeObjectState(a){this.renderGeometries.forEach(l=>{a.removeRenderGeometry(l)})}removeRenderGeometryObjectState(a,l){a.geometry.removeHighlight(l),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,ur.$.HIGHLIGHT)}computeAttachmentOrigin(a){for(const l of this.renderGeometries)l.geometry.computeAttachmentOrigin(Zi)&&(a.draped.origin[0]+=Zi[0],a.draped.origin[1]+=Zi[1],a.draped.num++)}getProjectedBoundingBox(a,l,h,d,u){var p=this;return(0,B.Z)(function*(){(0,V.cS)(u);for(let g=0;g<p.renderGeometries.length;g++)p._getRenderGeometryProjectedBoundingRect(p.renderGeometries[g],a,An,h),(0,V.VK)(u,An);if(l){let g;(0,V.be)(u,Zi);const _=(0,Ne.Si)(u,l.service.spatialReference,l);try{g=yield l.service.queryElevation(Zi[0],Zi[1],d,_,"ground")}catch{}(0,y.pC)(g)&&(u[2]=Math.min(u[2],g),u[5]=Math.max(u[5],g))}return u})()}_getRenderGeometryProjectedBoundingRect(a,l,h,d){if(this.boundingBox)(0,V.t8)(Nt,this.boundingBox);else{const u=a.boundingSphere,p=u[3];Nt[0]=u[0]-p,Nt[1]=u[1]-p,Nt[2]=u[2]-p,Nt[3]=u[0]+p,Nt[4]=u[1]+p,Nt[5]=u[2]+p}return l(Nt,0,2),this.calculateRelativeScreenBounds&&d.push({location:(0,V.be)(Nt),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),(0,V.y8)(Nt,h)}}const An=(0,ze.Ue)(),Nt=(0,V.Ue)(),Zi=(0,G.c)();var Lt=S(21286);class Sc{constructor(a,l,h,d=2048){this.text=a,this._alignment=l,this._parameters=h,this._maxSize=d,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${a}`,this._lines=a.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._backgroundHorizontalPadding)}get displayHeight(){return Math.ceil(this._lineSpacing*(this._lines.length-1)+this._lineHeight+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}get _firstLineYOffset(){return this._backgroundTopPadding+this._haloSize}get _metrics(){if((0,y.Wi)(this._metricsCached)){const a=ks(In,$r,$r).getContext("2d");this._setFontProperties(a,this._fontSize);let l=2*this._haloSize;const h=this._parameters.definition.font;"italic"!==h.style&&"oblique"!==h.style&&"bold"!==h.weight&&"bolder"!==h.weight||(l+=.3*a.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let d,u,p=0,g=0,_=0;this._lines.forEach((O,M)=>{const F=a.measureText(O),H=F.width,N=H+l;this._textWidths.push(H),this._lineWidths.push(N),p=Math.max(p,N),g=Math.max(g,F.actualBoundingBoxAscent),_=Math.max(_,F.actualBoundingBoxDescent),0===M&&(d=F),M===this._lines.length-1&&(u=F)});const v=a.font;let b=wn.get(v);if(!b){const O=a.measureText(xc);b=new Ec(O.actualBoundingBoxAscent,O.actualBoundingBoxDescent),wn.set(v,b)}g=Math.max(g,b.actualBoundingBoxAscent),_=Math.max(_,b.actualBoundingBoxDescent),this._metricsCached=new Pc(g-(this._hasBackground?d.actualBoundingBoxAscent:g),_-(this._hasBackground?u.actualBoundingBoxDescent:_),g+_,p,g)}return this._metricsCached}get _lineSpacing(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _lineHeight(){return this._metrics.lineHeight}get _linePadding(){return this._lineHeight*Cc}get _baselinePosition(){return this._metrics.baselinePosition}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _backgroundHorizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _backgroundVerticalPadding(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}get _backgroundTopPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingTop)}get _backgroundBottomPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingBottom)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if((0,y.Wi)(this._renderPixelRatio)){const a=this._parameters.definition.pixelRatio;this._renderPixelRatio=this._maxSize>0?Math.min(a,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):a}return this._renderPixelRatio}_getLineXOffset(a){switch(this._alignment){case hi.Left:return this._backgroundHorizontalPadding;case hi.Center:return(this.displayWidth-this._lineWidths[a])/2;case hi.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[a]}}render(a,l=0,h=0){a.save();const d=l/=this.renderPixelRatio,u=h/=this.renderPixelRatio,p=this._haloSize,g=this._firstLineYOffset;l+=p,h+=g+this._baselinePosition;const _=this._haloSize>0;_&&this._renderHalo(a,d,u,p,g),this._setFontProperties(a,this._renderedFontSize);for(let v=0;v<this._lines.length;++v){const b=this._lines[v],C=this._getLineXOffset(v);_&&(a.globalCompositeOperation="destination-out",a.fillStyle="rgb(0, 0, 0)",this._fillText(a,b,l+C,h),this._renderLineDecoration(a,l+C,h,this._textWidths[v])),a.globalCompositeOperation="source-over",a.fillStyle=this._parameters.textStyle,this._fillText(a,b,l+this._getLineXOffset(v),h),this._renderLineDecoration(a,l+C,h,this._textWidths[v]),h+=this._lineSpacing}if(ht.Z.TEXT_SHOW_BASELINE){a.strokeStyle=Dn,a.setLineDash([2,2]),a.lineWidth=1;let v=u+g;for(let b=0;b<this._lines.length;++b){const C=v+this._baselinePosition;this._drawLine(a,[d,C],[d+this.displayWidth,C]),v+=this._lineSpacing}}ht.Z.TEXT_SHOW_BORDER&&(a.strokeStyle=Dn,a.setLineDash([]),a.lineWidth=1,this._drawBox(a,[d,u],[this.displayWidth,this.displayHeight])),this._hasBackground&&(this._roundedRect(a,d,u,this._parameters.definition.background.borderRadius*this.renderPixelRatio),a.globalCompositeOperation="destination-over",a.fillStyle=this._parameters.backgroundStyle,a.fill()),a.restore()}_renderLineDecoration(a,l,h,d,u=!1){if("none"===this._parameters.definition.font.decoration||0===d)return;const g=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":h+=2*g;break;case"line-through":h-=.33*this._baselinePosition}const _=u?this._haloSize:0;a.strokeStyle=u?this._parameters.haloStyle:this._parameters.textStyle,a.lineWidth=this._toRenderUnit(g+2*_),a.beginPath(),a.moveTo(this._toRenderUnit(l-_),this._toRenderUnit(h)),a.lineTo(this._toRenderUnit(l+d+_),this._toRenderUnit(h)),a.stroke()}_roundedRect(a,l,h,d){l=this._toRenderUnit(l),h=this._toRenderUnit(h);const u=this.renderedWidth,p=this.renderedHeight;0!==d?(d=(0,Lt.uZ)(d,0,Math.floor(p/2)),a.beginPath(),a.moveTo(l,h+d),a.arcTo(l,h,l+d,h,d),a.lineTo(l+u-d,h),a.arcTo(l+u,h,l+u,h+d,d),a.lineTo(l+u,h+p-d),a.arcTo(l+u,h+p,l+u-d,h+p,d),a.lineTo(l+d,h+p),a.arcTo(l,h+p,l,h+p-d,d),a.closePath()):a.rect(l,h,u,p)}_renderHalo(a,l,h,d,u){const p=this.renderedWidth,g=this.renderedHeight,_=ks(In,Math.max(p,$r),Math.max(g,$r)),v=_.getContext("2d");v.clearRect(0,0,p,g),this._setFontProperties(v,this._renderedFontSize),v.fillStyle=this._parameters.haloStyle,v.strokeStyle=this._parameters.haloStyle;const b=this._renderedHaloSize<3;v.lineJoin=b?"miter":"round",b?this._renderHaloEmulated(v,d,u):this._renderHaloNative(v,d,u);let C=u+this._baselinePosition;for(let x=0;x<this._lines.length;++x){const R=this._getLineXOffset(x);this._renderLineDecoration(v,d+R,C,this._textWidths[x],!0),C+=this._lineSpacing}a.globalAlpha=this._parameters.definition.halo.color[3],a.drawImage(_,0,0,p,g,this._toRenderUnit(l),this._toRenderUnit(h),p,g),a.globalAlpha=1}_renderHaloEmulated(a,l,h){h+=this._baselinePosition;for(let d=0;d<this._lines.length;++d){const u=this._lines[d],p=this._getLineXOffset(d);for(const[g,_]of Ln)this._fillText(a,u,l+p+this._haloSize*g,h+this._haloSize*_);h+=this._lineSpacing}}_renderHaloNative(a,l,h){const d=2*this._haloSize;h+=this._baselinePosition;for(let u=0;u<this._lines.length;++u){const p=this._lines[u],g=this._getLineXOffset(u),_=5,v=.1;for(let b=0;b<_;b++)a.lineWidth=this._toRenderUnit((1-(_-1)*v+b*v)*d),this._strokeText(a,p,l+g,h);h+=this._lineSpacing}}_setFontProperties(a,l){a.font=this._parameters.fontString(l),a.textAlign="left",a.textBaseline="alphabetic"}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(a){return a*this.renderPixelRatio}_toRoundedRenderUnit(a){return Math.round(a*this.renderPixelRatio)}_fillText(a,l,h,d){a.fillText(l,this._toRenderUnit(h),this._toRenderUnit(d))}_strokeText(a,l,h,d){a.strokeText(l,this._toRenderUnit(h),this._toRenderUnit(d))}_drawLine(a,l,h){a.beginPath(),a.moveTo(this._toRoundedRenderUnit(l[0])+.5,this._toRoundedRenderUnit(l[1])+.5),a.lineTo(this._toRoundedRenderUnit(h[0])+.5,this._toRoundedRenderUnit(h[1])+.5),a.stroke()}_drawBox(a,l,h){const d=this._toRenderUnit(l[0]),u=this._toRenderUnit(l[1]),p=this._toRenderUnit(h[0]),g=this._toRenderUnit(h[1]),_=Math.floor(d)+.5,v=Math.ceil(d+p)-.5,b=Math.floor(u)+.5,C=Math.ceil(u+g)-.5;a.beginPath(),a.moveTo(_,b),a.lineTo(v,b),a.lineTo(v,C),a.lineTo(_,C),a.lineTo(_,b),a.stroke()}}const Ln=[];for(let a=0;a<360;a+=22.5)Ln.push([Math.cos(Math.PI*a/180),Math.sin(Math.PI*a/180)]);var hi;function ks(c,a,l){return c.canvas||(c.canvas=document.createElement("canvas")),c.canvas.width=a,c.canvas.height=l,c.canvas}!function(c){c[c.Left=0]="Left",c[c.Center=1]="Center",c[c.Right=2]="Right"}(hi||(hi={}));const In={canvas:null},Cc=.2,$r=512,Dn="rgb(255, 0, 255, 0.5)",xc=(()=>{let c="";for(let a=32;a<127;a++)c+=String.fromCharCode(a);return c})();class Pc{constructor(a,l,h,d,u){this.paddingTop=a,this.paddingBottom=l,this.lineHeight=h,this.displayWidth=d,this.baselinePosition=u}}class Ec{constructor(a,l){this.actualBoundingBoxAscent=a,this.actualBoundingBoxDescent=l}}const wn=new Map,Oc=Object.freeze({left:0,center:.5,right:1}),Kr=Object.freeze({"bottom-left":(0,oe.f)(0,0),bottom:(0,oe.f)(.5,0),"bottom-right":(0,oe.f)(1,0),left:(0,oe.f)(0,.5),center:(0,oe.f)(.5,.5),right:(0,oe.f)(1,.5),"top-left":(0,oe.f)(0,1),top:(0,oe.f)(.5,1),"top-right":(0,oe.f)(1,1)});var it,Un,Mn=S(21254);function pr(c){return null!=c}function Yi(c){return"number"==typeof c}function kr(c){return"string"==typeof c}function We(c,a){c&&c.push(a)}function di(c,a,l,h,d){const u=c.minSize,p=c.maxSize;if(c.expression)return We(d,"Could not convert size info: expression not supported"),!1;if(c.useSymbolValue){const g=h.symbolSize[l];return a.minSize[l]=g,a.maxSize[l]=g,a.offset[l]=a.minSize[l],a.factor[l]=0,a.type[l]=it.DefinedSize,!0}if(pr(c.field))return pr(c.stops)?2===c.stops.length&&Yi(c.stops[0].size)&&Yi(c.stops[1].size)?(Gn(c.stops[0].size,c.stops[1].size,c.stops[0].value,c.stops[1].value,a,l),a.type[l]=it.DefinedSize,!0):(We(d,"Could not convert size info: stops only supported with 2 elements"),!1):Yi(u)&&Yi(p)&&pr(c.minDataValue)&&pr(c.maxDataValue)?(Gn(u,p,c.minDataValue,c.maxDataValue,a,l),a.type[l]=it.DefinedSize,!0):null!=Mn.a[c.valueUnit]?(a.minSize[l]=-1/0,a.maxSize[l]=1/0,a.offset[l]=0,a.factor[l]=1/Mn.a[c.valueUnit],a.type[l]=it.DefinedSize,!0):"unknown"===c.valueUnit?(We(d,"Could not convert size info: proportional size not supported"),!1):(We(d,"Could not convert size info: scale-dependent size not supported"),!1);if(!pr(c.field)){if(c.stops&&c.stops[0]&&Yi(c.stops[0].size))return a.minSize[l]=c.stops[0].size,a.maxSize[l]=c.stops[0].size,a.offset[l]=a.minSize[l],a.factor[l]=0,a.type[l]=it.DefinedSize,!0;if(Yi(u))return a.minSize[l]=u,a.maxSize[l]=u,a.offset[l]=u,a.factor[l]=0,a.type[l]=it.DefinedSize,!0}return We(d,"Could not convert size info: unsupported variant of sizeInfo"),!1}function Gn(c,a,l,h,d,u){const p=Math.abs(h-l)>0?(a-c)/(h-l):0;d.minSize[u]=p>0?c:a,d.maxSize[u]=p>0?a:c,d.offset[u]=c-l*p,d.factor[u]=p}function zn(c,a,l){c[4*a+0]=l.r/255,c[4*a+1]=l.g/255,c[4*a+2]=l.b/255,c[4*a+3]=l.a}function Xs(c,a,l){const h=2===l&&"arithmetic"===c.rotationType;a.offset[l]=h?90:0,a.factor[l]=h?-1:1,a.type[l]=1}function Vn(c,a,l){if(!c)return null;const h=!a.supportedTypes||!!a.supportedTypes.size,d=!a.supportedTypes||!!a.supportedTypes.color,u=!a.supportedTypes||!!a.supportedTypes.rotation,p=!!a.supportedTypes&&!!a.supportedTypes.opacity,g=c.reduce((_,v)=>{if(!_)return _;if(v.valueExpression)return We(l,"Could not convert visual variables: arcade expressions not supported"),null;switch(v.type){case"size":return h?function Dc(c,a,l,h){if(c.normalizationField||c.valueRepresentation)return We(h,"Could not convert size info: unsupported property"),null;if(!function Lc(c){return null==c||kr(c)}(c.field))return We(h,"Could not convert size info: field is not a string"),null;if(a.size){if(c.field)if(a.size.field){if(c.field!==a.size.field)return We(h,"Could not convert size info: multiple fields in use"),null}else a.size.field=c.field}else a.size={field:c.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[it.Undefined,it.Undefined,it.Undefined]};let d;switch(c.axis){case"width":return d=di(c,a.size,0,l,h),d?a:null;case"height":return d=di(c,a.size,2,l,h),d?a:null;case"depth":return d=di(c,a.size,1,l,h),d?a:null;case"width-and-depth":return d=di(c,a.size,0,l,h),d&&di(c,a.size,1,l,h),d?a:null;case null:case void 0:case"all":return d=di(c,a.size,0,l,h),d=d&&di(c,a.size,1,l,h),d=d&&di(c,a.size,2,l,h),d?a:null;default:return We(h,`Could not convert size info: unknown axis "${c.axis}""`),null}}(v,_,a,l):_;case"color":return d?function Mc(c,a,l){if(c.normalizationField)return We(l,"Could not convert color info: unsupported property"),null;if(kr(c.field)){if(!c.stops)return We(l,"Could not convert color info: missing stops or colors"),null;{if(c.stops.length>8)return We(l,"Could not convert color info: too many color stops"),null;a.color={field:c.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const h=c.stops;for(let d=0;d<8;++d){const u=h[Math.min(d,h.length-1)];a.color.values[d]=u.value,zn(a.color.colors,d,u.color)}}}else{if(!(c.stops&&c.stops.length>=0))return We(l,"Could not convert color info: no field and no colors/stops"),null;{const h=c.stops&&c.stops.length>=0&&c.stops[0].color;a.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let d=0;d<8;d++)a.color.values[d]=1/0,zn(a.color.colors,d,h)}}return a}(v,_,l):_;case"opacity":return p?function Uc(c,a,l){if(c.normalizationField)return We(l,"Could not convert opacity info: unsupported property"),null;if(kr(c.field)){if(!c.stops)return We(l,"Could not convert opacity info: missing stops or opacities"),null;{if(c.stops.length>8)return We(l,"Could not convert opacity info: too many opacity stops"),null;a.opacity={field:c.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const h=c.stops;for(let d=0;d<8;++d){const u=h[Math.min(d,h.length-1)];a.opacity.values[d]=u.value,a.opacity.opacityValues[d]=u.opacity}}}else{if(!(c.stops&&c.stops.length>=0))return We(l,"Could not convert opacity info: no field and no opacities/stops"),null;{const h=c.stops&&c.stops.length>=0?c.stops[0].opacity:0;a.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let d=0;d<8;d++)a.opacity.values[d]=1/0,a.opacity.opacityValues[d]=h}}return a}(v,_,l):null;case"rotation":return u?function Gc(c,a,l){if(!kr(c.field))return We(l,"Could not convert rotation info: field is not a string"),null;if(a.rotation){if(c.field)if(a.rotation.field){if(c.field!==a.rotation.field)return We(l,"Could not convert rotation info: multiple fields in use"),null}else a.rotation.field=c.field}else a.rotation={field:c.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(c.axis){case"tilt":return Xs(c,a.rotation,0),a;case"roll":return Xs(c,a.rotation,1),a;case null:case void 0:case"heading":return Xs(c,a.rotation,2),a;default:return We(l,`Could not convert rotation info: unknown axis "${c.axis}""`),null}}(v,_,l):_;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(c.length>0&&g)||g.size||g.color||g.opacity||g.rotation?g&&g.size&&!function wc(c,a,l){for(let d=0;d<3;++d){let u=a.unitInMeters;c.type[d]===it.DefinedSize&&(u*=a.modelSize[d],c.type[d]=it.DefinedScale),c.minSize[d]=c.minSize[d]/u,c.maxSize[d]=c.maxSize[d]/u,c.offset[d]=c.offset[d]/u,c.factor[d]=c.factor[d]/u}let h;if(c.type[0]!==it.Undefined)h=0;else if(c.type[1]!==it.Undefined)h=1;else{if(c.type[2]===it.Undefined)return We(l,"No size axis contains a valid size or scale"),!1;h=2}for(let d=0;d<3;++d)c.type[d]===it.Undefined&&(c.minSize[d]=c.minSize[h],c.maxSize[d]=c.maxSize[h],c.offset[d]=c.offset[h],c.factor[d]=c.factor[h],c.type[d]=c.type[h]);return!0}(g.size,a,l)?null:g:null}function Js(c){return c&&null!=c.size}function gr(c,a){if(!c)return{enabled:!1};if(ht.Z.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const l=Vn(c.visualVariables,a);return l?{enabled:!0,visualVariables:l,materialParameters:Fn(l,a),requiresShaderTransformation:Js(l)}:{enabled:!1}}function mr(c,a,l){if(!a||!c.enabled)return!1;const h=c.visualVariables,d=Vn(a.visualVariables,l);return!!d&&!!(Xr(h.size,d.size,"size")&&Xr(h.color,d.color,"color")&&Xr(h.rotation,d.rotation,"rotation")&&Xr(h.opacity,d.opacity,"opacity"))&&(c.visualVariables=d,c.materialParameters=Fn(d,l),c.requiresShaderTransformation=Js(d),!0)}function Xr(c,a,l){if(!!c!=!!a||c&&c.field!==a.field)return!1;if(c&&"rotation"===l){const h=c,d=a;for(let u=0;u<3;u++)if(h.type[u]!==d.type[u]||h.offset[u]!==d.offset[u]||h.factor[u]!==d.factor[u])return!1}return!0}function Fn(c,a){const l={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},h=Js(c);return c&&c.size?(l.vvSizeEnabled=!0,l.vvSizeMinSize=c.size.minSize,l.vvSizeMaxSize=c.size.maxSize,l.vvSizeOffset=c.size.offset,l.vvSizeFactor=c.size.factor):c&&h&&(l.vvSizeValue=a.transformation.scale),c&&h&&(l.vvSymbolAnchor=a.transformation.anchor,l.vvSymbolRotationMatrix=(0,Nr.c)(),(0,Be.i)(yr),function Ic(c,a,l,h=(0,we.c)()){const d=c||0,u=a||0,p=l||0;0!==d&&(0,Be.o)(h,h,-d/180*Math.PI),0!==u&&(0,Be.r)(h,h,u/180*Math.PI),0!==p&&(0,Be.n)(h,h,p/180*Math.PI)}(a.transformation.rotation[2],a.transformation.rotation[0],a.transformation.rotation[1],yr),(0,Oi.f)(l.vvSymbolRotationMatrix,yr)),c&&c.color&&(l.vvColorEnabled=!0,l.vvColorValues=c.color.values,l.vvColorColors=c.color.colors),c&&c.opacity&&(l.vvOpacityEnabled=!0,l.vvOpacityValues=c.opacity.values,l.vvOpacityOpacities=c.opacity.opacityValues),l}function Qs(c,a,l){if(!c.vvSizeEnabled)return l;(0,Be.c)(ui,l);const h=c.vvSymbolRotationMatrix;(0,Be.s)(yr,h[0],h[1],h[2],0,h[3],h[4],h[5],0,h[6],h[7],h[8],0,0,0,0,1),(0,Be.m)(ui,ui,yr);for(let d=0;d<3;++d)Bn[d]=(0,Lt.uZ)(c.vvSizeOffset[d]+a[0]*c.vvSizeFactor[d],c.vvSizeMinSize[d],c.vvSizeMaxSize[d]);return(0,Be.k)(ui,ui,Bn),(0,Be.w)(ui,ui,c.vvSymbolAnchor),ui}(function(c){c[c.Undefined=0]="Undefined",c[c.DefinedSize=1]="DefinedSize",c[c.DefinedScale=2]="DefinedScale"})(it||(it={})),function(c){c[c.Undefined=0]="Undefined",c[c.DefinedAngle=1]="DefinedAngle"}(Un||(Un={}));const ui=(0,we.c)(),Bn=(0,G.c)(),yr=(0,we.c)();var Jr=S(8782),fr=S(64232),qs=S(9983),Qr=S(10285),Vc=S(94398);const Fc=(0,we.c)(),Nn=(0,G.f)(0,0,1),Ri=Jr.Ns,jc=[Ri/2,Ri/2,1-Ri/2,1-Ri/2],Wc=[Jr.Ph*Ri,Jr.Ph*Ri];class _r extends Bt{getCachedSize(){return{size:this._getIconSize()}}constructor(a,l,h,d){super(a,l,h,d),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}doLoad(a){var l=this;return(0,B.Z)(function*(){l._validateOrThrow();const h=l._prepareMaterialParameters(),d=l._getPrimitive();if((0,y.pC)(d))l._prepareResourcesPrimitive(h,d);else{const u=(0,vc.nf)(l.symbolLayer),p=(0,fc.sJ)(u);p&&"application/json"===p.mediaType?yield l._prepareResourcesCIM(h,JSON.parse(p.data),a):yield l._prepareResourcesHref(h,u,a)}})()}_validateOrThrow(){if(this._drivenProperties.size)return;const a=(0,Ne.bh)(this._getIconSize());if(a)throw new ne.Z("graphics3diconsymbollayer:invalid-size",a)}_getIconSize(){const a=this.symbolLayer,l=Math.round(null!=a.size?(0,Qe.F2)(a.size):16);return this._drivenProperties.size?Math.max(l,64):l}_generateTextureCIM(a){const l=this._getGraphicHash(a);let h=""===l?null:this._cimSymbolTextures.get(l);if(!h){const u=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol3D(this._cimLayers,a,"esriGeometryPoint",{scaleFactor:this._cimScaleFactorOrFunction},void 0,void 0);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",u.anchorPosition),h=new qs.x(u.imageData,{width:u.imageData.width,height:u.imageData.height,powerOfTwoResizeMode:Pe.CE.PAD}),this._cimSymbolTextures.set(l,h),this._context.stage.add(h)}return h}_computeSize(a,l){const h=a.width/a.height;return h>1?[l,Math.round(l/h)]:[Math.round(l*h),l]}_prepareMaterialParameters(){const a={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},l=this.symbol;if(function Hc(c){return c&&"point-3d"===c.type&&c.hasVisibleVerticalOffset()}(l)){const{screenLength:h,minWorldLength:d,maxWorldLength:u}=l.verticalOffset;a.verticalOffset={screenLength:(0,Qe.F2)(h),minWorldLength:d||0,maxWorldLength:(0,y.pC)(u)?u:1/0}}return this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),a.occlusionTest=!0,a.hasSlicePlane=this._context.slicePlaneEnabled,a}_prepareResourcesPrimitive(a,l){const h=this._getOutlineSize();if(ea(l)&&0===h)throw new Error("Nothing to render");if(this._outlineSize=h,a.color=this._getFillColor(),a.outlineColor=this._getOutlineColor(),a.outlineSize=this._outlineSize,(0,y.pC)(this._context.sharedResources.textures)){const u=this._context.sharedResources.textures.fromData(`${l}-icon`,()=>(0,Jr.cU)(l));this._texture=u.texture,this._releaseTexture=u,a.textureId=this._texture.id}a.textureIsSignedDistanceField=!0,a.distanceFieldBoundingBox=jc;const d=this._getIconSize();this._size=[d,d],this._symbolTextureRatio=1/Ri,this._createMaterialAndAddToStage(a,this._context.stage)}_prepareResourcesHref(a,l,h){var d=this;return(0,B.Z)(function*(){d._outlineSize=d._getOutlineSize(),a.color=d._getFillColor(),a.outlineColor=d._getOutlineColor(),a.outlineSize=d._outlineSize,a.textureIsSignedDistanceField=!1;const u=d._getIconSize(),p=u*d._context.graphicsCoreOwner.view.state.rasterPixelRatio;if((0,y.pC)(d._context.sharedResources.textures)){const g=yield(0,Lr.q6)(d._context.sharedResources.textures.fromUrl(l,p,{signal:h}));if(!1===g.ok)throw(0,j.r9)(g.error),new ne.Z("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${l})`);d._releaseTexture=g.value;const _=g.value.texture;d._size=d._computeSize(_.params,u),a.textureId=_.id}d._createMaterialAndAddToStage(a,d._context.stage)})()}_prepareResourcesCIM(a,l,h){var d=this;return(0,B.Z)(function*(){const u=new Vc.Z({data:l});if(!d._context.sharedResources.cimSymbolRasterizer){const C=(yield Promise.all([S.e(2815),S.e(3871),S.e(2236),S.e(8598)]).then(S.bind(S,57068))).CIMSymbolRasterizer;(0,j.k_)(h),d._context.sharedResources.cimSymbolRasterizer||(d._context.sharedResources.cimSymbolRasterizer=new C(d._context.renderCoordsHelper.spatialReference,!0))}const p=d._context.layer.fields?d._context.layer.fields.map(C=>C.toJSON()):null;let g,_;if(d._cimLayers=yield d._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(u,p,d._context.renderer&&"dictionary"===d._context.renderer.type?d._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:h}),d._context.renderer&&"dictionary"===d._context.renderer.type&&d._context.renderer.scaleExpression){const C=d._context.renderer;if(isNaN(C.scaleExpression)){const x=C.scaleExpression,R=yield(0,Es.Yi)(x,d._context.layer.spatialReference,p);_=(O,M,F)=>{const H=(0,bc.Z)(R,O,{$view:F},"esriGeometryPoint",M);return null!==H?H:1}}else g=Number(C.scaleExpression)}d._cimScaleFactorOrFunction=g||_||1;const v=d._context.renderer?yield d._context.renderer.getRequiredFields(d._context.layer.fieldsIndex):[];(0,j.k_)(h);const b=d._context.layer.fieldsIndex;d._cimRequiredFields=v.map(C=>b.get(C).name),d._cimMaterialParametersInfo=a,d._cimMaterialParametersInfo.color=d._getFillColor(),d._cimMaterialParametersInfo.outlineColor=[0,0,0,0],d._cimMaterialParametersInfo.outlineSize=0,d._cimMaterialParametersInfo.textureIsSignedDistanceField=!1})()}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||_c.S}_getOutlineSize(){let a=0;const l=this.symbolLayer;return(0,y.pC)(l.outline)&&null!=l.outline.size?Math.max((0,Qe.F2)(l.outline.size),0):(a=ea(this._getPrimitive())?1.5:0,Math.max(a,0))}_getOutlineColor(){const a=this._getLayerOpacity(),h=(0,y.U2)(this.symbolLayer,"outline","color");if((0,y.pC)(h)){const d=K.Z.toUnitRGB(h);return[d[0],d[1],d[2],h.a*a]}return[0,0,0,0]}_getFillColor(){if(ea(this._getPrimitive()))return hl;const a=(0,y.Wi)(this._getPrimitive()),l=(0,y.U2)(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(l,{hasIntrinsicColor:a})}_getAnchorPos(a,l){return"relative"===a?(0,oe.f)((l.x||0)+.5,.5-(l.y||0)):a in Kr?Kr[a]:Kr.center}_createMaterialAndAddToStage(a,l){if(this._fastUpdates=this._cimLayers?{enabled:!1}:gr(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(a,this._fastUpdates.materialParameters),this._cimLayers){let h=(0,y.pC)(a.textureId)?this._cimSymbolMaterials.get(a.textureId):null;return h||(h=new Qr.A(a),this._cimSymbolMaterials.set((0,y.Pt)(a.textureId,0),h),l.add(h)),h}return this._material=new Qr.A(a),l.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(a=>{a.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(a=>this._context.stage.remove(a)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(a=>this._context.stage.remove(a)),this._cimSymbolTextures.clear(),this._releaseTexture=(0,y.RY)(this._releaseTexture)}_getScaleFactor(a,l){if(this._drivenProperties.size&&a.size){for(let h=0;h<3;h++){const d=a.size[h];d&&"symbol-value"!==d&&"proportional"!==d&&(a.size[h]=(0,Qe.F2)(d))}if("symbol-value"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/l;if(isFinite(+a.size[2]))return+a.size[2]/l}return 1}createGraphics3DGraphic(a){const l=a.graphic;if(!this._validateGeometry(l.geometry))return null;let h,d=[0,0];if(this._cimLayers){if(!this._cimLayers.length)return null;const C=this._generateTextureCIM(l),x={textureId:C.id,...this._cimMaterialParametersInfo};h=this._createMaterialAndAddToStage(x,this._context.stage),d=[C.params.width,C.params.height]}else d=this._size,h=(0,y.Wg)(this._material);const u=nr(l.geometry);if((0,y.Wi)(u))return this.logger.warn(`unsupported geometry type for icon symbol: ${l.geometry.type}`),null;const p=a.renderingInfo,g=this._getVertexOpacityAndColor(p);let _=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(_=this._getScaleFactor(p,d[0]>d[1]?d[0]:d[1])),_*=this._symbolTextureRatio;const v=(0,oe.f)(d[0]*_,d[1]*_),b=this.setGraphicElevationContext(l,new q.o);return this.ensureDrapedStatus("on-the-ground"===b.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(l,u,h,g,v,a.layer.uid):this._createAs3DShape(l,u,h,g,v,b,l.uid)}layerOpacityChanged(){const a=this._getFillColor(),l=this._getOutlineColor();this._forEachMaterial(h=>{h.setParameters({color:a}),h.setParameters({outlineColor:l})})}layerElevationInfoChanged(a,l,h){const d=this._elevationContext.mode,u=(0,I.GC)(_r.elevationModeChangeTypes,h,d);if(u!==I.lO.UPDATE)return u;const p=(0,I.Xf)(d)||"absolute-height"===d;return this.updateGraphics3DGraphicElevationInfo(a,l,()=>p)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(a=>{a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}skipHighSymbolLodsChanged(){return!0}applyRendererDiff(a,l){for(const h in a.diff){if("visualVariables"!==h||!mr(this._fastUpdates,l,this._fastVisualVariableConvertOptions()))return Ue.Recreate_Symbol;(0,y.pC)(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return Ue.Fast_Update}_defaultElevationInfoNoZ(){return Zc}_createAs3DShape(a,l,h,d,u,p,g){const _=this.getFastUpdateAttrValues(a),v=_?M=>Qs(this._fastUpdates.materialParameters,_,M):void 0,C=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:g,layerUid:this._context.layer.uid}),x=(0,Pt.dV)(h,Nn,null,d,u,Yc,null,_,C),R=zs(this._context,l,x,p,g,v);if((0,y.Wi)(R))return null;const O=new Ft(this,R.object,[x],null,null,sr,p);return O.alignedSampledElevation=R.sampledElevation,O.needsElevationUpdates=(0,I.Xf)(p.mode)||"absolute-height"===p.mode,O.getScreenSize=this._createScreenSizeGetter(u,v),O.calculateRelativeScreenBounds=M=>h.calculateRelativeScreenBounds(O.getScreenSize(),1,M),ar(O,l,this._context.elevationProvider),O}_createAsOverlay(a,l,h,d,u,p){h.renderPriority=this._renderPriority;const g=(0,De.c)();(0,Se.KC)(l,g,this._context.overlaySR),g[2]=yn.Rn;const _=this._context.clippingExtent;if((0,y.pC)(_)&&!(0,V.BD)(_,g))return null;const v=this.getFastUpdateAttrValues(a),b=v?M=>Qs(this._fastUpdates.materialParameters,v,M):void 0,C=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a.uid,layerUid:this._context.layer.uid}),x=(0,Pt.dV)(h,Nn,g,d,u,null,null,v,C),R=new fr.z(x,{layerUid:p,graphicUid:a.uid,shaderTransformer:b});g[3]=0,(0,Hi.c)(R.boundingSphere,g);const O=new Yr(this,[R],null,this._context.drapeSourceRenderer);return O.getScreenSize=this._createScreenSizeGetter(u,b),O.calculateRelativeScreenBounds=M=>h.calculateRelativeScreenBounds(O.getScreenSize(),1,M),O}_createScreenSizeGetter(a,l){const h=this._outlineSize+2;if(this._fastUpdates.enabled){const d=a[0]/this._symbolTextureRatio,u=a[1]/this._symbolTextureRatio;return(p=(0,oe.a)())=>{const g=l(Fc);return p[0]=g[0]*d+h,p[1]=g[5]*u+h,p}}{const d=a[0]/this._symbolTextureRatio+h,u=a[1]/this._symbolTextureRatio+h;return(p=(0,oe.a)())=>(p[0]=d,p[1]=u,p)}}_fastVisualVariableConvertOptions(){const a=this._size[0]>this._size[1]?this._size[0]:this._size[1],l=(0,G.f)(a,a,a),h=(0,Qe.Wz)(1),d=a*h;return{modelSize:l,symbolSize:(0,G.f)(d,d,d),unitInMeters:h,transformation:{anchor:G.Z,scale:G.O,rotation:G.Z}}}_getGraphicHash(a){let l="";for(const h of this._cimRequiredFields)l+=h+a.attributes[h];return l}_forEachMaterial(a){(0,y.pC)(this._material)&&a(this._material),this._cimSymbolMaterials.forEach(a)}test(){return{...super.test(),material:this._material}}}function ea(c){return!(0,y.Wi)(c)&&("cross"===c||"x"===c)}_r.PRIMITIVE_SIZE=Wc,_r.elevationModeChangeTypes={definedChanged:I.lO.UPDATE,staysOnTheGround:I.lO.NONE,onTheGroundChanged:I.lO.RECREATE};const Zc={mode:"relative-to-ground",offset:0},Yc=(0,De.f)(0,0,0,1);var vr=S(39401);function ta(c){switch(c){case"butt":return vr.R.BUTT;case"square":return vr.R.SQUARE;case"round":return vr.R.ROUND;default:return null}}var ia=S(79020),Kc=S(81805),jn=S(27632),kc=S(33470),Xc=S(41857),nt=S(88569),ot=S(64127),Jt=S(44835),Jc=S(62718);const Wn=new Map([[T.T.POSITION,0],[T.T.UV0,2],[T.T.AUXPOS1,3],[T.T.NORMAL,4],[T.T.COLOR,5],[T.T.COLORFEATUREATTRIBUTE,5],[T.T.SIZE,6],[T.T.SIZEFEATUREATTRIBUTE,6],[T.T.OPACITYFEATUREATTRIBUTE,7]]);class qr extends Gr.A{initializeProgram(a){return new Vr.$(a.rctx,qr.shader.get().build(this.configuration),Wn)}_makePipelineState(a,l){const h=this.configuration,d=a===Jt.A.NONE;return(0,$e.sm)({blending:h.output===pe.H.Color||h.output===pe.H.Alpha?d?nt.wu:(0,nt.j7)(a):null,depthTest:{func:(0,nt.Bh)(a)},depthWrite:d?h.writeDepth?$e.LZ:null:(0,nt.K5)(a),colorWrite:$e.BK,stencilWrite:h.hasOccludees?ot.s3:null,stencilTest:h.hasOccludees?l?ot.eD:ot.RY:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=(0,$e.sm)({blending:nt.wu,depthTest:ot.zV,depthWrite:null,colorWrite:$e.BK,stencilWrite:null,stencilTest:ot.YD}),this._occluderPipelineOpaque=(0,$e.sm)({blending:nt.wu,depthTest:ot.zV,depthWrite:null,colorWrite:$e.BK,stencilWrite:ot.P7,stencilTest:ot.ii}),this._occluderPipelineMaskWrite=(0,$e.sm)({blending:null,depthTest:ot.JN,depthWrite:null,colorWrite:null,stencilWrite:ot.s3,stencilTest:ot.eD})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(a,l){return l?this._occludeePipelineState:this.configuration.occluder?a===je.r.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:a===je.r.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(a,l)}}qr.shader=new Ur.J(Jc.L,()=>S.e(2958).then(S.bind(S,62958)));var br=S(46359);class Qc extends Pi.F5{constructor(a){super(a,new eh),this._vertexAttributeLocations=Wn,this._configuration=new br.PI,this._layout=this.createLayout()}dispose(){}getConfiguration(a,l){return this._configuration.output=a,this._configuration.space=l.slot===je.r.DRAPED_MATERIAL?br.I9.Draped:this.parameters.worldSpace?br.I9.World:br.I9.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==vr.R.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.occluder=this.parameters.renderOccluded===Pi.yD.OccludeAndTransparentStencil,this._configuration.transparencyPassType=l.transparencyPassType,this._configuration.hasMultipassTerrain=l.multipassTerrain.enabled,this._configuration.cullAboveGround=l.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const a=(0,Ni.U$)().vec3f(T.T.POSITION).vec2f(T.T.UV0).vec3f(T.T.AUXPOS1);return this.parameters.worldSpace&&a.vec3f(T.T.NORMAL),a.f32(this.parameters.vvSizeEnabled?T.T.SIZEFEATUREATTRIBUTE:T.T.SIZE),this.parameters.vvColorEnabled?a.f32(T.T.COLORFEATUREATTRIBUTE):a.vec4f(T.T.COLOR),this.parameters.vvOpacityEnabled&&a.f32(T.T.OPACITYFEATUREATTRIBUTE),a}createBufferWriter(){return new th(this._layout,this.parameters)}requiresSlot(a,l){return!(l!==pe.H.Color&&l!==pe.H.Alpha&&l!==pe.H.Highlight&&l!==pe.H.Depth||a!==je.r.DRAPED_MATERIAL&&(this.parameters.renderOccluded===Pi.yD.OccludeAndTransparentStencil?a!==je.r.OPAQUE_MATERIAL&&a!==je.r.OCCLUDER_MATERIAL&&a!==je.r.TRANSPARENT_OCCLUDER_MATERIAL:l===pe.H.Color||l===pe.H.Alpha?a!==(this.parameters.writeDepth?je.r.TRANSPARENT_MATERIAL:je.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):a!==je.r.OPAQUE_MATERIAL))}createGLMaterial(a){return new qc(a)}}class qc extends kc.F{_updateParameters(a){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(qr,a)}_updateOccludeeState(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})}beginSlot(a){return this._output!==pe.H.Color&&this._output!==pe.H.Alpha||this._updateOccludeeState(a),this._updateParameters(a)}}class eh extends Xc.n{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.placement="end",this.cap=vr.R.BUTT,this.anchor=br.i5.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1}}class th{constructor(a,l){this.vertexBufferLayout=a,this._parameters=l}allocate(a){return this.vertexBufferLayout.createBuffer(a)}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(a,l,h,d,u){const p=h.vertexAttributes.get(T.T.POSITION).data,g=p.length/3;let _=[1,0,0];const v=h.vertexAttributes.get(T.T.NORMAL);this._parameters.worldSpace&&(0,y.pC)(v)&&(_=v.data);let b=1,C=0;this._parameters.vvSizeEnabled?C=h.vertexAttributes.get(T.T.SIZEFEATUREATTRIBUTE).data[0]:h.vertexAttributes.has(T.T.SIZE)&&(b=h.vertexAttributes.get(T.T.SIZE).data[0]);let x=[1,1,1,1],R=0;this._parameters.vvColorEnabled?R=h.vertexAttributes.get(T.T.COLORFEATUREATTRIBUTE).data[0]:h.vertexAttributes.has(T.T.COLOR)&&(x=h.vertexAttributes.get(T.T.COLOR).data);let O=0;this._parameters.vvOpacityEnabled&&(O=h.vertexAttributes.get(T.T.OPACITYFEATUREATTRIBUTE).data[0]);const M=new Float32Array(d.buffer);let F=u*(this.vertexBufferLayout.stride/4);const H=(le,fe,Ce,ie)=>{if(M[F++]=le[0],M[F++]=le[1],M[F++]=le[2],M[F++]=Ce[0],M[F++]=Ce[1],M[F++]=fe[0],M[F++]=fe[1],M[F++]=fe[2],this._parameters.worldSpace&&(M[F++]=_[0],M[F++]=_[1],M[F++]=_[2]),M[F++]=this._parameters.vvSizeEnabled?C:b,this._parameters.vvColorEnabled)M[F++]=R;else{const ge=Math.min(4*ie,x.length-4);M[F++]=x[ge+0],M[F++]=x[ge+1],M[F++]=x[ge+2],M[F++]=x[ge+3]}this._parameters.vvOpacityEnabled&&(M[F++]=O)};let N;var le;(le=N||(N={}))[le.ASCENDING=1]="ASCENDING",le[le.DESCENDING=-1]="DESCENDING";const te=(le,fe)=>{const Ce=(0,E.s)(ih,p[3*le],p[3*le+1],p[3*le+2]),ie=rh;let ge=le+fe;do{(0,E.s)(ie,p[3*ge],p[3*ge+1],p[3*ge+2]),ge+=fe}while((0,E.F)(Ce,ie)&&ge>=0&&ge<g);a&&((0,E.m)(Ce,Ce,a),(0,E.m)(ie,ie,a)),H(Ce,ie,[-1,-1],le),H(Ce,ie,[1,-1],le),H(Ce,ie,[1,1],le),H(Ce,ie,[-1,-1],le),H(Ce,ie,[1,1],le),H(Ce,ie,[-1,1],le)},ee=this._parameters.placement;"begin"!==ee&&"begin-end"!==ee||te(0,N.ASCENDING),"end"!==ee&&"begin-end"!==ee||te(g-1,N.DESCENDING)}}const ih=(0,G.c)(),rh=(0,G.c)();var Hn=S(54889),Sr=S(92222);const sh=["polyline","polygon","extent"];class es extends Bt{constructor(a,l,h,d){super(a,l,h,d)}doLoad(){var a=this;return(0,B.Z)(function*(){if(a._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},a._fastUpdates=a._context.renderer&&a._context.renderer.visualVariables&&a._context.renderer.visualVariables.length>0?gr(a._context.renderer,a._vvConvertOptions):{enabled:!1},!a._drivenProperties.size&&(null!=a.symbolLayer.size?a.symbolLayer.size:(0,Qe.Wz)(1))<0)throw new ne.Z("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");a._markerTexture=(0,y.pC)(a.symbolLayer.marker)&&(0,y.pC)(a._context.sharedResources.textures)?(0,Kc.uM)(a._context.sharedResources.textures,function $c(c){return"diamond"===c?"kite":c}(a.symbolLayer.marker.style)):null})()}_getMaterialParameters(a,l=!1){const h=this._getCombinedOpacityAndColor(l&&this._markerColor||this._materialColor);this._patternHidesLine&&!l&&(h[3]=0);const d={width:this._computeMaterialWidth(this.symbolLayer?.size),color:h,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:ta(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:a,stipplePattern:(0,Hn.Dp)(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...d,...this._fastUpdates.materialParameters}:d}get _materialColor(){return(0,y.yw)(this.symbolLayer.material,a=>a.color)}get _markerColor(){return(0,y.yw)(this.symbolLayer.marker,a=>a.color)}get _lineMaterial(){return(0,y.Wi)(this._lineMaterialCached)&&(this._lineMaterialCached=new Sr.U(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached)),this._lineMaterialCached}get _ringMaterial(){return(0,y.Wi)(this._ringMaterialCached)&&(this._ringMaterialCached=new Sr.U(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached)),this._ringMaterialCached}get _wireframeLineMaterial(){return(0,y.Wi)(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new Sr.U({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached)),this._wireframeLineMaterialCached}get _wireframeRingMaterial(){return(0,y.Wi)(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new Sr.U({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached)),this._wireframeRingMaterialCached}get _markerMaterial(){return(0,y.Wi)(this._markerMaterialCached)&&(0,y.pC)(this.symbolLayer.marker)&&(0,y.pC)(this._markerTexture)&&(this._markerMaterialCached=new Qc({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterialCached)),this._markerMaterialCached}destroy(){super.destroy(),this._forEachMaterial(a=>this._context.stage.remove(a)),this._lineMaterialCached=null,this._ringMaterialCached=null,this._wireframeLineMaterialCached=null,this._wireframeRingMaterialCached=null,this._markerMaterialCached=null,this._markerTexture=(0,y.RY)(this._markerTexture)}_getDrivenSize(a){return this._drivenProperties.size&&a.size?(0,Qe.F2)(function nl(c){for(let a=0;a<3;a++){const l=c[a];if("number"==typeof l)return isFinite(l)?l:0}return 0}(a.size)):1}_getSizeFeatureAttributeData(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Xt(this._fastUpdates.visualVariables.size.field,a):null}_getDrivenColor(a){const l=(0,De.f)(1,1,1,1);return this._drivenProperties.color&&a.color&&(l[0]=a.color[0],l[1]=a.color[1],l[2]=a.color[2],a.color.length>0&&(l[3]=a.color[3])),this._drivenProperties.opacity&&a.opacity&&(l[3]=a.opacity),l}_getColorFeatureAttributeData(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?Xt(this._fastUpdates.visualVariables.color.field,a):null}_getOpacityFeatureAttributeData(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?Xt(this._fastUpdates.visualVariables.opacity.field,a):null}createGraphics3DGraphic(a){const l=a.graphic;if(!this._validateGeometry(l.geometry,sh,this.symbolLayer.type))return null;const h=this.setGraphicElevationContext(l,new q.o);return this.ensureDrapedStatus("on-the-ground"===h.mode),this.draped?this._createAsOverlay(a,this._context.layer.uid):this._createAs3DShape(a,h,l.uid)}applyRendererDiff(a,l){for(const h in a.diff){if("visualVariables"!==h||!mr(this._fastUpdates,l,this._vvConvertOptions))return Ue.Recreate_Symbol;this._forEachMaterial(d=>d.setParameters(this._fastUpdates.materialParameters))}return Ue.Fast_Update}prepareSymbolLayerPatch(a){if("partial"!==a.diff.type)return;const l=a.diff.diff,h={};"complete"===l.size?.type&&(h.width=this._computeMaterialWidth(l.size.newValue),delete l.size),"complete"===l.cap?.type&&(h.cap=ta((0,y.Pt)(l.cap.newValue,"butt")),delete l.cap);const d=this._prepareMarkerPatch(a,l);this._prepareMaterialPatch(a,l,d),a.symbolLayerStatePatches.push(()=>this._forEachMaterial(u=>u.setParameters(h)))}layerOpacityChanged(){this._forEachMaterial((a,l)=>this._updateMaterialLayerOpacity(a,l))}_forEachMaterial(a){(0,y.pC)(this._lineMaterialCached)&&a(this._lineMaterialCached),(0,y.pC)(this._ringMaterialCached)&&a(this._ringMaterialCached),(0,y.pC)(this._wireframeLineMaterialCached)&&a(this._wireframeLineMaterialCached),(0,y.pC)(this._wireframeRingMaterialCached)&&a(this._wireframeRingMaterialCached),(0,y.pC)(this._markerMaterialCached)&&a(this._markerMaterialCached,!0)}_updateMaterialLayerOpacity(a,l=!1){const h=a.parameters.color,d=(0,y.U2)(this.symbolLayer,"material","color"),u=this._patternHidesLine&&!l?0:this._getCombinedOpacity(d),p=(0,De.f)(h[0],h[1],h[2],u);a.setParameters({color:p})}layerElevationInfoChanged(a,l,h){const d=this._elevationContext.mode,u=(0,I.GC)(es.elevationModeChangeTypes,h,d);if(u!==I.lO.UPDATE)return u;const p=(0,I.Xf)(d);return this.updateGraphics3DGraphicElevationInfo(a,l,()=>p)}slicePlaneEnabledChanged(){const a={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial(l=>l.setParameters(a)),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_getGeometryAsPolygonOrPolyline(a){switch(a.type){case"extent":if(a instanceof Zs.Z)return Ns.Z.fromExtent(a);break;case"polygon":case"polyline":return a}return null}_createAs3DShape(a,l,h){const u=this._getGeometryAsPolygonOrPolyline(a.graphic.geometry),p="polygon"===u.type?u.rings:u.paths,g=new Array,_=(0,V.Ue)(),v=(0,jn.V)(u,this._context.elevationProvider,this._context.renderCoordsHelper,l);this._logGeometryCreationWarnings(v,p,"polygon"===u.type?"rings":"paths","LineSymbol3DLayer");for(let R=0;R<v.lines.length;R++){const O=v.lines[R],M=O.position,F=O.mapPositions;if((0,y.pC)(this._context.clippingExtent)&&((0,V.cS)(_),(0,V.G1)(_,F),!(0,V.Zp)(_,this._context.clippingExtent)))continue;const H=this._createGeometry("polygon"===u.type?this._ringMaterial:this._lineMaterial,a,M,F,u.type,Cr.ELEVATED,h);g.push(H),ht.Z.LINE_WIREFRAMES&&g.push(H.instantiate({material:"polygon"===u.type?this._wireframeRingMaterial:this._wireframeLineMaterial})),(0,y.pC)(this._markerMaterial)&&g.push(H.instantiate({material:this._markerMaterial}))}if(0===g.length)return null;const C=new Ci.T({geometries:g,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:h}}),x=new Ft(this,C,g,null,null,Ml,l);return x.alignedSampledElevation=v.sampledElevation,x.needsElevationUpdates=(0,I.Xf)(l.mode),x}_createGeometry(a,l,h,d,u,p,g){const _="polygon"===u,v=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,b=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size,C=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:g,layerUid:this._context.layer.uid});return(0,ia.Y)(a,{overlayInfo:p===Cr.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:_,mapPositions:d,attributeData:{position:h,size:b?null:this._getDrivenSize(l.renderingInfo),color:v?null:this._getDrivenColor(l.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(l.graphic),colorFeature:this._getColorFeatureAttributeData(l.graphic),opacityFeature:this._getOpacityFeatureAttributeData(l.graphic)}},C)}_createAsOverlay(a,l){const h=a.graphic,d=this._getGeometryAsPolygonOrPolyline(h.geometry),u="polygon"===d.type?d.rings:d.paths,p="polygon"===d.type?this._ringMaterial:this._lineMaterial;p.renderPriority=this._renderPriority;const g=ht.Z.LINE_WIREFRAMES?"polygon"===d.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,_=this._markerMaterial;(0,y.pC)(g)&&(g.renderPriority=this._renderPriority-.001),(0,y.pC)(_)&&(_.renderPriority=this._renderPriority-.002);const v=new Array,b=(0,V.Ue)(),C=(0,V.cS)(),x=(0,jn.r)(d,this._context.overlaySR);this._logGeometryCreationWarnings(x,u,"polygon"===d.type?"rings":"paths","LineSymbol3DLayer");for(const O of x.lines){if((0,V.cS)(b),(0,V.G1)(b,O.position),!(0,V.Zp)(b,this._context.clippingExtent))continue;(0,V.TC)(C,b);const M=H=>{const N=this._createGeometry(H,a,O.position,void 0,d.type,Cr.DRAPED,h.uid),te=new fr.z(N,{layerUid:l,graphicUid:h.uid});return v.push(te),te};if((0,y.pC)(_)){const H=M(_),N=(0,y.Wg)(this.symbolLayer.marker).placement;"begin"!==N&&"begin-end"!==N||(0,V.G1)(b,O.position,0,1),"end"!==N&&"begin-end"!==N||(0,V.G1)(b,O.position,O.position.length-3,1),this._updateBoundingSphere(H,b)}const F=M(p);if(this._updateBoundingSphere(F,b),ht.Z.LINE_WIREFRAMES){const H=M(g);this._updateBoundingSphere(H,b)}}return new Yr(this,v,C,this._context.drapeSourceRenderer)}_updateBoundingSphere(a,l){(0,Hi.s)(a.boundingSphere,.5*(l[0]+l[3]),.5*(l[1]+l[4]),0,.5*Math.sqrt((l[3]-l[0])*(l[3]-l[0])+(l[4]-l[1])*(l[4]-l[1])))}get _patternHidesLine(){const a=this.symbolLayer.pattern;return(0,y.pC)(a)&&"style"===a.type&&"none"===a.style}_computeMaterialWidth(a){return a=(0,y.Pt)(a,(0,Qe.Wz)(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?(0,Qe.F2)(1):1:(0,Qe.F2)(a)}_prepareMaterialPatch(a,l,h){const d=l.material;if((0,y.Wi)(d))return void(h.changed&&h.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,a));if("collection"===d.type)return;const u="complete"===d.type?(0,y.yw)(d.newValue,g=>g.color):"complete"===d.diff.color?.type?d.diff.color.newValue:null,p=this._getCombinedOpacityAndColor(u);h.useMaterialColor&&this._patchMaterialColor((0,De.d)(p),this._markerMaterialCached,a),this._patternHidesLine&&(p[3]=0),this._patchMaterialColor(p,this._lineMaterialCached,a),delete l.material}_prepareMarkerPatch(a,l){const h=l.marker;if((0,y.Wi)(h)||"partial"!==h.type||(0,y.pC)(h.diff.style)||(0,y.pC)(h.diff.placement)||(0,y.pC)(h.diff.color)&&"complete"!==h.diff.color.type)return{changed:!1,useMaterialColor:(0,y.Wi)(this._markerColor)};const d=h.diff.color;if((0,y.Wi)(d))return delete l.marker,{changed:!1,useMaterialColor:(0,y.Wi)(this._markerColor)};const u=(0,y.Wg)(d.newValue);return(0,y.Wi)(u)?(delete l.marker,{changed:!0,useMaterialColor:!0}):(this._patchMaterialColor(this._getCombinedOpacityAndColor(u),this._markerMaterialCached,a),delete l.marker,{changed:!0,useMaterialColor:!1})}_patchMaterialColor(a,l,h){(0,y.Wi)(l)||h.symbolLayerStatePatches.push(()=>l.setParameters({color:a}))}}var Cr;es.elevationModeChangeTypes={definedChanged:I.lO.RECREATE,staysOnTheGround:I.lO.NONE,onTheGroundChanged:I.lO.RECREATE},function(c){c[c.DRAPED=0]="DRAPED",c[c.ELEVATED=1]="ELEVATED"}(Cr||(Cr={}));var ah=S(61751),nh=S(27530),xr=S(65231),ra=S(19574),Pr=S(98496),Zn=S(9044),vt=S(25833),ts=S(37187),Yn=S(49580);const oh=["mesh"];class sa{constructor(a,l,h){this.normals=a,this.indices=l,this.didFlipNormals=h}}const is=(0,G.c)(),qe=(0,G.c)(),$i=(0,G.c)(),Ki=(0,G.c)(),ki=(0,G.c)(),$n=(0,we.c)(),Er=(0,Nr.c)(),aa=(0,V.Ue)(),ch=[new ah.Z];var Ot;!function(c){c[c.NONE=0]="NONE",c[c.ECEF=1]="ECEF"}(Ot||(Ot={}));var rs=S(43652),hh=S(7167);class dh{constructor(a,l,h,d){this.graphics3DSymbolLayer=a,this.instanceIndex=l,this.elevationAligner=h,this.elevationContext=d,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(a){const l=this._lodRenderer.instanceData;a!==l.getVisible(this.instanceIndex)&&l.setVisible(this.instanceIndex,a)}destroy(){null!=this.instanceIndex&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(a,l,h){if(this.elevationAligner){(0,de.aO)(this.elevationContext.featureExpressionInfoContext,h);const u=this.elevationAligner(this,this.elevationContext,a.spatialReference,(p,g)=>(0,I.qZ)(p,a,this.elevationContext,l,g),l);(0,y.pC)(u)&&(this.alignedSampledElevation=u)}}getCenterObjectSpace(a=(0,G.c)()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,jt),(0,E.m)(a,this._lodRenderer.baseBoundingSphere.center,jt)}getBoundingBoxObjectSpace(a=(0,V.Ue)()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,jt);const l=this._lodRenderer.baseBoundingBox;(0,V.cS)(a);for(let h=0;h<8;++h)(0,E.s)(It,1&h?l[3]:l[0],2&h?l[4]:l[1],4&h?l[5]:l[2]),(0,E.m)(It,It,jt),(0,V.pp)(a,It);return a}computeAttachmentOrigin(a){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,jt),a.render.origin[0]+=jt[12],a.render.origin[1]+=jt[13],a.render.origin[2]+=jt[14],a.render.num++}getProjectedBoundingBox(a,l,h,d,u){var p=this;return(0,B.Z)(function*(){const g=p.getBoundingBoxObjectSpace(u),_=uh,v=(0,V.wp)(g)?1:_.length;p._lodRenderer.instanceData.getGlobalTransform(p.instanceIndex,jt);for(let C=0;C<v;C++){const x=_[C];It[0]=g[x[0]],It[1]=g[x[1]],It[2]=g[x[2]],(0,E.m)(It,It,jt),Ti[3*C+0]=It[0],Ti[3*C+1]=It[1],Ti[3*C+2]=It[2]}if(!a(Ti,0,v))return null;(0,V.cS)(g);let b=null;p.calculateRelativeScreenBounds&&(b=p.calculateRelativeScreenBounds());for(let C=0;C<3*v;C+=3){for(let x=0;x<3;x++)g[x]=Math.min(g[x],Ti[C+x]),g[x+3]=Math.max(g[x+3],Ti[C+x]);b&&h.push({location:Ti.slice(C,C+3),screenSpaceBoundingRect:b})}if(l&&((0,V.be)(g,na),"absolute-height"!==p.elevationContext.mode)){let C;const x=(0,Ne.Si)(g,l.service.spatialReference,l);try{C=yield l.service.queryElevation(na[0],na[1],d,x,"ground")}catch{}(0,y.pC)(C)&&(0,V.cv)(g,0,0,-p.alignedSampledElevation+C)}return g})()}addObjectState(a,l){if(a===Pe.V_.Highlight){const h=new hh.O(a);this._addHighlightId(h),l.addExternal(d=>{this._removeHighlightId(d)},h)}}removeObjectState(a){this._highlights.forEach(l=>a.remove(l))}_addHighlightId(a){this._highlights.add(a),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(a){this._highlights.delete(a),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const Ti=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],It=(0,G.c)(),na=(0,G.c)(),uh=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],jt=(0,we.c)();var Re,mh=S(11983),Kn=S(4511),yh=S(59598),Ai=S(67857),oa=S(82274),Xe=S(2282),kn=S(98943);!function(c){c[c.ALLOCATED=1]="ALLOCATED",c[c.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",c[c.VISIBLE=4]="VISIBLE",c[c.HIGHLIGHT=8]="HIGHLIGHT",c[c.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",c[c.REMOVE=32]="REMOVE",c[c.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",c[c.ACTIVE=18]="ACTIVE"}(Re||(Re={}));class _h{constructor(a){this.localTransform=a.getField(T.T.LOCALTRANSFORM,Ie.O1),this.globalTransform=a.getField(T.T.GLOBALTRANSFORM,Ie.O1),this.modelOrigin=a.getField(T.T.MODELORIGIN,Ie.fP),this.model=a.getField(T.T.MODEL,Ie.gK),this.modelNormal=a.getField(T.T.MODELNORMAL,Ie.gK),this.modelScaleFactors=a.getField(T.T.MODELSCALEFACTORS,Ie.Eu),this.boundingSphere=a.getField(T.T.BOUNDINGSPHERE,Ie.Cd),this.color=a.getField(T.T.COLOR,Ie.ek),this.featureAttribute=a.getField(T.T.FEATUREATTRIBUTE,Ie.ek),this.state=a.getField(T.T.STATE,Ie.D_),this.lodLevel=a.getField(T.T.LODLEVEL,Ie.D_),this.objectAndLayerIdColor=a.getField(T.T.OBJECTANDLAYERIDCOLOR,Ie.mc)}}let Xi=class extends si.Z{constructor(c,a){super(c),this.events=new Ar.Z,this._capacity=0,this._size=0,this._next=0,this._buffer=null,this._view=null,this._layout=function fh(c){let a=(0,Ni.U$)().mat4f64(T.T.LOCALTRANSFORM).mat4f64(T.T.GLOBALTRANSFORM).vec4f64(T.T.BOUNDINGSPHERE).vec3f64(T.T.MODELORIGIN).mat3f(T.T.MODEL).mat3f(T.T.MODELNORMAL).vec2f(T.T.MODELSCALEFACTORS);return c.includes("color")&&(a=a.vec4f(T.T.COLOR)),c.includes("featureAttribute")&&(a=a.vec4f(T.T.FEATUREATTRIBUTE)),a=a.u8(T.T.STATE).u8(T.T.LODLEVEL),c.includes(T.T.OBJECTANDLAYERIDCOLOR)&&(a=a.vec4u8(T.T.OBJECTANDLAYERIDCOLOR)),a.alignTo(8),a}(a)}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const c=this._findSlot();return this._view.state.set(c,Re.ALLOCATED),this._size++,this.events.emit("instances-changed"),c}removeInstance(c){(0,Xe.hu)(c>=0&&c<this._capacity&&0!=(this._view.state.get(c)&Re.ALLOCATED),"invalid instance handle"),this._getStateFlag(c,Re.ACTIVE)?this._setStateFlags(c,Re.REMOVE):this.freeInstance(c),this.events.emit("instances-changed")}freeInstance(c){const a=this._view.state;(0,Xe.hu)(c>=0&&c<this._capacity&&0!=(a.get(c)&Re.ALLOCATED),"invalid instance handle"),a.set(c,0),this._size--}setLocalTransform(c,a,l=!0){this._view.localTransform.setMat(c,a),l&&this.updateModelTransform(c)}getLocalTransform(c,a){this._view.localTransform.getMat(c,a)}setGlobalTransform(c,a,l=!0){this._view.globalTransform.setMat(c,a),l&&this.updateModelTransform(c)}getGlobalTransform(c,a){this._view.globalTransform.getMat(c,a)}updateModelTransform(c){const a=this._view,l=pi,h=Ut;a.localTransform.getMat(c,Xn),a.globalTransform.getMat(c,la);const d=(0,Be.m)(la,la,Xn);(0,E.s)(l,d[12],d[13],d[14]),a.modelOrigin.setVec(c,l),(0,Oi.f)(h,d),a.model.setMat(c,h);const u=(0,kn.mw)(pi,d);u.sort(),a.modelScaleFactors.set(c,0,u[1]),a.modelScaleFactors.set(c,1,u[2]),(0,Oi.e)(h,h),(0,Oi.t)(h,h),a.modelNormal.setMat(c,h),this._setStateFlags(c,Re.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:c})}getModelTransform(c,a){const l=this._view;l.model.getMat(c,Ut),l.modelOrigin.getVec(c,pi),a[0]=Ut[0],a[1]=Ut[1],a[2]=Ut[2],a[3]=0,a[4]=Ut[3],a[5]=Ut[4],a[6]=Ut[5],a[7]=0,a[8]=Ut[6],a[9]=Ut[7],a[10]=Ut[8],a[11]=0,a[12]=pi[0],a[13]=pi[1],a[14]=pi[2],a[15]=1}applyShaderTransformation(c,a){(0,y.pC)(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,c,a)}getCombinedModelTransform(c,a){return this.getModelTransform(c,a),(0,y.pC)(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,c,a),a}getCombinedLocalTransform(c,a){return this._view.localTransform.getMat(c,a),(0,y.pC)(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,c,a),a}getCombinedMaxScaleFactor(c){let a=this._view.modelScaleFactors.get(c,1);if((0,y.pC)(this.shaderTransformation)){const l=this.shaderTransformation.scaleFactor(pi,this,c);a*=Math.max(l[0],l[1],l[2])}return a}getCombinedMedianScaleFactor(c){let a=this._view.modelScaleFactors.get(c,0);if((0,y.pC)(this.shaderTransformation)){const l=this.shaderTransformation.scaleFactor(pi,this,c);a*=function vh(c,a,l){return Math.max(Math.min(c,a),Math.min(Math.max(c,a),l))}(l[0],l[1],l[2])}return a}getModel(c,a){this._view.model.getMat(c,a)}setFeatureAttribute(c,a){this._view.featureAttribute.setVec(c,a)}getFeatureAttribute(c,a){this._view.featureAttribute.getVec(c,a)}setColor(c,a){this._view.color.setVec(c,a)}setObjectAndLayerIdColor(c,a){this._view.objectAndLayerIdColor.setVec(c,a)}getColor(c,a){this._view.color.getVec(c,a)}setVisible(c,a){a!==this.getVisible(c)&&(this._setStateFlag(c,Re.VISIBLE,a),this.events.emit("instance-visibility-changed",{index:c}))}getVisible(c){return this._getStateFlag(c,Re.VISIBLE)}setHighlight(c,a){a!==this.getHighlight(c)&&(this._setStateFlag(c,Re.HIGHLIGHT,a),this.events.emit("instance-highlight-changed"))}getHighlight(c){return this._getStateFlag(c,Re.HIGHLIGHT)}getState(c){return this._view.state.get(c)}getLodLevel(c){return this._view.lodLevel.get(c)}countFlags(c){let a=0;for(let l=0;l<this._capacity;++l)this.getState(l)&c&&++a;return a}_setStateFlags(c,a){const l=this._view.state;a=l.get(c)|a,l.set(c,a)}_clearStateFlags(c,a){const l=this._view.state;a=l.get(c)&~a,l.set(c,a)}_setStateFlag(c,a,l){l?this._setStateFlags(c,a):this._clearStateFlags(c,a)}_getStateFlag(c,a){return!!(this._view.state.get(c)&a)}_grow(){const c=Math.max(bh,Math.floor(this._capacity*Sh)),a=this._layout.createBuffer(c);if(this._buffer){const l=new Uint8Array(this._buffer.buffer);new Uint8Array(a.buffer).set(l)}this._capacity=c,this._buffer=a,this._view=new _h(this._buffer)}_findSlot(){const c=this._view.state;let a=this._next;for(;c.get(a)&Re.ALLOCATED;)a=a+1===this._capacity?0:a+1;return this._next=a+1===this._capacity?0:a+1,a}};(0,P._)([(0,A.Cb)({constructOnly:!0})],Xi.prototype,"shaderTransformation",void 0),(0,P._)([(0,A.Cb)()],Xi.prototype,"_size",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],Xi.prototype,"size",null),Xi=(0,P._)([(0,se.j)("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],Xi);const bh=1024,Sh=2,pi=(0,G.c)(),Ut=(0,Nr.c)(),Xn=(0,we.c)(),la=(0,we.c)();class Ch extends oa.Z{constructor(a,l){super(h=>(0,As.w)(this._instanceData.view.boundingSphere.getVec(h,this._tmpSphere)),{maximumDepth:25}),this._tmpSphere=(0,As.c)(),this._tmpMat4=(0,we.c)(),this._instanceData=a,this._boundingSphere=l}addInstance(a){const l=this._instanceData.view.boundingSphere,h=this._instanceData.getCombinedModelTransform(a,this._tmpMat4);(0,E.m)(this._tmpSphere,this._boundingSphere.center,h),this._tmpSphere[3]=this._boundingSphere.radius*(0,kn.u1)(h),l.setVec(a,this._tmpSphere),this.add([a])}removeInstance(a){this.remove([a])}}class xh{constructor(a,l){this._worldSpaceRadius=a,this._minScreenSpaceRadii=l}selectLevel(a,l,h){const d=h.computeScreenPixelSizeAt(a),u=this._worldSpaceRadius*l/d;let p=0;for(let g=1;g<this._minScreenSpaceRadii.length;++g)u>=this._minScreenSpaceRadii[g]&&(p=g);return p}}var Ph=S(32393),Jn=S(62483),Eh=S(76438),Oh=S(9502);S(91480);class Rh extends Oh.Dx{constructor(a,l,h,d,u,p){super(a,l),this.layerUid=a,this.graphicUid=l,this.geometryId=h,this.triangleNr=d,this.baseBoundingSphere=u,this.numLodLevels=p}}var Qn=S(83994);class Th{constructor(a,l){const h=a.renderContext.rctx,d=l.geometry;this._materialRepository=a.materialRepository,d.material.setParameters({instancedDoublePrecision:!0});const u=d.material.createBufferWriter(),p=u.vertexBufferLayout,g=u.elementCount(d),_=u.allocate(g);u.write(null,null,d,_,0),this.geometry=d,this.material=d.material,this.glMaterials=new Ph.p(d.material,this._materialRepository),this.vertexBufferLayout=p,this.vbo=Qn.f.createVertex(h,Et.l1.STATIC_DRAW,_.buffer),this.vao=new Eh.U(h,zr.i,{geometry:(0,Kn.K)(p)},{geometry:this.vbo}),this.vertexCount=g}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(a,l,h,d,u,p,g,_){const v=this.geometry.id;this.material.intersect(this.geometry,a.transform.transform,a,h,d,(b,C,x,R,O)=>{if(b>=0){if(null!=l&&!l(a.rayBegin,a.rayEnd,b))return;const M=new Rh(p.layerUid,p.graphicUid(u),v,x,g,_);if((null==a.results.min.drapedLayerOrder||O>=a.results.min.drapedLayerOrder)&&(null==a.results.min.dist||b<a.results.min.dist)&&a.results.min.set(Ai.q7.LOD,M,b,C,a.transform.transform,O),a.options.store!==Ai.eC.MIN&&(null==a.results.max.drapedLayerOrder||O>=a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||b>a.results.max.dist)&&a.results.max.set(Ai.q7.LOD,M,b,C,a.transform.transform,O),a.options.store===Ai.eC.ALL){const F=(0,Jn.LP)(a.results.min.ray);F.set(Ai.q7.LOD,M,b,C,a.transform.transform,O),a.results.all.push(F)}}})}}class ca{static create(a,l,h){return(0,B.Z)(function*(){const d=yield Promise.allSettled(l.components.map(p=>a.controller.schedule(()=>new Th(a,p),h))),u=d.map(p=>"fulfilled"===p.status?p.value:null).filter(y.pC);if((0,j.Hc)(h)||u.length!==d.length){u.forEach(p=>p.destroy()),(0,j.k_)(h);for(const p of d)if("rejected"===p.status)throw p.reason}return new ca(l.minScreenSpaceRadius,u)})()}constructor(a,l){this.minScreenSpaceRadius=a,this.components=l}destroy(){this.components.forEach(a=>a.destroy())}intersect(a,l,h,d,u,p,g){this.components.forEach(_=>_.intersect(a,l,h,d,u,p,this.boundingSphere,g))}get boundingBox(){if((0,y.Wi)(this._boundingBox)){const a=(0,V.cS)();this.components.forEach(l=>{(0,y.pC)(l.boundingInfo)&&((0,V.pp)(a,l.boundingInfo.bbMin),(0,V.pp)(a,l.boundingInfo.bbMax))}),this._boundingBox=a}return this._boundingBox}get boundingSphere(){if((0,y.Wi)(this._boundingSphere)){const a=this.boundingBox,l=(0,G.c)();(0,V.be)(a,l),this._boundingSphere={center:l,radius:.5*(0,V.wz)(a)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((a,l)=>a+l.triangleCount,0)}}class Ah{constructor(a,l,h){this._elementSize=l,this._buffer=Qn.f.createVertex(a,Et.l1.STATIC_DRAW),this.resize(h)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(a,l,h,d=0){const u=new Uint8Array(this.array,a*this.elementSize,(l-a)*this.elementSize);new Uint8Array(h.array,d*this.elementSize).set(u)}transferAll(){this._buffer.setData(this._array)}transferRange(a,l){const h=a*this._elementSize,d=l*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),h,h,d)}resize(a){const l=a*this._elementSize,h=new ArrayBuffer(l);this._array&&(a>=this._capacity?new Uint8Array(h).set(new Uint8Array(this._array)):new Uint8Array(h).set(new Uint8Array(this._array).subarray(0,a*this._elementSize))),this._array=h,this._buffer.setSize(l),this._capacity=a}}class Lh{constructor(a){this.modelOriginHi=a.getField(T.T.MODELORIGINHI,Ie.ct),this.modelOriginLo=a.getField(T.T.MODELORIGINLO,Ie.ct),this.model=a.getField(T.T.MODEL,Ie.gK),this.modelNormal=a.getField(T.T.MODELNORMAL,Ie.gK),this.color=a.getField(T.T.INSTANCECOLOR,Ie.ek),this.featureAttribute=a.getField(T.T.INSTANCEFEATUREATTRIBUTE,Ie.ek),this.objectAndLayerIdColor=a.getField(T.T.OBJECTANDLAYERIDCOLOR_INSTANCED,Ie.mc)}}class qn{constructor(a,l){this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=a,this._instanceBufferLayout=l,this._elementSize=l.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const a=this._headIndex,l=this._tailIndex;return a>=l?a-l:a+this._capacity-l}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){(0,Xe.hu)(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){(0,Xe.hu)(this._updating,"not updating"),this.size<Dh*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){(0,Xe.hu)(this._updating,"not updating"),this.isFull&&this._grow();const a=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=a,this._captureFirstIndex=!1),this._incrementHead(),(0,Xe.hu)(this._headIndex!==this._tailIndex,"invalid pointers"),a}freeTail(){(0,Xe.hu)(this._updating,"not updating"),(0,Xe.hu)(this.size>0,"invalid size");const a=this._tailIndex===this._firstIndex;this._incrementTail(),a&&(this._firstIndex=this._tailIndex)}_grow(){const a=Math.max(eo,Math.floor(this._capacity*Ih));this._resize(a)}_shrink(){const a=Math.max(eo,Math.floor(this._capacity*wh));this._resize(a)}_resize(a){if((0,Xe.hu)(this._updating,"not updating"),a===this._capacity)return;const l=new Ah(this._rctx,this._elementSize,a);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const h=this.size,d=this._compactInstances(l);(0,Xe.hu)(d===h,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=d,this._prevHeadIndex=0}this._resized=!0,this._capacity=a,this._buffer=l,this._view=new Lh(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(a){const l=this._headIndex,h=this._tailIndex;return h<l?(this._buffer.copyRange(h,l,a),l-h):h>l?(this._buffer.copyRange(h,this._capacity,a),l>0&&this._buffer.copyRange(0,l,a,this._capacity-h),l+(this._capacity-h)):0}_incrementHead(a=1){this._headIndex=(this._headIndex+a)%this._capacity}_incrementTail(a=1){this._tailIndex=(this._tailIndex+a)%this._capacity}_transferRange(a,l){a<l?this._buffer.transferRange(a,l):a>l&&(l>0&&this._buffer.transferRange(0,l),this._buffer.transferRange(a,this._capacity))}}const eo=1024,Ih=2,Dh=.3,wh=.5;var ha=S(57623),Mh=S(65073),Uh=S(39711),to=S(26906);let Dt=class extends si.Z{constructor(c,a){super(c),this.type=Ai.q7.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new yh.V,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[je.r.OPAQUE_MATERIAL,je.r.TRANSPARENT_MATERIAL],this.canRender=!0,this._instanceData=new Xi({shaderTransformation:c.shaderTransformation},c.optionalFields),this._frameTask=a.registerTask(Ct.T8.LOD_RENDERER,this)}initialize(){this._instanceBufferLayout=function Vh(c){let a=(0,Ni.U$)().vec3f(T.T.MODELORIGINHI).vec3f(T.T.MODELORIGINLO).mat3f(T.T.MODEL).mat3f(T.T.MODELNORMAL);return(0,y.pC)(c)&&c.includes("color")&&(a=a.vec4f(T.T.INSTANCECOLOR)),(0,y.pC)(c)&&c.includes("featureAttribute")&&(a=a.vec4f(T.T.INSTANCEFEATUREATTRIBUTE)),(0,y.pC)(c)&&c.includes("objectAndLayerIdColor")&&(a=a.vec4u8(T.T.OBJECTANDLAYERIDCOLOR_INSTANCED)),a}(this.optionalFields),this._glInstanceBufferLayout=(0,Kn.K)(this._instanceBufferLayout,1),this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:c})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(c)}),this._instanceData.events.on("instance-visibility-changed",({index:c})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(c)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))}destroy(){this._frameTask.remove()}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(c){this._slicePlane=c}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const c={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(a=>{const l=a.memoryUsage;c.cpu+=l.cpu,c.gpu+=l.gpu}),this._highlightRenderInstanceData.forEach(a=>{const l=a.memoryUsage;c.cpu+=l.cpu,c.gpu+=l.gpu}),c}get renderStats(){const c=this._instanceData.size,a=[];return this._levels.forEach((l,h)=>{const p=this._defaultRenderInstanceData[h].size+this._highlightRenderInstanceData[h].size,g=l.triangleCount;a.push({renderedInstances:p,renderedTriangles:p*g,trianglesPerInstance:g})}),{totalInstances:c,renderedInstances:a.reduce((l,h)=>l+h.renderedInstances,0),renderedTriangles:a.reduce((l,h)=>l+h.renderedTriangles,0),levels:a}}initializeRenderContext(c,a){var l=this;return(0,B.Z)(function*(){l._context=c;const h=c.renderContext.rctx,d=yield Promise.allSettled(l.symbol.levels.map(p=>(l._defaultRenderInstanceData.push(new qn(h,l._instanceBufferLayout)),l._highlightRenderInstanceData.push(new qn(h,l._instanceBufferLayout)),ca.create(c,p,a)))),u=d.map(p=>"fulfilled"===p.status?p.value:null).filter(y.pC);if((0,j.Hc)(a)||u.length!==d.length){u.forEach(p=>p.destroy()),(0,j.k_)(a);for(const p of d)if("rejected"===p.status)throw p.reason}l._levels=u,l._levelSelector=(c=>{const a=c.baseBoundingSphere.radius,l=c.levels.map(h=>h.minScreenSpaceRadius);return new xh(a,l)})(l)})()}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(c=>c.destroy()),this._defaultRenderInstanceData.forEach(c=>c.destroy()),this._highlightRenderInstanceData.forEach(c=>c.destroy())}get needsTransparentPass(){return this._levels.some(c=>c.components.some(a=>a.material.requiresSlot(je.r.TRANSPARENT_MATERIAL,pe.H.Color)))}get needsHighlight(){return this._highlightRenderInstanceData.some(c=>c.size>0)}prepareRender(c){if(!ht.Z.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const a=c.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(c.bindParameters.contentCamera),a||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Ct.G5),this._needFullCycle=!1)}}render(c){!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(c.output)||(c.rctx.bindVAO(),c.output!==pe.H.Highlight&&c.output!==pe.H.ShadowHighlight&&this._renderComponents(c,this._defaultRenderInstanceData),c.output!==pe.H.ShadowExcludeHighlight&&this._renderComponents(c,this._highlightRenderInstanceData))}intersect(c,a,l,h){if(!this.baseMaterial.isVisible()||(0,y.Wi)(this._octree))return;const d=(0,G.c)();(0,E.b)(d,h,l);const u=p=>{this._instanceData.getCombinedModelTransform(p,so),c.transform.set(so),(0,E.m)(ao,l,c.transform.inverse),(0,E.m)(no,h,c.transform.inverse);const g=this._instanceData.getState(p),_=this._instanceData.getLodLevel(p),v=this._levels.length;(0,Xe.hu)(0!=(g&Re.ACTIVE),"invalid instance state"),(0,Xe.hu)(_>=0&&_<v,"invaid lod level"),this._levels[_].intersect(c,a,ao,no,p,this.metadata,v)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(u):this._octree.forEachAlongRay(l,d,u)}queryDepthRange(c){return this._queryDepthRangeOctree(c)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if((0,y.Wi)(this._octreeCached)){const c=this._instanceData,a=c.view?.state;if(!a)return null;this._octreeCached=new Ch(c,this.baseBoundingSphere);for(let l=0;l<c.capacity;++l)a.get(l)&Re.ACTIVE&&this._octreeCached.addInstance(l)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,y.SC)(this._octreeCached)}_queryDepthRangeOctree(c){if((0,y.Wi)(this._octree))return{near:1/0,far:-1/0};const a=c.viewForward,l=this._octree.findClosest(a,oa.Z.DepthOrder.FRONT_TO_BACK,c.frustum),h=this._octree.findClosest(a,oa.Z.DepthOrder.BACK_TO_FRONT,c.frustum);if(null==l||null==h)return{near:1/0,far:-1/0};const d=c.eye,u=this._instanceData.view;u.boundingSphere.getVec(l,Wt),(0,E.b)(Wt,Wt,d);const p=(0,E.e)(Wt,a)-Wt[3];u.boundingSphere.getVec(h,Wt),(0,E.b)(Wt,Wt,d);const g=(0,E.e)(Wt,a)+Wt[3];return{near:Math.max(c.near,p),far:Math.min(c.far,g)}}_requestUpdateCycle(c=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,c&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(c=>c.startUpdateCycle()),this._highlightRenderInstanceData.forEach(c=>c.startUpdateCycle())}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(c){const{_enableLevelSelection:a,_camera:l,_levelSelector:h}=this;this._defaultRenderInstanceData.forEach(v=>v.beginUpdate()),this._highlightRenderInstanceData.forEach(v=>v.beginUpdate());const d=this._instanceData,u=d.view;let p=d.size;const g=d.capacity;let _=this._instanceIndex;for(let v=0;v<p&&!c.done;++v){_===this._cycleStartIndex&&this._startUpdateCycle();const b=u.state.get(_);let C=0;if(!(b&Re.ALLOCATED)){_=_+1===g?0:_+1,p++;continue}const x=u.lodLevel.get(_);if(b&Re.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[x].freeTail(),b&Re.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[x].freeTail(),b&Re.REMOVE)d.freeInstance(_);else if(b&Re.VISIBLE){let R=0;a&&(u.modelOrigin.getVec(_,ro),R=h.selectLevel(ro,d.getCombinedMedianScaleFactor(_),l)),C=b&~(Re.ACTIVE|Re.TRANSFORM_CHANGED),R>=0&&(b&Re.HIGHLIGHT?(io(this._highlightRenderInstanceData[R],u,_),C|=Re.HIGHLIGHT_ACTIVE):(io(this._defaultRenderInstanceData[R],u,_),C|=Re.DEFAULT_ACTIVE)),u.state.set(_,C),u.lodLevel.set(_,R)}else C=b&~(Re.ACTIVE|Re.TRANSFORM_CHANGED),u.state.set(_,C);if((0,y.pC)(this._octreeCached)){const R=!!(b&Re.ACTIVE),O=!!(C&Re.ACTIVE);!R&&O?this._octreeCached.addInstance(_):R&&!O?this._octreeCached.removeInstance(_):R&&O&&b&Re.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(_),this._octreeCached.addInstance(_))}_=_+1===g?0:_+1,c.madeProgress()}this._instanceIndex=_,this._defaultRenderInstanceData.forEach(v=>v.endUpdate()),this._highlightRenderInstanceData.forEach(v=>v.endUpdate()),this._context.requestRender()}_renderComponents(c,a){this.levels.forEach((l,h)=>{const d=l.components.map(u=>this._beginComponent(c,a[h],u));l.components.forEach((u,p)=>this._renderComponent(c,d[p],a[h],u,h))})}_beginComponent(c,a,l){const{bindParameters:h,rctx:d,output:u}=c;if(0===a.size||!l.material.requiresSlot(h.slot,c.output))return null;const p=l.glMaterials.load(d,h.slot,u);return(0,y.pC)(p)?p.beginSlot(h):null}_renderComponent(c,a,l,h,d){if((0,y.Wi)(a))return;const{bindParameters:u,rctx:p}=c,g=p.bindTechnique(a,h.material.parameters,u);p.bindVAO(h.vao),a.ensureAttributeLocations(h.vao),g.bindDraw(Fh,u,h.material.parameters),ht.Z.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&c.output===pe.H.Color&&(g.setUniform4fv("externalColor",oo[Math.min(d,oo.length-1)]),g.setUniform1i("colorMixMode",ha.FZ.replace));const _=p.capabilities.instancing,v=l.capacity,b=l.headIndex,C=l.tailIndex,x=l.firstIndex,R=this._glInstanceBufferLayout,O=(M,F)=>{(0,to.XP)(p,zr.i,l.buffer,R,M),_.drawArraysInstanced(a.primitiveType,0,h.vertexCount,F-M),(0,to.UF)(p,zr.i,l.buffer,R)};h.material.parameters.transparent&&null!=x?b>C?((0,Xe.hu)(x>=C&&x<=b,"invalid firstIndex"),O(x,b),O(C,x)):b<C&&(x<=b?((0,Xe.hu)(x>=0&&x<=b,"invalid firstIndex"),O(x,b),O(C,v),O(0,x)):((0,Xe.hu)(x>=C&&x<=v,"invalid firstIndex"),O(x,v),O(0,b),O(C,x))):b>C?O(C,b):b<C&&(O(0,b),O(C,v)),p.bindVAO(null)}};function io(c,a,l){const h=c.allocateHead();!function zh(c,a,l,h){(0,Mh.EE)(c.modelOrigin,a,l.modelOriginHi,l.modelOriginLo,h),l.model.copyFrom(h,c.model,a),l.modelNormal.copyFrom(h,c.modelNormal,a),c.color&&l.color&&l.color.copyFrom(h,c.color,a),c.objectAndLayerIdColor&&l.objectAndLayerIdColor&&l.objectAndLayerIdColor.copyFrom(h,c.objectAndLayerIdColor,a),c.featureAttribute&&l.featureAttribute&&l.featureAttribute.copyFrom(h,c.featureAttribute,a)}(a,l,c.view,h)}(0,P._)([(0,A.Cb)({constructOnly:!0})],Dt.prototype,"symbol",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Dt.prototype,"optionalFields",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Dt.prototype,"metadata",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Dt.prototype,"shaderTransformation",void 0),(0,P._)([(0,A.Cb)()],Dt.prototype,"_instanceData",void 0),(0,P._)([(0,A.Cb)()],Dt.prototype,"_cycleStartIndex",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],Dt.prototype,"_enableLevelSelection",null),(0,P._)([(0,A.Cb)()],Dt.prototype,"_updateCyclesWithStaticCamera",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],Dt.prototype,"running",null),Dt=(0,P._)([(0,se.j)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],Dt);const ro=(0,G.c)(),Wt=(0,De.c)(),so=(0,we.c)(),ao=(0,G.c)(),no=(0,G.c)(),oo=[(0,De.f)(1,0,1,1),(0,De.f)(0,0,1,1),(0,De.f)(0,1,0,1),(0,De.f)(1,1,0,1),(0,De.f)(1,0,0,1)],Fh=new Uh.Qm;class lo{constructor(a,l,h,d,u,p,g,_,v,b,C,x){this.lodResources=a,this.lodRenderer=l,this.stageResources=h,this.originalMaterialParameters=d,this.resourceSize=u,this.isEsriSymbolResource=p,this.isWosr=g,this.resourceBoundingBox=_,this.symbolSize=v,this.extentPadding=b,this.physicalBasedRenderingEnabled=C,this.pivotOffset=x}}const Ji=(0,G.c)(),co=(0,we.c)(),da=(0,we.c)(),ss=(0,De.c)(),as=new I.Lm;var gi,ho=S(39863);function ua(c,a,l,h,d){return c[0]=a,c[1]=l,c[2]=h,c[3]=d,c}function uo(c,a,l){const h=a[0],d=a[1],u=a[2],p=a[3],g=l[0],_=l[1],v=l[2],b=l[3];return c[0]=h*g+u*_,c[1]=d*g+p*_,c[2]=h*v+u*b,c[3]=d*v+p*b,c}function po(c,a,l){return c[0]=a[0]-l[0],c[1]=a[1]-l[1],c[2]=a[2]-l[2],c[3]=a[3]-l[3],c}Object.freeze(Object.defineProperty({__proto__:null,LDU:function qh(c,a,l,h){return c[2]=h[2]/h[0],l[0]=h[0],l[1]=h[1],l[3]=h[3]-c[2]*l[1],[c,a,l]},add:function ed(c,a,l){return c[0]=a[0]+l[0],c[1]=a[1]+l[1],c[2]=a[2]+l[2],c[3]=a[3]+l[3],c},adjoint:function Zh(c,a){const l=a[0];return c[0]=a[3],c[1]=-a[1],c[2]=-a[2],c[3]=l,c},copy:function Nh(c,a){return c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c},determinant:function Yh(c){return c[0]*c[3]-c[2]*c[1]},equals:function id(c,a){const l=c[0],h=c[1],d=c[2],u=c[3],p=a[0],g=a[1],_=a[2],v=a[3],b=(0,ho.g)();return Math.abs(l-p)<=b*Math.max(1,Math.abs(l),Math.abs(p))&&Math.abs(h-g)<=b*Math.max(1,Math.abs(h),Math.abs(g))&&Math.abs(d-_)<=b*Math.max(1,Math.abs(d),Math.abs(_))&&Math.abs(u-v)<=b*Math.max(1,Math.abs(u),Math.abs(v))},exactEquals:function td(c,a){return c[0]===a[0]&&c[1]===a[1]&&c[2]===a[2]&&c[3]===a[3]},frob:function Qh(c){return Math.sqrt(c[0]**2+c[1]**2+c[2]**2+c[3]**2)},fromRotation:function kh(c,a){const l=Math.sin(a),h=Math.cos(a);return c[0]=h,c[1]=l,c[2]=-l,c[3]=h,c},fromScaling:function Xh(c,a){return c[0]=a[0],c[1]=0,c[2]=0,c[3]=a[1],c},identity:function jh(c){return c[0]=1,c[1]=0,c[2]=0,c[3]=1,c},invert:function Hh(c,a){const l=a[0],h=a[1],d=a[2],u=a[3];let p=l*u-d*h;return p?(p=1/p,c[0]=u*p,c[1]=-h*p,c[2]=-d*p,c[3]=l*p,c):null},mul:uo,multiply:uo,multiplyScalar:function rd(c,a,l){return c[0]=a[0]*l,c[1]=a[1]*l,c[2]=a[2]*l,c[3]=a[3]*l,c},multiplyScalarAndAdd:function sd(c,a,l,h){return c[0]=a[0]+l[0]*h,c[1]=a[1]+l[1]*h,c[2]=a[2]+l[2]*h,c[3]=a[3]+l[3]*h,c},rotate:function $h(c,a,l){const h=a[0],d=a[1],u=a[2],p=a[3],g=Math.sin(l),_=Math.cos(l);return c[0]=h*_+u*g,c[1]=d*_+p*g,c[2]=h*-g+u*_,c[3]=d*-g+p*_,c},scale:function Kh(c,a,l){const d=a[1],u=a[2],p=a[3],g=l[0],_=l[1];return c[0]=a[0]*g,c[1]=d*g,c[2]=u*_,c[3]=p*_,c},set:ua,str:function Jh(c){return"mat2("+c[0]+", "+c[1]+", "+c[2]+", "+c[3]+")"},sub:po,subtract:po,transpose:function Wh(c,a){if(c===a){const l=a[1];c[1]=a[2],c[2]=l}else c[0]=a[0],c[1]=a[2],c[2]=a[1],c[3]=a[3];return c}},Symbol.toStringTag,{value:"Module"}));class od extends ni.Z{constructor(a,l,h,d,u,p,g,_){super(a,l,h,null,xi.U.Mesh,_),this.path=d,this.geometrySR=u,this.upVectorAlignment=p,this.stencilWidth=g}}function go(c){return"upVectorAlignment"in c}!function(c){c[c.World=0]="World",c[c.Path=1]="Path"}(gi||(gi={})),Object.freeze(Object.defineProperty({__proto__:null,clone:function ld(c){return[c[0],c[1],c[2],c[3]]},create:function mo(){return[1,0,0,1]},createView:function hd(c,a){return new Float64Array(c,a,4)},fromValues:function cd(c,a,l,h){return[c,a,l,h]}},Symbol.toStringTag,{value:"Module"}));var et=S(90014),pa=S(70562);function yo(){return{up:(0,G.c)(),right:(0,G.c)()}}function dd(c,a,l){(0,E.m)(c.up,a.up,l),(0,E.m)(c.right,a.right,l)}function ud(c,a,l){(0,Ee.s)(c,(0,E.e)(l,a.right),(0,E.e)(l,a.up))}class pd{constructor(){this.pos=(0,G.c)(),this.posES=(0,G.c)(),this.vLeft=(0,G.c)(),this.vRight=(0,G.c)(),this.vMinSiblingLength=0,this.frame=yo(),this.rotationFrameUp=(0,G.c)(),this.rotationRight=(0,oe.a)(),this.rotationAngle=0,this.miterStretch=[1,0,0,1],this.maxStretchDistance=0}setFrameFromUpVector(a){(0,E.c)(this.frame.up,a),(0,E.a)(Qi,this.vLeft,this.vRight),(0,E.n)(Qi,Qi),(0,E.g)(fa,this.frame.up,(0,E.e)(Qi,this.frame.up)),(0,E.b)(os,Qi,fa),(0,E.n)(os,os),(0,E.f)(this.frame.right,os,this.frame.up)}}class fo{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[]}addVertex(a,l){return this.vertices.push((0,oe.d)(a)),this.vertexNormals.push((0,oe.d)(l)),this.vertices.length-1}addPole(a,l=null){return this.poles.push({position:(0,oe.d)(a),normal:l?(0,oe.d)(l):null}),this.poles.length-1}addSegment(a,l=null){this.vertexIndices.push(a.v0),this.vertexIndices.push(a.v1),l&&(this.poleIndices.push(l.v0),this.poleIndices.push(l.v1))}get numSegments(){return this.vertexIndices.length/2}translate(a,l){for(const h of this.vertices)h[0]+=a,h[1]+=l;for(const h of this.poles)h.position[0]+=a,h.position[1]+=l}}class yd{constructor(a){this.vertices=a,this.offset=(0,G.c)(),this.xform=(0,we.c)();const l=Math.floor((a.length-1)/2);(0,E.c)(this.offset,this.vertices[l].pos);for(const h of this.vertices)(0,E.b)(h.pos,h.pos,this.offset);(0,Be.w)(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const a=this.vertices.length,l=this.vertices[0];l.index=0,l.vLeft=(0,G.c)(),(0,E.b)(l.vRight,this.vertices[1].pos,l.pos);let h=(0,E.l)(l.vRight);l.vMinSiblingLength=h,(0,E.n)(l.vRight,l.vRight);let d=l;for(let u=1;u<a;++u){const p=this.vertices[u];if(p.index=u,p.vLeft=d.vRight,u<a-1){(0,E.b)(p.vRight,this.vertices[u+1].pos,p.pos);const g=(0,E.l)(p.vRight);p.vMinSiblingLength=Math.min(h,g),h=g,(0,E.n)(p.vRight,p.vRight)}else(0,E.c)(p.vRight,p.vLeft),p.vMinSiblingLength=h;d=p}}}class _d{numProfilesPerJoin(){return 1}extrude(a,l,h){for(let d=0;d<l.vertices.length;++d)h(a.index,a.frame,l.vertices[d],l.vertexNormals[d],!1)}}class ga{constructor(a=.8*Math.PI,l=1){this.cutoffAngle=a,this.numBendSubdivisions=l}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(a,l,h){const d=Ed;if(Math.abs(a.rotationAngle)>=this.cutoffAngle)for(let u=0;u<this.numBendSubdivisions+1;++u){(0,Be.d)(Co,.5*-a.rotationAngle+u*a.rotationAngle/this.numBendSubdivisions,a.rotationFrameUp),dd(d,a.frame,Co);for(let p=0;p<l.vertices.length;++p)(0,Ee.h)(l.vertices[p],a.rotationRight)*a.rotationAngle>=0?h(a.index,d,l.vertices[p],l.vertexNormals[p],!1):((0,Ee.q)(Li,l.vertices[p],a.miterStretch),h(a.index,a.frame,Li,l.vertexNormals[p],!0))}else for(let u=0;u<this.numBendSubdivisions+1;++u)for(let p=0;p<l.vertices.length;++p){const g=(0,Ee.h)(l.vertices[p],a.rotationRight)*a.rotationAngle>=0;(0,Ee.q)(Li,l.vertices[p],a.miterStretch),h(a.index,a.frame,Li,l.vertexNormals[p],!g)}}}class ma{rebuildConnectingProfileGeometry(a,l,h){for(let d=0;d<l.vertices.length;++d)h(a.index,a.frame,l.vertices[d],l.vertexNormals[d],0,0)}}class _o extends ma{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class ns extends ma{constructor(a,l=0,h=!1){super(),this.profile=a,this.profilePlaneOffset=l,this.flip=h}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(a,l,h){for(let d=0;d<l.vertices.length;++d)h(a.index,a.frame,l.vertices[d],l.vertexNormals[d],this.profilePlaneOffset,0)}rebuildCapGeometry(a,l){const h=ya;(0,Ee.s)(h,0,0);const d=this.flip?1:-1;for(let u=0;u<this.profile.vertices.length;++u)l(a.index,a.frame,this.profile.vertices[u],h,this.profilePlaneOffset,d)}buildTopology(a,l){const h=this.vertexBufferStart+this.profile.vertexIndices[0];for(let d=1;d<this.profile.numSegments;++d){const g=this.vertexBufferStart+this.profile.vertexIndices[2*d+0],_=this.vertexBufferStart+this.profile.vertexIndices[2*d+1];this.flip?l(_,g,h):l(h,g,_)}}}class vo extends ma{constructor(a){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=a.profile,this.flip=a.flip,this.sign=this.flip?1:-1,this.breakNormals=a.breakNormals,this.numSegments=a.subdivisions}getNumVertices(){let a=0;return a=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(a+=this.profile.vertices.length),a+=this.profile.poles.length,a}getNumIndices(){let a=0;a+=2*this.profile.numSegments*(this.numSegments-1);for(let l=0;l<this.profile.numSegments;++l)a+=this.profile.poleIndices[this.profile.vertexIndices[2*l+0]]===this.profile.poleIndices[this.profile.vertexIndices[2*l+1]]?1:2;return 3*a}rebuildCapGeometry(a,l){const h=a.frame,d=.5*this.sign,u=Li,p=ya;(0,Ee.s)(p,0,0);for(let g=0;g<this.profile.poles.length;++g){const _=this.profile.poles[g];_.normal?l(a.index,h,_.position,_.normal,d,0):l(a.index,h,_.position,p,d,this.sign)}if(this.breakNormals)for(let g=0;g<this.profile.vertices.length;++g)l(a.index,h,this.profile.vertices[g],this.profile.vertexNormals[g],0,0);for(let g=0;g<this.numSegments-1;++g){const _=(1-(g+1)/this.numSegments)*Math.PI*.5,v=Math.sin(_),b=Math.cos(_);for(let C=0;C<this.profile.vertices.length;++C){const x=this.profile.poles[this.profile.poleIndices[C]];(0,Ee.a)(u,this.profile.vertices[C],x.position),(0,Ee.b)(u,u,v),x.normal?((0,Ee.j)(u,u,x.position),l(a.index,h,u,x.normal,d*b,0)):((0,Ee.f)(p,u),(0,Ee.b)(p,p,v),(0,Ee.j)(u,u,x.position),l(a.index,h,u,p,d*b,this.sign*b))}}}buildTopology(a,l){const h=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,d=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let u=0;u<this.profile.numSegments;++u){const p=this.profile.vertexIndices[2*u+0],g=this.profile.vertexIndices[2*u+1],_=this.vertexBufferStart+this.profile.poleIndices[p],v=this.vertexBufferStart+this.profile.poleIndices[g];let b=h+p,C=h+g;for(let x=0;x<this.numSegments-1;++x){const R=d+x*this.profile.vertices.length+p,O=d+x*this.profile.vertices.length+g;this.flip?(l(R,C,b),l(C,R,O)):(l(b,C,R),l(O,R,C)),b=R,C=O}this.flip?(l(_,C,b),_!==v&&l(_,v,C)):(l(b,C,_),_!==v&&l(C,v,_))}}}class vd{constructor(a,l,h,d,u,p={}){this.options=p,this._extrusionVertexCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.profile=l,this.path=a,this.extruder=h,this.startCap=d,this.endCap=u;const g=this.path.vertices.length-2;this.numExtrusionProfiles=h.numProfilesPerJoin()*g+2,this.numVerticesTotal=l.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const _=this.startCap.getNumVertices();this.numVerticesTotal+=_,this.numNormalsTotal+=_,this.endCap.vertexBufferStart=this.numVerticesTotal;const v=this.endCap.getNumVertices();this.numVerticesTotal+=v,this.numNormalsTotal+=v,this.pathVertexData=(0,vt.xx)(1*this.numVerticesTotal),this.profileRightAxisData=(0,vt.xx)(4*this.numVerticesTotal),this.profileUpAxisData=(0,vt.xx)(4*this.numVerticesTotal),this.profileVertexAndNormalData=(0,vt.xx)(4*this.numVerticesTotal),this.originData=(0,vt.xx)(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(a,l,h,d,u){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=l.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=l.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=l.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=l.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=l.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=l.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=h[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=h[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=d[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=d[1],this.pathVertexData[this._extrusionVertexCount]=a,u){const p=this.path.vertices[a];this.profileRightAxisData[4*this._extrusionVertexCount+3]=p.rotationRight[0]*p.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=p.rotationRight[1]*p.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(a,l,h,d,u,p){this.profileRightAxisData[4*this._extrusionVertexCount+0]=l.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=l.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=l.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=l.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=l.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=l.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=h[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=h[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=d[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=d[1],this.pathVertexData[this._extrusionVertexCount]=a,this.profileRightAxisData[4*this._extrusionVertexCount+3]=u,this.profileUpAxisData[4*this._extrusionVertexCount+3]=p,++this._extrusionVertexCount}_rebuildGeometry(){const a=(h,d,u,p,g)=>this.emitVertex(h,d,u,p,g),l=(h,d,u,p,g,_)=>this.emitCapVertex(h,d,u,p,g,_);this._extrusionVertexCount=0;for(const h of this.path.vertices)this.originData[3*h.index+0]=h.pos[0],this.originData[3*h.index+1]=h.pos[1],this.originData[3*h.index+2]=h.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,l);for(let h=1;h<this.path.vertices.length-1;++h)this.extruder.extrude(this.path.vertices[h],this.profile,a);this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,l),this.startCap.rebuildCapGeometry(this.path.vertices[0],l),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],l)}buildTopology(){const a=this.profile.vertices.length,l=this.profile.numSegments,h=this.numExtrusionProfiles-1;let d=l*h*2*3;this.startCap.indexBufferStart=d,this.startCap.firstProfileVertexIndex=0,d+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=d,this.endCap.firstProfileVertexIndex=a*(this.numExtrusionProfiles-1);const u=new Array,p=new Array,g=new Array,_=(v,b,C)=>{u.push(v),u.push(b),u.push(C),p.push(v),p.push(b),p.push(C),g.push(this.pathVertexData[v]),g.push(this.pathVertexData[b]),g.push(this.pathVertexData[C])};for(let v=0;v<l;++v){const b=this.profile.vertexIndices[2*v],C=this.profile.vertexIndices[2*v+1];for(let x=0;x<h;++x){const R=x*a+b,O=(x+1)*a+C,M=x*a+C;_(R,(x+1)*a+b,O),_(R,O,M)}}this.startCap.buildTopology(this.path.vertices[0],_),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],_),this.vertexIndices=(0,ts.mi)(u),this.normalIndices=(0,ts.mi)(p),this.pathVertexIndices=(0,ts.mi)(g)}onPathChanged(){this._rebuildGeometry()}}class bo{constructor(a){this.builder=a}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class So extends bo{constructor(a){super(a),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=(0,vt.xx)(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=(0,vt.xx)(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(a){this.vertexAttributeColor[0]=255*a[0],this.vertexAttributeColor[1]=255*a[1],this.vertexAttributeColor[2]=255*a[2],this.vertexAttributeColor[3]=255*(a.length>3?a[3]:1)}bake(a){this.size=a;for(let l=0;l<this.builder.numVerticesTotal;++l){let h=this.builder.pathVertexData[l];const d=0===h||h===this.builder.path.vertices.length-1;h*=3;const u=Sd;(0,E.s)(u,this.builder.originData[h++],this.builder.originData[h++],this.builder.originData[h]);const p=4*l,g=fa,_=Li,v=Qi,b=xd,C=Pd;let x=0,R=0;if((0,E.s)(b,this.builder.profileRightAxisData[p],this.builder.profileRightAxisData[p+1],this.builder.profileRightAxisData[p+2]),(0,E.s)(C,this.builder.profileUpAxisData[p],this.builder.profileUpAxisData[p+1],this.builder.profileUpAxisData[p+2]),(0,Ee.s)(_,this.builder.profileVertexAndNormalData[p]*a[0],this.builder.profileVertexAndNormalData[p+1]*a[1]),d)(0,E.f)(v,C,b),x=this.builder.profileRightAxisData[p+3]*a[0],R=this.builder.profileUpAxisData[p+3];else{const M=ya,F=Cd;(0,Ee.s)(M,this.builder.profileRightAxisData[p+3],this.builder.profileUpAxisData[p+3]);const H=(0,Ee.i)(M);(0,Ee.f)(M,M);const N=(0,Ee.h)(_,M);if(Math.abs(N)>H){(0,Ee.s)(F,-M[1],M[0]);const te=(0,Ee.h)(_,F);(0,Ee.b)(M,M,H*Math.sign(N)),(0,Ee.b)(F,F,te),(0,Ee.j)(_,M,F)}(0,E.s)(v,0,0,0)}(0,E.s)(g,b[0]*_[0]+C[0]*_[1],b[1]*_[0]+C[1]*_[1],b[2]*_[0]+C[2]*_[1]),this.vertexAttributePosition[3*l+0]=u[0]+g[0]+v[0]*x,this.vertexAttributePosition[3*l+1]=u[1]+g[1]+v[1]*x,this.vertexAttributePosition[3*l+2]=u[2]+g[2]+v[2]*x;const O=Li;(0,Ee.s)(O,this.builder.profileVertexAndNormalData[p+2],this.builder.profileVertexAndNormalData[p+3]),this.vertexAttributeNormal[3*l+0]=b[0]*O[0]+C[0]*O[1]+v[0]*R,this.vertexAttributeNormal[3*l+1]=b[1]*O[0]+C[1]*O[1]+v[1]*R,this.vertexAttributeNormal[3*l+2]=b[2]*O[0]+C[2]*O[1]+v[2]*R}}createGeometryData(){const a=[[T.T.POSITION,this.builder.vertexIndices],[T.T.NORMAL,this.builder.normalIndices]],l=[[T.T.POSITION,new Oe.a(this.vertexAttributePosition,3,!0)],[T.T.NORMAL,new Oe.a(this.vertexAttributeNormal,3,!0)]];return this.vertexAttributeColor&&(a.push([T.T.COLOR,new Array(this.builder.vertexIndices.length).fill(0)]),l.push([T.T.COLOR,new Oe.a(this.vertexAttributeColor,4)])),{vertexAttributes:l,indices:a}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(a,l,h){const d=this.builder.vertexIndices,u=new Oe.a(this.vertexAttributePosition,3);(0,ha.CN)(a,l,0,d.length/3,d,u,void 0,void 0,h)}}class bd extends bo{constructor(a,l,h,d){super(a),this.sizeAttributeValue=l,this.colorAttributeValue=h,this.opacityAttributeValue=d,this.vvData=null,this.baked=new So(a),this.vvData=(0,vt.xx)(4*this.builder.path.vertices.length);for(let u=0;u<this.builder.path.vertices.length;++u)this.vvData[4*u+0]=l,this.vvData[4*u+1]=h,this.vvData[4*u+2]=d,this.vvData[4*u+3]=0===u||u===this.builder.path.vertices.length-1?1:0}createGeometryData(){return{vertexAttributes:[[T.T.POSITION,new Oe.a(this.builder.originData,3,!0)],[T.T.PROFILERIGHT,new Oe.a(this.builder.profileRightAxisData,4,!0)],[T.T.PROFILEUP,new Oe.a(this.builder.profileUpAxisData,4,!0)],[T.T.PROFILEVERTEXANDNORMAL,new Oe.a(this.builder.profileVertexAndNormalData,4,!0)],[T.T.FEATUREVALUE,new Oe.a(this.vvData,4,!0)]],indices:[[T.T.POSITION,this.builder.pathVertexIndices],[T.T.PROFILERIGHT,this.builder.vertexIndices],[T.T.PROFILEUP,this.builder.vertexIndices],[T.T.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[T.T.FEATUREVALUE,this.builder.pathVertexIndices]]}}}const Sd=(0,G.c)(),Li=(0,oe.a)(),ya=(0,oe.a)(),Cd=(0,oe.a)(),fa=(0,G.c)(),Qi=(0,G.c)(),xd=(0,G.c)(),Pd=(0,G.c)(),os=(0,G.c)(),Ed=yo(),Co=(0,we.c)();var qi=S(96395),xo=S(2770),Od=S(68565),Rd=S(92724),Td=S(24079),Po=S(57596);const Eo=new Map([[T.T.POSITION,0],[T.T.PROFILERIGHT,1],[T.T.PROFILEUP,2],[T.T.PROFILEVERTEXANDNORMAL,3],[T.T.FEATUREVALUE,4]]);class Ad extends Od.C{constructor(){super(...arguments),this.ambient=(0,G.f)(.2,.2,.2),this.diffuse=(0,G.f)(.8,.8,.8),this.specular=(0,G.f)(0,0,0),this.opacity=1}}class ls extends Gr.A{initializeConfiguration(a,l){l.hasWebGL2Context=a.rctx.type===Po.zO.WEBGL2,l.spherical=a.viewingMode===ci.JY.Global,l.doublePrecisionRequiresObfuscation=a.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(a){return new Vr.$(a.rctx,ls.shader.get().build(this.configuration),Eo)}initializePipeline(){const a=this.configuration.transparencyPassType,l=this.configuration,h=a===Jt.A.NONE,d=a===Jt.A.FrontFace;return(0,$e.sm)({blending:l.output!==pe.H.Color&&l.output!==pe.H.Alpha||!l.transparent?null:h?nt.wu:(0,nt.j7)(a),culling:l.hasSlicePlane&&!l.transparent&&l.doubleSidedMode!==qi.q.None?$e.sg:null,depthTest:{func:(0,nt.Bh)(a)},depthWrite:h||d?$e.LZ:null,colorWrite:$e.BK,stencilWrite:l.hasOccludees?ot.s3:null,stencilTest:l.hasOccludees?ot.RY:null,polygonOffset:h||d?null:nt.E0})}}ls.shader=new Ur.J(Td.P,()=>S.e(3478).then(S.bind(S,93478)));class Ke extends Fs.W{constructor(){super(...arguments),this.output=pe.H.Color,this.doubleSidedMode=qi.q.None,this.transparencyPassType=Jt.A.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}}(0,P._)([(0,me.o)({count:pe.H.COUNT})],Ke.prototype,"output",void 0),(0,P._)([(0,me.o)({count:qi.q.COUNT})],Ke.prototype,"doubleSidedMode",void 0),(0,P._)([(0,me.o)({count:Jt.A.COUNT})],Ke.prototype,"transparencyPassType",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"spherical",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"receiveShadows",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"receiveAmbientOcclusion",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"vvSize",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"vvColor",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"vvOpacity",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"hasSlicePlane",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"transparent",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"hasOccludees",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"hasMultipassTerrain",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"cullAboveGround",void 0),(0,P._)([(0,me.o)()],Ke.prototype,"doublePrecisionRequiresObfuscation",void 0),(0,P._)([(0,me.o)({constValue:Rd.f7.Disabled})],Ke.prototype,"pbrMode",void 0),(0,P._)([(0,me.o)({constValue:!0})],Ke.prototype,"hasVvInstancing",void 0),(0,P._)([(0,me.o)({constValue:!1})],Ke.prototype,"useCustomDTRExponentForWater",void 0),(0,P._)([(0,me.o)({constValue:!1})],Ke.prototype,"useFillLights",void 0);class _a extends Pi.F5{constructor(a){super(a,new Id),this.supportsEdges=!0,this._vertexAttributeLocations=Eo,this._configuration=new Ke,this._vertexBufferLayout=_a.getVertexBufferLayout()}getConfiguration(a,l){return this._configuration.output=a,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,a!==pe.H.Color&&a!==pe.H.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?qi.q.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?qi.q.WindingOrder:qi.q.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=!!l.ssaoHelper.active&&this.parameters.receiveSSAO),this._configuration.transparencyPassType=l.transparencyPassType,this._configuration.hasMultipassTerrain=l.multipassTerrain.enabled,this._configuration.cullAboveGround=l.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(a){return a!==pe.H.Shadow&&a!==pe.H.ShadowExcludeHighlight&&a!==pe.H.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(a,l,h,d,u,p){const g=a;if(!go(g))return;const _=g.path,v=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const F=this.parameters.vvSizeOffset,H=this.parameters.vvSizeFactor,N=this.parameters.vvSizeMinSize,te=this.parameters.vvSizeMaxSize,ee=_.sizeAttributeValue;v[0]*=(0,Lt.uZ)(F[0]+ee*H[0],N[0],te[0]),v[1]*=(0,Lt.uZ)(F[2]+ee*H[2],N[2],te[2])}const b=Math.max(v[0],v[1]),C=a.boundingInfo;if((0,y.Wi)(C))return void this._intersectTriangles(_,v,d,u,p);const x=(0,V.al)(C.bbMin[0]-b,C.bbMin[1]-b,C.bbMin[2]-b,C.bbMax[0]+b,C.bbMax[1]+b,C.bbMax[2]+b),R=[u[0]-d[0],u[1]-d[1],u[2]-d[2]],O=Math.sqrt(R[0]*R[0]+R[1]*R[1]+R[2]*R[2]);(0,ha.Tw)(x,d,[O/R[0],O/R[1],O/R[2]],h.tolerance)&&this._intersectTriangles(_,v,d,u,p)}_intersectTriangles(a,l,h,d,u){a.baked.size&&a.baked.size[0]===l[0]&&a.baked.size[1]===l[1]||a.baked.bake(l),a.baked.intersect(h,d,u)}createBufferWriter(){return new xo.G(this._vertexBufferLayout)}requiresSlot(a,l){switch(l){case pe.H.Shadow:case pe.H.ShadowHighlight:case pe.H.ShadowExcludeHighlight:if(!this.parameters.castShadows)return!1;case pe.H.Color:case pe.H.Alpha:case pe.H.Depth:case pe.H.Normal:case pe.H.Highlight:case pe.H.ObjectAndLayerIdColor:return a===(this.parameters.transparent?je.r.TRANSPARENT_MATERIAL:je.r.OPAQUE_MATERIAL)||a===je.r.DRAPED_MATERIAL;default:return!1}}createGLMaterial(a){return new Ld(a)}static getVertexBufferLayout(){return(0,Ni.U$)().vec3f(T.T.POSITION).vec4f(T.T.PROFILERIGHT).vec4f(T.T.PROFILEUP).vec4f(T.T.PROFILEVERTEXANDNORMAL).vec4f(T.T.FEATUREVALUE)}}class Ld extends Vs.Z{_updateOccludeeState(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})}_updateShadowState(a){((0,y.Wi)(this.technique)||a.shadowMap.enabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:a.shadowMap.enabled})}beginSlot(a){return this._output!==pe.H.Color&&this._output!==pe.H.Alpha||(this._updateShadowState(a),this._updateOccludeeState(a)),this.ensureTechnique(ls,a)}}class Id extends Ad{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveSSAO=!0,this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}}const Dd=["polyline"];function Oo(c,a,l){switch(a){default:case gi.World:for(const h of c.vertices){(0,E.a)(Te,h.pos,c.offset),l.worldUpAtPosition(Te,Te),h.setFrameFromUpVector(Te),h.rotationFrameUp=h.frame.up,(0,Ee.s)(h.rotationRight,1,0),(0,E.g)(Te,h.frame.up,(0,E.e)(h.frame.up,h.vLeft)),(0,E.b)(Te,h.vLeft,Te),(0,E.o)(Te,Te),(0,E.n)(Te,Te),(0,E.g)(mi,h.frame.up,(0,E.e)(h.frame.up,h.vRight)),(0,E.b)(mi,h.vRight,mi),(0,E.n)(mi,mi),(0,E.f)(Ao,h.rotationFrameUp,h.vLeft);const d=Math.sign((0,E.e)(Ao,h.vRight));if(h.rotationAngle=d*(Math.PI-(0,Lt.ZF)((0,E.e)(Te,mi))),Math.abs(h.rotationAngle)>0){const p=(0,Lt.b_)(Math.cos(.5*h.rotationAngle));ua(h.miterStretch,p-1+1,0,0,1)}const u=Math.PI-h.rotationAngle;h.maxStretchDistance=Math.abs(h.vMinSiblingLength/Math.cos(.5*u))}break;case gi.Path:(0,E.a)(Te,c.vertices[0].pos,c.offset),l.worldUpAtPosition(Te,Te),function fd(c,a){let l=null;const h=c.vertices.length,d=.99619469809,u=(0,G.c)(),p=(0,G.c)(),g=(0,G.c)(),_=(0,G.c)(),v=(0,G.c)(),b=(0,G.c)(),C=(0,et.Ue)();let x=c.vertices[0];(0,E.c)(p,a),(0,E.s)(u,0,1,0),(0,Pt.Ay)(x.vRight,p,u,u,g,p,d),(0,E.c)(x.frame.up,p),(0,E.c)(x.frame.right,g),l=x;for(let R=1;R<h;++R){x=c.vertices[R],(0,E.a)(v,x.vLeft,x.vRight);let O=(0,E.l)(v);O>0?(O=1/Math.sqrt(O),v[0]=v[0]*O,v[1]=v[1]*O,v[2]=v[2]*O):(v[0]=x.vRight[0],v[1]=x.vRight[1],v[2]=x.vRight[2]),(0,E.a)(b,l.pos,l.frame.up),(0,et.Yq)(x.pos,v,C),(0,et.BR)(C,(0,pa.re)(b,x.vLeft),_)?((0,E.b)(_,_,x.pos),(0,E.n)(p,_),(0,E.f)(g,v,p),(0,E.n)(g,g)):(0,Pt.Ay)(v,l.frame.up,l.frame.right,u,g,p,d),(0,E.c)(x.frame.up,p),(0,E.c)(x.frame.right,g),l=x}}(c,Te);for(const h of c.vertices){const d=Math.sign((0,E.e)(h.frame.right,h.vRight));(0,E.f)(h.rotationFrameUp,h.vRight,h.vLeft),(0,E.g)(h.rotationFrameUp,h.rotationFrameUp,d),(0,E.n)(h.rotationFrameUp,h.rotationFrameUp);const u=(0,E.e)(h.rotationFrameUp,h.frame.up),p=(0,E.e)(h.rotationFrameUp,h.frame.right);if((0,E.g)(Te,h.frame.up,-p),(0,E.g)(mi,h.frame.right,u),(0,E.a)(Te,Te,mi),(0,E.n)(Te,Te),ud(h.rotationRight,h.frame,Te),(0,E.o)(Te,h.vLeft),h.rotationAngle=-d*(Math.PI-(0,Lt.ZF)((0,E.e)(Te,h.vRight))),Math.abs(h.rotationAngle)>0){const _=(0,Lt.b_)(Math.cos(.5*h.rotationAngle));ua(h.miterStretch,1+(_-1)*h.rotationRight[0]*h.rotationRight[0],(_-1)*h.rotationRight[0]*h.rotationRight[1],(_-1)*h.rotationRight[0]*h.rotationRight[1],1+(_-1)*h.rotationRight[1]*h.rotationRight[1])}const g=Math.PI-h.rotationAngle;h.maxStretchDistance=Math.abs(h.vMinSiblingLength*(0,Lt.b_)(Math.cos(.5*g)))}}}function Ro(c,a,l){switch(c){case"symbol-value":return l;case"proportional":return a;default:return c}}function Md(c,a,l,h){let d=0;for(const u of c.vertices)l(u.posES,va),d+=va.sampledElevation,(0,E.a)(Te,u.pos,c.offset),h.setAltitude(Te,va.z),(0,E.b)(u.pos,Te,c.offset);return c.updatePathVertexInformation(),d/c.vertices.length}function Ud(c,a,l,h,d){const u=c.stageObject,p=u.geometries;let g=0;Gd.spatialReference=d.spatialReference;for(const _ of p){if(!go(_))continue;const v=_.path,b=v.builder.path;To.spatialReference=_.geometrySR,g+=Md(b,0,h,d),_.upVectorAlignment!==gi.World&&Oo(b,_.upVectorAlignment,d),v.onPathChanged(),_.invalidateBoundingInfo(),u.geometryVertexAttrsUpdated(_)}return g/p.length}const Gd=(0,Q.Tx)(0,0,0,null),To=(0,Q.Tx)(0,0,0,null),Te=(0,G.c)(),mi=(0,G.c)(),Ao=(0,G.c)(),va=new I.Lm;var cs=S(92383);function Lo(c,a,l,h,d=1){(0,E.s)(Ii,1,0,0),(0,E.s)(Di,0,1,0),(0,E.s)(tr,0,0,1),function Bd(c,a){(0,E.s)(Or,0,0,0);for(let l=0;l<a.length-3;l+=3)Or[0]+=a[l],Or[1]+=a[l+1],Or[2]+=a[l+2];(0,E.g)(c,Or,1/(a.length/3-1))}(ba,l),function Vd(c,a){const l=c.length/3-1;return(0,et.$I)(c,a,0,Math.floor(l/3),Math.floor(l*(2/3)))}(l,Io)&&function Fd(c,a,l,h,d,u){(0,y.pC)(d)?(d.basisMatrixAtPosition(u,Ht),(0,E.s)(hs,Ht[0],Ht[1],Ht[2]),(0,E.s)(ds,Ht[4],Ht[5],Ht[6]),(0,E.s)(Sa,Ht[8],Ht[9],Ht[10])):((0,E.s)(hs,1,0,0),(0,E.s)(ds,0,1,0),(0,E.s)(Sa,0,0,1));const p=(0,et.mJ)(c);(0,E.e)(p,Sa)<0&&(0,E.g)(p,p,-1),(0,E.c)(h,p);const g=(0,E.e)(p,ds),_=(0,E.e)(p,hs);Math.abs(g)<Math.abs(_)?((0,E.z)(a,hs,p,-_),(0,E.n)(a,a),(0,E.f)(l,a,p),(0,E.n)(l,l),(0,E.g)(l,l,-1)):((0,E.z)(l,ds,p,-g),(0,E.n)(l,l),(0,E.f)(a,l,p),(0,E.n)(a,a))}(Io,Ii,Di,tr,h,ba),(0,Ee.s)(He,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),(0,Ee.s)(wi,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let b=0;b<l.length;b+=3){(0,E.s)(er,l[b],l[b+1],l[b+2]);const C=(0,E.e)(Ii,er),x=(0,E.e)(Di,er);He[0]=Math.min(He[0],C),He[1]=Math.min(He[1],x),wi[0]=Math.max(wi[0],C),wi[1]=Math.max(wi[1],x)}const u=(0,E.e)(tr,ba);Ca(yi,He[0],He[1],u,Ii,Di,tr),Ca(Mi,wi[0],He[1],u,Ii,Di,tr),Ca(Ui,He[0],wi[1],u,Ii,Di,tr),(0,E.b)(Mi,Mi,yi),(0,E.g)(Mi,Mi,.5),(0,E.b)(Ui,Ui,yi),(0,E.g)(Ui,Ui,.5),(0,E.a)(yi,yi,Mi),(0,E.a)(yi,yi,Ui);const _=He[0]-He[0]%d,v=He[1]-He[1]%d;for(let b=0;b<l.length;b+=3){(0,E.s)(er,l[b],l[b+1],l[b+2]);const C=b/3,x=4*C;c[x]=((0,E.e)(Ii,er)-_)/d,c[x+1]=((0,E.e)(Di,er)-v)/d,c[x+2]=_/d,c[x+3]=v/d;const R=9*C;for(let O=0;O<3;O++)a[R+O]=yi[O],a[R+O+3]=Mi[O],a[R+O+6]=Ui[O]}}const ba=(0,G.c)(),er=(0,G.c)(),Io=(0,et.Ue)(),Ii=(0,G.c)(),Di=(0,G.c)(),tr=(0,G.c)(),He=(0,oe.a)(),wi=(0,oe.a)(),yi=(0,G.c)(),Mi=(0,G.c)(),Ui=(0,G.c)(),Ht=(0,we.c)(),hs=(0,G.c)(),ds=(0,G.c)(),Sa=(0,G.c)(),Or=(0,G.c)();function Ca(c,a,l,h,d,u,p){(0,E.s)(c,a*d[0]+l*u[0]+h*p[0],a*d[1]+l*u[1]+h*p[1],a*d[2]+l*u[2]+h*p[2])}var Do=S(92972),fi=S(95402),Nd=S(15842),jd=S(66401);class us extends Gr.A{initializeConfiguration(a,l){l.hasWebGL2Context=a.rctx.type===Po.zO.WEBGL2}initializeProgram(a){return new Vr.$(a.rctx,us.shader.get().build(this.configuration),wo)}_setPipelineState(a,l){const h=this.configuration,d=a===Jt.A.NONE,u=a===Jt.A.FrontFace;return(0,$e.sm)({blending:h.output===pe.H.Color||h.output===pe.H.Alpha?d?nt.wu:(0,nt.j7)(a):null,culling:(0,$e.zp)(h.cullFace),depthTest:{func:(0,nt.Bh)(a)},depthWrite:d?h.writeDepth?$e.LZ:null:(0,nt.K5)(a),colorWrite:$e.BK,stencilWrite:h.hasOccludees?ot.s3:null,stencilTest:h.hasOccludees?l?ot.eD:ot.RY:null,polygonOffset:d||u?h.polygonOffset?Wd:null:(0,nt.je)(h.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(a,l){return l?this._occludeePipelineState:super.getPipelineState(a,l)}}us.shader=new Ur.J(jd.P,()=>S.e(5655).then(S.bind(S,35655)));const Wd={factor:1,units:1};class lt extends Fs.W{constructor(){super(...arguments),this.output=pe.H.Color,this.cullFace=Pe.Vr.None,this.transparencyPassType=Jt.A.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.hasOccludees=!1,this.enableOffset=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}(0,P._)([(0,me.o)({count:pe.H.COUNT})],lt.prototype,"output",void 0),(0,P._)([(0,me.o)({count:Pe.Vr.COUNT})],lt.prototype,"cullFace",void 0),(0,P._)([(0,me.o)({count:fi.b.COUNT})],lt.prototype,"style",void 0),(0,P._)([(0,me.o)({count:Jt.A.COUNT})],lt.prototype,"transparencyPassType",void 0),(0,P._)([(0,me.o)()],lt.prototype,"hasSlicePlane",void 0),(0,P._)([(0,me.o)()],lt.prototype,"hasVertexColors",void 0),(0,P._)([(0,me.o)()],lt.prototype,"polygonOffset",void 0),(0,P._)([(0,me.o)()],lt.prototype,"writeDepth",void 0),(0,P._)([(0,me.o)()],lt.prototype,"hasOccludees",void 0),(0,P._)([(0,me.o)()],lt.prototype,"patternSpacing",void 0),(0,P._)([(0,me.o)()],lt.prototype,"lineWidth",void 0),(0,P._)([(0,me.o)()],lt.prototype,"enableOffset",void 0),(0,P._)([(0,me.o)()],lt.prototype,"draped",void 0),(0,P._)([(0,me.o)()],lt.prototype,"hasMultipassTerrain",void 0),(0,P._)([(0,me.o)()],lt.prototype,"cullAboveGround",void 0);const wo=new Map([[T.T.POSITION,0],[T.T.COLOR,3],[T.T.UVMAPSPACE,4],[T.T.BOUNDINGRECT,5]]);class xa extends Nd.c{constructor(a){super(a,new Yd),this.supportsEdges=!0,this._vertexAttributeLocations=wo,this._configuration=new lt}getConfiguration(a,l){return this._configuration.output=a,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=l.transparencyPassType,this._configuration.enableOffset=l.camera.relativeElevation<nt.ve,this._configuration.hasMultipassTerrain=l.multipassTerrain.enabled,this._configuration.cullAboveGround=l.multipassTerrain.cullAboveGround,this._configuration}requiresSlot(a,l){return!!(l===pe.H.Color||l===pe.H.Alpha||l===pe.H.Highlight||l===pe.H.Depth&&this.parameters.writeLinearDepth)&&(a===je.r.DRAPED_MATERIAL||(l===pe.H.Highlight?a===je.r.OPAQUE_MATERIAL:a===(this.parameters.writeDepth?je.r.TRANSPARENT_MATERIAL:je.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)))}createGLMaterial(a){return new Hd(a)}createBufferWriter(){const a=(0,Ni.U$)().vec3f(T.T.POSITION).vec4u8(T.T.COLOR).vec4f(T.T.UVMAPSPACE);return this.parameters.draped||a.mat3f(T.T.BOUNDINGRECT),new Zd(a)}}class Hd extends Vs.Z{_updateParameters(a){return this.ensureTechnique(us,a)}_updateOccludeeState(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})}beginSlot(a){return this._output!==pe.H.Color&&this._output!==pe.H.Alpha||this._updateOccludeeState(a),this._updateParameters(a)}}class Zd extends xo.G{write(a,l,h,d,u){for(const p of this.vertexBufferLayout.fieldNames){const g=h.vertexAttributes.get(p),_=h.indices.get(p);if(g&&_)switch(p){case T.T.POSITION:{(0,Xe.hu)(3===g.size);const v=d.getField(p,Ie.ct);v&&(0,ji.ho)(_,g.data,a,v,u);break}case T.T.COLOR:{(0,Xe.hu)(3===g.size||4===g.size);const v=d.getField(p,Ie.mc);v&&(0,ji.Vs)(_,g.data,g.size,v,u);break}case T.T.UVMAPSPACE:{(0,Xe.hu)(4===g.size);const v=d.getField(p,Ie.ek);v&&(0,ji.SW)(_,g.data,v,u);break}case T.T.BOUNDINGRECT:{(0,Xe.hu)(9===g.size);const v=d.getField(p,Ie.gK);v&&this.writeBoundingRect(_,g.data,a,v,u);break}}}}writeBoundingRect(a,l,h,d,u){const p=h,g=d.typedBuffer,_=d.typedBufferStride,v=a.length;u*=_;for(let b=0;b<v;++b){const C=9*a[b],x=l[C],R=l[C+1],O=l[C+2];g[u]=p[0]*x+p[4]*R+p[8]*O+p[12],g[u+1]=p[1]*x+p[5]*R+p[9]*O+p[13],g[u+2]=p[2]*x+p[6]*R+p[10]*O+p[14];for(let M=3;M<9;++M)g[u+M]=l[C+M];u+=_}}}class Yd extends Pi.Mt{constructor(){super(...arguments),this.color=(0,De.f)(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Pe.Vr.None,this.hasOccludees=!1,this.style=fi.b.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}function Qd(c,a){if(function Jd(c){return c.material instanceof xa&&!c.material.parameters.draped}(c)){const l=c.vertexAttributes.get(T.T.POSITION).data;Lo(c.getMutableAttribute(T.T.UVMAPSPACE).data,c.getMutableAttribute(T.T.BOUNDINGRECT).data,l,a)}}function qd(c,a,l,h,d){const u=Ha(c,a,l,h,d),p=c.stageObject.geometries;for(const g of p)Qd(g,d);return u}const eu=["polyline","polygon","extent"];class ps extends Bt{constructor(a,l,h,d){super(a,l,h,d),this._needsUV=!1,this._hasOutline=!1}doLoad(){return(0,B.Z)(function*(){})()}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if((0,y.pC)(this._material))return;const a=(0,y.U2)(this.symbolLayer,"material","color"),l=this._getCombinedOpacityAndColor(a);this._material=function $d(c,a,l){return function kd(c,a,l){return(0,y.pC)(c)?"none"===c.style||"solid"===c.style?("none"===c.style&&(a.color=(0,De.f)(0,0,0,0),a.transparent=!0),new Do.E(a)):(a.style=function Xd(c){switch(c){case"horizontal":return fi.b.Horizontal;case"vertical":return fi.b.Vertical;case"cross":return fi.b.Cross;case"forward-diagonal":return fi.b.ForwardDiagonal;case"backward-diagonal":return fi.b.BackwardDiagonal;case"diagonal-cross":return fi.b.DiagonalCross;default:return}}(c.style),a.draped=l.isDraped,new xa(a)):new Do.E(a)}(function Kd(c){return c&&c.pattern||null}(c),a,l)}(this.symbolLayer,{color:l,transparent:l[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof xa,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const a=this.symbolLayer.outline;!(0,y.pC)(this._outlineMaterial)&&this._isValidOutline(a)&&(this._hasOutline=!0,this._outlineMaterial=(h=>{const d=(0,Hn.Dp)(a.pattern);return new Sr.U({width:h,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:d,stippleScaleWithLineWidth:!0,cap:ta(a.patternCap||"butt")})})((0,Qe.F2)(a.size)),this._context.stage.add(this._outlineMaterial))}_isValidOutline(a){return(0,y.pC)(a)&&null!=a.size&&a.size>0&&(0,y.pC)(a.color)&&((0,y.Wi)(a.pattern)||"style"!==a.pattern.type||"none"!==a.pattern.style)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(a){const l=a.graphic;if(!this._validateGeometry(l.geometry,eu,this.symbolLayer.type))return null;const h=this._getVertexOpacityAndColor(a.renderingInfo,255),d=this.setGraphicElevationContext(l,new q.o);return this.ensureDrapedStatus("on-the-ground"===d.mode),this._ensureMaterials(),this.draped?this._createAsOverlay(l,h):this._createAs3DShape(l,h,d)}layerOpacityChanged(){if((0,y.pC)(this._material)){const a=this._material.parameters.color,l=(0,y.U2)(this.symbolLayer,"material","color"),h=this._getCombinedOpacity(l);this._material.setParameters({color:[a[0],a[1],a[2],h],transparent:h<1||this.needsDrivenTransparentPass})}if((0,y.pC)(this._outlineMaterial)){const a=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[a[0],a[1],a[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(a,l,h){const d=this._elevationContext.mode,u=(0,I.GC)(ps.elevationModeChangeTypes,h,d);if(u!==I.lO.UPDATE)return u;const p=(0,I.Xf)(d);return this.updateGraphics3DGraphicElevationInfo(a,l,()=>p)}slicePlaneEnabledChanged(){return(0,y.pC)(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(0,y.pC)(this._outlineMaterial)&&this._outlineMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_createAs3DShape(a,l,h){const d=cr(a.geometry);if((0,y.Wi)(d))return null;const u=Ys(d,this._context.elevationProvider,this._context.renderCoordsHelper,h),p=new tu(u,l,this._context.layer.uid,a.uid),g=p.renderData.position.length/3;if(this._needsUV&&(p.uvMapSpace=(0,vt.xx)(4*g,!0),p.boundingRect=(0,tt.bg)(9*g,!0),Lo(p.uvMapSpace,p.boundingRect,p.renderData.position,this._context.renderCoordsHelper)),p.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(p),this._createAs3DShapeFill(p),this._hasOutline&&this._createAs3DShapeOutline(p),this._logGeometryCreationWarnings(p.renderData,d.rings,"rings","FillSymbol3DLayer"),0===p.outGeometries.length)return null;const _=new Ci.T({geometries:p.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a.uid}}),v=new Ft(this,_,p.outGeometries,null,null,qd,h);return v.alignedSampledElevation=p.renderData.sampledElevation,v.needsElevationUpdates=(0,I.Xf)(h.mode),v}_createAs3DShapeFill(a){const l=a.renderData.polygons;for(const{position:h,mapPositions:d,holeIndices:u,index:p,count:g}of l){if((0,y.pC)(this._context.clippingExtent)&&((0,V.cS)(wt),(0,V.G1)(wt,d),!(0,V.Zp)(wt,this._context.clippingExtent)))continue;const _=(0,or.e)(d,u,3);if(0===_.length)continue;const v=gn({material:(0,y.Wg)(this._material),indices:_,mapPositions:d,attributeData:{position:h,color:a.color,uvMapSpace:this._needsUV?(0,vt.AA)(a.uvMapSpace,4*p,4*g):null,boundingRect:this._needsUV?(0,tt.Rq)(a.boundingRect,9*p,9*g):null,objectAndLayerIdColor:a.objectAndLayerIdColor}});a.outGeometries.push(v)}}_createAs3DShapeOutline(a){if(!this._hasOutline)return;const l=a.renderData.outlines;for(let h=0;h<l.length;++h){const{mapPositions:d,position:u}=l[h];if((0,y.pC)(this._context.clippingExtent)&&((0,V.cS)(wt),(0,V.G1)(wt,d),!(0,V.Zp)(wt,this._context.clippingExtent)))continue;const p=(0,ia.Y)((0,y.Wg)(this._outlineMaterial),{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:d,attributeData:{position:u}},a.objectAndLayerIdColor),g=p.vertexAttributes.get(T.T.POSITION);g.data===u&&(g.data=(0,tt.QZ)(u)),a.outGeometries.push(p)}}_createAsOverlay(a,l){const h=cr(a.geometry);if((0,y.Wi)(h))return null;(0,y.Wg)(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,(0,y.pC)(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority);const d=fn(h,this._context.overlaySR),u=new iu(d,l,this._context.layer.uid,a.uid);return this._needsUV&&(u.uvMapSpace=(0,vt.xx)(u.renderData.position.length/3*4,!0),function zd(c,a,l,h,d=1){if(l.isGeographic&&h===ci.JY.Global){const v=(0,tt.bg)(a.length),b=a.length,C=(0,cs.Iu)(l);for(let x=0;x<b;x+=3)(0,Se.gH)(a,x,v,x,C);a=v}(0,Ee.s)(He,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let v=0;v<a.length;v+=3)He[0]=Math.min(He[0],a[v]),He[1]=Math.min(He[1],a[v+1]);const g=He[0]-He[0]%d,_=He[1]-He[1]%d;for(let v=0;v<a.length;v+=3){const b=v/3*4;c[b]=(a[v]-g)/d,c[b+1]=(a[v+1]-_)/d,c[b+2]=g/d,c[b+3]=_/d}}(u.uvMapSpace,u.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),u.outBoundingBox=(0,V.cS)(),u.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(u),this._createAsOverlayFill(u),this._hasOutline&&this._createAsOverlayOutline(u),this._logGeometryCreationWarnings(u.renderData,h.rings,"rings","FillSymbol3DLayer"),0===u.outGeometries.length?null:new Yr(this,u.outGeometries,u.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(a){const l=a.renderData.polygons;for(const{position:h,holeIndices:d,index:u,count:p}of l){const g=(0,V.cS)(wt);if((0,V.G1)(g,h),!(0,V.Zp)(g,this._context.clippingExtent))continue;const _=(0,or.e)(h,d,3);if(0===_.length)continue;(0,V.TC)(a.outBoundingBox,g);const v=gn({material:(0,y.Wg)(this._material),indices:_,attributeData:{position:h,color:a.color,uvMapSpace:this._needsUV?(0,vt.AA)(a.uvMapSpace,4*u,4*p):null,objectAndLayerIdColor:a.objectAndLayerIdColor}}),b=new fr.z(v,a);(0,Hi.s)(b.boundingSphere,.5*(g[0]+g[3]),.5*(g[1]+g[4]),0,.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1]))),a.outGeometries.push(b)}}_createAsOverlayOutline(a){if(!this._hasOutline)return;const l=a.renderData.outlines;for(let h=0;h<l.length;++h){const{position:d}=l[h];if((0,V.cS)(wt),(0,V.G1)(wt,d),!(0,V.Zp)(wt,this._context.clippingExtent))continue;(0,V.TC)(a.outBoundingBox,wt);const u=(0,ia.Y)((0,y.Wg)(this._outlineMaterial),{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:d}},a.objectAndLayerIdColor),p=new fr.z(u,a);(0,Hi.s)(p.boundingSphere,.5*(wt[0]+wt[3]),.5*(wt[1]+wt[4]),0,.5*Math.sqrt((wt[3]-wt[0])*(wt[3]-wt[0])+(wt[4]-wt[1])*(wt[4]-wt[1]))),a.outGeometries.push(p)}}_getOutlineOpacity(){const a=(0,y.U2)(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*((0,y.pC)(a)?a.a:0)}_getOutlineColor(){const a=(0,y.U2)(this.symbolLayer,"outline","color"),l=this._getOutlineOpacity();return(0,Ne.Uu)((0,y.pC)(a)?K.Z.toUnitRGB(a):null,l)}test(){return{...super.test(),createAsOverlay:(a,l)=>this._createAsOverlay(a,l),createAs3DShape:(a,l,h)=>this._createAs3DShape(a,l,h)}}}ps.elevationModeChangeTypes={definedChanged:I.lO.RECREATE,staysOnTheGround:I.lO.NONE,onTheGroundChanged:I.lO.RECREATE};const wt=(0,V.Ue)();class tu extends jr{constructor(a,l,h,d){super(a,h,d),this.color=l}}class iu extends jr{constructor(a,l,h,d){super(a,h,d),this.color=l}}class ru{constructor(a=null,l="center",h="center",d=null,u=[0,0,0],p=0,g=[0,0,0,1],_=[0,0],v="world",b=0,C=0){this.verticalOffset=a,this.horizontalPlacement=l,this.verticalPlacement=h,this.text=d,this.translation=u,this.elevationOffset=p,this.centerOffset=g,this.screenOffset=_,this.centerOffsetUnits=v,this.displayWidth=b,this.displayHeight=C}}class Pa{constructor(a){this.definition=a,this.key=JSON.stringify(a),this.haloSize=Math.round(a.halo.size),this.textStyle=this._colorToRGBA(a.color),this.haloStyle=this._colorToRGB(a.halo.color),this.backgroundStyle=0!==a.background.color[3]?this._colorToRGBA(a.background.color):null}fontString(a){const l=this.definition.font;return`${l.style} ${l.weight} ${a}px ${l.family}, sans-serif`}_colorToRGB(a){return`rgb(${a.slice(0,3).map(l=>Math.floor(255*l)).toString()})`}_colorToRGBA(a){return`rgba(${a.slice(0,3).map(l=>Math.floor(255*l)).toString()},${a[3]})`}static fromSymbol(a,l){return(0,B.Z)(function*(){const h=(0,y.U2)(a,"material","color"),d=(0,y.R2)(h,De.Z,K.Z.toUnitRGBA),u=(0,y.R2)(a.size,12,Qe.F2),p=a.lineHeight,g=(0,y.pC)(a.background)?(0,y.Wg)(K.Z.toUnitRGBA(a.background.color)):De.Z,_={family:(0,y.R2)(a.font,"sans-serif",R=>R.family),decoration:(0,y.R2)(a.font,"none",R=>R.decoration),weight:(0,y.R2)(a.font,"normal",R=>R.weight),style:(0,y.R2)(a.font,"normal",R=>R.style)},v=a.halo,b=(0,y.pC)(v)&&(0,y.pC)(v.color)&&v.size>0?{size:(0,Qe.F2)(v.size),color:K.Z.toUnitRGBA(v.color)}:{size:0,color:De.Z},C=new Pa({color:d,size:u,background:{color:g,padding:(0,y.pC)(a.background)?[.65*u,.5*u]:[0,0],borderRadius:(0,y.pC)(a.background)?u*(6/16):0},lineSpacingFactor:p,font:_,halo:b,pixelRatio:l}),x=C.fontString(u);try{yield document.fonts.load(x)}catch{bi.Z.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${x}'. Some text symbology may be rendered using the default browser font.`)}return C})()}}class su{constructor(a,l,h){this._renderer=new Sc(a,l,h)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const a=ks(au,this._renderer.renderedWidth,this._renderer.renderedHeight),l=a.getContext("2d");return l.save(),this._renderer.render(l,0,0),l.restore(),new qs.x(a,{wrap:{s:Et.e8.CLAMP_TO_EDGE,t:Et.e8.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:Pe.CE.PAD})}}const au={canvas:null},nu=[0,0,1];function Mo(c,a,l){c&&c.forEach(h=>{const d=a(h);(0,y.pC)(d)&&l(d,h.graphic)})}const cu={mode:"relative-to-ground",offset:0};var Uo=S(90978);const hu={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},du=["polyline","polygon","extent"];class Zt extends Bt{constructor(a,l,h,d){super(a,l,h,d)}doLoad(){return(0,B.Z)(function*(){})()}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(a){const l=a.graphic;if(!this._validateGeometry(l.geometry,du,this.symbolLayer.type))return null;const h=this.setGraphicElevationContext(l,new q.o);return this.ensureDrapedStatus("on-the-ground"===h.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(l):this._createAs3DShape(l,h,l.uid)}ensureMaterial(){if((0,y.pC)(this._material))return;const a=new Uo.m,l=this.symbolLayer.color;(0,y.pC)(l)&&(a.color=K.Z.toUnitRGBA(l));const h=this._getCombinedOpacity(l,{hasIntrinsicColor:!0});a.color=[a.color[0],a.color[1],a.color[2],h],a.transparent=h<1||this.needsDrivenTransparentPass,a.waveDirection=(0,y.pC)(this.symbolLayer.waveDirection)?Zt.headingVectorFromAngle(this.symbolLayer.waveDirection):(0,oe.f)(0,0);const u=hu[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];a.waveStrength=u.waveStrength,a.waveTextureRepeat=u.textureRepeat,a.waveVelocity=u.waveVelocity,a.flowStrength=u.perturbationStrength,a.hasSlicePlane=this._context.slicePlaneEnabled,a.isDraped=this.draped,this._material=new Uo.H(a),this._context.stage.add(this._material)}layerOpacityChanged(){if((0,y.Wi)(this._material))return;const a=this._material.parameters.color,l=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});this._material.setParameters({color:[a[0],a[1],a[2],l],transparent:l<1||this.needsDrivenTransparentPass})}layerElevationInfoChanged(a,l,h){const d=this._elevationContext.mode,u=(0,I.GC)(Zt.elevationModeChangeTypes,h,d);if(u!==I.lO.UPDATE)return u;const p=(0,I.Xf)(d);return this.updateGraphics3DGraphicElevationInfo(a,l,()=>p)}slicePlaneEnabledChanged(){return(0,y.pC)(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_createAs3DShape(a,l,h){const d=cr(a.geometry);if((0,y.Wi)(d))return null;const u=Ys(d,this._context.elevationProvider,this._context.renderCoordsHelper,l),p=u.position.length/3,g=(0,tt.bg)(2*p);this._createUVCoordsFromVertices(g,u.mapPositions,p,this._context.elevationProvider.spatialReference);const _=new uu(u,g);if(this._create3DShapeGeometries(_),this._logGeometryCreationWarnings(_.renderData,d.rings,"rings","WaterSymbol3DLayer"),0===_.outGeometries.length)return null;const v=new Ci.T({geometries:_.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:h}}),b=new Ft(this,v,_.outGeometries,null,null,Ha,l);return b.alignedSampledElevation=_.renderData.sampledElevation,b.needsElevationUpdates=(0,I.Xf)(l.mode),b}_createUVCoordsFromVertices(a,l,h,d){const u=(0,Ws.c9)(d);(0,ze.cS)(_i);for(let _=0;_<h;_++)(0,Ee.s)(Go,l[3*_],l[3*_+1]),(0,ze.Ho)(_i,Go);(0,Hi.b)(_i,_i,u);const g=_i[1]%Zt.unitSizeOfTexture;gs[0]=_i[0]-_i[0]%Zt.unitSizeOfTexture,gs[1]=_i[1]-g;for(let _=0;_<h;_++)a[2*_]=(l[3*_]*u-gs[0])/Zt.unitSizeOfTexture,a[2*_+1]=(l[3*_+1]*u-gs[1])/Zt.unitSizeOfTexture}_create3DShapeGeometries(a){const l=a.renderData.polygons,h=a.uvCoords;for(const{count:d,index:u,position:p,mapPositions:g,holeIndices:_}of l){if((0,y.pC)(this._context.clippingExtent)&&((0,V.cS)(vi),(0,V.G1)(vi,g),!(0,V.Zp)(vi,this._context.clippingExtent)))continue;const v=(0,or.e)(g,_,3);if(0===v.length)continue;const b=(0,tt.Rq)(h,2*u,2*d),C=mn({material:(0,y.Wg)(this._material),indices:v,mapPositions:g,attributeData:{position:p,uv0:b}});a.outGeometries.push(C)}}_createAsOverlay(a){const l=cr(a.geometry);if((0,y.Wi)(l))return null;(0,y.Wg)(this._material).renderPriority=this._renderPriority;const h=fn(l,this._context.overlaySR),d=h.position.length/3,u=(0,tt.bg)(2*d);this._createUVCoordsFromVertices(u,h.position,d,this._context.overlaySR);const p=new pu(h,u,this._context.layer.uid,a.uid);return p.outBoundingBox=(0,V.cS)(),this._createAsOverlayWater(p),this._logGeometryCreationWarnings(p.renderData,l.rings,"rings","WaterSymbol3DLayer"),0===p.outGeometries.length?null:new Yr(this,p.outGeometries,p.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(a){const l=a.uvCoords,h=a.renderData.polygons;for(const{position:d,holeIndices:u,index:p,count:g}of h){if((0,V.cS)(vi),(0,V.G1)(vi,d),!(0,V.Zp)(vi,this._context.clippingExtent))continue;(0,V.TC)(a.outBoundingBox,vi);const _=(0,or.e)(d,u,3);if(0===_.length)continue;const v=(0,tt.Rq)(l,2*p,2*g),b=mn({material:(0,y.Wg)(this._material),indices:_,attributeData:{position:d,uv0:v}}),C=new fr.z(b,a);(0,Hi.s)(C.boundingSphere,.5*(vi[0]+vi[3]),.5*(vi[1]+vi[4]),0,.5*Math.sqrt((vi[3]-vi[0])*(vi[3]-vi[0])+(vi[4]-vi[1])*(vi[4]-vi[1]))),a.outGeometries.push(C)}}static headingVectorFromAngle(a){const l=(0,oe.a)(),h=(0,ho.t)(a);return l[0]=Math.sin(h),l[1]=Math.cos(h),l}test(){return{...super.test(),create3DShape:a=>this._createAs3DShape(a.graphic,a.elevationContext,a.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}}Zt.unitSizeOfTexture=100,Zt.elevationModeChangeTypes={definedChanged:I.lO.RECREATE,staysOnTheGround:I.lO.NONE,onTheGroundChanged:I.lO.RECREATE};const gs=(0,oe.a)(),_i=(0,ze.Ue)(),Go=(0,oe.a)(),vi=(0,V.Ue)();class uu extends jr{constructor(a,l){super(a,null,null),this.uvCoords=l}}class pu extends jr{constructor(a,l,h,d){super(a,h,d),this.uvCoords=l}}function gu(c,a,l,h){const d=Vo[c.type]&&Vo[c.type][a.type]||zo[a.type];return d?new d(c,a,l,h):(bi.Z.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${a.type}`),null)}const zo={icon:_r,object:class Bh extends Bt{getCachedSize(){const[a,l,h]=(0,y.pC)(this._resources)?this._resources.symbolSize:[1,1,1];return{width:a,depth:l,height:h}}constructor(a,l,h,d){super(a,l,h,d),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=h.physicalBasedRenderingEnabled}doLoad(a){var l=this;return(0,B.Z)(function*(){if(!l._drivenProperties.size&&(0,Ne.bh)(l.symbolLayer))throw new Error;const h=l.symbolLayer;if(l._isPrimitive){const d=h.resource?h.resource.primitive:ka.S;l._resources=yield l._createResourcesForPrimitive(d,a)}else l._resources=yield l._createResourcesForUrl(h.resource.href,a);l.layerOpacityChanged(),l.slicePlaneEnabledChanged(),l.physicalBasedRenderingChanged(),l.complexity=l.computeComplexity()})()}get extentPadding(){return(0,y.pC)(this._resources)?this._resources.extentPadding:0}get _isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return(0,y.pC)(this._resources)?this._resources.lodRenderer:null}_setMaterialTransparencyParams(a,l=(0,y.U2)(this.symbolLayer,"material","color")){const h=this._getCombinedOpacity(l),d=h<1||this.needsDrivenTransparentPass;return a.transparent=d,a.opacity=h,a.cullFace=d?Pe.Vr.None:Pe.Vr.Back,a}_createResourcesForPrimitive(a,l){var h=this;return(0,B.Z)(function*(){if(!function Vl(c){switch(c){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}(a))throw new Error(`Unknown object symbol primitive: ${a}`);const d=h.symbolLayer,u=(0,V.Ue)((0,rs.Uz)(a)),p=(0,G.d)((0,V.dp)(u)),g=(0,G.d)((0,rs.$K)(p,d)),_=(0,E.l)(g),C={usePBR:h._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:G.O,diffuse:G.O,hasSlicePlane:h._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:h.symbolLayer.castShadows,offsetTransparentBackfaces:!h.symbolLayer.isPrimitive},x=!!C.usePBR;h._setMaterialTransparencyParams(C);const R=h.symbol;if("point-3d"===R.type&&R.verticalOffset){const{screenLength:te,minWorldLength:ee,maxWorldLength:le}=R.verticalOffset;C.verticalOffset={screenLength:(0,Qe.F2)(te),minWorldLength:ee||0,maxWorldLength:(0,y.pC)(le)?le:1/0},C.castShadows=!1}if(h._context.screenSizePerspectiveEnabled&&(C.screenSizePerspective=h._context.sharedResources.screenSizePerspectiveSettings),h._drivenProperties.color)C.externalColor=De.O;else{const te=(0,y.pC)(d.material)?d.material.color:null,ee=(0,y.pC)(te)?K.Z.toUnitRGBA(te):De.O;C.externalColor=ee}h._fastUpdates=gr(h._context.renderer,h._fastVisualVariableConvertOptions(u,g,p,y.YP)),C.instanced=["transformation"],h._fastUpdates.enabled?(Object.assign(C,h._fastUpdates.materialParameters),C.instanced.push("featureAttribute"),h._optionalFields.push("featureAttribute")):h._hasPerInstanceColor()&&(C.instanced.push("color"),h._optionalFields.push("color")),(0,Cs.Z)("enable-feature:objectAndLayerId-rendering")&&(C.instanced.push("objectAndLayerIdColor"),h._optionalFields.push("objectAndLayerIdColor"));const O=new hr.Gp(C),M=rn(a,O);if(!M)throw new Error(`Unknown object symbol primitive: ${a}`);const F=wr(M).map(te=>({opacity:1,transparent:te.parameters.transparent})),H=yield h._createStageResources(M,x,l),N=yield h._createLodRenderer(M,l);return new lo(M,N,H,F,p,!1,!1,u,g,_,x,y.YP)})()}_createResourcesForUrl(a,l){var h=this;return(0,B.Z)(function*(){const d=["transformation"],u={materialParamsMixin:{instanced:d,hasSlicePlane:h._context.slicePlaneEnabled,castShadows:h.symbolLayer.castShadows},streamDataRequester:h._context.streamDataRequester,cache:h._context.sharedResources.objectResourceCache};h._fastUpdates=gr(h._context.renderer,h._fastVisualVariableConvertOptions(y.YP,y.YP,y.YP,y.YP)),h._fastUpdates.enabled?(Object.assign(u.materialParamsMixin,h._fastUpdates.materialParameters),d.push("featureAttribute"),h._optionalFields.push("featureAttribute")):h._hasPerInstanceColor()&&(d.push("color"),h._optionalFields.push("color")),(0,Cs.Z)("enable-feature:objectAndLayerId-rendering")&&(d.push("objectAndLayerIdColor"),h._optionalFields.push("objectAndLayerIdColor"));const p=h.symbol;if("point-3d"===p.type&&p.verticalOffset){const{screenLength:Fe,minWorldLength:Ye,maxWorldLength:ct}=p.verticalOffset;u.materialParamsMixin.verticalOffset={screenLength:(0,Qe.F2)(Fe),minWorldLength:Ye||0,maxWorldLength:(0,y.pC)(ct)?ct:1/0},u.materialParamsMixin.castShadows=!1}u.signal=l,u.usePBR=h._context.physicalBasedRenderingEnabled,u.skipHighLods=h._context.skipHighSymbolLods;const g=u.usePBR,_=yield(0,mh.fetch)(a,u),v=_.isEsriSymbolResource,b=_.isWosr,C=function gh(c){return{levels:c.map(a=>function ph(c){const a=new Array;return c.stageResources.geometries.forEach(l=>{a.push(new Qa(l,c.stageResources.textures))}),{components:a,minScreenSpaceRadius:(0,y.Pt)(c.lodThreshold,0),pivotOffset:c.pivotOffset}}(a))}}(_.lods);C.levels.sort((Fe,Ye)=>Fe.minScreenSpaceRadius-Ye.minScreenSpaceRadius);const x=h._context,O=h._getExternalColorParameters(h.symbolLayer.material),M=(0,y.U2)(h.symbolLayer,"material","color"),F=h._getCombinedOpacity(M,{hasIntrinsicColor:!0}),H=h.needsDrivenTransparentPass,N=wr(C),te=wr(C).map(Fe=>({opacity:Fe.parameters.opacity||1,transparent:Fe.parameters.transparent}));N.forEach(Fe=>{const Ye=Fe.parameters;Fe.setParameters(O);const ct=Ye.opacity*F;Fe.setParameters({opacity:ct,transparent:ct<1||H||Ye.transparent}),x.screenSizePerspectiveEnabled&&Fe.setParameters({screenSizePerspective:x.sharedResources.screenSizePerspectiveSettings})});const ee=_.referenceBoundingBox,le=(0,G.d)((0,V.dp)(ee)),fe=(0,G.d)(C.levels[0].pivotOffset),Ce=(0,G.d)((0,rs.$K)(le,h.symbolLayer)),ie=(0,E.l)(Ce);mr(h._fastUpdates,h._context.renderer,h._fastVisualVariableConvertOptions(ee,Ce,le,fe))&&N.forEach(Fe=>Fe.setParameters(h._fastUpdates.materialParameters));const ge=yield h._createStageResources(C,g,l),Ge=yield h._createLodRenderer(C,l);return new lo(C,Ge,ge,te,le,v,b,ee,Ce,ie,g,fe)})()}_addDisposeResource(a){this._disposeResourceHandles.push(a)}_createStageResources(a,l,h){var d=this;return(0,B.Z)(function*(){const u=d._context.stage,p=wr(a);l!==d._context.physicalBasedRenderingEnabled&&d.physicalBasedRenderingChanged(),u.addMany(p),d._addDisposeResource(()=>u.removeMany(p));const g=qa(a);u.addMany(g),d._addDisposeResource(()=>u.removeMany(g)),yield u.load(g,h),(0,j.k_)(h);const _=tn(a);return u.addMany(_),d._addDisposeResource(()=>u.removeMany(_)),{materials:p,textures:g,geometries:_}})()}_createLodRenderer(a,l){var h=this;return(0,B.Z)(function*(){const d=h._context.stage,u={layerUid:h._context.layer.uid,graphicUid:_=>h._instanceIndexToGraphicUid.get(_),notifyGraphicGeometryChanged:_=>h._context.notifyGraphicGeometryChanged(h._instanceIndexToGraphicUid.get(_)),notifyGraphicVisibilityChanged:_=>h._context.notifyGraphicVisibilityChanged(h._instanceIndexToGraphicUid.get(_))},p=h._fastUpdates.enabled?{applyTransform:(_,v,b)=>{_.getFeatureAttribute(v,ss),(0,Be.c)(b,Qs(h._fastUpdates.materialParameters,ss,b))},scaleFactor:(_,v,b)=>(v.getFeatureAttribute(b,ss),function zc(c,a,l){if(!a.vvSizeEnabled)return(0,E.s)(c,1,1,1);for(let h=0;h<3;++h)c[h]=(0,Lt.uZ)(a.vvSizeOffset[h]+l[0]*a.vvSizeFactor[h],a.vvSizeMinSize[h],a.vvSizeMaxSize[h]);return c}(_,h._fastUpdates.materialParameters,ss))}:null,g=new Dt({symbol:a,optionalFields:h._optionalFields,metadata:u,shaderTransformation:p},h._context.scheduler);return g.slicePlaneEnabled=h._context.slicePlaneEnabled,h._addDisposeResource(()=>{d.removeRenderPlugin(g),g.destroy()}),yield d.addRenderPlugin(g.slots,g,l),g})()}_getExternalColorParameters(a){const l={};return this._drivenProperties.color?l.externalColor=De.O:(0,y.pC)(a)&&(0,y.pC)(a.color)?l.externalColor=K.Z.toUnitRGBA(a.color):(l.externalColor=De.O,l.colorMixMode="ignore"),l}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(a=>a()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(a){const l=a.graphic;if(!this._validateGeometry(l.geometry))return null;const h=nr(l.geometry);if((0,y.Wi)(h))return this.logger.warn(`unsupported geometry type for icon symbol: ${l.geometry.type}`),null;const d=this.setGraphicElevationContext(l,new q.o);return this._createAs3DShape(l,h,a.renderingInfo,d,l.uid,a.layer.uid)}notifyDestroyGraphicLayer(a){this._instanceIndexToGraphicUid.delete(a.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if((0,y.Wi)(this._resources))return;const a=this._drivenProperties.opacity,l=!this._isPrimitive,h=this._resources.stageResources.materials,d=this._resources.originalMaterialParameters;for(let u=0;u<h.length;u++){const p=h[u],g=(0,y.U2)(this.symbolLayer,"material","color"),_=d[u],v=this._getCombinedOpacity(g,{hasIntrinsicColor:l})*_.opacity,b=v<1||a||_.transparent;p.setParameters({opacity:v,transparent:b}),this._isPrimitive&&p.setParameters({cullFace:b?Pe.Vr.None:Pe.Vr.Back})}}layerElevationInfoChanged(a,l){return this.updateGraphics3DGraphicElevationInfo(a,l,I.B5)}slicePlaneEnabledChanged(){if((0,y.Wi)(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const a of this._resources.stageResources.materials)a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if((0,y.Wi)(this._resources))return!0;const{stageResources:a,isWosr:l}=this._resources;for(const h of a.materials)this._isPrimitive?h.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):l||h.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!1}applyRendererDiff(a,l){if((0,y.Wi)(this._resources))return Ue.Recreate_Symbol;const{stageResources:{materials:h},lodRenderer:d,resourceBoundingBox:u,symbolSize:p,resourceSize:g,pivotOffset:_}=this._resources;for(const v in a.diff){if("visualVariables"!==v||!mr(this._fastUpdates,l,this._fastVisualVariableConvertOptions(u,p,g,_)))return Ue.Recreate_Symbol;for(const b of h)b.setParameters(this._fastUpdates.materialParameters);d.notifyShaderTransformationChanged()}return Ue.Fast_Update}computeComplexity(){if((0,y.Wi)(this._resources))return super.computeComplexity();const a=this._resources.lodResources,l=en(a.levels[0]).reduce((u,p)=>u+p.indices.get(T.T.POSITION).length,0)/3,d=qa(a).reduce((u,p)=>u+(p.params.encoding&&"image/ktx2"===p.params.encoding?p.estimatedTexMemRequired:p.estimatedTexMemRequired/4),0)+tn(a).reduce((u,p)=>u+(u=>Array.from(u.vertexAttributes.values()).reduce((p,g)=>p+(g.data.buffer?.byteLength??0),0)+Array.from(u.indices.values()).reduce((p,g)=>p+(Array.isArray(g)?12*g.length:g.buffer.byteLength),0))(p),0);return{primitivesPerFeature:l,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:{...nn(this.symbol,this.symbolLayer),resourceBytes:d}}}_hasLodRenderer(){return(0,y.pC)(this._resources)}_createAs3DShape(a,l,h,d,u,p){if(!this._hasLodRenderer()||(0,y.Wi)(this._resources))return null;const g=this.getFastUpdateAttrValues(a),_=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?(0,Ne.Uu)(h.color,h.opacity):null,v=this._context.clippingExtent;if((0,Se.KC)(l,Ji,this._context.elevationProvider.spatialReference),(0,y.pC)(v)&&!(0,V.BD)(v,Ji))return null;const b=this._requiresTerrainElevation(d),C=this._computeGlobalTransform(l,d,da,as),x=this._computeLocalTransform(this._resources,this.symbolLayer,h,co),R=this._resources.lodRenderer.instanceData,O=R.addInstance();this._instanceIndexToGraphicUid.set(O,u),R.setLocalTransform(O,x,!1),R.setGlobalTransform(O,C),g&&R.setFeatureAttribute(O,g),_&&R.setColor(O,_),(0,y.pC)(this._context.stage.renderView.objectAndLayerIdRenderHelper)&&R.setObjectAndLayerIdColor(O,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:u,layerUid:p}));const M=new dh(this,O,wl,d);return b&&(M.alignedSampledElevation=as.sampledElevation),M.needsElevationUpdates=(0,I.B5)(d.mode),ar(M,l,this._context.elevationProvider),M}_computeGlobalTransform(a,l,h,d){return(0,I.qZ)(a,this._context.elevationProvider,l,this._context.renderCoordsHelper,d),Ji[0]=a.x,Ji[1]=a.y,Ji[2]=d.z,(0,Se.Bm)(a.spatialReference,Ji,h,this._context.renderCoordsHelper.spatialReference),h}_computeLocalTransform(a,l,h,d){return(0,Be.i)(d),this._applyObjectRotation(h,!1,d),this._applyObjectRotation(l,!0,d),this._applyObjectScale(a,h,d),this._applyAnchor(a,l,d),d}_applyObjectScale(a,l,h){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const u=(0,Ne.bD)(this._drivenProperties.size&&l.size?l.size:a.symbolSize,a.symbolSize,a.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===u[0]&&1===u[1]&&1===u[2]||(0,Be.k)(h,h,u)}prepareSymbolLayerPatch(a){if("partial"!==a.diff.type)return;const l=a.diff.diff;this._preparePatchTransform(a,l),this._preparePatchColor(a,l)}updateGeometry(a,l){if((0,y.Wi)(this._resources))return!0;const h=l&&nr(l);if((0,y.Wi)(h))return!1;const d=this.getGeometryElevationMode(l);return a.elevationContext.mode===d&&(this._computeGlobalTransform(h,a.elevationContext,da,as),this._requiresTerrainElevation(a.elevationContext)&&(a.alignedSampledElevation=as.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(a.instanceIndex,da,!0),ar(a,h,this._context.elevationProvider),!0)}_preparePatchTransform(a,l){if(!(l.heading||l.tilt||l.roll||l.width||l.height||l.depth||l.anchor||l.anchorPosition)||(0,y.Wi)(this._resources))return;const h=(O,M,F)=>(0,y.Pt)(null!=O&&"complete"===O.type?O.newValue:M,F),d=h(l.heading,this.symbolLayer.heading,0),u=h(l.tilt,this.symbolLayer.tilt,0),p=h(l.roll,this.symbolLayer.roll,0),g=h(l.width,this.symbolLayer.width,void 0),_=h(l.height,this.symbolLayer.height,void 0),v=h(l.depth,this.symbolLayer.depth,void 0),b=h(l.anchor,this.symbolLayer.anchor,void 0),C=h(l.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete l.heading,delete l.tilt,delete l.roll,delete l.width,delete l.height,delete l.depth,delete l.anchor,delete l.anchorPosition;const x={heading:d,tilt:u,roll:p,anchor:b,anchorPosition:C},R=this._resources;this.loadStatus===ft.LOADED&&a.symbolLayerStatePatches.push(()=>{R.symbolSize=(0,G.d)((0,rs.$K)(R.resourceSize,{width:g,height:_,depth:v,isPrimitive:this.symbolLayer.isPrimitive}))}),a.graphics3DGraphicPatches.push((O,M)=>{const F=this._computeLocalTransform(R,x,M,co);R.lodRenderer.instanceData.setLocalTransform(O.instanceIndex,F,!0)})}_preparePatchColor(a,l){if(!l.material||"partial"!==l.material.type)return;const h=l.material.diff;if(!h.color||"complete"!==h.color.type||null==h.color.newValue||null==h.color.oldValue)return;const d=h.color.newValue,u=(0,y.pC)(d)?K.Z.toUnitRGBA(d):De.O;delete h.color;const p=this._resources;(0,y.Wi)(p)||a.graphics3DGraphicPatches.push(g=>{let _;this._hasPerInstanceColor()?(p.lodRenderer.instanceData.setColor(g.instanceIndex,u),_=this._setMaterialTransparencyParams({},d)):_=this._setMaterialTransparencyParams({externalColor:u},d);for(const v of p.stageResources.materials)v.setParameters(_)})}_requiresTerrainElevation(a){return"absolute-height"!==a.mode}_applyObjectRotation(a,l,h){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&l))return(0,Ne._Z)(a.heading,a.tilt,a.roll,h)}_computeAnchor(a,l,h){const d=(0,G.c)();switch(h.anchor){case"center":(0,E.c)(d,(0,V.be)(a)),(0,E.o)(d,d);break;case"top":{const u=(0,V.be)(a);(0,E.s)(d,-u[0],-u[1],-a[5]);break}case"bottom":{const u=(0,V.be)(a);(0,E.s)(d,-u[0],-u[1],-a[2]);break}case"relative":{const u=(0,V.be)(a),p=(0,V.dp)(a),g=h.anchorPosition,_=g?(0,G.f)(g.x,g.y,g.z):G.Z;(0,E.B)(d,p,_),(0,E.a)(d,d,u),(0,E.o)(d,d);break}default:(0,y.pC)(l)?(0,E.o)(d,l):(0,E.c)(d,G.Z)}return d}_applyAnchor(a,l,h){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const d=this._computeAnchor(a.resourceBoundingBox,a.pivotOffset,l);d&&(0,Be.w)(h,h,d)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(a,l,h,d){const u=(0,y.pC)(a)?(0,G.d)((0,V.dp)(a)):G.O,p=(0,y.pC)(a)?this._computeAnchor(a,d,this.symbolLayer):G.Z,g=this._context.renderCoordsHelper.unitInMeters,_=(0,Ne.bD)((0,y.pC)(l)?l:void 0,l,h,g),v=(0,G.f)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:u,symbolSize:(0,y.pC)(l)?l:G.O,unitInMeters:g,transformation:{anchor:p,scale:_,rotation:v}}}},line:es,path:class wd extends Bt{constructor(a,l,h,d){super(a,l,h,d),this._intrinsicSize=(0,oe.f)(1,1),this._upVectorAlignment=gi.Path,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}doLoad(){var a=this;return(0,B.Z)(function*(){const l=(0,y.pC)(a.symbolLayer.width)?a.symbolLayer.width:a.symbolLayer.height,h=(0,y.pC)(a.symbolLayer.height)?a.symbolLayer.height:l;a._vvConvertOptions={modelSize:[1,1,1],symbolSize:[l,1,h],unitInMeters:a._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},a._fastUpdates=a._context.renderer&&a._context.renderer.visualVariables&&a._context.renderer.visualVariables.length>0?gr(a._context.renderer,a._vvConvertOptions):{enabled:!1};const d=a.symbolLayer.anchor||"center";a._upVectorAlignment="heading"===a.symbolLayer.profileRotation?gi.World:gi.Path;const u=a.symbolLayer.profile||"circle";switch(u){default:case"circle":a._profile=function gd(c=20){const l=new fo,h={v0:0,v1:0};l.addPole((0,oe.f)(0,0));for(let u=0;u<c;++u){const p=2*u*Math.PI/c,g=Math.cos(p),_=Math.sin(p),v=(0,oe.f)(.5*g,.5*_),b=(0,oe.f)(g,_);l.addVertex(v,b)}for(let u=0;u<c-1;++u)l.addSegment({v0:u,v1:u+1},h);return l.addSegment({v0:c-1,v1:0},h),l}(10);break;case"quad":a._profile=function md(){const l=new fo,h=(0,oe.f)(-.5,-.5),d=(0,oe.f)(.5,-.5),u=(0,oe.f)(.5,.5),p=(0,oe.f)(-.5,.5),g=(0,oe.f)(0,-1),_=(0,oe.f)(1,0),v=(0,oe.f)(0,1),b=(0,oe.f)(-1,0);return l.addPole((0,oe.f)(0,.5),v),l.addPole((0,oe.f)(0,.5)),l.addPole((0,oe.f)(0,-.5)),l.addPole((0,oe.f)(0,-.5),g),l.addVertex(h,g),l.addVertex(d,g),l.addSegment({v0:0,v1:1},{v0:3,v1:3}),l.addVertex(d,_),l.addVertex(u,_),l.addSegment({v0:2,v1:3},{v0:2,v1:1}),l.addVertex(u,v),l.addVertex(p,v),l.addSegment({v0:4,v1:5},{v0:0,v1:0}),l.addVertex(p,b),l.addVertex(h,b),l.addSegment({v0:6,v1:7},{v0:1,v1:2}),l}()}let p=[0,0];switch("center"!==d&&(p={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[d],a._profile.translate(p[0],p[1])),a.symbolLayer.join){case"round":a._extruder=new ga(0,3);break;case"bevel":a._extruder=new ga(0,1);break;case"miter":a._extruder=new ga(.8*Math.PI,1);break;default:a._extruder=new _d}const g=a.symbolLayer.cap||"butt";switch(g){case"none":a._startCap=new _o,a._endCap=new _o;break;case"butt":default:a._startCap=new ns(a._profile,0),a._endCap=new ns(a._profile,0,!0);break;case"square":a._startCap=new ns(a._profile,-.5),a._endCap=new ns(a._profile,.5,!0);break;case"round":{const O="quad"===u;a._startCap=new vo({profile:a._profile,flip:!1,breakNormals:O,subdivisions:3}),a._endCap=new vo({profile:a._profile,flip:!0,breakNormals:O,subdivisions:3});break}}const _=(0,y.U2)(a.symbolLayer,"material","color"),v=a._getCombinedOpacityAndColor(_),b=(0,G.d)(v),C=v[3],x=C<1||a.needsDrivenTransparentPass,R={diffuse:b,ambient:b,opacity:C,transparent:x,hasVertexColors:!1,hasSlicePlane:a._context.slicePlaneEnabled,castShadows:a.symbolLayer.castShadows,cullFace:x||"none"===g?Pe.Vr.None:Pe.Vr.Back,offsetTransparentBackfaces:!0};if(!a._drivenProperties.size&&((0,Ee.s)(a._intrinsicSize,l,h),!(0,Ne.ZL)(a._intrinsicSize[0])||!(0,Ne.ZL)(a._intrinsicSize[1])))throw new ne.Z("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(a._fastUpdates.enabled&&a._fastUpdates.visualVariables.size||(0,Ee.b)(a._intrinsicSize,a._intrinsicSize,1/a._context.renderCoordsHelper.unitInMeters),a._fastUpdates.enabled){const O={...R,...a._fastUpdates.materialParameters,size:(0,oe.b)(a._intrinsicSize)};a._material=new _a(O)}else R.hasVertexColors=a._drivenProperties.color||a._drivenProperties.opacity,a._material=new hr.Gp(R);a._material.setParameters({usePBR:a._context.physicalBasedRenderingEnabled,isSchematic:!0}),a._context.stage.add(a._material)})()}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(a){const l=a.graphic;if(!this._validateGeometry(l.geometry,Dd,this.symbolLayer.type))return null;const h=this.setGraphicElevationContext(l,new q.o);return this._createAs3DShape(l,a.renderingInfo,h,l.uid)}layerOpacityChanged(){const a=(0,y.U2)(this.symbolLayer,"material","color"),l=this._getCombinedOpacity(a);this._material.setParameters({opacity:l,transparent:l<1||this.needsDrivenTransparentPass})}layerElevationInfoChanged(a,l){return this.updateGraphics3DGraphicElevationInfo(a,l,I.B5)}slicePlaneEnabledChanged(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}applyRendererDiff(a,l){for(const h in a.diff){if("visualVariables"!==h||!mr(this._fastUpdates,l,this._vvConvertOptions))return Ue.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return Ue.Fast_Update}_getVertexData(a){let l=0;const h=a.paths,d=[],u=a.spatialReference,p=this._context.elevationProvider.spatialReference,g=this._context.renderCoordsHelper.spatialReference;for(const x of h)l+=x.length;const _=(0,tt.bg)(3*l),v=(0,tt.bg)(3*l);let b=0;for(const x of h){d.push({index:b,numVertices:x.length});for(const R of x)_[b++]=R[0],_[b++]=R[1],_[b++]=a.hasZ?R[2]:0}let C=!0;return(0,y.pC)(p)&&!u.equals(p)&&(C=(0,Se.CM)(_,u,0,_,p,0,l)),(0,y.pC)(p)&&!p.equals(g)?(0,Se.CM)(_,p,0,v,g,0,l):this._copyVertices(_,0,v,0,l),{pathVertexDataInfos:d,vertexDataES:_,vertexDataRS:v,projectionSuccess:C,terrainElevation:0}}_copyVertices(a,l,h,d,u){l*=3,d*=3;for(let p=0;p<u;++p)h[d++]=a[l++],h[d++]=a[l++],h[d++]=a[l++]}_createAs3DShape(a,l,h,d){const u=a.geometry,p=new Array,g=u.spatialReference,_=(0,V.Ue)(),v=this._context.renderCoordsHelper;To.spatialReference=g;const b=this._getVertexData(u);if(!b.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0===b.pathVertexDataInfos.length)return 0!==u.paths.length&&u.paths.some(O=>O.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;for(const O of b.pathVertexDataInfos){const M=O.index,F=O.numVertices;if(F<2||(0,y.pC)(this._context.clippingExtent)&&((0,V.cS)(_),(0,V.G1)(_,b.vertexDataES,3*M,F),!(0,V.Zp)(_,this._context.clippingExtent)))continue;const H=[];for(let ge=M;ge<M+3*F;){const Ge=ge++,Fe=ge++,Ye=ge++,ct=new pd;(0,E.s)(ct.posES,b.vertexDataES[Ge],b.vertexDataES[Fe],b.vertexDataES[Ye]);const ri=(0,I.w7)(ct.posES,this._context.elevationProvider,h,v);(0,E.s)(Te,b.vertexDataRS[Ge],b.vertexDataRS[Fe],b.vertexDataRS[Ye]),v.setAltitude(Te,ri),(0,E.c)(ct.pos,Te),H.push(ct)}const N=new yd(H);Oo(N,this._upVectorAlignment,this._context.renderCoordsHelper);const te=new vd(N,this._profile,this._extruder,this._startCap,this._endCap);let ee=null;if(this._fastUpdates.enabled){const ge=this._fastUpdates.visualVariables,Ge=ge.size?Xt(ge.size.field,a):0,Fe=ge.color?Xt(ge.color.field,a):0,Ye=ge.opacity?Xt(ge.opacity.field,a):0;ee=new bd(te,Ge,Fe,Ye)}else{const ge=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const Ye=l.size;ge[0]*=Ro(Ye[0],"symbol-value"===Ye[2]?this.symbolLayer.height||0:Ye[2],this.symbolLayer.width||0),ge[1]*=Ro(Ye[2],"symbol-value"===Ye[0]?this.symbolLayer.width||0:Ye[0],this.symbolLayer.height||0)}let Ge;this._drivenProperties.color&&(Ge=l.color),this._drivenProperties.opacity&&null!=l.opacity&&(Ge=Ge?[Ge[0],Ge[1],Ge[2],l.opacity]:[1,1,1,l.opacity]);const Fe=new So(te);Fe.bake(ge),Ge&&Fe.bakeVertexColors(Ge),ee=Fe}const{vertexAttributes:le,indices:fe}=ee.createGeometryData(),Ce=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:d,layerUid:this._context.layer.uid}),ie=new od(this._material,le,fe,ee,g,this._upVectorAlignment,this._stencilWidth,Ce);ie.transformation=ee.xform,p.push(ie)}if(0===p.length)return null;const x=new Ci.T({geometries:p,metadata:{layerUid:this._context.layer.uid,graphicUid:d}}),R=new Ft(this,x,p,null,null,Ud,h);return R.alignedSampledElevation=b.terrainElevation,R.needsElevationUpdates=(0,I.B5)(h.mode),R}},fill:ps,extrude:class hc extends Bt{constructor(a,l,h,d){super(a,l,h,d),this.ensureDrapedStatus(!1)}doLoad(){var a=this;return(0,B.Z)(function*(){if(!a._drivenProperties.size){const _=(0,Ne.bh)(a._getSymbolSize());if(_)throw new ne.Z("graphics3dextrudesymbollayer:invalid-size",_)}const l=(0,y.U2)(a.symbolLayer,"material","color"),h=a._getCombinedOpacityAndColor(l),d=(0,G.d)(h),u=h[3],p=u<1||a.needsDrivenTransparentPass,g={usePBR:a._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:d,ambient:d,opacity:u,transparent:p,cullFace:p?Pe.Vr.None:Pe.Vr.Back,hasVertexColors:!0,hasSlicePlane:a._context.slicePlaneEnabled,castShadows:a.symbolLayer.castShadows,offsetTransparentBackfaces:!0};a._material=new hr.Gp(g),a._bottomMaterial=new hr.Gp({...g,cullFace:Pe.Vr.Back}),a._context.stage.add(a._material),a._context.stage.add(a._bottomMaterial)})()}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(a){const l=a.graphic;if(!this._validateGeometry(l.geometry,cc,this.symbolLayer.type))return null;const h=this._getVertexOpacityAndColor(a.renderingInfo,255),d=this.setGraphicElevationContext(l,new q.o);return this._createAs3DShape(l,a.renderingInfo,h,d,l.uid)}layerOpacityChanged(a,l){const h=(0,y.U2)(this.symbolLayer,"material","color"),d=this._getCombinedOpacity(h),u=d<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:d,transparent:u}),this._bottomMaterial.setParameters({opacity:d,transparent:u});const p=this._getLayerOpacity();a.forEach(g=>{const _=l(g);(0,y.pC)(_)&&_.layerOpacityChanged(p,this._context.isAsync)})}layerElevationInfoChanged(a,l){return this.updateGraphics3DGraphicElevationInfo(a,l,I.B5)}slicePlaneEnabledChanged(a,l){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),a.forEach(h=>{const d=l(h);(0,y.pC)(d)&&d.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_getExtrusionSize(a){let l;return l=a.size&&this._drivenProperties.size?function al(c,a=0){const l=c[a];return"number"==typeof l&&isFinite(l)?l:null}(a.size,2)??0:this._getSymbolSize(),l/=this._context.renderCoordsHelper.unitInMeters,l}applyRendererDiff(a,l){return this._drivenPropertiesChanged(l)?Ue.Recreate_Symbol:Ue.Recreate_Graphics}queryForSnapping(a,l,h,d){var u=this;return(0,B.Z)(function*(){const p=u._getExtrusionSize(h)*u._context.renderCoordsHelper.unitInMeters/(0,Ws._R)(l),{objectId:g,target:_}=a,v=(0,js.d9)(_);switch(v.z=(v.z??0)+p,a.type){case"edge":{const{start:b,end:C}=a,x=(0,js.d9)(b),R=(0,js.d9)(C);return x.z=(x.z??0)+p,R.z=(R.z??0)+p,[(0,Hs.p)(g,v,1/0,x,R)]}case"vertex":return[(0,Hs.u)(g,v,1/0),(0,Hs.p)(g,_,1/0,_,v)];default:return[]}})()}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(a,l,h,d,u){const p=cr(a.geometry);if((0,y.Wi)(p))return null;if(0===p.rings.length||!p.rings.some(ct=>ct.length>0))return this._logGeometryValidationWarnings(p.rings,"rings","ExtrudeSymbol3DLayer"),null;const g=Ys(p,this._context.elevationProvider,this._context.renderCoordsHelper,d);this._logGeometryCreationWarnings(g,p.rings,"rings","ExtrudeSymbol3DLayer");const _=(0,Ne.zE)(p);if((0,y.Wi)(_))return null;const v=new Array,b=(0,V.Ue)(),C=(0,we.c)(),x=(0,G.c)(),R=this._context.renderCoordsHelper.viewingMode===ci.JY.Global;R||this._context.renderCoordsHelper.worldUpAtPosition(null,x),(0,Se.Bm)(p.spatialReference,[_.x,_.y,0],C,this._context.renderCoordsHelper.spatialReference);const O=(0,we.c)();(0,Be.a)(O,C);const M=(0,Nr.c)();(0,Oi.b)(M,O);const{polygons:F,mapPositions:H,position:N}=g,te=N.length/3,ee=new Float64Array(3*te*6),le=new Float64Array(3*te*6),fe=new Float64Array(3*te*6),Ce=new Float64Array(1*te*6);let ie=0;for(let ct=0;ct<F.length;++ct){const ri=F[ct],Ia=ri.count;if(this._context.clippingExtent&&((0,V.cS)(b),(0,V.G1)(b,ri.mapPositions),!(0,V.Zp)(b,this._context.clippingExtent)))continue;const ys=(0,or.e)(ri.mapPositions,ri.holeIndices,3);if(0===ys.length)continue;const Da=new Array(3*Ia*2+ys.length),wa=new Array(ys.length),fs=6*Ia,Ma=3*ee.BYTES_PER_ELEMENT,_s=new Ie.fP(ee.buffer,ie*Ma,Ma,(ie+fs)*Ma),Ua=3*le.BYTES_PER_ELEMENT,vs=new Ie.fP(le.buffer,ie*Ua,Ua,(ie+fs)*Ua),tl=new Float64Array(fe.buffer,3*ie*fe.BYTES_PER_ELEMENT,3*fs),il=new Float64Array(Ce.buffer,1*ie*Ce.BYTES_PER_ELEMENT,1*fs),ip=this._getExtrusionSize(l);dc(N,H,ys,ri,_s.typedBuffer,tl,vs.typedBuffer,il,Da,wa,ip,x,R),(0,lr.t)(_s,_s,O),(0,lr.a)(vs,vs,M),ie+=6*Ia;const rl=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:u,layerUid:this._context.layer.uid}),sl=new yc(_s.typedBuffer,tl,vs.typedBuffer,il);v.push(Sn(this._material,Da,Da.length-wa.length,sl,h,rl)),v.push(Sn(this._bottomMaterial,wa,0,sl,h,rl))}if(0===v.length)return null;const ge=new Ci.T({geometries:v,metadata:{layerUid:this._context.layer.uid,graphicUid:u,isElevationSource:!0}});ge.transformation=C;const Ge=(0,Ms.hM)(this.symbolLayer,{opacity:this._getLayerOpacity()}),Fe=(0,y.pC)(Ge)?{baseMaterial:this._material,edgeMaterials:[Ge],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,Ye=new Ft(this,ge,v,null,null,gc,d,Fe);return Ye.alignedSampledElevation=g.sampledElevation,Ye.needsElevationUpdates=(0,I.B5)(d.mode),Ye}},text:class ou extends Bt{constructor(a,l,h,d){super(a,l,h,d),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}doLoad(){var a=this;return(0,B.Z)(function*(){if(!a._drivenProperties.size){const l=(0,Ne.bh)(a.symbolLayer.size);if(l)throw new ne.Z("graphics3dtextsymbollayer:invalid-size",l)}yield a._createTextRenderParameters()})()}_createTextRenderParameters(){var a=this;return(0,B.Z)(function*(){const l=a._context.graphicsCoreOwner.view.state.rasterPixelRatio;a._textRenderParameters=yield Pa.fromSymbol(a.symbolLayer,l)})()}destroy(){super.destroy()}createGraphics3DGraphic(a){const l=a.graphic,h=nr(l.geometry);if((0,y.Wi)(h))return this.logger.warn(`unsupported geometry type for text symbol: ${l.geometry.type}`),null;const d=this.symbolLayer.text;if((0,y.Wi)(d)||""===d)return null;const u=(0,Ir.Pd)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if((0,y.pC)(u)&&!(0,Ir.as)(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const p=new ru(u,this.symbolLayer.horizontalAlignment,function Ac(c){return"middle"===c?"center":c}(this.symbolLayer.verticalAlignment));return this._createAs3DShape(l,h,d,p)}createLabel(a,l,h,d){const u=a.graphic,p=nr(u.geometry);if((0,y.Wi)(p))return this.logger.warn(`unsupported geometry type for label: ${u.geometry.type}`),null;const g=l.text;return!g||/^\s+$/.test(g)?null:this._createAs3DShape(u,p,g,l,h,d)}setGraphicElevationContext(a,l,h=0){const d=super.setGraphicElevationContext(a,l);return d.addOffsetRenderUnits(h),d}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(a,l){return Mo(a,l,(h,d)=>{this.updateGraphicElevationContext(d,h)}),I.lO.UPDATE}slicePlaneEnabledChanged(a,l){return Mo(a,l,h=>{for(const d of h.stageObject.geometries)d.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}skipHighSymbolLodsChanged(){return!0}updateGraphicElevationContext(a,l){const h=l.elevationContext;this.setGraphicElevationContext(a,h,(0,y.pC)(l.metadata)?l.metadata.elevationOffset:0),l.needsElevationUpdates=(0,I.Xf)(h.mode)||"absolute-height"===h.mode}_defaultElevationInfoNoZ(){return cu}_createAs3DShape(a,l,h,d,u,p){const g=this.setGraphicElevationContext(a,new q.o,d.elevationOffset),_="polyline"===(0,y.U2)(a.geometry,"type"),v=a.uid;let b=null,C=null;if((0,y.Wi)(p)){const ie=function Rc(c){switch(c){case"left":return hi.Left;case"right":return hi.Right;default:return hi.Center}}(d.horizontalPlacement);b=new su(h,ie,this._textRenderParameters);let ge=null;if((0,y.pC)(this._context.sharedResources.textures)){C=this._context.sharedResources.textures.fromData(b.key,()=>(0,y.Wg)(b).create(),()=>{(0,y.pC)(ge)&&ge.release()});const Ge=this._context.stage.renderView.textureRepository.acquire(C.texture.id);if((0,y.Wi)(Ge)||(0,j.y8)(Ge))return C.release(),null;ge=Ge}}const x=function lu(c,a){if("baseline"===a.verticalPlacement){const h=Oc[a.horizontalPlacement],d=(0,y.pC)(c)?c.baselineAnchorY:0;return(0,oe.f)(h,d)}const l=function Tc(c,a){switch(a){case"bottom":return"left"===c?"bottom-left":"right"===c?"bottom-right":"bottom";case"center":return c;case"top":return"left"===c?"top-left":"right"===c?"top-right":"top"}}(a.horizontalPlacement,a.verticalPlacement);return Kr[l]}(b,d),R={occlusionTest:!0,screenOffset:d.screenOffset,anchorPosition:x,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:d.centerOffsetUnits,drawInSecondSlot:!0};if((0,y.pC)(p)?R.textureId=p.id:(0,y.pC)(C)&&(R.textureId=C.texture.id),(0,y.pC)(d.verticalOffset)){const{screenLength:ie,minWorldLength:ge,maxWorldLength:Ge}=d.verticalOffset;R.verticalOffset={screenLength:(0,Qe.F2)(ie),minWorldLength:ge||0,maxWorldLength:(0,y.pC)(Ge)?Ge:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:ie,screenSizePerspectiveSettingsLabels:ge}=this._context.sharedResources;R.screenSizePerspective=ge.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),R.screenSizePerspectiveAlignment=ie}let O;if(_&&(R.shaderPolygonOffset=1e-4),R.hasSlicePlane=this._context.slicePlaneEnabled,(0,y.pC)(u)){const ie=JSON.stringify(R);O=u.get(ie),(0,y.Wi)(O)&&(O=new Qr.A(R),u.add(ie,O))}else O=new Qr.A(R);const M=d.translation,F=(0,y.pC)(b)?(0,oe.f)(b.displayWidth,b.displayHeight):oe.Z,N=(0,Pt.dV)(O,nu,M,null,F,d.centerOffset,[0,0],null),te=zs(this._context,l,N,g,v);if((0,y.Wi)(te))return null;const ee=new Ft(this,te.object,[N],(0,y.Wi)(u)?[O]:null,C,sr,g);ee.alignedSampledElevation=te.sampledElevation,ee.needsElevationUpdates=(0,I.Xf)(g.mode)||"absolute-height"===g.mode;const{displayWidth:le,displayHeight:fe}=(0,y.pC)(b)?b:d;ee.getScreenSize=(ie=(0,oe.a)())=>(ie[0]=le,ie[1]=fe,ie);const Ce=new Ka(d.elevationOffset,h);return ee.metadata=Ce,ar(ee,l,this._context.elevationProvider),ee}},water:Zt},Vo={"mesh-3d":{fill:class lh extends Bt{constructor(a,l,h,d){super(a,l,h,d),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}doLoad(){var a=this;return(0,B.Z)(function*(){ht.Z.DRAW_MESH_GEOMETRY_NORMALS&&(a._debugVertexNormalMaterial=new Yn.Y({color:[1,0,1,1]}),a._debugFaceNormalMaterial=new Yn.Y({color:[0,1,1,1]}))})()}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),a=>a.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(a){const l=a.graphic;if(!this._validateGeometry(l.geometry,oh,"fill on mesh-3d"))return null;const h=this.setGraphicElevationContext(l,new q.o);return this._createAs3DShape(l,a.renderingInfo,h,l.uid)}layerOpacityChanged(a,l){const h=this._getLayerOpacity();this._materials.forEach(d=>{d.material.setParameters({layerOpacity:h});const u=d.material.parameters;this._setMaterialTransparentParameter(u,d),d.material.setParameters({transparent:u.transparent})}),a.forEach(d=>{const u=l(d);(0,y.pC)(u)&&u.layerOpacityChanged(h,this._context.isAsync)})}layerElevationInfoChanged(a,l){return this.updateGraphics3DGraphicElevationInfo(a,l,I.B5)}slicePlaneEnabledChanged(a,l){return this._materials.forEach(h=>{h.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),a.forEach(h=>{const d=l(h);(0,y.pC)(d)&&d.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const a=this._usePBR();return this._materials.forEach(l=>l.material.setParameters({usePBR:a})),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(a){return(0,y.Wi)(a)?"-":a instanceof K.Z?a.toHex():a.contentHash}_materialPropertiesDefault(a,l){const h=this._requiresSymbolVertexColors(),d=!!a.vertexAttributes.color,u=!!a.vertexAttributes.tangent;return{hasSymbolVertexColors:h,hasVertexColors:d,hasVertexTangents:u,uid:`vc:${d},vt:${u},vct${l},svc:${h}`}}_materialProperties(a,l,h){const d=this._materialPropertiesDefault(a,h);if(!l.material)return d;const{color:u,colorTexture:p,normalTexture:g,doubleSided:_,alphaCutoff:v,alphaMode:b}=l.material,C=this._colorOrTextureUid(u),x=this._colorOrTextureUid(p),R=this._colorOrTextureUid(g);if(d.color=u,d.colorTexture=p,d.normalTexture=g,d.uid=`${d.uid},cmuid:${C},ctmuid:${x},ntmuid:${R},ds:${_},ac:${v},am:${b}`,l.material instanceof nh.Z){const{metallic:O,roughness:M,metallicRoughnessTexture:F,emissiveColor:H,emissiveTexture:N,occlusionTexture:te}=l.material,ee=this._colorOrTextureUid(F),le=this._colorOrTextureUid(H),fe=this._colorOrTextureUid(N),Ce=this._colorOrTextureUid(te);d.metallic=O,d.roughness=M,d.metallicRoughnessTexture=F,d.emissiveColor=H,d.emissiveTexture=N,d.occlusionTexture=te,d.colorTextureTransform=l.material.colorTextureTransform,d.normalTextureTransform=l.material.normalTextureTransform,d.emissiveTextureTransform=l.material.emissiveTextureTransform,d.occlusionTextureTransform=l.material.occlusionTextureTransform,d.metallicRoughnessTextureTransform=l.material.metallicRoughnessTextureTransform,d.uid=`${d.uid},mrm:${O},mrr:${M},mrt:${ee},emuid:${le},etmuid:${fe},otmuid:${Ce}`}return d}_setInternalColorValueParameters(a,l){l.diffuse=K.Z.toUnitRGB(a),l.opacity=a.a}_getLoadableTextureResource(a){return a.data?a.data:a.url}_getInternalTextureId(a){const l=this._getInternalTexture(a,Pe.JJ.Opaque);return(0,y.pC)(l)?l.id:null}_getInternalTexture(a,l){const h=this._getLoadableTextureResource(a);if(!h)return null;const d=`${a.contentHash}/${l}`;let u=this._textures.get(d);return u||(u=new qs.x((0,ra.$A)(h)?h.data:h,{mipmap:!0,wrap:this._castTextureWrap(a.wrap),noUnpackFlip:!0,preMultiplyAlpha:!(0,ra.$A)(h)&&l!==Pe.JJ.Opaque,encoding:(0,ra.$A)(h)&&(0,y.pC)(h.encoding)?h.encoding:void 0}),this._textures.set(d,u),this._context.stage.add(u),this._context.stage.loadImmediate(u)),u}_castTextureWrap(a="repeat"){if("string"==typeof a){const l=this._castTextureWrapIndividual(a);return{s:l,t:l}}return{s:this._castTextureWrapIndividual(a.horizontal),t:this._castTextureWrapIndividual(a.vertical)}}_castTextureWrapIndividual(a){switch(a){case"clamp":return Et.e8.CLAMP_TO_EDGE;case"mirror":return Et.e8.MIRRORED_REPEAT;default:return Et.e8.REPEAT}}_setInternalMaterialParameters(a,l){if((0,y.pC)(a.color)&&this._setInternalColorValueParameters(a.color,l),(0,y.pC)(a.colorTexture)){const h=this._getInternalTexture(a.colorTexture,l.textureAlphaMode);(0,y.pC)(h)?(l.textureId=h.id,l.textureAlphaPremultiplied=!!h.params.preMultiplyAlpha):l.textureId=void 0}(0,y.pC)(a.normalTexture)&&(l.normalTextureId=this._getInternalTextureId(a.normalTexture)),(0,y.pC)(a.emissiveColor)&&(l.emissiveFactor=K.Z.toUnitRGB(a.emissiveColor)),(0,y.pC)(a.emissiveTexture)&&(l.emissiveTextureId=this._getInternalTextureId(a.emissiveTexture)),(0,y.pC)(a.occlusionTexture)&&(l.occlusionTextureId=this._getInternalTextureId(a.occlusionTexture)),(0,y.pC)(a.metallicRoughnessTexture)&&(l.metallicRoughnessTextureId=this._getInternalTextureId(a.metallicRoughnessTexture)),l.colorTextureTransformMatrix=(0,Pr.i)(a.colorTextureTransform),l.normalTextureTransformMatrix=(0,Pr.i)(a.normalTextureTransform),l.occlusionTextureTransformMatrix=(0,Pr.i)(a.occlusionTextureTransform),l.emissiveTextureTransformMatrix=(0,Pr.i)(a.emissiveTextureTransform),l.metallicRoughnessTextureTransformMatrix=(0,Pr.i)(a.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(a){const l=this._drivenProperties.color;let h=(0,y.pC)(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(l)a.externalColor=De.O;else{const d=(0,y.pC)(this.symbolLayer.material)?this.symbolLayer.material.color:null;(0,y.pC)(d)?a.externalColor=K.Z.toUnitRGBA(d):(h=null,a.externalColor=De.O)}h&&(a.colorMixMode=h),a.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(a){const l=a.vertexAttributes.color;if((0,y.Wi)(l))return!1;for(let h=3;h<l.length;h+=4)if(255!==l[h])return!0;return!1}_getOrCreateMaterial(a,l){const h=l.material?.color,d=l.material?.colorTexture,u=l.material?.alphaMode,p="blend"===u,g="opaque"!==u&&(this._hasTransparentVertexColors(a)||(0,y.pC)(h)&&h.a<1||(0,y.pC)(d)&&d.transparent||p),_=this._materialProperties(a,l,g),v=this._materials.get(_.uid);if(v)return v.material;const b={material:null,isComponentTransparent:g,alphaMode:l.material?l.material.alphaMode:"opaque"},C=null==_.metallicRoughnessTexture&&null==_.metallic&&null==_.roughness,x={usePBR:this._usePBR(),isSchematic:C,hasVertexColors:_.hasVertexColors,hasSymbolColors:_.hasSymbolVertexColors,hasVertexTangents:_.hasVertexTangents,ambient:G.Z,diffuse:G.O,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:Pe.Vr.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};C||(x.mrrFactors=[null!=_.metallic?_.metallic:1,null!=_.roughness?_.roughness:1,.5]),l.material&&(x.doubleSided=l.material.doubleSided,x.cullFace=l.material.doubleSided?Pe.Vr.None:Pe.Vr.Back,x.textureAlphaCutoff=l.material.alphaCutoff),this._setExternalMaterialParameters(x),this._setMaterialTransparentParameter(x,b),this._setInternalMaterialParameters(_,x);const R=new hr.Gp(x);return b.material=R,this._materials.set(_.uid,b),this._context.stage.add(R),R}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(a,l){a.transparent=this.needsDrivenTransparentPass||l.isComponentTransparent||a.layerOpacity<1||a.opacity<1||a.externalColor&&a.externalColor[3]<1,a.textureAlphaMode="auto"===l.alphaMode?a.transparent?Pe.JJ.MaskBlend:Pe.JJ.Opaque:"opaque"===l.alphaMode?Pe.JJ.Opaque:"mask"===l.alphaMode?Pe.JJ.Mask:Pe.JJ.Blend}_addDebugNormals(a,l){const h=l.length,d=a.spatialReference.isGeographic?20015077/180:1,u=.1*Math.max(a.extent.width*d,a.extent.height*d,a.extent.zmax-a.extent.zmin),p=[],g=[],_=[],v=[];for(let R=0;R<h;R++){const O=l[R],M=O.vertexAttributes.get(T.T.POSITION),F=O.vertexAttributes.get(T.T.NORMAL),H=O.indices.get(T.T.POSITION),N=O.indices.get(T.T.NORMAL),te=M.data,ee=F.data;for(let le=0;le<H.length;le++){const fe=3*H[le],Ce=3*N[le];for(let ie=0;ie<3;ie++)p.push(te[fe+ie]);for(let ie=0;ie<3;ie++)p.push(te[fe+ie]+ee[Ce+ie]*u);if(g.push(g.length),g.push(g.length),le%3==0){this._calculateFaceNormal(te,H,le,ki),this._getFaceVertices(te,H,le,qe,$i,Ki),(0,E.a)(qe,qe,$i),(0,E.a)(qe,qe,Ki),(0,E.g)(qe,qe,1/3);for(let ie=0;ie<3;ie++)_.push(qe[ie]);for(let ie=0;ie<3;ie++)_.push(qe[ie]+ki[ie]*u);v.push(v.length),v.push(v.length)}}}const b=l[0].transformation,C=new ni.Z(this._debugVertexNormalMaterial,[[T.T.POSITION,new Oe.a(p,3,!0)]],[[T.T.POSITION,g]],null,xi.U.Line);l.push(C),C.transformation=b;const x=new ni.Z(this._debugFaceNormalMaterial,[[T.T.POSITION,new Oe.a(_,3,!0)]],[[T.T.POSITION,v]],null,xi.U.Line);x.transformation=b,l.push(x)}_createAs3DShape(a,l,h,d){const u=a.geometry;if("mesh"!==u.type)return null;const p=this._createGeometryInfo(u,l,d);if((0,y.Wi)(p))return null;const{geometries:g,objectTransformation:_}=p;ht.Z.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(u,g);const v=new Ci.T({geometries:g,metadata:{layerUid:this._context.layer.uid,graphicUid:d}});v.transformation=_;const b=(0,Ms.hM)(this.symbolLayer,{opacity:this._getLayerOpacity()}),C=(0,y.pC)(b)?new Gl(g[0].material,[b],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,x=new Ft(this,v,g,null,null,sr,h,C);x.needsElevationUpdates=(0,I.B5)(h.mode),x.useObjectOriginAsAttachmentOrigin=!0,h.centerPointInElevationSR=this._getCenterPointInElevationSR(v);const{elevationProvider:R,renderCoordsHelper:O}=this._context;return x.alignedSampledElevation=sr(x,h,0,(F,H)=>(0,I.qZ)(F,R,h,O,H),O),x}_getCenterPointInElevationSR(a){const l=(0,Q.Tx)(0,0,0,(0,y.pC)(this._context.elevationProvider.spatialReference)?this._context.elevationProvider.spatialReference:null);return(0,Se.MT)([a.transformation[12],a.transformation[13],a.transformation[14]],this._context.renderCoordsHelper.spatialReference,l),l}_createComponentNormals(a,l,h,d){switch(h.shading||"flat"){default:case"source":return this._createComponentNormalsSource(a,l,h,d);case"flat":return this._createComponentNormalsFlat(a,d);case"smooth":return this._createComponentNormalsSmooth(a,d)}}_createComponentNormalsSource(a,l,h,d){if((0,y.Wi)(l))return this._createComponentNormalsFlat(a,d);let u=!1;if(!h.trustSourceNormals)for(let p=0;p<d.length;p+=3){this._calculateFaceNormal(a,d,p,ki);for(let g=0;g<3;g++){const _=3*d[p+g];qe[0]=l[_+0],qe[1]=l[_+1],qe[2]=l[_+2],(0,E.e)(ki,qe)<0&&(l[_+0]=-l[_+0],l[_+1]=-l[_+1],l[_+2]=-l[_+2],u=!0)}}return new sa(l,d,u)}_createComponentNormalsFlat(a,l){const h=(0,vt.xx)(l.length),d=new Array(3*l.length);for(let u=0;u<l.length;u+=3){const p=this._calculateFaceNormal(a,l,u,ki);for(let g=0;g<3;g++)h[u+g]=p[g],d[u+g]=u/3}return new sa(h,d,!1)}_createComponentNormalsSmooth(a,l){const h={};for(let p=0;p<l.length;p+=3){const g=this._calculateFaceNormal(a,l,p,ki);for(let _=0;_<3;_++){const v=l[p+_];let b=h[v];b||(b={normal:(0,G.c)(),count:0},h[v]=b),(0,E.a)(b.normal,b.normal,g),b.count++}}const d=(0,vt.xx)(3*l.length),u=new Array(3*l.length);for(let p=0;p<l.length;p++){const g=h[l[p]];1!==g.count&&((0,E.n)(g.normal,g.normal),g.count=1);for(let _=0;_<3;_++)d[3*p+_]=g.normal[_];u[p]=p}return new sa(d,u,!1)}_getFaceVertices(a,l,h,d,u,p){const g=3*l[h+0],_=3*l[h+1],v=3*l[h+2];d[0]=a[g+0],d[1]=a[g+1],d[2]=a[g+2],u[0]=a[_+0],u[1]=a[_+1],u[2]=a[_+2],p[0]=a[v+0],p[1]=a[v+1],p[2]=a[v+2]}_calculateFaceNormal(a,l,h,d){return this._getFaceVertices(a,l,h,qe,$i,Ki),(0,E.b)($i,$i,qe),(0,E.b)(Ki,Ki,qe),(0,E.f)(qe,$i,Ki),(0,E.n)(d,qe),d}_getOrCreateComponents(a){return(0,y.Pt)(a.components,ch)}_createPositionBuffer(a,l){let h=a.vertexAttributes.position;const d=l.reprojection===Ot.ECEF?l.transformBeforeProject:null;if((0,y.pC)(d)&&(h=(0,xr.zZ)(h,new Float64Array(h.length),d)),l.reprojection===Ot.NONE)return l.needsBufferCopy?new Float64Array(h):h;const u=(0,y.pC)(d)?h:new Float64Array(h.length);return(0,Se.CM)(h,a.spatialReference,0,u,this._context.renderCoordsHelper.spatialReference,0,h.length/3),u}_createNormalBuffer(a,l,h){let d=a.vertexAttributes.normal;if((0,y.Wi)(d))return null;const u=h.reprojection===Ot.ECEF?h.transformBeforeProject:null;if((0,y.pC)(u)&&(d=(0,xr.w9)(d,new Float32Array(d.length),u)),"local"===this._context.graphicsCoreOwner.view.viewingMode||h.reprojection===Ot.NONE)return h.needsBufferCopy&&a.vertexAttributes.normal===d?new Float32Array(d):d;const p=a.vertexAttributes.position,g=(0,y.pC)(u)?d:new Float32Array(d.length);return(0,xr.Iz)(d,p,l,a.spatialReference,g)}_createTangentBuffer(a,l,h){let d=a.vertexAttributes.tangent;if((0,y.Wi)(d))return null;const u=h.reprojection===Ot.ECEF?h.transformBeforeProject:null;if((0,y.pC)(u)&&(d=(0,xr.VS)(d,new Float32Array(d.length),u)),"local"===this._context.graphicsCoreOwner.view.viewingMode||h.reprojection===Ot.NONE)return h.needsBufferCopy&&a.vertexAttributes.normal===d?new Float32Array(d):d;const p=a.vertexAttributes.position,g=(0,y.pC)(u)?d:new Float32Array(d.length);return(0,xr.wi)(d,p,l,a.spatialReference,g)}_createColorBuffer(a){return a.vertexAttributes.color}_createSymbolColorBuffer(a){if(this._requiresSymbolVertexColors()){const l=this._getVertexOpacityAndColor(a),h=(0,Zn.F5)((0,y.U2)(this.symbolLayer,"material","colorMixMode")),d=new Uint8Array(4);return(0,Zn.HB)(l,h,d),d}return null}_createBuffers(a,l){const h=a.vertexAttributes&&a.vertexAttributes.position;if(!h)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const d=a.vertexAttributes.normal,u=a.vertexAttributes.uv,p=a.vertexAttributes.tangent;if((0,y.pC)(d)&&d.length!==h.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if((0,y.pC)(p)&&p.length/4!=h.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if((0,y.pC)(u)&&u.length/2!=h.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const g=this._computeReprojectionInfo(a),_=this._createPositionBuffer(a,g),v=this._createColorBuffer(a),b=this._createSymbolColorBuffer(l),C=this._createNormalBuffer(a,_,g),x=this._createTangentBuffer(a,_,g);return{positionBuffer:_,normalBuffer:C,tangentBuffer:x,uvBuffer:u,colorBuffer:v,symbolColorBuffer:b,objectTransformation:g.reprojection===Ot.NONE&&(0,y.pC)(g.objectTransformation)?g.objectTransformation:this._transformOriginLocal(a,_,C,x),geometryTransformation:g.reprojection===Ot.NONE&&(0,y.pC)(g.geometryTransformation)?g.geometryTransformation:(0,we.c)()}}_computeReprojectionInfo(a){const l=(0,y.pC)(a.transform),h=l&&a.transform.geographic||this._context.renderCoordsHelper.viewingMode===ci.JY.Local?Ot.NONE:Ot.ECEF;if(l){if(h===Ot.NONE){const u=(0,we.c)();return(0,Se.Bm)(a.spatialReference,a.transform.origin,u,this._context.renderCoordsHelper.spatialReference),{reprojection:h,objectTransformation:u,geometryTransformation:(0,we.b)(a.transform.localMatrix),needsBufferCopy:!1}}const d=(0,Be.f)((0,we.c)(),a.transform.origin);return(0,Be.m)(d,d,a.transform.localMatrix),{reprojection:h,transformBeforeProject:d,needsBufferCopy:!0}}return{reprojection:h,needsBufferCopy:!0}}_transformOriginLocal(a,l,h,d){const u=this._context.renderCoordsHelper.spatialReference,p=a.anchor;is[0]=p.x,is[1]=p.y,is[2]=p.z;const g=(0,we.c)();(0,Se.Bm)(a.spatialReference,is,g,u);const _=Ie.fP.fromTypedArray(l);if((0,Be.a)($n,g),(0,lr.t)(_,_,$n),(0,y.pC)(h)||(0,y.pC)(d)){if((0,Oi.f)(Er,g),(0,Oi.t)(Er,Er),(0,y.pC)(h)){const v=Ie.ct.fromTypedArray(h);(0,lr.a)(v,v,Er)}if((0,y.pC)(d)){const v=Ie.ct.fromTypedArray(d,4*d.BYTES_PER_ELEMENT);(0,lr.a)(v,v,Er)}}return g}_validateFaces(a,l){const h=a.vertexAttributes.position.length/3,d=l.faces;if(d){let u=-1;for(let p=0;p<d.length;p++){const g=d[p];g>u&&(u=g)}if(h<=u)return this.logger.warn(`Vertex index ${u} is out of bounds of the mesh position buffer`),!1}else if(h%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(a,l){return l.faces?l.faces:(0,ts.p)(a.vertexAttributes.position.length/3)}_isOutsideClippingArea(a){if(!this._context.clippingExtent)return!1;const l=a.vertexAttributes&&a.vertexAttributes.position;if(!l)return!1;const h=this._context.elevationProvider.spatialReference;let d;const u=l.length/3;return(0,y.pC)(h)&&!a.spatialReference.equals(h)?(d=new Float64Array(l.length),(0,Se.CM)(a.vertexAttributes.position,a.spatialReference,0,d,h,0,u)):d=l,(0,V.cS)(aa),(0,V.G1)(aa,d,0,u),!(0,V.Zp)(aa,this._context.clippingExtent)}_createGeometryInfo(a,l,h){if(!(0,Se.Up)(a.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(a))return null;const d=this._createBuffers(a,l);if((0,y.Wi)(d))return null;const{positionBuffer:u,uvBuffer:p,colorBuffer:g,symbolColorBuffer:_,normalBuffer:v,tangentBuffer:b,objectTransformation:C,geometryTransformation:x}=d,R=this._getOrCreateComponents(a),O=new Array;let M=!1;for(const F of R){if(!this._validateFaces(a,F))return null;const H=this._getOrCreateFaces(a,F);if(0===H.length)continue;const N=this._createComponentNormals(u,v,F,H);N.didFlipNormals&&(M=!0);const te=[[T.T.POSITION,new Oe.a(u,3,!0)],[T.T.NORMAL,new Oe.a(N.normals,3,!0)]],ee=[[T.T.POSITION,H],[T.T.NORMAL,N.indices]];(0,y.pC)(g)&&(te.push([T.T.COLOR,new Oe.a(g,4,!0)]),ee.push([T.T.COLOR,H])),(0,y.pC)(_)&&(te.push([T.T.SYMBOLCOLOR,new Oe.a(_,4,!0)]),ee.push([T.T.SYMBOLCOLOR,new Array(H.length).fill(0)])),(0,y.pC)(p)&&(te.push([T.T.UV0,new Oe.a(p,2,!0)]),ee.push([T.T.UV0,H])),(0,y.pC)(b)&&(te.push([T.T.TANGENT,new Oe.a(b,4,!0)]),ee.push([T.T.TANGENT,H]));const le=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:h,layerUid:this._context.layer.uid}),fe=this._getOrCreateMaterial(a,F),Ce=new ni.Z(fe,te,ee,null,xi.U.Mesh,le);Ce.transformation=x,O.push(Ce)}return M&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:O,objectTransformation:C}}}}};class Fo extends Is{set symbol(a){this._symbol=a,a.symbolLayers.forEach((l,h)=>{const d=this.symbolLayers[h];(0,y.pC)(d)&&(d.symbol=a,d.symbolLayer=l)})}get symbol(){return this._symbol}constructor(a,l,h){super(l.schedule),this._symbol=a,this._context=l,this._backgroundLayers=h,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}doLoad(a){var l=this;return(0,B.Z)(function*(){let h=l._symbol.symbolLayers;l._extentPadding=0,l._backgroundLayers&&(h=l._backgroundLayers.concat(h));const d=h.length;for(;l.symbolLayers.length<h.length;)l.symbolLayers.push(null);l.symbolLayers.length=h.length;const u=[];for(let p=0;p<d;p++){const g=h.getItemAt(p);if(!1===g.enabled)continue;ms.renderPriority=1-(1+p)/d,ms.renderPriorityStep=1/d,ms.ignoreDrivers=g._ignoreDrivers;const _=gu(l.symbol,g,l._context,ms),v=(0,j.$F)(a,()=>{l.symbolLayers[p]=null,_.destroy()});v&&u.push(v),l.symbolLayers[p]=_}if(yield(0,Lr.Ed)(l.symbolLayers,function(){var p=(0,B.Z)(function*(g,_){if((0,y.pC)(g))try{yield g.load(),l._extentPadding+=Math.max(l._extentPadding,g.extentPadding)}catch{l.symbolLayers[_]=null}});return function(g,_){return p.apply(this,arguments)}}()),u.forEach(p=>p.remove()),(0,j.k_)(a),l.symbolLayers.length&&!l.symbolLayers.some(p=>!!p))throw new Error})()}getSymbolLayerSize(a){const l=this.symbolLayers[a];return(0,y.pC)(l)?l.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(a=>(0,y.pC)(a)&&a.queryForSnapping)}createGraphics3DGraphic(a,l){const h=a.graphic,d=new Array(this.symbolLayers.length);for(let p=0;p<this.symbolLayers.length;p++){const g=this.symbolLayers[p];d[p]=(0,y.pC)(g)?g.createGraphics3DGraphic(a):null}return new sc(h,l||this,d,a.layer,this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null)}get complexity(){return Gs(this.symbolLayers.map(a=>(0,y.U2)(a,"complexity")))}globalPropertyChanged(a,l){const h=this.symbolLayers.length;for(let d=0;d<h;d++){const u=this.symbolLayers[d],p=g=>{const _=g.layers[d];return _ instanceof Ft?_:null};if((0,y.pC)(u)&&!u.globalPropertyChanged(a,l,p))return!1}return!0}applyRendererDiff(a,l){return this.loadStatus!==ft.LOADED?Ue.Recreate_Symbol:this.symbolLayers.reduce((h,d)=>h!==Ue.Recreate_Symbol&&(0,y.pC)(d)?Math.min(h,d.applyRendererDiff(a,l)):h,Ue.Fast_Update)}prepareSymbolPatch(a){if(this.loadStatus===ft.FAILED||"partial"!==a.diff.type)return;const l=a.diff.diff;if(!l.symbolLayers||"partial"!==l.symbolLayers.type)return;const h=l.symbolLayers.diff;this.symbolLayers.forEach((d,u)=>{if((0,y.Wi)(d))return;const p=h[u];if(p){const g={diff:p,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};d.prepareSymbolLayerPatch(g),a.symbolStatePatches.push(...g.symbolLayerStatePatches),g.graphics3DGraphicPatches.length&&a.graphics3DGraphicPatches.push((_,v)=>{const b=_.layers[u];(0,y.pC)(b)&&g.graphics3DGraphicPatches.forEach(C=>C(b,v))})}})}updateGeometry(a,l){for(let h=0;h<this.symbolLayers.length;h++){const d=this.symbolLayers[h];if((0,y.Wi)(d))continue;const u=a.layers[h];if((0,y.Wi)(u)||!d.updateGeometry(u,l))return!1}return!0}onRemoveGraphic(a){for(let l=0;l<this.symbolLayers.length;l++){const h=this.symbolLayers[l];if((0,y.Wi)(h))continue;const d=a.layers[l];(0,y.pC)(d)&&h.onRemoveGraphic(d)}}getFastUpdateStatus(){let a=0,l=0,h=0;return this.symbolLayers.forEach(d=>{(0,y.Wi)(d)||(d.loadStatus===ft.LOADING?a++:d.isFastUpdatesEnabled()?h++:l++)}),{loading:a,slow:l,fast:h}}queryForSnapping(a,l,h,d){var u=this;return(0,B.Z)(function*(){const p=u.symbolLayers.filter(y.pC).filter(_=>(0,y.pC)(_.queryForSnapping)).map(_=>_.queryForSnapping(a,l,h,d)),g=yield Promise.all(p);return(0,j.k_)(d),g.flat()})()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const a of this.symbolLayers)(0,y.pC)(a)&&a.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const ms={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class mu extends Fo{constructor(a,l,h){super(a,l,h),this._calloutSymbolLayer=null,this.symbol.hasVisibleCallout()&&(this._calloutSymbolLayer=function Ql(c,a){if(!(0,Ir.Pd)(c))return un.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${c.type}' does not support callouts`),null;if(!c.callout)return null;const l=ql[c.callout.type];return l?new l(c,a):(un.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${c.callout.type}`),null)}(this.symbol,l))}doLoad(a){var l=()=>super.doLoad,h=this;return(0,B.Z)(function*(){const d=h._calloutSymbolLayer?(0,Lr.q6)(h._calloutSymbolLayer.load()):null;try{yield l().call(h,a),(0,j.k_)(a)}catch(u){throw h._calloutSymbolLayer?.abortLoad(),u}d&&(yield d)})()}destroy(){super.destroy(),this._calloutSymbolLayer=(0,y.SC)(this._calloutSymbolLayer)}createGraphics3DGraphic(a,l){const h=super.createGraphics3DGraphic(a,l);if((0,y.pC)(this._calloutSymbolLayer)&&(0,y.pC)(h)){const d=this._createCalloutGraphic(a);(0,y.pC)(d)&&h.addAuxiliaryGraphic(d)}return h}globalPropertyChanged(a,l){return!!super.globalPropertyChanged(a,l)&&(!this._calloutSymbolLayer||this._calloutSymbolLayer.globalPropertyChanged(a,l,h=>this._getCalloutGraphicLayer(h)))}updateGeometry(a,l){const h=super.updateGeometry(a,l);if(h&&this._calloutSymbolLayer){const d=this._getCalloutGraphicLayer(a);if(d)return this._calloutSymbolLayer.updateGeometry(d,l)}return h}_createCalloutGraphic(a){const l=a.renderingInfo;return a.renderingInfo=new Jl(l.renderer,l.symbol),this._calloutSymbolLayer.createGraphics3DGraphic(a)}_getCalloutGraphicLayer(a){for(const l of a._auxiliaryLayers)if(l.graphics3DSymbolLayer===this._calloutSymbolLayer)return l}}class fu extends Is{constructor(a,l,h){super(l),this.symbol=a,this._convert=h,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(a){return(0,y.pC)(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(a):null}get symbolLayers(){return(0,y.pC)(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return(0,y.pC)(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}doLoad(a){var l=this;return(0,B.Z)(function*(){const h=yield l.symbol.fetchSymbol({signal:a});h.id=l.symbol.id,l.graphics3DSymbol=l._convert(h),(0,y.pC)(l.graphics3DSymbol)&&(yield l.graphics3DSymbol.load())})()}createGraphics3DGraphic(a){return(0,y.pC)(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(a,this):null}get complexity(){return(0,y.pC)(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:Us}globalPropertyChanged(a,l){return!!(0,y.pC)(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(a,l)}applyRendererDiff(a,l){return(0,y.pC)(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(a,l):Ue.Recreate_Symbol}prepareSymbolPatch(a){(0,y.pC)(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(a)}updateGeometry(a,l){return!!(0,y.pC)(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(a,l)}onRemoveGraphic(){}getFastUpdateStatus(){return(0,y.pC)(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){(0,y.pC)(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return void 0===this.graphics3DSymbol}}class _u{constructor(a){this._graphicsCore=a,this._idToState=new Map,this._states=new Set;const l=a.owner.layer&&a.owner.layer.objectIdField;l?(this._getGraphicId=h=>(0,Q.MS)(h,l),this._getGraphics3DGraphicById=h=>this._graphicsCore.getGraphics3DGraphicByObjectId(h)):(this._getGraphicId=h=>h.uid,this._getGraphics3DGraphicById=h=>this._graphicsCore.getGraphics3DGraphicById(h))}destroy(){this._idToState.clear(),this._states.forEach((a,l)=>this.remove(l))}add(a){const l={remove:()=>this.remove(a)};if(this._states.has(a))return l;const h=this._getGraphicId(a.graphic),d=this._getGraphics3DGraphicById(h);return this._states.has(a)||this._states.add(a),this._ensureStateList(h).push(a),a.displaying=!!(0,y.pC)(d)&&d.isVisible(),a.isDraped=!!(0,y.pC)(d)&&d.isDraped,a.tracking=!0,(0,y.pC)(d)&&a.emit("changed"),l}remove(a){if(this._states.has(a)){if(this._idToState.size){const l=this._getGraphicId(a.graphic),h=this._idToState.get(l);h&&((0,xe.Od)(h,a),0===h.length&&this._idToState.delete(l))}this._states.delete(a),a.tracking=!1,a.displaying=!1}}addGraphic(a){this._forEachState(a,l=>{l.displaying=a.isVisible(),l.isDraped=a.isDraped,l.emit("changed")})}removeGraphic(a){this._forEachState(a,l=>{l.displaying=!1,l.isDraped=!1})}updateGraphicGeometry(a){this._forEachState(a,l=>l.emit("changed"))}updateGraphicVisibility(a){this._forEachState(a,l=>l.displaying=a.isVisible())}allGraphicsDeleted(){this._states.forEach(a=>{a.displaying=!1})}_ensureStateList(a){const l=this._idToState.get(a);if(l)return l;const h=new Array;return this._idToState.set(a,h),h}_forEachState(a,l){if(0===this._states.size||0===this._idToState.size)return;const h=this._getGraphicId(a.graphic);this._idToState.get(h)?.forEach(l)}}var vu=S(36592);let Qt=class extends si.Z{constructor(c){super(c),this._index=new vu.Q(9,(0,Cs.Z)("esri-csp-restrictions")?a=>({minX:a.extent[0],minY:a.extent[1],maxX:a.extent[2],maxY:a.extent[3]}):[".extent[0]",".extent[1]",".extent[2]",".extent[3]"]),this._missing=new Set,this._boundsByFeature=new Map,this.spatialReference=null,this.hasZ=null,this.hasM=null,this.objectIdField=null,this.updating=!1}setup(c){this._addMany(c)}destroy(){this._missing.clear(),this._index=(0,y.SC)(this._index),this._boundsByFeature.clear(),this._boundsByFeature=null}update(){this._missing.size>0&&(this._addMany(Array.from(this._missing.values())),this.updating=!1,this._missing.clear())}get updatingRemaining(){return this._missing.size}queryGraphicUIDsInExtent(c,a,l){!(0,y.Wi)(a)&&a.equals(this.spatialReference)&&(Yt.minX=c[0],Yt.minY=c[1],Yt.maxX=c[2],Yt.maxY=c[3],this.update(),this._index.search(Yt,h=>l(h.graphic.uid)))}add(c){this._missing.add(c),this.updating=!0}remove(c){if(this._missing.delete(c))return void(this.updating=this._missing.size>0);this._index.remove(c);const a=(0,Q.MS)(c.graphic,this._get("objectIdField"));null!=a&&this._boundsByFeature.delete(a)}_addMany(c){if(0===c.length)return;const a=this._get("objectIdField");for(const l of c){l.computeExtent(this.spatialReference);const h=(0,Q.MS)(l.graphic,a);null!=h&&this._boundsByFeature.set(h,l.extent)}this._index.load(c)}clear(){this._index.clear(),this._missing.clear(),this._boundsByFeature.clear(),this.updating=!1}forEachInBounds(c,a){Yt.minX=c[0],Yt.minY=c[1],Yt.maxX=c[2],Yt.maxY=c[3],this.update(),this._index.search(Yt,l=>{a(l)})}getBounds(c,a){this.update();const l=this._boundsByFeature.get(c);return l?(0,V.JR)(a,l):null}};(0,P._)([(0,A.Cb)({constructOnly:!0})],Qt.prototype,"spatialReference",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Qt.prototype,"hasZ",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Qt.prototype,"hasM",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Qt.prototype,"objectIdField",void 0),(0,P._)([(0,A.Cb)()],Qt.prototype,"updating",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],Qt.prototype,"updatingRemaining",null),Qt=(0,P._)([(0,se.j)("esri.views.3d.layers.graphics.SpatialIndex2D")],Qt);const Yt={minX:0,minY:0,maxX:0,maxY:0};var bu=S(29505);let Gi=class extends(Ar.Z.EventedMixin(si.Z)){get spatialReference(){return this.view?.spatialReference}constructor(c){super(c),this._elevationOffset=0,this._layerHandes=new Tr.Z}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=(0,Jn.Z8)(this.view.state.viewingMode),this._intersector.options.store=Ai.eC.MIN;const c=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=c[2],this._zmax=c[5];const a=this.stageLayer.events;this._layerHandes.add([a.on("layerObjectAdded",l=>this._objectChanged(l.object)),a.on("layerObjectRemoved",l=>this._objectChanged(l.object)),a.on("objectGeometryAdded",l=>this._objectChanged(l.object)),a.on("objectGeometryRemoved",l=>this._objectChanged(l.object)),a.on("objectGeometryUpdated",l=>this._objectChanged(l.object)),a.on("objectTransformation",l=>this._objectChanged(l))])}dispose(){this._layerHandes.destroy()}elevationInfoChanged(){const c=null!=this.layer?this.layer.elevationInfo:null;if(null!=c&&"on-the-ground"!==c.mode){const a=(0,Ws._R)(this.layer.spatialReference),l=(0,bu.Z7)(c.unit??"meters");this._elevationOffset=(0,y.Pt)(c.offset,0)*l/a}else this._elevationOffset=0}getElevation(c,a,l,h){if(mt[0]=c,mt[1]=a,mt[2]=l,!this._renderCoordsHelper.toRenderCoords(mt,h,mt))return bi.Z.getLogger(this.declaredClass).error("could not project point for elevation alignment"),null;const d=this._elevationOffset,u=this._zmin+d;return this._renderCoordsHelper.setAltitude(Bo,this._zmax+d,mt),this._renderCoordsHelper.setAltitude(No,u,mt),this._intersector.reset(Bo,No,null),this._intersector.intersect(this._intersectLayers,null,1,null,_=>!!_.metadata?.isElevationSource),this._intersector.results.min.getIntersectionPoint(mt)?this._renderCoordsHelper.getAltitude(mt):null}_objectChanged(c){const a=this.spatialReference;if(!c.metadata?.isElevationSource||(0,y.Wi)(a))return;(0,V.cS)(qt);const l=c.metadata.lastValidElevationBB;l.isEmpty()||this._expandExtent(a,l.min,l.max,qt);const{min:h,max:d}=c.boundingVolumeWorldSpace;this._expandExtent(a,h,d,qt),(0,V.y8)(qt,Ea),this._zmin=Math.min(this._zmin,qt[2]),this._zmax=Math.max(this._zmax,qt[5]),Oa.extent=Ea,Oa.spatialReference=a,this.emit("elevation-change",Oa),(0,E.c)(l.min,h),(0,E.c)(l.max,d)}_computeLayerExtent(c,a){return(0,V.cS)(qt),(0,y.pC)(c)&&a.objects.forAll(l=>this._expandExtent(c,l.boundingVolumeWorldSpace.min,l.boundingVolumeWorldSpace.max,qt)),qt}_expandExtent(c,a,l,h){for(let d=0;d<8;++d)mt[0]=1&d?a[0]:l[0],mt[1]=2&d?a[1]:l[1],mt[2]=4&d?a[2]:l[2],this._renderCoordsHelper.fromRenderCoords(mt,mt,c),(0,V.pp)(h,mt);return h}};(0,P._)([(0,A.Cb)({constructOnly:!0})],Gi.prototype,"layer",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Gi.prototype,"stageLayer",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Gi.prototype,"view",void 0),(0,P._)([(0,A.Cb)()],Gi.prototype,"spatialReference",null),Gi=(0,P._)([(0,se.j)("esri.views.3d.layers.support.StageLayerElevationProvider")],Gi);const qt=(0,V.cS)(),Ea=(0,ze.cS)(),Oa={spatialReference:null,extent:Ea,context:"scene"},mt=(0,G.c)(),Bo=(0,G.c)(),No=(0,G.c)(),Ze=(0,G.c)();var Ra,xu=S(63416),Pu=S(32042),rt=S(23147),Eu=S(34103),Ou=S(72642),jo=S(22490),Ru=S(35540),Tu=S(12874);const Ta=(0,G.c)(),Au=(0,V.Ue)(),Wo="esri.views.3d.layers.graphics.Graphics3DCore",yt=bi.Z.getLogger(Wo);let ue=Ra=class extends si.Z{get _viewSpatialReference(){return this.owner.view.spatialReference}get spatialIndex(){return this._spatialIndex||(this._spatialIndex=new Qt({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:!!this.hasZ,hasM:!!this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values()))),this._spatialIndex.update(),this._spatialIndex}get numberOfGraphics(){return this._numberOfGraphics}get effectiveUpdatePolicy(){return(0,y.pC)(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?rt.j.ASYNC:(0,y.Pt)(this._forcedUpdatePolicy,this.preferredUpdatePolicy)}get featureStore(){return this._featureStore}get initializePromise(){return this._initializePromise}get scaleVisibility(){return this._scaleVisibility}get elevationAlignment(){return this._elevationAlignment}get objectStates(){return this._objectStates}get filterVisibility(){return this._filterVisibility}get updating(){return!!(this._graphicsWaitingForSymbol.size>0||this.running||this._elevationAlignment?.updating||(0,y.pC)(this._scaleVisibility)&&this._scaleVisibility.updating||(0,y.pC)(this._filterVisibility)&&this._filterVisibility.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||this._loadingSymbols>0)}get running(){return this._pendingUpdates.size>0||!!this._spatialIndex?.updating}get suspendedOrOutsideOfView(){return this.owner.suspended||!!this.owner.suspendInfo?.outsideOfView}get updatingRemaining(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}get displayFeatureLimit(){const c=this.owner&&this.owner.view&&this.owner.view.qualitySettings,a=c?c.graphics3D.minTotalNumberOfFeatures:0,l=c?c.graphics3D.maxTotalNumberOfFeatures:0,h=c?c.graphics3D.maxTotalNumberOfPrimitives:0,d=this.averageSymbolComplexity,u=Math.max(1,(0,y.pC)(d)?d.primitivesPerFeature:1),p=(0,y.pC)(d)&&d.drawCallsPerFeature>0?l/d.drawCallsPerFeature*.3:l,g=Math.ceil(h/u),_=Math.max(a,Math.min(l,g,p)),v=this._get("displayFeatureLimit");return v&&v.minimumTotalNumberOfFeatures===a&&v.maximumTotalNumberOfFeatures===l&&v.maximumTotalNumberOfPrimitives===h&&v.averageSymbolComplexity===d&&v.maximumNumberOfFeatures===_?v:{minimumTotalNumberOfFeatures:a,maximumTotalNumberOfFeatures:l,maximumTotalNumberOfPrimitives:h,averageSymbolComplexity:d,maximumNumberOfFeatures:_}}get averageSymbolComplexity(){const c=function Bl(c){const a=Gs(c);return a.numComplexities>0&&(a.primitivesPerFeature/=a.numComplexities,a.primitivesPerCoordinate/=a.numComplexities,a.drawCallsPerFeature/=a.numComplexities,a.memory.bytesPerFeature/=a.numComplexities,a.memory.bytesPerFeatureLabel/=a.numComplexities,a.memory.bytesPerCoordinate/=a.numComplexities,a.memory.resourceBytes/=a.numComplexities,a.memory.draped.bytesPerFeature/=a.numComplexities,a.memory.draped.bytesPerFeatureLabel/=a.numComplexities,a.memory.draped.bytesPerCoordinate/=a.numComplexities),a}(this._symbolComplexities),a=this._get("averageSymbolComplexity");return 0===c.numComplexities||(0,y.pC)(a)&&(c.estimated&&(a.primitivesPerFeature>=c.primitivesPerFeature||a.primitivesPerCoordinate>=c.primitivesPerCoordinate||a.drawCallsPerFeature>=c.drawCallsPerFeature)||a.primitivesPerFeature===c.primitivesPerFeature&&a.primitivesPerCoordinate===c.primitivesPerCoordinate&&a.drawCallsPerFeature===c.drawCallsPerFeature)?a:c}get usedMemory(){const c=(0,y.pC)(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,a=this._getSymbolComplexitiesUsed().reduce((l,h)=>l+h.memory.resourceBytes,0);return this._usedMemory+c+a}get usedMemoryPerGraphic(){if(this._usedMemory&&this._numberOfGraphics){const c=this._numberOfGraphics/(this._numberOfGraphics+Math.max(this._pendingAdds,this._pendingRemoves));return this._usedMemory/this._numberOfGraphics*c}return(0,y.pC)(this.averageSymbolComplexity)?this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}get unprocessedMemoryEstimate(){return(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic}get _symbolComplexities(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this._getSymbolComplexitiesUsed()}get visible(){return this._visible}_getConvertedSymbol(c){if("web-style"===c.type)return c.clone();const a=this._symbolConversionCache.get(c.id);if((0,y.pC)(a))return a;const l=(0,ai.q)(c,{geometryType:this.layer?.geometryType??void 0,retainId:!0,hasLabelingContext:this._hasLabelingContext(c)}),h=l.symbol||null;return(0,y.Wi)(h)&&l.error&&yt.error(l.error.message),this._symbolConversionCache.set(c.id,h),h}_getSymbolComplexitiesUsedOrRenderer(c){if((0,y.Wi)(c))return[];const a=c.getSymbols(),l="backgroundFillSymbol"in c?c.backgroundFillSymbol:null;if(!(l||a&&a.length))return[];const h=[],d=this._getSymbolComplexityUsedOrRenderer(l);(0,y.pC)(d)&&h.push(d);for(const u of a){const p=this._getSymbolComplexityUsedOrRenderer(u);(0,y.pC)(p)&&h.push(p)}return h}_getSymbolComplexityUsedOrRenderer(c){if((0,y.Wi)(c))return null;const a=this._symbols.get(c.id);if((0,y.pC)(a))return a.complexity;const l=this._getConvertedSymbol(c);return(0,y.pC)(l)?function Fl(c){return"web-style"===c.type?Us:Gs(c.symbolLayers.toArray().map(a=>an(c,a)))}(l):null}_getSymbolComplexitiesUsed(){const c=[];return this._symbols.forEach(a=>{(0,y.pC)(a)&&c.push(a.complexity)}),c}get _objectIdField(){return this.layer.objectIdField}constructor(c){super(c),this._propertiesPool=new xu.L({computedExtent:Zs.Z},this),this.computedExtent=null,this.currentRenderer=null,this.rendererHasGeometryOperations=!1,this._graphicStateTracking=null,this.graphics3DGraphics=new Map,this.stageLayer=null,this.stage=null,this._graphicsDrapedUids=new Set,this._graphicsBySymbol=new Map,this._symbolConversionCache=new Map,this._symbols=new Map,this._graphicsWithoutSymbol=new Map,this._graphicsWaitingForSymbol=new Map,this._graphicsUpdateId=0,this._handles=new Tr.Z,this._frameTask=Ct.sq,this._suspendSymbolCleanup=!1,this._arcadeOnDemand=null,this._rendererChangeAbortController=null,this._elevationInfoChangeAbortController=null,this._initializeAbortController=null,this._scaleVisibility=null,this._filterVisibility=null,this._spatialIndex=null,this.extentPadding=0,this._updatingPendingLoadedGraphicsChange=null,this._featureStore=null,this._deconflictor=null,this._labeler=null,this._objectStates=null,this._viewElevationProvider=null,this._stageLayerElevationProvider=null,this._sharedSymbolResourcesOwnerHandle=null,this._whenGraphics3DGraphicRequests={},this._pendingUpdates=new Map,this._numberOfGraphics=0,this._numberOfGraphicsProvidingElevation=0,this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this._loadingSymbols=0,this._pendingUpdatesPool=new xs.Z({allocator:a=>a||new Lu,deallocator:a=>(a.clear(),a)}),this._symbolWarningLogged=!1,this._geometryWarningLogged=!1,this._objectIdInvisibleSet=new Set,this._whenSymbolRemoved=new xs.Z,this.preferredUpdatePolicy=rt.j.SYNC,this._forcedUpdatePolicy=null,this.elevationFeatureExpressionEnabled=!0,this.owner=null,this.layer=null,this.graphicSymbolSupported=!0,this.getRenderingInfoWithoutRenderer=!1,this.setUidToIdOnAdd=!0,this.hasZ=null,this.hasM=null,this._usedMemory=0,this._visible=!1,this._startCreateGraphics=!1,this.symbolCreationContext=new Il(c.owner.view.resourceController.scheduler,(a,l)=>this._frameTask.schedule(a,l))}initialize(){this._featureStore=new Vt({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:!!this.hasZ,hasM:!!this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,getSpatialIndex:()=>this.spatialIndex,forEach:l=>this.graphics3DGraphics.forEach(l)});const c=(l,h,d)=>this.spatialIndex.queryGraphicUIDsInExtent(l,h,d),{componentFactories:a}=this;if((0,y.pC)(a.elevationAlignment)){const l=a.elevationAlignment(this,c);this._elevationAlignment=l}if((0,y.pC)(a.scaleVisibility)){const l=a.scaleVisibility(this,c);this._scaleVisibility=l}if((0,y.pC)(a.filterVisibility)){const l=a.filterVisibility({featureStore:this._featureStore,getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:h=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(xt.FILTER,h((0,Q.MS)(d.graphic,this._objectIdField)),at.GRAPHIC)),setAllFeaturesVisibility:h=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(xt.FILTER,h,at.GRAPHIC)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(h=>h.clearVisibilityFlag(xt.FILTER))});this._filterVisibility=l}if((0,y.pC)(a.deconflictor)){const l=a.deconflictor(this);this._deconflictor=l}if((0,y.pC)(a.labeler)&&(0,y.pC)(this._scaleVisibility)){const l=a.labeler(this,this._scaleVisibility);this._labeler=l}if((0,y.pC)(a.objectStates)){const l=a.objectStates(this);this._objectStates=l}this._initializeAbortController=new AbortController,this._initializePromise=this._initializeAsync()}_initializeAsync(){var c=this;return(0,B.Z)(function*(){const a=c._initializeAbortController?.signal,l=c.owner.view;c._viewElevationProvider=new Rl(c._viewSpatialReference,l),c._initializeStage(l,c.layer.uid);const h=l.sharedSymbolResources;c.symbolCreationContext.sharedResources=h,c._sharedSymbolResourcesOwnerHandle=h.addGraphicsOwner(c.owner),(0,y.pC)(c.currentRenderer)&&(c.symbolCreationContext.renderer=c.currentRenderer),c.symbolCreationContext.stage=c.stage,c.symbolCreationContext.streamDataRequester=h.streamDataRequester,c.symbolCreationContext.renderCoordsHelper=l.renderCoordsHelper,c.symbolCreationContext.layer=c.layer,c.symbolCreationContext.graphicsCoreOwner=c.owner,c.symbolCreationContext.localOriginFactory=new Pu.C(l.renderSpatialReference),c.symbolCreationContext.elevationProvider=l.elevationProvider,c.symbolCreationContext.notifyGraphicGeometryChanged=u=>c.notifyGraphicGeometryChanged(u),c.symbolCreationContext.notifyGraphicVisibilityChanged=u=>c.notifyGraphicVisibilityChanged(u);const d=(0,de.WI)(c.layer.elevationInfo,c.elevationFeatureExpressionEnabled);if(c.symbolCreationContext.featureExpressionInfoContext=yield(0,de.kr)(d,c._viewSpatialReference,a,yt),(0,j.k_)(a),c.symbolCreationContext.screenSizePerspectiveEnabled=l.screenSizePerspectiveEnabled&&!!c.layer.screenSizePerspectiveEnabled,c.symbolCreationContext.slicePlaneEnabled=!!c.owner.slicePlaneEnabled,c.symbolCreationContext.physicalBasedRenderingEnabled=!!c.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,c.symbolCreationContext.skipHighSymbolLods=!!c.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,"drapeSourceType"in c.owner){const{owner:u}=c;c.symbolCreationContext.drapeSourceRenderer=l.basemapTerrain.overlayManager.registerGeometryDrapeSource(u),c._handles.add((0,k.kB)(()=>l.basemapTerrain.overlayManager.unregisterDrapeSource(u)))}c._handles.add([(0,he.YP)(()=>c.suspendedOrOutsideOfView,()=>c._frameTask.reschedule(()=>c._updateLayerVisibility())),(0,he.YP)(()=>[c.layer?.screenSizePerspectiveEnabled,c.owner.view.screenSizePerspectiveEnabled],()=>{const u=l.screenSizePerspectiveEnabled&&!!c.layer.screenSizePerspectiveEnabled;u!==c.symbolCreationContext.screenSizePerspectiveEnabled&&(c.symbolCreationContext.screenSizePerspectiveEnabled=u,c._labeler?.reset(),c.recreateAllGraphicsAndSymbols())}),(0,he.YP)(()=>c.owner.slicePlaneEnabled,u=>c._slicePlaneEnabledChange(!!u)),(0,he.YP)(()=>c.owner.view.state?.rasterPixelRatio,()=>c._pixelRatioChange()),(0,he.YP)(()=>!!c.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,u=>c._physicalBasedRenderingChange(u)),(0,he.YP)(()=>!!c.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,u=>c._skipHighSymbolLoDsChange(u)),(0,he.gx)(()=>l.basemapTerrain?.tilingScheme,u=>{!u.spatialReference.equals(c.symbolCreationContext.overlaySR)&&(0,y.pC)(l.basemapTerrain.spatialReference)&&(c.symbolCreationContext.overlaySR=l.basemapTerrain.spatialReference),c._handles.has("loaded-graphics")?c.recreateAllGraphics():c._handles.add([(0,he.on)(()=>c.owner?.loadedGraphics,"change",g=>{c._graphicsCollectionChanged(g),c._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{c.recreateAllGraphics(),c._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")},{initial:!0}),(0,he.YP)(()=>c.effectiveUpdatePolicy,u=>{(0,y.pC)(c.stageLayer)&&(c.stageLayer.updatePolicy=u),c.symbolCreationContext.isAsync=c.effectiveUpdatePolicy===rt.j.ASYNC,u===rt.j.SYNC&&c.runTask(Ct.G5)},he.tX)]),c._frameTask=l.resourceController.scheduler.registerTask(Ct.T8.GRAPHICS_CORE,c),c.layer&&"featureReduction"in c.layer&&c._handles.add((0,he.YP)(()=>c.layer.featureReduction,()=>c._deconflictor.featureReductionChange())),c.notifyChange("averageSymbolComplexity"),c.rendererChange(c.owner.renderer).catch(()=>{}),c._initializeAbortController=null})()}_abortInitialize(){this._initializeAbortController&&(this._initializeAbortController.abort(),this._initializeAbortController=null)}destroy(){this._abortInitialize(),this._abortRendererChange(),this._abortElevationInfoChange(),this._frameTask.remove(),this._frameTask=Ct.sq,this.owner.view.deconflictor.removeGraphicsOwner(this),this.owner.view.labeler.removeGraphicsOwner(this),this._elevationAlignment=(0,y.SC)(this._elevationAlignment),this._scaleVisibility=(0,y.SC)(this._scaleVisibility),this._filterVisibility=(0,y.SC)(this._filterVisibility),this._deconflictor=null,this._labeler=null,this._objectStates=(0,y.SC)(this._objectStates),this.clear(),this._featureStore=(0,y.SC)(this._featureStore),this._updatingPendingLoadedGraphicsChange=(0,y.hw)(this._updatingPendingLoadedGraphicsChange),this._graphicStateTracking=(0,y.SC)(this._graphicStateTracking),this.stage&&(this.stage.remove(this.stageLayer),this.stageLayer=null,this.stage=null),this._handles=(0,y.SC)(this._handles),this._set("owner",null);for(const c in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[c].reject(new ne.Z("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null,this._sharedSymbolResourcesOwnerHandle=(0,y.hw)(this._sharedSymbolResourcesOwnerHandle),this._propertiesPool=(0,y.SC)(this._propertiesPool),this._pendingUpdatesPool=null,this._symbolConversionCache.clear(),this._objectIdInvisibleSet.clear(),this._spatialIndex=(0,y.SC)(this._spatialIndex)}clear(){this._objectStates?.allGraphicsDeleted(),(0,y.pC)(this._graphicStateTracking)&&this._graphicStateTracking.allGraphicsDeleted(),this.graphics3DGraphics.forEach(c=>c.destroy()),this._spatialIndex?.clear(),this.graphics3DGraphics.clear(),this._numberOfGraphics=0,this._usedMemory=0,this._updateLayerVisibility(),this._symbols.forEach(y.SC),this._symbols.clear(),this._graphicsBySymbol.clear(),this._graphicsWithoutSymbol.clear(),this._graphicsWaitingForSymbol.clear(),this._pendingUpdates.clear(),this._pendingUpdatesPool.clear(),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1,this.notifyChange("updating"),this.notifyChange("running"),this.notifyChange("updatingRemaining"),this._featureStore.events.emit("changed")}_initializeStage(c,a){this.stage=c._stage,this.stageLayer=new Eu.F({pickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},a),this.stage.add(this.stageLayer);const l=this.stageLayer.events;l.on("objectTransformation",h=>this.notifyGraphicGeometryChanged(h.metadata.graphicUid)),l.on("visibilityChanged",h=>this.notifyGraphicVisibilityChanged(h.metadata.graphicUid)),l.on("objectGeometryAdded",h=>this.notifyGraphicGeometryChanged(h.object.metadata.graphicUid)),l.on("objectGeometryRemoved",h=>this.notifyGraphicGeometryChanged(h.object.metadata.graphicUid)),l.on("objectGeometryUpdated",h=>this.notifyGraphicGeometryChanged(h.object.metadata.graphicUid))}notifyGraphicGeometryChanged(c){if((0,y.Wi)(this._graphicStateTracking)||(0,y.Wi)(c))return;const a=this.graphics3DGraphics.get(c);a&&this._graphicStateTracking.updateGraphicGeometry(a)}notifyGraphicVisibilityChanged(c){if((0,y.Wi)(this._graphicStateTracking)||(0,y.Wi)(c))return;const a=this.graphics3DGraphics.get(c);a&&this._graphicStateTracking.updateGraphicVisibility(a)}_updateLayerVisibility(){const l=!(this.suspendedOrOutsideOfView||this._numberOfGraphics>this.displayFeatureLimit.maximumNumberOfFeatures*Iu);l!==this._visible&&(this._visible=l,l?(this.stageLayer.pickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.pickable=!1,this._hideAllGraphics()),this._updateStageLayerVisibility())}_updateStageLayerVisibility(){this.stageLayer.visible=this._visible&&(null==this.layer.opacity||this.layer.opacity>0)}getGraphics3DGraphicById(c){return null!=c?this.graphics3DGraphics.get(c):void 0}getGraphics3DGraphicByObjectId(c){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(c):null}_getGraphicObjectID(c,a=this.owner.layer&&this.owner.layer.objectIdField){return(0,Q.MS)(c,a)}get graphics3DGraphicsByObjectID(){const c=this.owner.layer&&this.owner.layer.objectIdField;if(!c)return;const a=new Map;return this.graphics3DGraphics.forEach(l=>{if(!l)return;const d=this._getGraphicObjectID(l.graphic,c);(0,y.pC)(d)&&a.set(d,l)}),a}get labelsEnabled(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}updateLabelingInfo(c){var a=this;return(0,B.Z)(function*(){const l=a._deconflictor&&a._deconflictor.labelingInfoChange(c),h=a._labeler&&a._labeler.labelingInfoChange(c);yield(0,j.as)([l,h])})()}updateVisibilityInfo(){this._deconflictor&&this._deconflictor.labelingInfoChange(),this._labeler&&this._labeler.visibilityInfoChange()}get symbolUpdateType(){if(this._pendingUpdates.size>0)return"unknown";let c=0,a=0;return(0,za.oE)(this._symbols,(l,h)=>{if((0,y.pC)(l)){const d=l.getFastUpdateStatus();if(d.loading>0)return!0;this._graphicsBySymbol.has(h)&&(a+=d.fast,c+=d.slow)}return!1})?"unknown":a>=0&&0===c?"fast":c>=0&&0===a?"slow":"mixed"}runTask(c){if(this._frameTask.processQueue(c),this._applyPendingUpdates(c),this.notifyChange("running"),this.running||this.notifyChange("updating"),this.notifyChange("updatingRemaining"),!c.hasProgressed)return Ct.iQ.YIELD}setObjectIdVisibility(c,a){a?this._objectIdInvisibleSet.delete(c):this._objectIdInvisibleSet.add(c);const l=this._findGraphics3DGraphicByObjectId(c);(0,y.pC)(l)&&this._updateUserVisibility(l)}_findGraphics3DGraphicByObjectId(c){return(0,za.fQ)(this.graphics3DGraphics,a=>this._getGraphicObjectID(a.graphic)===c)}_updateUserVisibility(c){if((0,y.Wi)(c))return!1;const a=c.graphic,l=this._getGraphicObjectID(a),h=a.visible&&!this.owner.suspended&&((0,y.Wi)(l)||!this._objectIdInvisibleSet.has(l));return c.setVisibilityFlag(xt.USER_SETTING,h,at.GRAPHIC)}_whenGraphics3DGraphic(c){const a=this.graphics3DGraphics.get(c.uid);if(a)return Promise.resolve(a);const l=this._whenGraphics3DGraphicRequests[c.uid];if(l)return l.promise;const h=(0,j.dD)();return this._whenGraphics3DGraphicRequests[c.uid]=h,h.promise}_boundsForGraphics3DGraphic(c,a){var l=this;return(0,B.Z)(function*(){const h=l._viewSpatialReference,d=l.owner.view.renderSpatialReference,u=l.owner.view.basemapTerrain.spatialReference,_=l._viewElevationProvider?{service:l._viewElevationProvider,useViewElevation:!!(0,y.pC)(a)&&!!a.useViewElevation,minDemResolution:(0,y.pC)(a)?a.minDemResolution:null,minDemResolutionForPoints:l.owner.view.resolution}:null,v=yield c.getProjectedBoundingBox((C,x,R)=>(0,Se.CM)(C,d,x,C,h,x,R),(C,x,R)=>(0,Se.CM)(C,u,x,C,h,x,R),_,(0,y.U2)(a,"signal"));if(!v)return null;const b=v.boundingBox;if(v.requiresDrapedElevation){const C=l.symbolCreationContext.elevationProvider;if(C){(0,V.be)(b,Ta);const x=(0,y.Pt)(C.getElevation(Ta[0],Ta[1],0,h,"ground"),0);b[2]=Math.min(b[2],x),b[5]=Math.max(b[5],x)}}return{boundingBox:b,screenSpaceObjects:v.screenSpaceObjects}})()}whenGraphicBounds(c,a){var l=this;return(0,B.Z)(function*(){yield(0,he.N1)(()=>l.owner?.loadedGraphics);const h=l.owner.layer&&l.owner.layer.objectIdField,d=l.owner.loadedGraphics.find(p=>p===c||null!=h&&null!=p.attributes&&c.attributes&&p.attributes[h]===c.attributes[h]);if(!d)throw new ne.Z("internal:graphic-not-part-of-view","Graphic is not part of this view");const u=yield l._whenGraphics3DGraphic(d);return l._boundsForGraphics3DGraphic(u,a)})()}computeAttachmentOrigin(c,a){const l=this.graphics3DGraphics.get(c.uid);if(!l)return null;const h=l.computeAttachmentOrigin();if(0===h.render.num&&0===h.draped.num)return null;(0,E.s)($t,0,0,0);let d=0;if(h.render.num>0){if(!(0,Se.SH)(h.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,ir,a))return null;(0,E.a)($t,$t,ir),d++}if(h.draped.num>0){const[u,p]=h.draped.origin,g=(0,y.Pt)(this._viewElevationProvider.getElevation(u,p,"ground"),0);if((0,E.s)(ir,u,p,g),!(0,Se.SH)(ir,this._viewElevationProvider.spatialReference,ir,a))return null;(0,E.a)($t,$t,ir),d++}return d>1&&(0,E.g)($t,$t,1/d),new Ou.Z({x:$t[0],y:$t[1],z:$t[2],spatialReference:a})}getSymbolLayerSize(c,a){const l=this._symbols.get(c.id);if((0,y.Wi)(l))throw new ne.Z("internal:symbol-not-part-of-view","Symbol is not part of this view");const h=c.symbolLayers.indexOf(a);if(-1===h)throw new ne.Z("internal:missing-symbol-layer","Symbol layer is not in symbol");const d=l.getSymbolLayerSize(h);if((0,y.Wi)(d))throw new ne.Z("internal:missing-size","Symbol layer has no valid size");return d}_graphicsCollectionChanged(c){this._startCreateGraphics&&(this.add(c.added),this.remove(c.removed))}graphicUpdateHandler(c){const a=c.graphic.uid,l=this.graphics3DGraphics.get(a);if(!(0,y.Wi)(l)||!(0,y.Wi)(this._graphicsWithoutSymbol.get(a)))switch(c.property){case"visible":this._graphicUpdateVisibleHandler(l);break;case"geometry":this._graphicUpdateGeometryHandler(l,c);break;case"symbol":this._graphicUpdateSymbolHandler(l,c);break;case"attributes":break;case"transform":this._graphicUpdateTransformHandler(l,c)}}_graphicUpdateGeometryHandler(c,a){const l=a.graphic.geometry;if((0,y.Wi)(l))return void this._recreateGraphic(a.graphic);if((0,y.Wi)(c)){const d=a.graphic.symbol&&a.graphic.symbol.id;if(d){const u=this._symbols.get(d);if((0,y.pC)(u)&&u.loadStatus===ft.LOADING)return}return void this._recreateGraphic(a.graphic)}const h=c.graphics3DSymbol;!(0,y.Wi)(a.newValue)&&h.updateGeometry(c,a.newValue)||this._recreateGraphic(c.graphic),this._expandComputedExtent(l)}_graphicUpdateSymbolHandler(c,a){const l=a.graphic,h=(0,y.pC)(c)?c.graphics3DSymbol:(0,y.pC)(a.oldValue)?this._symbols.get(a.oldValue.id):null;if((0,y.Wi)(h)||(0,y.Wi)(a.newValue))return void this._recreateGraphic(l);const d=h.symbol,u=this._getConvertedSymbol(a.newValue);if((0,y.pC)(u)&&(u.type!==d.type||"web-style"===u.type)||"web-style"===d.type)return void this._recreateGraphic(l);const p=this._graphicsBySymbol.get(d.id);if(p&&1!==p.size)return void this._recreateGraphic(l);const g=(0,U.Hg)(d,u);if((0,y.Wi)(g))return void this._updateSymbolMapping(d.id,u);const _={diff:g,graphics3DGraphicPatches:[],symbolStatePatches:[]};if(h.prepareSymbolPatch(_),!(0,U.xb)(_.diff))return void this._recreateGraphic(l);const v=this._getRenderingInfo(l);if((0,y.Wi)(v))return void this._recreateGraphic(l);const b=h.extentPadding;for(const C of _.symbolStatePatches)C();if(b!==h.extentPadding&&this._recomputeExtentPadding(),(0,y.pC)(c))for(const C of _.graphics3DGraphicPatches)C(c,v);this._updateSymbolMapping(d.id,u)}_graphicUpdateVisibleHandler(c){this._updateUserVisibility(c)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())}_graphicUpdateTransformHandler(c,a){}recreateGraphics(c){this._suspendSymbolCleanup=!0,this.remove(c),this.add(c),this._suspendSymbolCleanup=!1,this.effectiveUpdatePolicy===rt.j.SYNC&&this._cleanupSymbols()}_recreateGraphic(c){this.recreateGraphics([c])}_beginGraphicUpdate(c){const a=this._graphicsUpdateId;return this._graphicsUpdateId++,this._graphicsWaitingForSymbol.set(c.uid,a),1===this._graphicsWaitingForSymbol.size&&this.notifyChange("updating"),a}_endGraphicUpdate(c){c&&(this._graphicsWaitingForSymbol.delete(c.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))}_recomputeExtentPadding(){let c=0;this._symbols.forEach(a=>{(0,y.pC)(a)&&(c=Math.max(c,a.extentPadding))}),this._set("extentPadding",c)}_expandComputedExtent(c){const a=Au,l=c.spatialReference;(0,Q.FS)(c,a);const h=this._viewSpatialReference,d=Ra.tmpVec;if((0,Va.fS)(l,h)||(0,Se.Rg)(a[0],a[1],0,l,d,h)&&(a[0]=d[0],a[1]=d[1],(0,Se.Rg)(a[3],a[4],0,l,d,h),a[3]=d[0],a[4]=d[1]),!(isFinite(a[0])&&isFinite(a[3])&&isFinite(a[1])&&isFinite(a[4])))return;const u=this.computedExtent;let p=null;const g=isFinite(a[2])&&isFinite(a[5]),_=g&&(!u||null==u.zmin||a[2]<u.zmin),v=g&&(!u||null==u.zmax||a[5]>u.zmax);u?(a[0]<u.xmin||a[1]<u.ymin||a[3]>u.xmax||a[4]>u.ymax||_||v)&&(p=this._propertiesPool.get("computedExtent"),p.xmin=Math.min(a[0],u.xmin),p.ymin=Math.min(a[1],u.ymin),p.xmax=Math.max(a[3],u.xmax),p.ymax=Math.max(a[4],u.ymax),p.spatialReference=h):(p=this._propertiesPool.get("computedExtent"),p.xmin=a[0],p.ymin=a[1],p.xmax=a[3],p.ymax=a[4],p.spatialReference=h),p&&(_&&(p.zmin=a[2]),v&&(p.zmax=a[5]),this._set("computedExtent",p))}_abortElevationInfoChange(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)}elevationInfoChange(){var c=this;return(0,B.Z)(function*(){c._abortElevationInfoChange();const a=new AbortController;c._elevationInfoChangeAbortController=a;const l=(0,de.WI)(c.layer.elevationInfo,c.elevationFeatureExpressionEnabled);c.symbolCreationContext.featureExpressionInfoContext=yield(0,de.kr)(l,c._viewSpatialReference,a.signal,yt),(0,j.k_)(a.signal),c._elevationInfoChangeAbortController=null,c._labeler?.elevationInfoChange(),c.forEachGraphics3DSymbol((h,d,u)=>{h.globalPropertyChanged("elevationInfo",d)?d.forEach(p=>{const g=p.graphic,_=p.labelLayers;for(const v of _)v.graphics3DSymbolLayer.updateGraphicElevationContext(g,v)}):c._recreateSymbol(u)}),c.updateStageLayerElevationProvider(),c._elevationAlignment?.elevationInfoChange()})()}updateStageLayerElevationProvider(){this._stageLayerElevationProvider?(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,y.M2)(this._stageLayerElevationProvider)):(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&this._numberOfGraphicsProvidingElevation>0&&(this._stageLayerElevationProvider=new Gi({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))}_clearSymbolsAndGraphics(){this.clear(),(0,y.pC)(this._filterVisibility)&&this._filterVisibility.clear(),this._labeler?.reset(),this._deconflictor?.clear(),this._elevationAlignment?.clear(),this.stageLayer?.invalidateSpatialQueryAccelerator(),this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider=(0,y.M2)(this._stageLayerElevationProvider))}startCreateGraphics(){this._startCreateGraphics=!0,this.recreateAllGraphics()}recreateAllGraphics(){this._recreateAllGraphics(!1)}recreateAllGraphicsAndSymbols(){this._recreateAllGraphics(!0)}_recreateAllGraphics(c=!1){if(!this._startCreateGraphics)return;const{loadedGraphics:a,view:l}=this.owner,h=l.basemapTerrain.tilingScheme&&a&&a.length?a.toArray():null;!c&&h||this._clearSymbolsAndGraphics(),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&!!this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this._set("computedExtent",null),h&&(c?this.add(h):this.recreateGraphics(h))}_recreateSymbol(c){const a=this._graphicsBySymbol.get(c),l=[];a&&(a.forEach((d,u)=>{const p=d.usedMemory;this._conditionalRemove(d,u),this._spatialIndex?.remove(d),l.push(d.graphic),d.destroy(),this._removeGraphics3DGraphic(u,p),this._updateLayerVisibility(),this._featureStore.events.emit("changed")}),this._graphicsBySymbol.set(c,new Map));const h=this._symbols.get(c);(0,y.SC)(h),this._symbols.delete(c),this.add(l)}_recreateGraphicsForSymbol(c){const a=this._graphicsBySymbol.get(c);if(a){const l=[];a.forEach(h=>l.push(h.graphic)),this.recreateGraphics(l)}}_conditionalRemove(c,a){this._graphicsDrapedUids.delete(a),this._objectStates?.removeGraphic(c),this._labeler?.removeGraphic(c),this._deconflictor?.removeGraphic(c),(0,y.pC)(this._graphicStateTracking)&&this._graphicStateTracking.removeGraphic(c)}add(c){c&&0!==c.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(c)===rt.j.ASYNC?this._addDelayed(c):this._addImmediate(c),this.notifyChange("updating")):yt.error("#add()","Cannot add graphics before terrain surface has been initialized"))}_updatePolicyForGraphics(c){if(this.effectiveUpdatePolicy===rt.j.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const a of c)if((0,y.pC)(a.geometry)&&"mesh"===a.geometry.type&&!a.geometry.loaded)return rt.j.ASYNC;return this.effectiveUpdatePolicy}_addImmediate(c){this._geometryWarningLogged=!1,this._symbolWarningLogged=!1;for(const a of c)this._addGraphic(a,this._getRenderingInfo(a,yt),rt.j.SYNC);this._cleanupSymbols(),this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols()),this.owner.view.deconflictor.setDirty()}_addDelayed(c){for(const a of c){const l=a.uid;let h=this._pendingUpdates.get(l);h?h.add?h.state!==ke.NEW&&h.abortController?.abort():this._pendingAdds++:(h=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(l,h)),h.add=a}this.notifyChange("running"),this.notifyChange("updatingRemaining")}remove(c){this.effectiveUpdatePolicy===rt.j.ASYNC?this._removeDelayed(c):this._removeImmediate(c),this.notifyChange("updating")}_removeImmediate(c){for(const a of c)this._removeGraphic(a);this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_removeDelayed(c){for(const a of c){const l=a.uid,h=this._pendingUpdates.get(l);if(h)h.add&&(h.remove?h.add=null:this._pendingUpdates.delete(l),h.state===ke.LOADING&&h.abortController?.abort(),this._pendingAdds--);else{const d=this._pendingUpdatesPool.pushNew();d.remove=a,this._pendingUpdates.set(l,d),this._pendingRemoves++,this._applyPendingRemovesFirst=!0}}0===this._pendingUpdates.size&&this._finishPendingUpdates(),this.notifyChange("running"),this.notifyChange("updatingRemaining")}_finishPendingUpdates(){this._pendingUpdatesPool.clear(),this._cleanupSymbols(),(this._pendingAdds||this._pendingRemoves)&&yt.warn("pendingAdds/Removes in inconsistent state!"),this._pendingAdds=0,this._pendingRemoves=0,this._applyPendingRemovesFirst=!1}_applyPendingUpdates(c){if(this._geometryWarningLogged=!1,this._symbolWarningLogged=!1,0===this._pendingUpdates.size&&this._spatialIndex?.updating)return this._spatialIndex.update(),void c.madeProgress();if(this._applyPendingRemovesFirst){this._applyPendingRemovesFirst=!1;for(const[a,l]of this._pendingUpdates){if(c.done){this._applyPendingRemovesFirst=!0;break}if(l.remove&&!l.add&&(this._pendingRemoves--,c.madeProgress(),this._removeGraphic(l.remove),l.remove=null,this._pendingUpdates.delete(a),0===this._pendingRemoves))break}}for(const[a,l]of this._pendingUpdates){if(c.done)break;l.add&&l.state===ke.NEW&&this._processPendingUpdateNew(l);let h=this.effectiveUpdatePolicy;if(!l.remove||l.add&&l.state!==ke.READY||(this._pendingRemoves--,c.madeProgress(),this._removeGraphic(l.remove),l.remove=null,h=rt.j.SYNC),l.add)switch(l.state){case ke.READY:this._addGraphic(l.add,l.renderingInfo,h),l.add=null,this._pendingAdds--,c.madeProgress();break;case ke.REJECTED:l.add=null,this._pendingAdds--}null==l.remove&&null==l.add&&this._pendingUpdates.delete(a)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}_processPendingUpdateNew(c){if(!c.add)return void(c.state=ke.READY);const a=c.add.geometry;(0,y.pC)(a)&&"mesh"===a.type&&!a.loaded?this._processPendingUpdateNewMesh(c,a):this._processPendingUpdateNewRenderingInfo(c)}_processPendingUpdateNewMesh(c,a){var l=this;return(0,B.Z)(function*(){c.state=ke.LOADING,c.abortController=new AbortController;const h=c.abortController.signal;try{yield a.load({signal:h})}catch(d){return l._processPendingUpdateNewError(c,d)}c.abortController=null,l._processPendingUpdateNewRenderingInfo(c)})()}_processPendingUpdateNewError(c,a){c.abortController=null,c.state=(0,j.D_)(a)?ke.NEW:ke.REJECTED}_processPendingUpdateNewRenderingInfo(c){var a=this;return(0,B.Z)(function*(){if((0,y.Wi)(a.layer.renderer)||"dictionary"!==a.layer.renderer.type)return c.renderingInfo=a._getRenderingInfo(c.add,yt),void(c.state=ke.READY);c.state=ke.LOADING,c.abortController=new AbortController;let l=null;try{l=yield a._getRenderingInfoAsync(c.add,{signal:c.abortController.signal})}catch(h){return c.abortController=null,void(c.state=(0,j.D_)(h)?ke.NEW:ke.REJECTED)}(0,y.Wi)(l)||(0,y.Wi)(l.symbol)?(yt&&!a._symbolWarningLogged&&(a._symbolWarningLogged=!0,yt.warn(`Graphic in layer ${a.layer.id} has no symbol and will not render`)),c.renderingInfo=null):c.renderingInfo=l,c.state=ke.READY})()}_addGraphic(c,a,l){if(this._graphicsWithoutSymbol.set(c.uid,c),(0,y.Wi)(a)||(0,y.Wi)(a.symbol)||!(0,Q.S6)(c))return;(0,y.pC)(this.stage.renderView.objectAndLayerIdRenderHelper)&&this.setUidToIdOnAdd&&this.stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(c.objectId,c.uid,this.layer.id,this.layer.uid,!!this.layer.popupEnabled);const d=this.getOrCreateGraphics3DSymbol(a.symbol,a.renderer);if((0,y.Wi)(d))return;this._expandComputedExtent(c.geometry);const u=this._beginGraphicUpdate(c),p=new Ll(c,a,this.layer);let g=!1;const _=C=>{C===d.symbol.id&&(g=!0)};this._whenSymbolRemoved.push(_);const v=()=>{if(--this._loadingSymbols,!this.destroyed){if(this._whenSymbolRemoved.removeUnordered(_),this._graphicsWaitingForSymbol.get(c.uid)!==u||g||d.destroyed||this.graphicSymbolSupported&&c.symbol&&c.symbol.id!==d.symbol.id)--d.referenced,this._cleanupSymbols();else{const C=this._createGraphics3DGraphic(d,p);this._spatialIndex&&(0,y.pC)(C)&&this._spatialIndex.add(C),--d.referenced,this._endGraphicUpdate(c)}this._featureStore.events.emit("changed"),this._labeler&&this.owner.view.labeler.setDirty()}},b=C=>{--this._loadingSymbols,this.destroyed||(this._whenSymbolRemoved.removeUnordered(_),g||((0,j.D_)(C)?this.add([c]):d.destroyed||this._endGraphicUpdate(c)))};++this._loadingSymbols,l===rt.j.ASYNC?d.load(()=>this._frameTask.schedule(v),C=>this._frameTask.schedule(()=>b(C))):d.load(v,b)}_removeGraphic(c){const a=c.uid,l=this.graphics3DGraphics.get(a);if(l){l.graphics3DSymbol.onRemoveGraphic(l);const h=l.usedMemory,d=l.isElevationSource;this._conditionalRemove(l,a),this._spatialIndex?.remove(l),this._graphicsBySymbol.get(l.graphics3DSymbol.symbol.id)?.delete(a),this._graphicsWithoutSymbol.delete(a),this._removeGraphics3DGraphic(a,h,d),l.destroy(),this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(a),this._graphicsWaitingForSymbol.delete(a),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))}_hasLabelingContext(c){if(c instanceof jo.Z||c instanceof Ru.Z){const a=this.symbolCreationContext.layer;return!!a.labelingInfo&&a.labelingInfo.some(l=>l.symbol===c)}return!1}_hasValidSymbolCreationContext(c){return!(c instanceof jo.Z&&!this._hasLabelingContext(c)&&(yt.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),1))}_getRenderingInfo(c,a){const l=c.geometry;if((0,y.Wi)(l))return a&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!(0,Se.Up)(l.spatialReference,this._viewSpatialReference))return a&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&(0,y.pC)(c.symbol))return a&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const h=this.rendererHasGeometryOperations?(0,Y.mW)(c,this.layer):c;let d;return d=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||(0,y.pC)(this.currentRenderer))?this.owner.getRenderingInfo(h,this.currentRenderer,this._arcadeOnDemand):{symbol:h.symbol||Ol(h.geometry)},(0,y.Wi)(d)||(0,y.Wi)(d.symbol)?(a&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):d}_getRenderingInfoAsync(c,a){if((0,y.Wi)(c.geometry))return yt&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,yt.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!this.graphicSymbolSupported&&(0,y.pC)(c.symbol))return yt&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,yt.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;const h=this.rendererHasGeometryOperations?(0,Y.mW)(c,this.layer):c;return this.owner.getRenderingInfoAsync(h,this.currentRenderer,this._arcadeOnDemand,a)}_createGraphics3DSymbol(c,a){if(!this._hasValidSymbolCreationContext(c))return null;const l=this._getConvertedSymbol(c);if(!l)return null;let h;if((0,y.pC)(a)&&"backgroundFillSymbol"in a&&a.backgroundFillSymbol){const u=(0,ai.q)(a.backgroundFillSymbol,{ignoreDrivers:!0});(0,y.pC)(u.symbol)&&"web-style"!==u.symbol.type&&"cim"!==u.symbol.type&&(h=u.symbol.symbolLayers)}const d=function yu(c,a,l){return"point-3d"===c.type?new mu(c,a,l):new Fo(c,a,l)}(l,this.symbolCreationContext,h);return d.load(()=>{const u=d.extentPadding;u>this.extentPadding&&this._set("extentPadding",u),this.notifyChange("averageSymbolComplexity")},()=>{}),d}getOrCreateGraphics3DSymbol(c,a){let l=this._symbols.get(c.id);return void 0===l&&(l=c instanceof Tu.Z?new fu(c,h=>this._frameTask.schedule(h),h=>this._createGraphics3DSymbol(h,a)):this._createGraphics3DSymbol(c,a),this._symbols.set(c.id,l)),(0,y.pC)(l)&&++l.referenced,l}trackGraphicState(c){return(0,y.Wi)(this._graphicStateTracking)&&(this._graphicStateTracking=new _u(this)),this._graphicStateTracking.add(c)}_addGraphics3DGraphic(c){this._usedMemory+=c.usedMemory,this.graphics3DGraphics.set(c.graphic.uid,c),this._numberOfGraphics++,c.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_removeGraphics3DGraphic(c,a,l=!1){this._usedMemory-=a,this.graphics3DGraphics.delete(c),this._numberOfGraphics--,l&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider()),this._updateLayerVisibility()}_createGraphics3DGraphic(c,a){const l=a.graphic;if(this._graphicsWithoutSymbol.delete(l.uid),!this._symbols.has(c.symbol.id))return this.add([l]),null;if(this.graphics3DGraphics.has(l.uid))return null;const h=c.createGraphics3DGraphic(a);if((0,y.Wi)(h))return null;this._addGraphics3DGraphic(h);const d=c.symbol.id;if(this._graphicsBySymbol.has(d)||this._graphicsBySymbol.set(d,new Map),this._graphicsBySymbol.get(d).set(l.uid,h),h.isDraped&&this._graphicsDrapedUids.add(l.uid),h.centroid=null,(0,y.pC)(l.geometry)&&"point"!==l.geometry.type&&(h.centroid=(0,Ne.zE)(l.geometry,this._viewSpatialReference)),this._updateUserVisibility(h),(0,y.pC)(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(h),(0,y.pC)(this._filterVisibility)){const{defaultVisibility:p}=this._filterVisibility;h.setVisibilityFlag(xt.FILTER,p,at.GRAPHIC),p||this._filterVisibility.reapply()}this._deconflictor?.addGraphic(h),this._labeler?.addGraphic(h),this._objectStates?.addGraphic(h),this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,h),h.initialize(this.stage,this.stageLayer,this.owner),(0,y.pC)(this._graphicStateTracking)&&this._graphicStateTracking.addGraphic(h);const u=this._whenGraphics3DGraphicRequests[l.uid];return u&&(delete this._whenGraphics3DGraphicRequests[l.uid],u.resolve(h)),h}_abortRendererChange(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)}rendererChange(c){var a=this;return(0,B.Z)(function*(){if(a._abortRendererChange(),c!==a.currentRenderer)if(a._validateRenderer(c),(0,y.Wi)(c)&&a._currentRendererChange(null,!1),Fa(c))if((0,y.pC)(c)&&c.arcadeRequired){const l=new AbortController;a._rendererChangeAbortController=l;const{arcadeUtils:h}=yield a._ensureArcade();(0,j.k_)(l);const d=h.hasGeometryOperations(c);d&&(yield h.enableGeometryOperations(),(0,j.k_)(l)),a.effectiveUpdatePolicy===rt.j.ASYNC?yield a._frameTask.schedule(()=>a._currentRendererChange(c,d),l.signal):a._currentRendererChange(c,d),a._rendererChangeAbortController=null}else if(a.effectiveUpdatePolicy===rt.j.ASYNC){const l=new AbortController;a._rendererChangeAbortController=l,yield a._frameTask.schedule(()=>a._currentRendererChange(c,!1),l.signal),a._rendererChangeAbortController=null}else a._currentRendererChange(c,!1);else a._currentRendererChange(c,!1)})()}_ensureArcade(){var c=this;return(0,B.Z)(function*(){return(0,y.Wi)(c._arcadeOnDemand)&&(c._arcadeOnDemand=yield(0,Es.LC)()),c._arcadeOnDemand})()}_currentRendererChange(c,a){this.currentRenderer=c,this.rendererHasGeometryOperations=a,this.symbolCreationContext.arcade=(0,y.Wg)(this._arcadeOnDemand);const l=this.symbolCreationContext.renderer;if(c===l)return;if(this._symbolConversionCache.clear(),(0,y.Wi)(c))return this.symbolCreationContext.renderer=null,void this.recreateAllGraphicsAndSymbols();const h=(0,U.Hg)(l,c);this._updateUnchangedSymbolMappings(h,c,l),this.symbolCreationContext.renderer=c,(0,y.Wi)(h)||("complete"===h.type?this.recreateAllGraphicsAndSymbols():"partial"===h.type&&(this._applyRendererDiff(h,c,l)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}_diffHasSymbolChange(c){for(const a in c.diff)switch(a){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"uniqueValueGroups":case"authoringInfo":case"fieldDelimiter":delete c.diff[a];break;default:return!0}return!1}_applySymbolSetDiff(c,a,l){c=c||[],a=a||[];const h=[];for(const d of a){const u=this._graphicsBySymbol.get(d.id);u&&u.forEach((p,g)=>{const _=p.graphic,v=this.layer instanceof Z.Z?this.layer:null,b=(0,y.Wg)(this._arcadeOnDemand);if(d===l.defaultSymbol&&l.getSymbol((0,Y.mW)(_,v),{arcade:b})===l.defaultSymbol)return;const C=p.usedMemory;c.length||l.defaultSymbol?h.push(_):this._graphicsWithoutSymbol.set(g,_);const x=this.graphics3DGraphics.get(g);this._conditionalRemove(x,g),p.destroy(),u.delete(g),this._removeGraphics3DGraphic(g,C),this._updateLayerVisibility()}),this._whenSymbolRemoved.forAll(p=>p(d.id))}(c.length||h.length)&&(this._graphicsWithoutSymbol.forEach(d=>h.push(d)),this._graphicsWithoutSymbol.clear(),this.add(h)),this._cleanupSymbols(),this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty()}_applyUniqueValueRendererDiff(c,a,l){const h=c.diff.defaultSymbol,d=c.diff.uniqueValueInfos;if(h||d){const u=d?d.added.map(g=>g.symbol).filter(y.pC):[],p=d?d.removed.map(g=>g.symbol).filter(y.pC):[];if(d)for(let g=0;g<d.changed.length;g++)u.push(d.changed[g].newValue.symbol),p.push(d.changed[g].oldValue.symbol);return h?(l.defaultSymbol&&p.push(l.defaultSymbol),a.defaultSymbol&&u.push(a.defaultSymbol)):l.defaultSymbol&&u.length&&p.push(a.defaultSymbol),this._applySymbolSetDiff(u,p,a),delete c.diff.defaultSymbol,delete c.diff.uniqueValueInfos,!0}return!1}_calculateUnchangedSymbolMapping(c,a,l){if("unique-value"!==a?.type||"unique-value"!==l?.type||(0,y.pC)(c)&&"partial"!==c.type)return[];const h=_=>(0,y.pC)(_)?_.id:null,d=c&&c.diff,u=d&&d.defaultSymbol,p=d&&d.uniqueValueInfos;let g;if(p)g=p.unchanged.map(_=>({oldId:h(_.oldValue.symbol),newId:h(_.newValue.symbol)}));else{g=[];for(const _ of l.uniqueValueInfos??[]){const v=h(_.symbol),b=a.uniqueValueInfos?.find(C=>C.value===_.value);b&&v!==h(b.symbol)&&g.push({oldId:v,newId:h(b.symbol)})}}return!u&&l.defaultSymbol&&g.push({oldId:h(l.defaultSymbol),newId:h(a.defaultSymbol)}),g}_updateSymbolMapping(c,a){const l=(0,y.pC)(a)&&a?"string"==typeof a?a:a.id:null;if((0,y.Wi)(c)||c===l)return;const h=this._graphicsBySymbol.get(c);this._graphicsBySymbol.delete(c),void 0!==h&&this._graphicsBySymbol.set(l,h);const d=this._symbols.get(c);if(void 0!==d&&(this._symbols.delete(c),this._symbols.set(l,d),(0,y.pC)(d))){const u="string"==typeof a?null:a;(0,y.pC)(u)?d.symbol=u:d.symbol.id=l}}_updateUnchangedSymbolMappings(c,a,l){const h=this._calculateUnchangedSymbolMapping(c,a,l);for(const{oldId:d,newId:u}of h)this._updateSymbolMapping(d,u)}_applyRendererDiff(c,a,l){if(this._diffHasSymbolChange(c))return!1;if(a instanceof Ga.Z&&l instanceof Ga.Z&&this._applyUniqueValueRendererDiff(c,a,l)&&0===Object.keys(c.diff).length)return!0;for(const[h]of this._graphicsBySymbol){const d=this._symbols.get(h);if((0,y.pC)(d))switch(d.applyRendererDiff(c,a)){case Ue.Recreate_Symbol:this._recreateSymbol(h);break;case Ue.Recreate_Graphics:this._recreateGraphicsForSymbol(h)}}return!0}opacityChange(){this.forEachGraphics3DSymbol((c,a)=>c.globalPropertyChanged("opacity",a)),this._updateStageLayerVisibility()}_slicePlaneEnabledChange(c){c!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=c,this.stageLayer.sliceable=c,this.forEachGraphics3DSymbol((a,l)=>a.globalPropertyChanged("slicePlaneEnabled",l)),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())}_physicalBasedRenderingChange(c){this.symbolCreationContext.physicalBasedRenderingEnabled=c,this.forEachGraphics3DSymbol((a,l,h)=>{a.globalPropertyChanged("physicalBasedRenderingEnabled",l)||this._recreateSymbol(h)})}_skipHighSymbolLoDsChange(c){this.symbolCreationContext.skipHighSymbolLods=c,this.forEachGraphics3DSymbol((a,l,h)=>{a.globalPropertyChanged("skipHighSymbolLods",l)||this._recreateSymbol(h)})}_pixelRatioChange(){this.forEachGraphics3DSymbol((c,a,l)=>{c.globalPropertyChanged("pixelRatio",a)||this._recreateSymbol(l)})}_signalUpdatingDuringAsyncLoadedGraphicsChange(){this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=(0,dl.Os)(()=>{this._updatingPendingLoadedGraphicsChange=null})}setClippingExtent(c,a){const l=this.symbolCreationContext.clippingExtent,h=(0,ze.Ue)();return this.symbolCreationContext.clippingExtent=function Cu(c,a,l){if((0,y.Wi)(c)||(0,y.Wi)(l))return!1;let h=!0;return Ze[0]=null!=c.xmin?c.xmin:0,Ze[1]=null!=c.ymin?c.ymin:0,Ze[2]=null!=c.zmin?c.zmin:0,h=h&&(0,Se.CM)(Ze,c.spatialReference,0,Ze,l,0,1),a[0]=Ze[0],a[1]=Ze[1],Ze[0]=null!=c.xmax?c.xmax:0,Ze[1]=null!=c.ymax?c.ymax:0,Ze[2]=null!=c.zmax?c.zmax:0,h=h&&(0,Se.CM)(Ze,c.spatialReference,0,Ze,l,0,1),a[2]=Ze[0],a[3]=Ze[1],null==c.xmin&&(a[0]=-1/0),null==c.ymin&&(a[1]=-1/0),null==c.xmax&&(a[2]=1/0),null==c.ymax&&(a[3]=1/0),h}(c,h,a)?(0,V.JR)((0,V.Ue)(),h):null,!(0,V.fS)(this.symbolCreationContext.clippingExtent,l)}modifyGraphics3DGraphicVisibilities(c){let a=!1;this.graphics3DGraphics.forEach(l=>{c(l)&&(a=!0)}),a&&(this.owner.view.labeler?.setDirty(),this.owner.view.deconflictor.setDirty())}forEachGraphics3DSymbol(c){for(const[a,l]of this._symbols){if((0,y.Wi)(l))return;c(l,this._graphicsBySymbol.get(a)||Du,a)}}updateAllGraphicsVisibility(){(0,y.pC)(this._filterVisibility)&&this._filterVisibility.reapply(),this.modifyGraphics3DGraphicVisibilities(c=>{const a=this._updateUserVisibility(c),l=(0,y.pC)(this._scaleVisibility)&&this._scaleVisibility.updateVisibility(c);return a||l})}_hideAllGraphics(){this.modifyGraphics3DGraphicVisibilities(c=>c.setVisibilityFlag(xt.USER_SETTING,!1,at.GRAPHIC))}_validateRenderer(c){const a=function ul(c,a){if((0,y.Wi)(c))return null;if(!Fa(c))return new ne.Z("renderer-conversion-3d:unsupported-renderer",`Unsupported renderer of type '${c.type||c.declaredClass}'`,{renderer:c});switch(c.type){case"simple":return function pl(c){return Ps(c,(0,ai.q)(c.symbol).error)}(c);case"unique-value":return function gl(c,a){const l={...ai.K,...a},h=c.uniqueValueInfos?.map(u=>(0,ai.q)(u.symbol,l).error).filter(y.pC),d=(0,ai.q)(c.defaultSymbol,l);return d.error&&h?.unshift(d.error),Ps(c,h)}(c,a);case"class-breaks":return function ml(c){const a=c.classBreakInfos.map(h=>(0,ai.q)(h.symbol).error).filter(y.pC),l=(0,ai.q)(c.defaultSymbol);return l.error&&a.unshift(l.error),Ps(c,a)}(c);case"dictionary":case"heatmap":return null}return null}(c,{geometryType:this.layer?.geometryType});a&&yt.warn(`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`,a.message)}_volatileGraphicsUpdated(){this._labeler?.reset(),this.stageLayer.shaderTransformationChanged(),this.notifyChange("updating")}_cleanupSymbols(){if(this._graphicsWaitingForSymbol.size>0||this._suspendSymbolCleanup)return;let c=!1;this._symbols.forEach((a,l)=>{if((0,y.Wi)(a)||a.referenced>0)return;const h=this._graphicsBySymbol.get(l);h&&0!==h.size||(this._graphicsBySymbol.delete(l),this._symbols.delete(l),(0,y.SC)(a),c=!0)}),c&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}get test(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map(c=>({symbolId:c,graphics:[...this._graphicsBySymbol.get(c).keys()].sort()})),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:c=>{this._forcedUpdatePolicy=c}}}get performanceInfo(){return{visible:this.graphics3DGraphics.size,missing:this._graphicsWithoutSymbol.size,pending:this._pendingUpdates.size}}};var ke;ue.tmpVec=(0,G.c)(),(0,P._)([(0,A.Cb)({readOnly:!0})],ue.prototype,"computedExtent",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"currentRenderer",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"rendererHasGeometryOperations",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_frameTask",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],ue.prototype,"_viewSpatialReference",null),(0,P._)([(0,A.Cb)()],ue.prototype,"_rendererChangeAbortController",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_elevationInfoChangeAbortController",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_initializeAbortController",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_elevationAlignment",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_scaleVisibility",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_filterVisibility",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_initializePromise",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_spatialIndex",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],ue.prototype,"extentPadding",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_updatingPendingLoadedGraphicsChange",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_featureStore",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_deconflictor",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_labeler",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_objectStates",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_loadingSymbols",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"preferredUpdatePolicy",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_forcedUpdatePolicy",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],ue.prototype,"effectiveUpdatePolicy",null),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"elevationFeatureExpressionEnabled",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"owner",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"layer",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"graphicSymbolSupported",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"getRenderingInfoWithoutRenderer",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"componentFactories",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"setUidToIdOnAdd",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"featureStore",null),(0,P._)([(0,A.Cb)()],ue.prototype,"initializePromise",null),(0,P._)([(0,A.Cb)()],ue.prototype,"scaleVisibility",null),(0,P._)([(0,A.Cb)()],ue.prototype,"elevationAlignment",null),(0,P._)([(0,A.Cb)()],ue.prototype,"objectStates",null),(0,P._)([(0,A.Cb)()],ue.prototype,"filterVisibility",null),(0,P._)([(0,A.Cb)({readOnly:!0})],ue.prototype,"updating",null),(0,P._)([(0,A.Cb)({readOnly:!0})],ue.prototype,"running",null),(0,P._)([(0,A.Cb)({readOnly:!0})],ue.prototype,"suspendedOrOutsideOfView",null),(0,P._)([(0,A.Cb)({readOnly:!0,dependsOn:[]})],ue.prototype,"updatingRemaining",null),(0,P._)([(0,A.Cb)({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],ue.prototype,"displayFeatureLimit",null),(0,P._)([(0,A.Cb)({readOnly:!0,dependsOn:[]})],ue.prototype,"averageSymbolComplexity",null),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"hasZ",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],ue.prototype,"hasM",void 0),(0,P._)([(0,A.Cb)()],ue.prototype,"_objectIdField",null),ue=Ra=(0,P._)([(0,se.j)(Wo)],ue),function(c){c[c.NEW=0]="NEW",c[c.LOADING=1]="LOADING",c[c.READY=2]="READY",c[c.REJECTED=3]="REJECTED"}(ke||(ke={}));class Lu{constructor(){this.add=null,this.renderingInfo=null,this.state=ke.NEW,this.abortController=null,this.remove=null}clear(){this.add=null,this.renderingInfo=null,this.state=ke.NEW,this.abortController=null,this.remove=null}}const Iu=10,$t=(0,G.c)(),ir=(0,G.c)(),Du=new Map;class Mu{constructor(){this._extents=new xs.Z({allocator:a=>a||(0,ze.Ue)()}),this._tmpExtent=(0,ze.Ue)(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(a){this._contains(a)||(this._removeContained(a),(0,ze.JG)(this._extents.pushNew(),a),this._dirty=!0)}pop(){return this._dirty&&this._mergeTight(),this._extents.pop()}merge(a){return this._mergeTight(a),a.hasProgressed}_mergeTight(a=Ct.G5){const l=this._extents,h=new Set;let d=0;for(;d!==l.length;){l.sort((u,p)=>u[0]-p[0]),d=l.length,h.clear();for(let u=0;u<l.length;++u){if(a.done)return;const p=l.getItemAt(u);if(p){for(let g=u+1;g<l.length;++g){const _=l.getItemAt(g);if(null==_||_[0]>=p[2])break;h.add(_)}h.forEach(g=>{if(p===g)return;if(g[2]<=p[0])return void h.delete(g);const _=(0,ze.SO)(p),v=(0,ze.SO)(g),b=this._tmpExtent;(0,ze.jn)(p,g,b);const C=_+v;((0,ze.SO)(b)-C)/C<.05&&((0,ze.JG)(p,b),h.delete(g),l.remove(g),a.madeProgress())}),h.add(p)}}}this._dirty=!1}_contains(a){return this._extents.some(l=>(0,ze.r3)(l,a))}_removeContained(a){this._extents.filterInPlace(l=>!(0,ze.r3)(a,l))}get test(){const a=this;return{containsPoint:l=>a._extents.some(h=>(0,ze.BD)(h,l))}}}let ei=class extends si.Z{constructor(c){super(c),this._dirtyExtents=new Mu,this._globalDirty=!1,this._averageExtentUpdateSize=0,this._dirtyGraphicsSet=new Set,this._handles=new Tr.Z,this._updateElevation=!1,this.graphicsCoreOwner=null,this.graphicsCore=null,this.events=new Ar.Z}initialize(){const a=this.graphicsCoreOwner.view.resourceController.scheduler;this._handles.add([this.elevationProvider.on("elevation-change",l=>this._elevationChanged(l)),(0,he.YP)(()=>this.graphicsCoreOwner.suspended,()=>this._suspendedChange()),a.registerTask(Ct.T8.ELEVATION_ALIGNMENT,this)])}destroy(){this._dirtyGraphicsSet.clear(),this._handles=(0,y.SC)(this._handles),this.graphicsCoreOwner=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null,this.elevationProvider=null}clear(){this._dirtyGraphicsSet.clear(),this.notifyChange("updating")}_suspendedChange(){!0===this.graphicsCoreOwner.suspended?this._updateElevation=!1:!1===this.graphicsCoreOwner.suspended&&this._updateElevation&&(this._globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this._globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this._dirtyGraphicsSet.size>0||this._dirtyExtents&&!this._dirtyExtents.empty||this._globalDirty}get updatingRemaining(){return this._dirtyGraphicsSet.size+this._dirtyExtents.size*this._averageExtentUpdateSize}runTask(c){for(this._globalDirty&&(this._markAllGraphicsElevationDirty(),this._globalDirty=!1,c.madeProgress()),c.run(()=>this._dirtyExtents.merge(c));this.running&&!c.done;)this._updateDirtyGraphics(c),this._updateDirtyExtents(c);this.notifyChange("updating")}_updateDirtyGraphics(c){const a=this.graphicsCoreOwner.view.renderCoordsHelper,l=this.graphicsCore.effectiveUpdatePolicy===rt.j.ASYNC;for(const h of this._dirtyGraphicsSet.keys()){const d=this.graphicsCore.getGraphics3DGraphicById(h);if(this._dirtyGraphicsSet.delete(h),(0,y.pC)(d)&&(d.alignWithElevation(this.elevationProvider,a,l),this.graphicsCoreOwner.view.deconflictor.setDirty(),c.madeProgress()),c.done)return}}_updateDirtyExtents(c){for(;!this._dirtyExtents.empty&&!c.done;){const a=this._dirtyExtents.pop(),l=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:a,spatialReference:l});const h=this._dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(a,l,d=>{const u=this.graphicsCore.getGraphics3DGraphicById(d);(0,y.pC)(u)&&u.needsElevationUpdates()&&this._dirtyGraphicsSet.add(d)}),this._averageExtentUpdateSize=.1*(this._dirtyGraphicsSet.size-h)+.9*this._averageExtentUpdateSize,c.madeProgress()}}_markAllGraphicsElevationDirty(){this._dirtyExtents.clear(),this._dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((c,a)=>this._dirtyGraphicsSet.add(a))}_elevationChanged(c){if("scene"===c.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:a,spatialReference:l}=c;if(this.graphicsCoreOwner.suspended){if(!this._updateElevation){const h=this.graphicsCore.computedExtent;h&&a[2]>h.xmin&&a[0]<h.xmax&&a[3]>h.ymin&&a[1]<h.ymax&&(this._updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:a,spatialReference:l})}else a[0]===-1/0?this._globalDirty=!0:this._dirtyExtents.add(a),this.notifyChange("updating")}};(0,P._)([(0,A.Cb)()],ei.prototype,"graphicsCoreOwner",void 0),(0,P._)([(0,A.Cb)()],ei.prototype,"graphicsCore",void 0),(0,P._)([(0,A.Cb)()],ei.prototype,"queryGraphicUIDsInExtent",void 0),(0,P._)([(0,A.Cb)()],ei.prototype,"elevationProvider",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],ei.prototype,"updating",null),(0,P._)([(0,A.Cb)({readOnly:!0})],ei.prototype,"updatingRemaining",null),ei=(0,P._)([(0,se.j)("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],ei);const Uu=ei;var Gt=S(8834),Ho=S(10992);function Gu(c,a,l,h){return function Yo(c,a,l,h){h.clip[0]=0,h.clip[1]=l?h.len:Number.MAX_VALUE;for(let d=0;d<c.length;d++)if(!Vu(c[d],a,h))return!1;return!0}(c,a,l,function Zo(c,a,l,h){const d=zu;return c?(l&&h&&(d.len=(0,E.i)(a,l)),(0,E.c)(d.dir,c)):h?(d.len=(0,E.i)(a,l),(0,E.b)(d.dir,l,a),(0,E.g)(d.dir,d.dir,1/d.len)):((0,E.b)(d.dir,l,a),(0,E.n)(d.dir,d.dir)),d}(h,a,l,!0))}const zu={dir:(0,G.c)(),len:0,clip:(0,oe.a)()};function Vu(c,a,l){const h=(0,E.e)((0,et.mJ)(c),l.dir),d=-(0,et.jH)(c,a);if(d<0&&h>=0)return!1;if(h>-1e-6&&h<1e-6)return d>0;if((d<0||h<0)&&!(d<0&&h<0))return!0;const u=d/h;return h>0?u<l.clip[1]&&(l.clip[1]=u):u>l.clip[0]&&(l.clip[0]=u),l.clip[0]<=l.clip[1]}const $o=.5*Math.PI,Fu=$o/Math.PI*180;class Bu{constructor(a){this._renderCoordsHelper=a.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:(0,G.c)(),direction:(0,G.c)()};for(let l=0;l<4;l++)this._extent[l]={origin:(0,G.c)(),direction:(0,G.c)(),cap:{next:null,direction:(0,G.c)()}},this._planes[l]=(0,et.Ue)();this._planes[Gt.Nu.NEAR]=(0,et.Ue)(),this._planes[Gt.Nu.FAR]=(0,et.Ue)(),this._planesWithoutFar=this._planes.slice(0,5)}update(a,l,h,d=!0){const u=this._extent;this._toRenderBoundingExtent(a,l,h),(0,E.a)(this._center.origin,u[0].origin,u[2].origin),(0,E.g)(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),d||(0,E.g)(this._center.direction,this._center.direction,-1);for(let p=0;p<4;p++){const g=u[p];this._renderCoordsHelper.worldUpAtPosition(g.origin,g.direction);const _=u[3===p?0:p+1];g.cap.next=_.origin,(0,E.r)(g.cap.direction,g.origin,_.origin),(0,et.my)(g.direction,g.cap.direction,g.origin,this._planes[p]),d||(0,E.g)(g.direction,g.direction,-1)}(0,et.my)(u[0].cap.direction,u[1].cap.direction,u[0].origin,this._planes[Gt.Nu.NEAR]),d?(0,et.tk)(this._planes[Gt.Nu.NEAR],this._planes[Gt.Nu.FAR]):((0,et.JG)(this._planes[Gt.Nu.FAR],this._planes[Gt.Nu.NEAR]),(0,et.tk)(this._planes[Gt.Nu.NEAR],this._planes[Gt.Nu.NEAR])),this._maxSpan=Math.max(Math.abs(a[0]-a[2]),Math.abs(a[1]-a[3])),this._maxSpanSpatialReference=l,this._minGlobalAltitude=.9*(0,cs.Iu)(this._maxSpanSpatialReference).radius}isVisibleInFrustum(a,l,h=!1){if(null==a)return!1;if(this._renderCoordsHelper.viewingMode===ci.JY.Global){if(this._maxSpan>(this._maxSpanSpatialReference.isGeographic?Fu:$o*l))return!0;if(null!=a.altitude&&a.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(a)}if(0===this._maxSpan){const u=this._extent[0];return!(h||!a.intersectsRay((0,pa.re)(u.origin,u.direction)))}for(let u=0;u<this._extent.length;u++){const p=this._extent[u];if(!h&&a.intersectsRay((0,pa.re)(p.origin,p.direction))||a.intersectsLineSegment((0,Ho.zk)(p.origin,p.cap.next,ju),p.cap.direction))return!0}const d=h?this._planes:this._planesWithoutFar;for(let u=0;u<a.lines.length;u++){const p=a.lines[u];if(Gu(d,p.origin,p.endpoint,p.direction))return!0}return!1}_toRenderBoundingExtentGlobal(a,l,h){(0,ze.be)(a,zt),zt[2]=h,(0,Se.Bm)(l,zt,Aa,this._renderCoordsHelper.spatialReference),(0,Be.a)(Ko,Aa),(0,V.cS)(bt);for(const{x0:u,x1:p,y0:g,y1:_}of Nu)for(let v=0;v<5;v++){const b=v/4;zt[0]=(0,Lt.t7)(a[u],a[p],b),zt[1]=(0,Lt.t7)(a[g],a[_],b),zt[2]=h,(0,Se.SH)(zt,l,zt,this._renderCoordsHelper.spatialReference),(0,E.m)(zt,zt,Ko),(0,V.pp)(bt,zt)}(0,E.s)(this._extent[0].origin,bt[0],bt[1],bt[2]),(0,E.s)(this._extent[1].origin,bt[3],bt[1],bt[2]),(0,E.s)(this._extent[2].origin,bt[3],bt[4],bt[2]),(0,E.s)(this._extent[3].origin,bt[0],bt[4],bt[2]);for(let u=0;u<4;++u)(0,E.m)(this._extent[u].origin,this._extent[u].origin,Aa)}_toRenderBoundingExtentLocal(a,l,h){(0,Se.dH)(a,l,ti,this._renderCoordsHelper.spatialReference),(0,E.s)(this._extent[0].origin,ti[0],ti[1],h),(0,E.s)(this._extent[1].origin,ti[2],ti[1],h),(0,E.s)(this._extent[2].origin,ti[2],ti[3],h),(0,E.s)(this._extent[3].origin,ti[0],ti[3],h)}_toRenderBoundingExtent(a,l,h){switch(this._renderCoordsHelper.viewingMode){case ci.JY.Global:this._toRenderBoundingExtentGlobal(a,l,h);break;case ci.JY.Local:this._toRenderBoundingExtentLocal(a,l,h);break;default:(0,Dr.Bg)(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(a){if((0,et.jH)(a.planes[Gt.Nu.NEAR],this._center.origin)<0&&(0,E.e)(this._center.direction,a.direction)<0)return!0;for(let l=0;l<4;l++){const h=this._extent[l];if((0,et.jH)(a.planes[Gt.Nu.NEAR],h.origin)<0&&(0,E.e)(h.direction,a.direction)<0)return!0}return!1}}const Nu=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],zt=(0,G.c)(),Aa=(0,we.c)(),Ko=(0,we.c)(),bt=(0,V.Ue)(),ti=(0,ze.Ue)(),ju=(0,Ho.Ue)();let rr=class extends si.Z{constructor(c){super(c),this.suspended=!1,this._extent=null,this._extentIntersectionDirty=!0,this._isVisibleBelowSurfaceInternal=!1,this._handles=new Tr.Z,this.graphicsCoreOwner=null,this.updating=!0}initialize(){const{graphicsCoreOwner:c}=this;this._extentIntersection=new Bu({renderCoordsHelper:c.view.renderCoordsHelper});const a=c.view,l=a.basemapTerrain,h=a.resourceController.scheduler;this._handles.add([a.on("resize",()=>this._viewChange()),(0,he.YP)(()=>a.state.camera,()=>this._viewChange(),he.Z_),h.registerTask(Ct.T8.FRUSTUM_VISIBILITY,this),(0,he.YP)(()=>l.visibleElevationBounds,()=>this._elevationBoundsChange())]),"local"===a.viewingMode?this._isVisibleBelowSurface=!0:this._handles.add([(0,he.YP)(()=>[l.baseOpacity,l.wireframe,a.map?.ground?.navigationConstraint?.type],()=>this._updateIsVisibleBelowSurface(),he.nn)])}destroy(){this._set("graphicsCoreOwner",null),this._extent=null,this._extentIntersection=null,this._handles=(0,y.SC)(this._handles)}_setDirty(){this.updating||this._set("updating",!0)}setExtent(c){this._extent=c,this._extentIntersectionDirty=!0,this._setDirty()}_viewChange(){this._setDirty()}_elevationBoundsChange(){this._setDirty(),this._extentIntersectionDirty=!0}set _isVisibleBelowSurface(c){this._isVisibleBelowSurfaceInternal=c,this._setDirty(),this._extentIntersectionDirty=!0}_updateIsVisibleBelowSurface(){const c=this.graphicsCoreOwner.view;this._isVisibleBelowSurface="local"===c.viewingMode||!c.basemapTerrain.opaque||"none"===c.map.ground?.navigationConstraint?.type}_updateExtentIntersection(){if(!this._extentIntersectionDirty)return;this._extentIntersectionDirty=!1;const c=this.graphicsCoreOwner.view;let a;if(this._isVisibleBelowSurfaceInternal)a=-.3*(0,cs.Iu)(c.spatialReference).radius;else{const{min:l,max:h}=c.basemapTerrain.visibleElevationBounds;a=l-Math.max(1,(h-l)*(1.2-1))}this._extentIntersection.update(this._extent,c.spatialReference,a)}get running(){return this.updating}runTask(c){if(this._set("updating",!1),!this._extent)return this._set("suspended",!1),Ct.iQ.YIELD;this._updateExtentIntersection();const a=this.graphicsCoreOwner.view.frustum,l=(0,cs.Iu)(this.graphicsCoreOwner.view.spatialReference).radius;this._set("suspended",!this._extentIntersection.isVisibleInFrustum(a,l)),c.madeProgress()}};(0,P._)([(0,A.Cb)({readOnly:!0})],rr.prototype,"suspended",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],rr.prototype,"graphicsCoreOwner",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],rr.prototype,"updating",void 0),rr=(0,P._)([(0,se.j)("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],rr);const Hu=rr;var Kt;!function(c){c[c.Object=0]="Object",c[c.RenderGeometry=1]="RenderGeometry",c[c.External=2]="External",c[c.COUNT=3]="COUNT"}(Kt||(Kt={}));class Zu{constructor(){this._items=[]}addObject(a,l){this._items.push({type:Kt.Object,objectStateId:l,object:a})}addRenderGeometry(a,l,h){this._items.push({type:Kt.RenderGeometry,objectStateId:l,renderGeometry:a,owner:h})}addExternal(a,l){this._items.push({type:Kt.External,objectStateId:l,remove:a})}remove(a){for(let l=this._items.length-1;l>=0;--l){const h=this._items[l];h.objectStateId===a&&(this._removeObjectStateItem(h),this._items.splice(l,1))}}removeObject(a){for(let l=this._items.length-1;l>=0;--l){const h=this._items[l];h.type===Kt.Object&&h.object===a&&(this._removeObjectStateItem(h),this._items.splice(l,1))}}removeRenderGeometry(a){for(let l=this._items.length-1;l>=0;--l){const h=this._items[l];h.type===Kt.RenderGeometry&&h.renderGeometry===a&&(this._removeObjectStateItem(h),this._items.splice(l,1))}}removeAll(){this._items.forEach(a=>{this._removeObjectStateItem(a)}),this._items=[]}_removeObjectStateItem(a){switch(a.type){case Kt.Object:a.objectStateId.channel===Pe.V_.Highlight?a.object.removeHighlight(a.objectStateId):a.objectStateId.channel===Pe.V_.MaskOccludee&&a.object.removeOcclude(a.objectStateId);break;case Kt.RenderGeometry:a.owner.removeRenderGeometryObjectState(a.renderGeometry,a.objectStateId);break;case Kt.External:a.remove(a.objectStateId)}}}class Yu{constructor(a,l){this.stateType=a,this.objectIdField=l,this.objectStateSet=new Zu,this.ids=new Set,this.paused=!1}hasGraphic(a){return this.ids.has(this.objectIdField?a.graphic.attributes[this.objectIdField]:a.graphic.uid)}}class $u{constructor(a){this._graphicsCore=a,this._stateSets=new Array}destroy(){this.reset(),this._stateSets=null}reset(){this._stateSets&&(this._stateSets.forEach(a=>a.objectStateSet.removeAll()),this._stateSets.length=0)}acquireSet(a,l){const h=new Yu(a,l);this._stateSets.push(h);const d=(0,k.kB)(()=>this.releaseSet(h));return{set:h,handle:d}}releaseSet(a){a.objectStateSet.removeAll();const l=this._stateSets?this._stateSets.indexOf(a):-1;-1!==l&&this._stateSets.splice(l,1)}_addObjectStateSet(a,l){a.addObjectStateSet(l.stateType,l.objectStateSet)}_removeObjectStateSet(a,l){a.removeObjectState(l.objectStateSet)}setUid(a,l){a.ids.add(l);const h=this._graphicsCore.graphics3DGraphics.get(l);h&&this._addObjectStateSet(h,a)}setUids(a,l){l.forEach(h=>this.setUid(a,h))}setObjectIds(a,l){l.forEach(h=>a.ids.add(h)),this._initializeSet(a)}addGraphic(a){this._stateSets.forEach(l=>{!l.paused&&l.hasGraphic(a)&&this._addObjectStateSet(a,l)})}removeGraphic(a){this._stateSets.forEach(l=>{l.hasGraphic(a)&&this._removeObjectStateSet(a,l)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(a=>a.objectStateSet.removeAll())}_initializeSet(a){const l=this._graphicsCore.graphics3DGraphics;a.objectIdField?l.forEach(h=>{h&&a.hasGraphic(h)&&this._addObjectStateSet(h,a)}):a.ids.forEach(h=>{const d=l.get(h);d&&this._addObjectStateSet(d,a)})}get test(){return{states:this._stateSets}}}var ko=S(93579);const Xo=bi.Z.getLogger("esri.views.3d.layers.graphics.Graphics3DScaleVisibility");let Mt=class extends w.r{constructor(c){super(c),this._scaleRangeActive=!1,this._layerScaleRangeVisibilityQuery=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null,this.layerScaleEnabled=!0,this.suspended=!1,this._dirty=!0}initialize(){this.updateScaleRangeActive(),this.handles.add(this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(Ct.T8.SCALE_VISIBILITY,this)),this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())}destroy(){this.updatingHandles.removeAll(),this.handles.removeAll(),this._dirty=!1,this._extent=null,this.graphicsCoreOwner=null,this.layer=null,this.queryGraphicUIDsInExtent=null,this.graphicsCore=null,this.basemapTerrain=null}get updating(){return this._dirty||this.updatingHandles.updating}_setDirty(){this._dirty=!0}setExtent(c){const a=this.graphicsCoreOwner.view.spatialReference,l=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;if(a===l)this._extent=c??null;else{const h=(0,ze.Ue)();this._extent=(0,Se.dH)(c,a,h,l)?h:null}this._setDirty()}scaleRangeActive(){return this._scaleRangeActive}updateScaleRangeActive(){const c=this.layer,a=c.effectiveScaleRange;let l=this.layerScaleEnabled&&null!=a&&Jo(a.minScale,a.maxScale);c.labelingInfo&&!l&&(l=c.labelingInfo.some(d=>d&&Jo(d.minScale??0,d.maxScale??0)));const h=this._scaleRangeActive!==l;return this._scaleRangeActive=l,l&&!this.handles.has(Rr)&&this.basemapTerrain?(this.handles.add(this.basemapTerrain.on("scale-change",d=>this._scaleUpdateHandler(d)),Rr),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),Rr)):!l&&this.handles.has(Rr)&&this.handles.remove(Rr),h}get running(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}runTask(c){const a=this.graphicsCoreOwner.view.basemapTerrain;if(this._extent&&a&&a.ready&&this._scaleRangeActive&&this.layerScaleEnabled){if(this._layerScaleRangeVisibilityQuery)return Ct.iQ.YIELD;{this._layerScaleRangeVisibilityQuery=!0;const{minScale:l,maxScale:h}=this.layer.effectiveScaleRange;a.queryVisibleScaleRange(this._extent,l,h,d=>this._finishUpdate(d))}}else this._finishUpdate(!0);c.madeProgress()}_finishUpdate(c){this._layerScaleRangeVisibilityQuery=!1,this._set("suspended",!c),this._dirty=!1}_visibleAtLayerScale(c){const a=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||(0,ko.rs)(c,a.minScale||0,a.maxScale||0)}_visibleAtLabelScale(c,a){return(0,ko.rs)(c,a.minScale||0,a.maxScale||0)}_graphicScale(c){let a;return(0,y.pC)(c.centroid)?a=c.centroid:(0,y.pC)(c.graphic.geometry)&&"point"===c.graphic.geometry.type&&(a=c.graphic.geometry),a?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(a):1:null}_graphicVisible(c){if(!this.layerScaleEnabled)return!0;const a=this._graphicScale(c);return this._visibleAtLayerScale(a)}updateVisibility(c){if(this._scaleRangeActive){const a=this._graphicVisible(c);return c.setVisibilityFlag(xt.SCALE_RANGE,a,at.GRAPHIC)}return!1}updateGraphicLabelScaleVisibility(c){if(!this._scaleRangeActive||!c.labelLayers||0===c.labelLayers.length)return!1;const a=this._graphicScale(c),l=this._updateLabelScaleVisibility(c,a);return l&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()),l}_updateLabelScaleVisibility(c,a){if(!c.labelLayers||0===c.labelLayers.length)return!1;const l=c.labelLayers[0]._labelClass;if(l&&null!=l.minScale&&null!=l.maxScale){const h=this._visibleAtLabelScale(a,l);if(c.setVisibilityFlag(xt.SCALE_RANGE,h,at.LABEL))return!0}return!1}_scaleUpdateHandler(c){if(this._setDirty(),!this.graphicsCore.visible)return;const a=c.extent,l=c.scale,h=this._visibleAtLayerScale(l);let d=!1;const u=this.graphicsCoreOwner.view.spatialReference,p=c.spatialReference;if((0,y.Wi)(p))return void Xo.error("scaleUpdate: Internal error, no SpatialReference given for tiles");const g=!p.equals(u);!g||(0,Se.dH)(a,p,Qo,u)?(this.queryGraphicUIDsInExtent(g?Qo:a,u,v=>{const b=this.graphicsCore.getGraphics3DGraphicById(v);if((0,y.Wi)(b))return;const C=b.centroid;(0,y.pC)(C)&&(a[0]>C.x||a[1]>C.y||a[2]<C.x||a[3]<C.y)||(b.setVisibilityFlag(xt.SCALE_RANGE,h,at.GRAPHIC)&&(d=!0),this._updateLabelScaleVisibility(b,l)&&(d=!0))}),d&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty())):Xo.error("scaleUpdate: Internal error, cannot project AABR from "+p+" to wkid "+u)}layerMinMaxScaleChangeHandler(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(c=>c.clearVisibilityFlag(xt.SCALE_RANGE)):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility(),this._setDirty()}};function Jo(c,a){return c>0||a>0}(0,P._)([(0,A.Cb)()],Mt.prototype,"graphicsCoreOwner",void 0),(0,P._)([(0,A.Cb)()],Mt.prototype,"layer",void 0),(0,P._)([(0,A.Cb)()],Mt.prototype,"queryGraphicUIDsInExtent",void 0),(0,P._)([(0,A.Cb)()],Mt.prototype,"graphicsCore",void 0),(0,P._)([(0,A.Cb)()],Mt.prototype,"basemapTerrain",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Mt.prototype,"layerScaleEnabled",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],Mt.prototype,"suspended",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],Mt.prototype,"updating",null),(0,P._)([(0,A.Cb)()],Mt.prototype,"_dirty",void 0),Mt=(0,P._)([(0,se.j)("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],Mt);const Rr="terrain-events",Qo=(0,ze.Ue)(),Ku=Mt;let Ve=class extends w.r{constructor(c){super(c),this.type="graphics-3d",this.graphicsCore=null,this.drapeSourceType=ll.Lw.Features,this.scaleVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this._suspendResumeExtent=null}initialize(){const{layer:c}=this,a="effectiveScaleRange"in c?c:null,l=this.scaleVisibilityEnabled&&(0,y.pC)(a),h=new ue({owner:this,layer:this.owner.layer,preferredUpdatePolicy:rt.j.SYNC,graphicSymbolSupported:!0,componentFactories:{elevationAlignment:(d,u)=>new Uu({graphicsCoreOwner:this,graphicsCore:d,queryGraphicUIDsInExtent:u,elevationProvider:this.view.elevationProvider}),scaleVisibility:l?(d,u)=>new Ku({graphicsCoreOwner:this,layer:a,queryGraphicUIDsInExtent:u,graphicsCore:d,basemapTerrain:this.owner.view.basemapTerrain}):null,objectStates:d=>new $u(d)}});if(this._set("graphicsCore",h),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new Hu({graphicsCoreOwner:this})),"fullOpacity"in this.owner){const d=this.owner;this.updatingHandles.add(()=>d.fullOpacity,()=>this.graphicsCore.opacityChange())}if("elevationInfo"in c){const d=c;this.updatingHandles.add(()=>d.elevationInfo,(u,p)=>{(0,U.Hg)(u,p)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})}this._set("initializePromise",this._initializeAsync()),this.updatingHandles.addPromise(this.initializePromise)}_initializeAsync(){var c=this;return(0,B.Z)(function*(){try{yield c.graphicsCore.initializePromise}catch(a){if((0,j.D_)(a))return;throw a}c.destroyed||(c.handles.add((0,he.YP)(()=>c.view.clippingArea,()=>c._updateClippingExtent(),he.Z_)),c._updateClippingExtent(),c._setupSuspendResumeExtent(),c.graphicsCore.startCreateGraphics())})()}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",(0,y.SC)(this.frustumVisibility)),this._set("graphicsCore",(0,y.SC)(this.graphicsCore))}get layer(){return this.owner.layer}get view(){return this.owner.view}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get objectStates(){return this.graphicsCore?.objectStates}get scaleVisibilitySuspended(){return!(!(0,y.pC)(this.scaleVisibility)||!this.scaleVisibility.suspended)}get frustumVisibilitySuspended(){return(0,y.pC)(this.frustumVisibility)&&this.frustumVisibility.suspended}get suspended(){return this.owner.suspended??!1}get updating(){return!!(this.graphicsCore?.updating||(0,y.pC)(this.scaleVisibility)&&this.scaleVisibility.updating||(0,y.pC)(this.frustumVisibility)&&this.frustumVisibility.updating||this.updatingHandles.updating)}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner.fullOpacity??1}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}notifyGraphicGeometryChanged(c){this.graphicsCore.notifyGraphicGeometryChanged(c)}notifyGraphicVisibilityChanged(c){this.graphicsCore.notifyGraphicVisibilityChanged(c)}getRenderingInfo(c,a,l){const h=function Me(c,a){const l=ve(c,a),h=function Je(c,a){if((0,y.pC)(c.symbol))return c.symbol;const l=ve(c,a);return(0,y.pC)(l)&&"dot-density"!==l.type?l.getSymbol(c,a):null}(c,a);if((0,y.Wi)(h))return null;const d={renderer:l,symbol:h};if((0,y.Wi)(l)||!("visualVariables"in l)||!l.visualVariables)return d;const u=(0,ce.getVisualVariableValues)(l,c,a)??[],p=["proportional","proportional","proportional"];for(const{variable:g,value:_}of u)switch(g.type){case"color":d.color=_.toRgba();break;case"size":if("outline"===g.target)d.outlineSize=_;else{const b=g.useSymbolValue?"symbol-value":_;switch(g.axis){case"width":p[0]=b;break;case"depth":p[1]=b;break;case"height":p[2]=b;break;case"width-and-depth":p[0]=p[1]=b;break;default:p[0]=p[1]=p[2]=b}}break;case"opacity":d.opacity=_;break;case"rotation":switch(g.axis){case"tilt":d.tilt=_;break;case"roll":d.roll=_;break;default:d.heading=_}}return"proportional"===p[0]&&"proportional"===p[1]&&"proportional"===p[2]||(d.size=p),d}(c,{renderer:a,arcade:l});if((0,y.pC)(h)&&h.color){const d=h.color;d[0]=d[0]/255,d[1]=d[1]/255,d[2]=d[2]/255}return h}getRenderingInfoAsync(c,a,l,h){return function bs(c,a){return Ss.apply(this,arguments)}(c,{renderer:a,arcade:l,...h})}getHit(c){if(this.owner.loadedGraphics){const a=this.owner.loadedGraphics.find(l=>l.uid===c);if(a){const h=(0,Y.mW)(a,this.layer instanceof Z.Z?this.layer:null);return{type:"graphic",graphic:h,layer:h.layer}}}return null}whenGraphicBounds(c,a){return this.graphicsCore?this.graphicsCore.whenGraphicBounds(c,a):Promise.reject()}computeAttachmentOrigin(c,a){return this.graphicsCore?this.graphicsCore.computeAttachmentOrigin(c,a):null}getSymbolLayerSize(c,a){return this.graphicsCore?this.graphicsCore.getSymbolLayerSize(c,a):null}maskOccludee(c){const{set:a,handle:l}=this.objectStates.acquireSet(Pe.V_.MaskOccludee,null);return this.objectStates.setUid(a,c.uid),l}highlight(c){if(c instanceof ol.Z)return qo;if("number"==typeof c)return this.highlight([c]);if(c instanceof z.Z)return this.highlight([c]);if(c instanceof L.Z&&(c=c.toArray()),Array.isArray(c)&&c.length>0){if(c[0]instanceof z.Z){const a=c.map(d=>d.uid),{set:l,handle:h}=this.objectStates.acquireSet(Pe.V_.Highlight,null);return this.objectStates.setUids(l,a),h}if("number"==typeof c[0]){const a=c,{set:l,handle:h}=this.objectStates.acquireSet(Pe.V_.Highlight,null);return this.objectStates.setObjectIds(l,a),h}}return qo}_setupSuspendResumeExtent(){const{scaleVisibility:c,frustumVisibility:a}=this;if((0,y.Wi)(c)&&(0,y.Wi)(a))return;const l=({computedExtent:h,extentPadding:d})=>{this._suspendResumeExtent=(0,Ne.Go)(h,this._suspendResumeExtent,1.2,d),(0,y.pC)(c)&&c.setExtent(this._suspendResumeExtent),(0,y.pC)(a)&&a.setExtent(this._suspendResumeExtent)};this.handles.add((0,he.YP)(()=>({computedExtent:this.graphicsCore?.computedExtent,extentPadding:this.graphicsCore?.extentPadding}),h=>l(h),he.tX))}_updateClippingExtent(){this.graphicsCore.setClippingExtent(this.view.clippingArea,this.view.spatialReference)&&this.graphicsCore.recreateAllGraphics()}};(0,P._)([(0,A.Cb)()],Ve.prototype,"type",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Ve.prototype,"owner",void 0),(0,P._)([(0,A.Cb)()],Ve.prototype,"layer",null),(0,P._)([(0,A.Cb)()],Ve.prototype,"view",null),(0,P._)([(0,A.Cb)({constructOnly:!0})],Ve.prototype,"graphicsCore",void 0),(0,P._)([(0,A.Cb)()],Ve.prototype,"scaleVisibility",null),(0,P._)([(0,A.Cb)({constructOnly:!0})],Ve.prototype,"frustumVisibility",void 0),(0,P._)([(0,A.Cb)()],Ve.prototype,"elevationAlignment",null),(0,P._)([(0,A.Cb)()],Ve.prototype,"objectStates",null),(0,P._)([(0,A.Cb)()],Ve.prototype,"scaleVisibilitySuspended",null),(0,P._)([(0,A.Cb)({readOnly:!0})],Ve.prototype,"frustumVisibilitySuspended",null),(0,P._)([(0,A.Cb)()],Ve.prototype,"suspended",null),(0,P._)([(0,A.Cb)({readOnly:!0})],Ve.prototype,"updating",null),(0,P._)([(0,A.Cb)()],Ve.prototype,"loadedGraphics",null),(0,P._)([(0,A.Cb)()],Ve.prototype,"fullOpacity",null),(0,P._)([(0,A.Cb)()],Ve.prototype,"slicePlaneEnabled",null),(0,P._)([(0,A.Cb)()],Ve.prototype,"drapeSourceType",void 0),(0,P._)([(0,A.Cb)()],Ve.prototype,"updatePolicy",null),(0,P._)([(0,A.Cb)({constructOnly:!0})],Ve.prototype,"scaleVisibilityEnabled",void 0),(0,P._)([(0,A.Cb)({constructOnly:!0})],Ve.prototype,"frustumVisibilityEnabled",void 0),(0,P._)([(0,A.Cb)()],Ve.prototype,"initializePromise",void 0),Ve=(0,P._)([(0,se.j)("esri.views.3d.layers.graphics.GraphicsProcessor")],Ve);const qo=(0,k.kB)();function La(){return La=(0,B.Z)(function*(c,a,l){if((0,y.Wi)(c)||0===a.candidates.length)return el;const h=c.graphics3DGraphicsByObjectID??c.graphics3DGraphics,d=[],u=[],{renderer:p}=c,g=(0,y.pC)(p)&&"arcadeRequired"in p&&p.arcadeRequired?(0,Es.LC)():null,_=function(){var O=(0,B.Z)(function*(M,{graphic:F,graphics3DSymbol:H}){const N=yield g,te=yield c.getRenderingInfoAsync(F,p,N,{signal:l});return(0,y.Wi)(te)?[]:H.queryForSnapping(M,b,te,l)});return function(F,H){return O.apply(this,arguments)}}(),{candidates:v,spatialReference:b}=a;for(let O=0;O<v.length;++O){const M=v[O],{objectId:F}=M,H="number"==typeof F?h?.get(F):void 0;if((0,y.Wi)(H))continue;const{graphics3DSymbol:N}=H;N.symbologySnappingSupported&&(d.push(_(M,H)),u.push(O))}if(0===d.length)return el;const C=yield Promise.all(d);(0,j.k_)(l);const x=[],R=[];for(let O=0;O<C.length;++O){const M=C[O],F=u[O];for(const H of M)x.push(H),R.push(F)}return{candidates:x,sourceCandidateIndices:R}}),La.apply(this,arguments)}const el={candidates:[],sourceCandidateIndices:[]};var Xu=S(46367),Ju=S(82911),qu=S(45611);let ii=class extends($(qu.Z)){constructor(){super(...arguments),this.type="graphics-3d",this.symbologySnappingSupported=!0,this._slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null}initialize(){this._set("processor",new Ve({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.initializePromise),this.handles.add(this.layer.on("graphic-update",c=>this.processor.graphicsCore.graphicUpdateHandler(c))),this.addResolvingPromise(function Qu(c){const a=c.view.spatialReference,l=c.layer.fullExtent,h=(0,y.pC)(l)&&l.spatialReference;if((0,y.Wi)(l)||!h)return Promise.resolve(null);if(h.equals(a))return Promise.resolve(l.clone());const d=(0,Xu.iV)(l,a);return(0,y.pC)(d)?Promise.resolve(d):c.view.state.isLocal?(0,Ju.projectGeometry)(l,a,c.layer.portalItem).then(u=>!c.destroyed&&u?u:null).catch(()=>null):Promise.resolve(null)}(this).then(c=>this.fullExtentInLocalViewSpatialReference=c)),this.layer.internal?this.notifyChange("updating"):this.handles.add((0,he.gx)(()=>this.view?.basemapTerrain?.ready,()=>()=>this.notifyChange("updating"),{once:!0}))}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("processor",(0,y.SC)(this.processor))}get loadedGraphics(){return this.layer.graphics}get legendEnabled(){return this.canResume()&&!this.processor?.frustumVisibilitySuspended}get slicePlaneEnabled(){return this._slicePlaneEnabled&&!this.layer.internal}set slicePlaneEnabled(c){this._slicePlaneEnabled=c}getSuspendInfo(){const c=super.getSuspendInfo();return c.outsideScaleRange=this.processor?.scaleVisibilitySuspended??!1,c.outsideOfView=this.processor?.frustumVisibilitySuspended??!1,c}fetchPopupFeatures(c,a){return(0,B.Z)(function*(){return(0,y.Wg)(a)?.clientGraphics??[]})()}getHit(c){return this.processor.getHit(c)}whenGraphicBounds(c,a){return this.processor.whenGraphicBounds(c,a)}computeAttachmentOrigin(c,a){return this.processor?.computeAttachmentOrigin(c,a)}getSymbolLayerSize(c,a){return this.processor.getSymbolLayerSize(c,a)}queryGraphics(){return Promise.resolve(this.loadedGraphics)}maskOccludee(c){return this.processor.maskOccludee(c)}highlight(c){return this.processor.highlight(c)}elevationAlignPointsInFeatures(c,a){var l=this;return(0,B.Z)(function*(){const{processor:h}=l;if((0,y.Wi)(h)||(0,y.Wi)(h.graphics3DGraphics))throw new ne.Z("graphicslayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");const{graphics3DGraphics:d}=h;return function be(c,a,l,h,d){return Ae.apply(this,arguments)}(l.view,l.layer,p=>"number"==typeof p?d.get(p):void 0,c,a)})()}queryForSymbologySnapping(c,a){var l=this;return(0,B.Z)(function*(){return function ku(c,a,l){return La.apply(this,arguments)}(l.processor,c,a)})()}get updatePolicy(){return this.processor?.graphicsCore.effectiveUpdatePolicy||rt.j.SYNC}canResume(){return super.canResume()&&!this.processor?.scaleVisibilitySuspended}isUpdating(){return!(!this.processor?.updating&&(this.layer.internal||this.view?.basemapTerrain?.ready))}get performanceInfo(){return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:-1,totalNumberOfFeatures:-1,nodes:0,core:null,updating:this.updating,elevationUpdating:this.processor?.elevationAlignment.updating??!1,visibilityFrustum:!this.processor?.frustumVisibilitySuspended}}getUsedMemory(){return this.processor?.graphicsCore?.usedMemory??0}getUnloadedMemory(){return this.processor?.graphicsCore?.unprocessedMemoryEstimate}ignoresMemoryFactor(){return!0}};(0,P._)([(0,A.Cb)()],ii.prototype,"loadedGraphics",null),(0,P._)([(0,A.Cb)({readOnly:!0})],ii.prototype,"legendEnabled",null),(0,P._)([(0,A.Cb)()],ii.prototype,"layer",void 0),(0,P._)([(0,A.Cb)({readOnly:!0})],ii.prototype,"processor",void 0),(0,P._)([(0,A.Cb)()],ii.prototype,"_slicePlaneEnabled",void 0),(0,P._)([(0,A.Cb)({type:Boolean})],ii.prototype,"slicePlaneEnabled",null),ii=(0,P._)([(0,se.j)("esri.views.3d.layers.GraphicsLayerView3D")],ii);const ep=ii},2180:(St,Le,S)=>{S.d(Le,{hM:()=>j,$s:()=>$,eU:()=>se});var B=S(91558),ne=(S(8314),S(62208)),y=S(23841),he=S(4794),xe=S(17803);function se(I){return I&&I.enabled&&(function _e(I){return"extrude"===I.type}(I)||function A(I){return"fill"===I.type}(I))&&(0,ne.pC)(I.edges)}function j(I,q){return function re(I,q){if((0,ne.Wi)(I))return null;const de=(0,ne.pC)(I.color)?(0,he.b)(B.Z.toUnitRGBA(I.color)):(0,he.f)(0,0,0,0),ae=(0,y.F2)(I.size),be=(0,y.F2)(I.extensionLength);switch(I.type){case"solid":return $({color:de,size:ae,extensionLength:be,...q});case"sketch":return function J(I){return{...W,...I,type:"sketch"}}({color:de,size:ae,extensionLength:be,...q});default:return}}(function k(I){return I&&I.enabled&&I.edges||null}(I),q)}function $(I){return{...Q,...I,type:"solid"}}const Q={color:(0,he.f)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:xe.i.OPAQUE,hasSlicePlane:!1},W={color:(0,he.f)(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:xe.i.OPAQUE,hasSlicePlane:!1}},68565:(St,Le,S)=>{S.d(Le,{C:()=>re,W:()=>j});var B=S(99770),P=S(84833),ne=S(95285),y=S(97139),he=S(48565),A=S(7090),_e=S(17625),xe=S(16396),se=S(41857);function j($,J){const Q=xe.T.FEATUREVALUE;$.attributes.add(Q,"vec4");const W=$.vertex;W.code.add(_e.H`
  bool isCapVertex() {
    return ${Q}.w == 1.0;
  }
  `),W.uniforms.add(new ne.A("size",I=>I.size)),J.vvSize?(W.uniforms.add(new y.J("vvSizeMinSize",I=>I.vvSizeMinSize)),W.uniforms.add(new y.J("vvSizeMaxSize",I=>I.vvSizeMaxSize)),W.uniforms.add(new y.J("vvSizeOffset",I=>I.vvSizeOffset)),W.uniforms.add(new y.J("vvSizeFactor",I=>I.vvSizeFactor)),W.code.add(_e.H`
    vec2 getSize() {
      return size * clamp(vvSizeOffset + ${Q}.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):W.code.add(_e.H`vec2 getSize(){
return size;
}`),J.vvOpacity?(W.constants.add("vvOpacityNumber","int",8),W.uniforms.add([new A.O("vvOpacityValues",I=>I.vvOpacityValues,8),new A.O("vvOpacityOpacities",I=>I.vvOpacityOpacities,8)]),W.code.add(_e.H`
    vec4 applyOpacity(vec4 color) {
      float value = ${Q}.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
    }
    `)):W.code.add(_e.H`vec4 applyOpacity(vec4 color){
return color;
}`),J.vvColor?(W.constants.add("vvColorNumber","int",se.x),W.uniforms.add([new A.O("vvColorValues",I=>I.vvColorValues,se.x),new he.b("vvColorColors",I=>I.vvColorColors,se.x)]),W.code.add(_e.H`
    vec4 getColor() {
      float value = ${Q}.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[vvColorNumber - 1]);
    }
    `)):W.code.add(_e.H`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),$.include(P.f),$.attributes.add(xe.T.PROFILERIGHT,"vec4"),$.attributes.add(xe.T.PROFILEUP,"vec4"),$.attributes.add(xe.T.PROFILEVERTEXANDNORMAL,"vec4"),W.code.add(_e.H`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),W.code.add(_e.H`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),W.code.add(_e.H`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),W.code.add(_e.H`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}class re extends se.n{constructor(){super(...arguments),this.size=(0,B.f)(1,1)}}},17803:(St,Le,S)=>{var B,P;S.d(Le,{i:()=>B}),(P=B||(B={}))[P.INVISIBLE=0]="INVISIBLE",P[P.TRANSPARENT=1]="TRANSPARENT",P[P.OPAQUE=2]="OPAQUE"},95402:(St,Le,S)=>{var B,P;S.d(Le,{b:()=>B}),(P=B||(B={}))[P.Horizontal=0]="Horizontal",P[P.Vertical=1]="Vertical",P[P.Cross=2]="Cross",P[P.ForwardDiagonal=3]="ForwardDiagonal",P[P.BackwardDiagonal=4]="BackwardDiagonal",P[P.DiagonalCross=5]="DiagonalCross",P[P.COUNT=6]="COUNT"},45611:(St,Le,S)=>{S.d(Le,{Z:()=>J});var B=S(17626),P=S(14517),ne=S(61885),y=S(80542),he=S(61996),A=S(63290),_e=S(62208),xe=S(60330),se=S(77712),re=(S(90912),S(85931),S(76898));let $=class extends((0,y.p)((0,he.IG)((0,xe.v)(ne.Z.EventedMixin(P.Z))))){constructor(Q){super(Q),this.layer=null,this.parent=null}initialize(){this.when().catch(Q=>{if("layerview:create-error"!==Q.name){const W=this.layer&&this.layer.id||"no id",I=this.layer&&this.layer.title||"no title";A.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${I}', id: '${W}')`,Q)}})}get fullOpacity(){return(0,_e.Pt)(this.get("layer.opacity"),1)*(0,_e.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this.updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(Q){this._overrideIfSome("visible",Q)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const Q=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(Q.viewNotReady=!0),this.layer&&this.layer.loaded||(Q.layerNotLoaded=!0),this.visible||(Q.layerInvisible=!0),Q}isUpdating(){return!1}};(0,B._)([(0,se.Cb)()],$.prototype,"fullOpacity",null),(0,B._)([(0,se.Cb)()],$.prototype,"layer",void 0),(0,B._)([(0,se.Cb)()],$.prototype,"parent",void 0),(0,B._)([(0,se.Cb)({readOnly:!0})],$.prototype,"suspended",null),(0,B._)([(0,se.Cb)({readOnly:!0})],$.prototype,"suspendInfo",null),(0,B._)([(0,se.Cb)({readOnly:!0})],$.prototype,"legendEnabled",null),(0,B._)([(0,se.Cb)({type:Boolean,readOnly:!0})],$.prototype,"updating",null),(0,B._)([(0,se.Cb)({readOnly:!0})],$.prototype,"updatingProgress",null),(0,B._)([(0,se.Cb)()],$.prototype,"visible",null),(0,B._)([(0,se.Cb)()],$.prototype,"view",void 0),$=(0,B._)([(0,re.j)("esri.views.layers.LayerView")],$);const J=$}}]);