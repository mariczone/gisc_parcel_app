"use strict";(self.webpackChunkparcel_app=self.webpackChunkparcel_app||[]).push([[2230],{59990:(Y,L,n)=>{function o(d){const g=d.layer;return"floorInfo"in g&&g.floorInfo?.floorField&&"floors"in d.view?Z(d.view.floors,g.floorInfo.floorField):null}function u(d,g){return"floorInfo"in g&&g.floorInfo?.floorField?Z(d,g.floorInfo.floorField):null}function Z(d,g){if(!d?.length)return null;const _=d.filter(m=>""!==m).map(m=>`'${m}'`);return _.push("''"),`${g} IN (${_.join(",")}) OR ${g} IS NULL`}n.d(L,{c:()=>o,f:()=>u})},82230:(Y,L,n)=>{n.r(L),n.d(L,{default:()=>Le});var o=n(15861),u=n(17626),Z=n(88879),d=n(77712),m=(n(90912),n(85931),n(76898));let P=class extends Z.Z{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer&&this.sourceLayer.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};(0,u._)([(0,d.Cb)({type:Boolean})],P.prototype,"isAggregate",void 0),P=(0,u._)([(0,m.j)("esri.AggregateGraphic")],P);const C=P;n(29132);var M=n(74333),V=n(26584),v=n(8314),N=n(58817),S=n(63290),l=n(62208),R=n(10699),U=n(32917),ne=n(14517),oe=n(52884);let T=class extends ne.Z{constructor(e){super(e),this._filter=null,this.duration=(0,v.Z)("mapview-transitions-duration"),this._excludedEffectView=new oe.AM(e),this._includedEffectView=new oe.AM(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e)}get filter(){return this._filter||(0,l.Wg)(this.featureEffect)?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(e){const t=this._get("featureEffect"),r=(0,l.Wg)(e),i=(0,l.Wg)(r?.includedEffect),s=(0,l.Wg)(r?.excludedEffect),a=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=i,this._excludedEffectView.effect=s,this._set("featureEffect",r),this._filter=r?.filter||t?.filter||null,a||this.endTransitions()}};(0,u._)([(0,d.Cb)()],T.prototype,"_filter",void 0),(0,u._)([(0,d.Cb)()],T.prototype,"_excludedEffectView",void 0),(0,u._)([(0,d.Cb)()],T.prototype,"_includedEffectView",void 0),(0,u._)([(0,d.Cb)()],T.prototype,"duration",void 0),(0,u._)([(0,d.Cb)()],T.prototype,"excludedEffects",null),(0,u._)([(0,d.Cb)()],T.prototype,"featureEffect",null),(0,u._)([(0,d.Cb)()],T.prototype,"filter",null),(0,u._)([(0,d.Cb)()],T.prototype,"hasEffects",null),(0,u._)([(0,d.Cb)()],T.prototype,"includedEffects",null),(0,u._)([(0,d.Cb)({value:0})],T.prototype,"scale",null),(0,u._)([(0,d.Cb)()],T.prototype,"transitioning",null),T=(0,u._)([(0,m.j)("esri.layers.effects.FeatureEffectView")],T);const de=T;var z=n(98624),X=n(72469),G=n(68653),ee=n(17253),W=n(65234);let H=class extends ee.Z{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){const r=W.Z.fromJSON(t.spatialReference),i=[];for(let s=0;s<e.length;s++){const a=e[s],c=C.fromJSON(a),f=a.geometry&&a.geometry.spatialReference;(0,l.pC)(c.geometry)&&!f&&(c.geometry.spatialReference=r);const h=a.aggregateGeometries,p=c.aggregateGeometries;if(h&&(0,l.pC)(p))for(const y in p){const b=p[y],F=h[y]?.spatialReference;(0,l.pC)(b)&&!F&&(b.spatialReference=r)}i.push(c)}return i}};(0,u._)([(0,d.Cb)({type:[C],json:{write:!0}})],H.prototype,"features",void 0),(0,u._)([(0,G.r)("features")],H.prototype,"readFeatures",null),H=(0,u._)([(0,m.j)("esri.rest.support.AggregateFeatureSet")],H);const te=H;var K=n(96854),B=n(39351),A=n(37384),I=n(49391);function E(){return(E=(0,o.Z)(function*(e,t){if(!e)return null;switch(e.type){case"symbol":return new((yield Promise.all([n.e(5314),n.e(5506),n.e(9202),n.e(4589),n.e(8592),n.e(8803)]).then(n.bind(n,58803))).default)(t);case"heatmap":return new((yield Promise.all([n.e(5314),n.e(5506),n.e(9202),n.e(4589),n.e(8592),n.e(2900)]).then(n.bind(n,32900))).default)(t)}})).apply(this,arguments)}var Q=n(22418),re=n(62192),_e=n(71251);function ce(e){return e.some(t=>t.globalId)}function ie(e){return e.filter(t=>!t.error).map(t=>t.objectId??t.globalId).filter(t=>null!=t)}function pe(e,t){const r=new Set(e);for(const i of t.values())r.add(i);return r}function ye(e,t){const r=new Set(e);for(const i of t.values())r.delete(i);return r}let se=class extends ne.Z{constructor(e){super(e),this._hasGlobalIds=!1,this._notifyUpdating=()=>{this.notifyChange("updating")}}normalizeCtorArgs(e){return this._queueProcessor=new _e.e({concurrency:1,process:e.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(e){const t=this._queueProcessor,r=t.last();switch(e.type){case"update":case"refresh":if(r?.type===e.type)return;t.push(e).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":{const i="processed-edit"===r?.type?r:null;i&&t.popLast();const s=this._mergeEdits(i,e);for(const a of s)a&&t.push(a).then(this._notifyUpdating,this._notifyUpdating);break}}this.notifyChange("updating")}_mergeEdits(e,t){const{addedFeatures:r,deletedFeatures:i,updatedFeatures:s}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||ce(r)||ce(s)||ce(i),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...r,...s],removed:i}}];const a=new Set(ie(e?.edits.addOrModified??[])),c=new Set(ie(e?.edits.removed??[])),f=new Set([...ie(r),...ie(s)]),h=new Set(ie(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(pe(ye(a,h),f)).map(p=>({objectId:p})),removed:Array.from(pe(ye(c,f),h)).map(p=>({objectId:p}))}}]}};(0,u._)([(0,d.Cb)({readOnly:!0})],se.prototype,"updating",null),(0,u._)([(0,d.Cb)()],se.prototype,"process",void 0),se=(0,u._)([(0,m.j)("esri.views.2d.layers.support.FeatureCommandQueue")],se);const Re=se;var Ce=n(60330),Ee=n(59289);let $=class extends Ce.D{constructor(e){super(e),this._startupResolver=(0,R.hh)(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(e){this.client.tileRenderer=e}get closed(){return this._connection.closed}startup(e,t,r,i){var s=this;return(0,o.Z)(function*(){yield s.when();const a=s._controller.signal,c=function be(e){return Array.isArray(e)}(r.source)?{transferList:r.source,signal:a}:void 0,f={service:r,config:t,tileInfo:e.tileInfo.toJSON(),tiles:i};yield s._connection.invoke("startup",f,c),s._startupResolver.resolve(),s._set("isReady",!0)})()}updateTiles(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,(0,R.R8)(t._connection.invoke("updateTiles",e))})()}update(e){var t=this;return(0,o.Z)(function*(){const r={config:e};return yield t._startupResolver.promise,t._connection.invoke("update",r)})()}applyUpdate(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("applyUpdate",e)})()}setHighlight(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,(0,R.R8)(t._connection.invoke("controller.setHighlight",e))})()}stop(){var e=this;return(0,o.Z)(function*(){if(yield e._startupResolver.promise,!e.closed)return(0,R.R8)(e._connection.invoke("stop"))})()}refresh(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,(0,R.R8)(t._connection.invoke("controller.refresh",e))})()}querySummaryStatistics(e,t,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.querySummaryStatistics",{query:e.toJSON(),params:t},r)})()}queryAggregateSummaryStatistics(e,t,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateSummaryStatistics",{query:e.toJSON(),params:t},r)})()}queryUniqueValues(e,t,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryUniqueValues",{query:e.toJSON(),params:t},r)})()}queryAggregateUniqueValues(e,t,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateUniqueValues",{query:e.toJSON(),params:t},r)})()}queryClassBreaks(e,t,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryClassBreaks",{query:e.toJSON(),params:t},r)})()}queryAggregateClassBreaks(e,t,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateClassBreaks",{query:e.toJSON(),params:t},r)})()}queryHistogram(e,t,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryHistogram",{query:e.toJSON(),params:t},r)})()}queryAggregateHistogram(e,t,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateHistogram",{query:e.toJSON(),params:t},r)})()}queryFeatures(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatures",e?.toJSON(),t)})()}queryVisibleFeatures(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryVisibleFeatures",e?.toJSON(),t)})()}queryObjectIds(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryObjectIds",e?.toJSON(),t)})()}queryFeatureCount(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatureCount",e?.toJSON(),t)})()}queryExtent(e,t){var r=this;return(0,o.Z)(function*(){return r._connection.invoke("controller.queryExtent",e.toJSON(),t)})()}queryLatestObservations(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryLatestObservations",e.toJSON(),t)})()}queryStatistics(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.queryStatistics",e)})()}queryAggregates(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregates",e?.toJSON(),t)})()}queryAggregateCount(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateCount",e?.toJSON(),t)})()}queryAggregateIds(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateIds",e?.toJSON(),t)})()}getObjectId(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getObjectId",e)})()}getDisplayId(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getDisplayId",e)})()}getFeatures(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getFeatures",e)})()}getAggregates(){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getAggregates")})()}getAggregateValueRanges(){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getAggregateValueRanges")})()}mapValidDisplayIds(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.mapValidDisplayIds",e)})()}onEdits(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,(0,R.R8)(t._connection.invoke("controller.onEdits",e))})()}enableEvent(e,t){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,(0,R.R8)(r._connection.invoke("controller.enableEvent",{name:e,value:t}))})()}pauseStream(){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,R.R8)(e._connection.invoke("controller.pauseStream"))})()}resumeStream(){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,R.R8)(e._connection.invoke("controller.resumeStream"))})()}sendMessageToSocket(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,(0,R.R8)(t._connection.invoke("controller.sendMessageToSocket",e))})()}sendMessageToClient(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,(0,R.R8)(t._connection.invoke("controller.sendMessageToClient",e))})()}updateCustomParameters(e){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,(0,R.R8)(t._connection.invoke("controller.updateCustomParameters",e))})()}_startWorker(e){var t=this;return(0,o.Z)(function*(){try{t._connection=yield(0,Ee.bA)("Pipeline",{client:t.client,strategy:"dedicated",signal:e})}catch(r){(0,R.H9)(r)}})()}};(0,u._)([(0,d.Cb)()],$.prototype,"isReady",void 0),(0,u._)([(0,d.Cb)({constructOnly:!0})],$.prototype,"client",void 0),(0,u._)([(0,d.Cb)()],$.prototype,"tileRenderer",null),$=(0,u._)([(0,m.j)("esri.views.2d.layers.support.FeatureLayerProxy")],$);const Se=$;var Ie=n(43930),Oe=n(84378),fe=n(58098);class xe{constructor(t){this._tiles=new Map,this.buffer=0,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this.buffer=t.buffer}destroy(){}clear(){this._tiles.forEach(t=>this._releaseTile(t))}tileKeys(){const t=[];return this._tiles.forEach((r,i)=>t.push(i)),t}update(t){const r=this.tileInfoView.getTileCoverage(t.state,this.buffer,"closest"),{spans:i,lodInfo:s}=r,{level:a}=s,c=[],f=[],h=new Set,p=new Set;for(const{row:y,colFrom:b,colTo:F}of i)for(let O=b;O<=F;O++){const j=fe.Z.getId(a,y,s.normalizeCol(O),s.getWorldForColumn(O)),q=this._getOrAcquireTile(c,j);h.add(j),q.isReady?q.visible=!0:p.add(q.key)}return p.forEach(y=>this._addPlaceholders(h,y)),this._tiles.forEach(y=>{h.has(y.key.id)||(f.push(y.key.id),this._releaseTile(y))}),Oe.Z.pool.release(r),{hasMissingTiles:p.size>0,added:c,removed:f}}_getOrAcquireTile(t,r){if(!this._tiles.has(r)){const i=this.acquireTile(new fe.Z(r));t.push(r),this._tiles.set(r,i),i.visible=!1}return this._tiles.get(r)}_getTile(t){return this._tiles.get(t)}_releaseTile(t){this._tiles.delete(t.key.id),this.releaseTile(t)}_addPlaceholders(t,r){const i=this._addPlaceholderChildren(t,r);Math.abs(1-i)<1e-6||this._addPlaceholderParent(t,r)||(this._getTile(r.id).visible=!0)}_addPlaceholderChildren(t,r){let i=0;return this._tiles.forEach(s=>{i+=this._addPlaceholderChild(t,s,r)}),i}_addPlaceholderChild(t,r,i){return r.key.level<=i.level||!r.hasData||!i.contains(r.key)?0:(r.visible=!0,t.add(r.key.id),1/(1<<2*(r.key.level-i.level)))}_addPlaceholderParent(t,r){let i=r.getParentKey(),s=0,a=null;for(;(0,l.pC)(i);){if(t.has(i.id))return!0;const c=this._getTile(i.id);if(c?.isReady){for(const f of t){const h=this._getTile(f);h&&i.contains(h.key)&&(h.visible=!1)}return c.visible=!0,t.add(c.key.id),!0}c?.hasData&&c.patchCount>s&&(s=c.patchCount,a=c),i=i.getParentKey()}return!!a&&(a.visible=!0,t.add(a.key.id),!0)}}var Pe=n(13812),Ue=n(2319),x=n(36630),ge=n(59990),Te=n(46679),ae=n(10023);const ve="esri.views.layers.FeatureLayerView",he=S.Z.getLogger(ve),Ae=e=>{let t=class extends e{constructor(...r){super(...r),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([(0,U.YP)(()=>{const r=this.layer;return[r?.elevationInfo?.featureExpressionInfo,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),U.tX),(0,U.on)(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),(0,U.on)(()=>{const r=this.layer;return r&&"sublayers"in r?r.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:r,layer:{fieldsIndex:i},requiredFields:s}=this;return(0,x.Q0)(i,"outFields"in r&&r.outFields?[...(0,x.Lk)(i,r.outFields),...s]:s)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){he.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(r){throw new Error("missing implementation")}createQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},i=(0,l.pC)(this.filter)?this.filter.createQuery(r):new K.Z(r);if("feature"===this.layer.type){const s=(0,ge.c)(this);(0,l.pC)(s)&&(i.where=i.where?`(${i.where}) AND (${s})`:s)}return(0,l.pC)(this.timeExtent)&&(i.timeExtent=(0,l.pC)(i.timeExtent)?i.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),i}createAggregateQuery(){return new K.Z({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryFeatures(r,i){throw new Error("missing implementation")}queryObjectIds(r,i){throw new Error("missing implementation")}queryFeatureCount(r,i){throw new Error("missing implementation")}queryExtent(r,i){throw new Error("missing implementation")}fetchPopupFeatures(r,i){var s=this;return(0,o.Z)(function*(){const a=s.validateFetchPopupFeatures(i);if(a)throw a;return s.fetchClientPopupFeatures(i)})()}_loadArcadeModules(r){return r.get("expressionInfos.length")||Array.isArray(r.content)&&r.content.some(i=>"expression"===i.type)?(0,Te.LC)():Promise.resolve()}_handleRequiredFieldsChange(){const r=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",r),r.then(()=>{this._updatingRequiredFieldsPromise===r&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var r=this;return(0,o.Z)(function*(){if(!r.layer||!r.view)return;const i="3d"===r.view.type,{layer:s,layer:{fieldsIndex:a,objectIdField:c}}=r,f="renderer"in s&&s.renderer,h="orderBy"in s&&s.orderBy,p="featureReduction"in s?s.featureReduction:null,y=new Set,b=yield(0,R.as)([f?f.collectRequiredFields(y,a):null,(0,x.Mu)(y,s),i?(0,x.vl)(y,s):null,(0,l.pC)(r.filter)?(0,x.Ll)(y,s,r.filter):null,(0,l.pC)(r.featureEffect)?(0,x.Ll)(y,s,r.featureEffect.filter):null,p?(0,x.ZV)(y,s,p):null,h?(0,x.Qj)(y,s,h):null]);if("timeInfo"in s&&s.timeInfo&&r.timeExtent&&(0,x.gd)(y,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"feature"===s.type&&(s.floorInfo&&(0,x.gd)(y,s.fieldsIndex,[s.floorInfo.floorField]),i&&(0,l.pC)(s.infoFor3D)&&(null==s.globalIdField&&he.error("globalIdField missing on 3DObjectFeatureLayer"),(0,x.gd)(y,s.fieldsIndex,[s.globalIdField]))),"subtype-group"===s.type){(0,x.AB)(y,a,s.subtypeField);const O=s.sublayers.map(j=>Promise.all([j.renderer?.collectRequiredFields(y,a),(0,x.Mu)(y,j)]));yield(0,R.as)(O)}for(const O of b)O.error&&he.error(O.error);(0,x.AB)(y,a,c),i&&"displayField"in s&&s.displayField&&(0,x.AB)(y,a,s.displayField);const F=Array.from(y).sort();r._set("requiredFields",F)})()}validateFetchPopupFeatures(r){if((0,l.Wi)(r))return null;for(const i of r.clientGraphics??[]){const s=i.layer;if("popupEnabled"in s&&!s.popupEnabled)return new V.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(i.isAggregate){const a="featureReduction"in s?s.featureReduction:null;if(!(a&&"popupTemplate"in a&&a.popupEnabled&&a.popupTemplate))return new V.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!(0,ae.V)(s,r))return new V.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}fetchClientPopupFeatures(r){var i=this;return(0,o.Z)(function*(){const s=(0,l.pC)(r)?r.clientGraphics:null;if(!s||0===s.length)return[];const a=new Array(s.length),c=new Map,f=yield i.createPopupQuery(r);for(let h=0;h<s.length;h++){const p=s[h];if(p.isAggregate){a[h]=p;continue}const y=p.layer;if(!("popupEnabled"in y))continue;const b=(0,x.Lk)(i.layer.fieldsIndex,f.outFields),F=(0,ae.V)(y,r);if((0,l.Wi)(F))continue;const O=yield i._loadArcadeModules(F);O&&O.arcadeUtils.hasGeometryOperations(F)||!(0,x.R9)(b,p)?c.set(p.getObjectId(),{graphic:p,index:h}):a[h]=p}if("stream"===i.layer.type||0===c.size)return a.filter(Boolean);f.objectIds=Array.from(c.keys());try{const h=yield i.layer.queryFeatures(f);for(const p of h.features){const{graphic:{geometry:y},index:b}=c.get(p.getObjectId());p.geometry||(p.geometry=y),a[b]=p}}catch{}return a.filter(Boolean)})()}createPopupQuery(r){var i=this;return(0,o.Z)(function*(){const s=i.layer.createQuery(),a=new Set;let c=!1;const f=(0,l.pC)(r)&&r.clientGraphics?r.clientGraphics.map(h=>h.layer):[i.layer];for(const h of f){if(!("popupEnabled"in h))continue;const p=(0,ae.V)(h,r);if((0,l.Wi)(p))continue;const y=yield i._loadArcadeModules(p),b=y&&y.arcadeUtils.hasGeometryOperations(p);c=!("point"!==i.layer.geometryType&&!b);const F=yield(0,ae.e)(i.layer,p);for(const O of F)a.add(O)}if(s.returnGeometry=c,s.returnZ=c,s.returnM=c,s.outFields=Array.from(a),s.outSpatialReference=i.view.spatialReference,"feature"===i.layer.type){const h=(0,ge.c)(i);(0,l.pC)(h)&&(s.where=s.where?`(${s.where}) AND (${h})`:h)}return s})()}canResume(){return!(!super.canResume()||(0,l.pC)(this.timeExtent)&&this.timeExtent.isEmpty)}};return(0,u._)([(0,d.Cb)()],t.prototype,"_updatingRequiredFieldsPromise",void 0),(0,u._)([(0,d.Cb)({readOnly:!0})],t.prototype,"availableFields",null),(0,u._)([(0,d.Cb)({type:Ue.Z})],t.prototype,"featureEffect",null),(0,u._)([(0,d.Cb)({type:z.Z})],t.prototype,"filter",void 0),(0,u._)([(0,d.Cb)(Pe.qG)],t.prototype,"timeExtent",void 0),(0,u._)([(0,d.Cb)()],t.prototype,"layer",void 0),(0,u._)([(0,d.Cb)({type:Number})],t.prototype,"maximumNumberOfFeatures",null),(0,u._)([(0,d.Cb)({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),(0,u._)([(0,d.Cb)({readOnly:!0})],t.prototype,"requiredFields",void 0),(0,u._)([(0,d.Cb)()],t.prototype,"suspended",void 0),(0,u._)([(0,d.Cb)()],t.prototype,"view",void 0),t=(0,u._)([(0,m.j)(ve)],t),t};var we=n(45611),Ze=n(94421),Ve=n(31637),Me=n(2004);function me(e){return e&&"openPorts"in e}let w=class extends(Ae((0,Ze.Z)((0,A.y)(we.Z)))){constructor(){var e;super(...arguments),e=this,this._pipelineIsUpdating=!0,this._commandsQueue=new Re({process:t=>{switch(t.type){case"processed-edit":return this._doEdit(t);case"refresh":return this._doRefresh(t.dataChanged);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._updateHighlight=(0,R.Ds)((0,o.Z)(function*(){return e._proxy.setHighlight(Array.from(e._highlightIds.keys()))})),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.featureEffectView=new de,this._lastDefinitionExpression=null}destroy(){(0,l.yw)(this._updateClusterSizeTask,e=>e.remove()),this._proxy?.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.addHandles([this.on("valueRangesChanged",e=>{this._set("_aggregateValueRanges",e.valueRanges)}),(0,U.YP)(()=>this.featureEffect,e=>{this.featureEffectView.featureEffect=e},U.tX)],"constructor"),this.featureEffectView.endTransitions()}_initProxy(){var e=this;return(0,o.Z)(function*(){const t=e.layer;if("isTable"in t&&t.isTable)throw new V.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e.layer});if(("feature"===t.type||"subtype-group"===t.type)&&!(0,X.S1)(t)?.operations.supportsQuery)throw new V.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:t});e._proxy&&e._proxy.destroy();const r=e._createClientOptions();return e._set("_proxy",new Se({client:r})),e._proxy.when()})()}_initServiceOptions(){var e=this;return(0,o.Z)(function*(){return e._set("_serviceOptions",yield e._createServiceOptions()),e._serviceOptions})()}get _effectiveFeatureReduction(){if(!("featureReduction"in this.layer))return null;const e=this.layer.featureReduction;return e&&(!("maxScale"in e)||!e.maxScale||e.maxScale<this.view.scale)?e:null}get orderByFields(){return"stream"!==this._serviceOptions?.type?this._serviceOptions?.orderByFields:void 0}get labelsVisible(){return!this.suspended&&("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]).some(t=>t.labelingInfo&&t.labelsVisible)}get queryMode(){return this._serviceOptions?.type}get renderingConfigHash(){if(!this.layer)return null;const e=this.availableFields,t=this.layer,r=this.view.floors,{definitionExpression:i}=t,s="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,a="renderer"in t&&t.renderer,c="gdbVersion"in t?t.gdbVersion:void 0,f="historicMoment"in t?t.historicMoment?.getTime():void 0,{timeExtent:h}=this,p="customParameters"in t?JSON.stringify(t.customParameters):void 0,y="apiKey"in t?t.apiKey:void 0,b="stream"===t.type?`${JSON.stringify(t.geometryDefinition)}${t.definitionExpression}`:null,F=JSON.stringify(this.clips),O=this._effectiveFeatureReduction?.toJSON(),j="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),q="sublayers"in this.layer&&this.layer.sublayers.items.reduce((k,ue)=>k+`${ue.visible?1:0}.${JSON.stringify(ue.renderer)}.${ue.labelsVisible}\n.${JSON.stringify(ue.labelingInfo)}`,"");return JSON.stringify({orderBy:j,sublayerHash:q,subtypeCode:"subtypeCode"in this.layer&&this.layer.subtypeCode,filterHash:(0,l.pC)(this.filter)&&this.filter.toJSON(),effectHash:(0,l.pC)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:b,gdbVersion:c,definitionExpression:i,historicMoment:f,availableFields:e,renderer:a,labelingInfo:s,timeExtent:h,floors:r,clipsHash:F,featureReduction:O,customParameters:p,apiKey:y})}highlight(e){let t;e instanceof Z.Z?t=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?t=[e]:M.Z.isCollection(e)&&e.length>0?t=e.map(i=>i?.getObjectId()).toArray():Array.isArray(e)&&e.length>0&&(t="number"==typeof e[0]||"string"==typeof e[0]?e:e.map(i=>i?.getObjectId()));const r=t?.filter(l.pC);return r&&r.length?(this._addHighlight(r),{remove:()=>this._removeHighlight(r)}):{remove:()=>{}}}hasHighlight(){return!!this._highlightIds.size}hitTest(e,t){var r=this;return(0,o.Z)(function*(){if(!r.tileRenderer)return null;const i=yield r.tileRenderer.hitTest(t);if(0===i.length)return null;const{features:s,aggregates:a}=yield r._proxy.getFeatures(i);return[...a.map(c=>r._createGraphicHit(e,C.fromJSON(c))),...s.map(c=>r._createGraphicHit(e,Z.Z.fromJSON(c)))]})()}queryStatistics(){return this._proxy.queryStatistics()}querySummaryStatistics(e,t,r){var i=this;return(0,o.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.querySummaryStatistics(i._cleanUpQuery(e),s,r)})()}queryAggregateSummaryStatistics(e,t,r){var i=this;return(0,o.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryAggregateSummaryStatistics(i._cleanUpAggregateQuery(e),s,r)})()}queryUniqueValues(e,t,r){var i=this;return(0,o.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryUniqueValues(i._cleanUpQuery(e),s,r)})()}queryAggregateUniqueValues(e,t,r){var i=this;return(0,o.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryAggregateUniqueValues(i._cleanUpAggregateQuery(e),s,r)})()}queryClassBreaks(e,t,r){var i=this;return(0,o.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryClassBreaks(i._cleanUpQuery(e),s,r)})()}queryAggregateClassBreaks(e,t,r){var i=this;return(0,o.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryAggregateClassBreaks(i._cleanUpAggregateQuery(e),s,r)})()}queryHistogram(e,t,r){var i=this;return(0,o.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryHistogram(i._cleanUpQuery(e),s,r)})()}queryAggregateHistogram(e,t,r){var i=this;return(0,o.Z)(function*(){const s={...t,scale:i.view.scale};return i._proxy.queryAggregateHistogram(i._cleanUpAggregateQuery(e),s,r)})()}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then(r=>{const i=ee.Z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryVisibleFeatures(e,t){return this._proxy.queryVisibleFeatures(this._cleanUpQuery(e),t).then(r=>{const i=ee.Z.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryAggregates(e,t){var r=this;return(0,o.Z)(function*(){const i=yield r._proxy.queryAggregates(r._cleanUpAggregateQuery(e),t),s=te.fromJSON(i);return s.features.forEach(a=>r._setLayersForFeature(a)),s})()}queryAggregateIds(e,t){return this._proxy.queryAggregateIds(this._cleanUpAggregateQuery(e),t)}queryAggregateCount(e,t){return this._proxy.queryAggregateCount(this._cleanUpAggregateQuery(e),t)}queryAggregateJSON(e,t){return this._proxy.queryAggregates(this._cleanUpAggregateQuery(e),t)}queryFeaturesJSON(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}queryObjectIds(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}queryFeatureCount(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}queryExtent(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then(r=>({count:r.count,extent:Me.Z.fromJSON(r.extent)}))}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:t,added:r,removed:i}=this._tileStrategy.update(e);(r.length||i.length)&&this._proxy.updateTiles({added:r,removed:i}),t&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new xe({acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.addAttachHandles((0,U.YP)(()=>this.renderingConfigHash,()=>this._update(),U.nn)),"stream"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",e=>this._edit(e)))}detach(){this._commandsQueue.clear(),this._proxy?.stop(),this.container.removeAllChildren(),this.tileRenderer?.uninstall(this.container),this.tileRenderer=null,this._tileStrategy=(0,l.SC)(this._tileStrategy),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const e="renderer"in this.layer&&null!=this.layer.renderer,t=this._commandsQueue.updating,r=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,s=this._pipelineIsUpdating,a=null==this.tileRenderer||this.tileRenderer?.updating,c=e&&(t||r||i||s||a);return(0,v.Z)("esri-2d-log-updating")&&console.log(`Updating FLV2D: ${c}\n  -> hasRenderer ${e}\n  -> hasPendingCommand ${t}\n  -> updatingRequiredFields ${r}\n  -> updatingProxy ${i}\n  -> updatingPipeline ${s}\n  -> updatingTileRenderer ${a}\n`),c}_createClientOptions(){return{setUpdating:e=>{this._set("_pipelineIsUpdating",e)},emitEvent:e=>{this.emit(e.name,e.event)}}}_detectQueryMode(e){var t=this;return(0,o.Z)(function*(){const r="path"in e,{layer:i}=t,c=!("editingInfo"in i&&i.editingInfo?.lastEditDate)&&"refreshInterval"in i&&!!i.refreshInterval,f=(0,X.S1)(i);if(r&&("feature"===i.type||"subtype-group"===i.type)&&"point"===i.geometryType&&f?.query.supportsPagination&&!f?.operations.supportsEditing&&!c&&(0,v.Z)("featurelayer-snapshot-enabled"))try{const h=yield i.queryFeatureCount();if(h<=(0,v.Z)("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:h};const p=(0,v.Z)("featurelayer-snapshot-point-max-threshold"),y=(0,v.Z)("featurelayer-snapshot-point-coverage"),b=t.view.extent,F=(0,l.Wg)(i.fullExtent),O=F?.clone().intersection(b),j=(0,l.pC)(O)?O.width*O.height:0,q=F?.width*F?.height;if(h<=p&&(0===q?0:j/q)>=y)return{mode:"snapshot",featureCount:h}}catch(h){S.Z.getLogger(t.declaredClass).warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:h})}return{mode:"on-demand"}})()}_createServiceOptions(){var e=this;return(0,o.Z)(function*(){const t=e.layer;if("stream"===t.type)return null;const r=(0,X.S1)(t),{capabilities:i,objectIdField:s}=t,a=t.fields.map(k=>k.toJSON()),c=(0,l.pC)(t.fullExtent)?t.fullExtent.toJSON():null,f=(0,Ie.oq)(t.geometryType),h="timeInfo"in t&&t.timeInfo&&t.timeInfo.toJSON()||null,p=t.spatialReference?t.spatialReference.toJSON():null,y="feature"===t.type?t.globalIdField:null;let b;"ogc-feature"===t.type?b=t.source.getSource():me(t.source)?b=yield t.source.openPorts():t.parsedUrl&&(b=(0,N.d9)(t.parsedUrl),"dynamicDataSource"in t&&t.dynamicDataSource&&(b.query={layer:JSON.stringify({source:t.dynamicDataSource})}));const F="datesInUnknownTimezone"in e.layer&&e.layer.datesInUnknownTimezone,O=("subtypeField"in e.layer?e.layer.subtypeField:null)??null,{mode:j,featureCount:q}=yield e._detectQueryMode(b);let le=e.layer.objectIdField;if("feature"===e.layer.type&&(0,l.pC)(e.layer.orderBy)&&e.layer.orderBy.length){const k=!e.layer.orderBy[0].valueExpression&&e.layer.orderBy[0].field;k&&(le=k)}return{type:j,timeReferenceUnknownClient:F,subtypeField:O,featureCount:q,globalIdField:y,maxRecordCount:i.query.maxRecordCount,tileMaxRecordCount:i.query.tileMaxRecordCount,capabilities:i,effectiveCapabilities:r,fields:a,fullExtent:c,geometryType:f,objectIdField:s,source:b,timeInfo:h,spatialReference:p,orderByFields:le,datesInUnknownTimezone:F,dateFieldsTimeReference:("dateFieldsTimeReference"in e.layer?e.layer.dateFieldsTimeReference?.toJSON():null)||null,preferredTimeReference:("preferredTimeReference"in e.layer?e.layer.preferredTimeReference?.toJSON():null)||null,editFieldsInfo:"editFieldsInfo"in e.layer?e.layer.editFieldsInfo?.toJSON():null}})()}_createMemoryServiceOptions(e){var t=this;return(0,o.Z)(function*(){const r=yield e.openPorts();return{...t._createServiceOptions(),type:"memory",source:r}})()}_cleanUpQuery(e){const t=K.Z.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}_cleanUpAggregateQuery(e){const t=K.Z.from(e)||this.createAggregateQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}_update(){var e=this;return(0,o.Z)(function*(){return e._commandsQueue.push({type:"update"})})()}_edit(e){var t=this;return(0,o.Z)(function*(){return t.suspended?void t._clearTiles():t._validateEdit(e)?t._commandsQueue.push({type:"edit",edits:e}):void 0})()}doRefresh(e){var t=this;return(0,o.Z)(function*(){if(t.attached&&t._tileStrategy.tileKeys().length)return t.suspended&&e?void t._clearTiles():t._commandsQueue.push({type:"refresh",dataChanged:e})})()}_clearTiles(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}_validateEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,r=e.deletedFeatures.some(s=>-1===s.objectId||!s.objectId),i=t&&this.availableFields.includes(t);return r&&!i?(S.Z.getLogger(this.declaredClass).error(new V.Z("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null):e}_doUpdate(){var e=this;return(0,o.Z)(function*(){try{if(e.destroyed||!e._hasRequiredSupport(e.layer)||!e._tileStrategy)return;const{featureEffectView:t,filter:r}=e;if(yield e._updateRequiredFields(),e.destroyed)return;const{renderer:i}=e._getEffectiveRenderer();e._set("_effectiveRenderer",i);const s=e._createSchemaConfig(),a=e._createConfiguration(s,r,t.filter),c=e._lastDefinitionExpression!==a.schema.source.definitionExpression;e._lastDefinitionExpression=a.schema.source.definitionExpression;const f=a.schema.tileRenderer,h=e._createTileRendererHash(f);if("snapshot"===e._serviceOptions.type&&(a.schema.source.initialFeatureCount=e._serviceOptions.featureCount),h!==e._tileRendererHash){yield e._initTileRenderer(f,i);const p=e.layer,y="stream"===p.type?yield e._initServiceOptions():e._serviceOptions;e.tileRenderer.onConfigUpdate(i),"stream"!==p.type&&me(p.source)&&(y.source=yield p.source.openPorts());const b={added:e._tileStrategy.tileKeys(),removed:[]};yield e._proxy.startup(e.view.featuresTilingScheme,a,y,b),e.hasHighlight()&&(yield e._proxy.setHighlight(Array.from(e._highlightIds.keys()))),yield e._onceTilesUpdated(),e.tileRenderer.onConfigUpdate(i)}else{"snapshot"===e._serviceOptions.type&&c&&(a.schema.source.changedFeatureCount=yield e.layer.queryFeatureCount());const p=yield e._proxy.update(a);(p.mesh||p.targets?.aggregate)&&e._lockGPUUploads();try{yield e._proxy.applyUpdate(p)}catch(y){(0,R.D_)(y)||S.Z.getLogger(e.declaredClass).error(y)}(p.mesh||p.targets?.aggregate)&&e._unlockGPUUploads(),e.tileRenderer.onConfigUpdate(i),e._updateClusterSizeVariable(),e._forceAttributeTextureUpload()}e._tileRendererHash=h,e.tileRenderer.invalidateLabels(),e.requestUpdate()}catch{}})()}_doEdit(e){var t=this;return(0,o.Z)(function*(){try{yield t._proxy.onEdits(e)}catch(r){(0,R.D_)(r)}})()}_doRefresh(e){var t=this;return(0,o.Z)(function*(){t._lockGPUUploads();try{let r;e&&"snapshot"===t.queryMode&&"queryFeatureCount"in t.layer&&(r=yield t.layer.queryFeatureCount()),yield t._proxy.refresh({dataChanged:e,featureCount:r})}catch(r){(0,R.D_)(r)}t._unlockGPUUploads(),t._effectiveFeatureReduction&&t._updateClusterSizeVariable()})()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(e,t){return(0,U.YP)(()=>this._aggregateValueRanges,r=>{this._updateClusterEffectiveRendererSizeVariable(e,t,r),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()})}_updateClusterEffectiveRendererSizeVariable(e,t,r){var i=this;return(0,o.Z)(function*(){if(e.dynamicClusterSize&&"visualVariables"in e&&e.visualVariables){const s=(0,re.os)(e.visualVariables);if((0,l.pC)(s)&&"cluster_count"===s.field){const a=e.visualVariables.indexOf(s);e.visualVariables[a]=(0,re.aV)(t,r);const c=e.clone();c.dynamicClusterSize=!0,i._set("_effectiveRenderer",c)}}})()}_getEffectiveRenderer(){const e=this.layer,t="renderer"in e?e.renderer:null,r=this._effectiveFeatureReduction;if(this._updateClusterSizeTask=(0,l.hw)(this._updateClusterSizeTask),r&&"renderer"in r&&r.renderer&&!r.renderer.authoringInfo?.isAutoGenerated){const i=r.fields;if("cluster"===r.type){const{renderer:s,didInject:a}=(0,re.st)(r.renderer,r,this._aggregateValueRanges);return a&&(this._updateClusterSizeTask=this._createUpdateClusterSizeTask(s,r)),{renderer:s,aggregateFields:i,featureReduction:r}}return{renderer:r.renderer,aggregateFields:i,featureReduction:r}}if(r&&"cluster"===r.type&&t&&(0,re.yR)(t)){const i=r,s=[],a=(0,re.S1)(s,t,i,this._aggregateValueRanges,!0);return this._updateClusterSizeTask=this._createUpdateClusterSizeTask(a,i),{renderer:a,aggregateFields:s,featureReduction:r}}return{renderer:t,aggregateFields:[],featureReduction:null}}_acquireTile(e){const t=this.tileRenderer.acquireTile(e);return t.once("attach",()=>{this.requestUpdate()}),t}_releaseTile(e){this.tileRenderer.releaseTile(e)}_initTileRenderer(e,t){var r=this;return(0,o.Z)(function*(){const i=yield function D(e,t){return E.apply(this,arguments)}(e,{layerView:r,tileInfoView:r.view.featuresTilingScheme,layer:r.layer});return r.tileRenderer&&(r._tileStrategy.clear(),r.tileRenderer.uninstall(r.container),r.tileRenderer=(0,l.SC)(r.tileRenderer)),r.destroyed?null:(r._proxy.tileRenderer=i,r._set("tileRenderer",i),r.tileRenderer.install(r.container),r.tileRenderer.onConfigUpdate(t),r.requestUpdate(),r.tileRenderer)})()}_createTileRendererHash(e){return`${e.type}`}get hasFilter(){return!!(this.filter||"floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length||this._visibilityOverrides.size||this.timeExtent)}_injectOverrides(e){const t=(0,l.pC)(e)?e.timeExtent:null,r=(0,l.pC)(this.timeExtent)&&(0,l.pC)(t)?this.timeExtent.intersection(t):this.timeExtent||t;let i=null;const s="floorInfo"in this.layer&&this.layer.floorInfo;if(s){const c=(0,l.pC)(e)?e.where:null;i=this._addFloorFilterClause(c)}if(!this._visibilityOverrides.size&&!r&&!s)return(0,l.pC)(e)?e.toJSON():null;(e=(0,l.pC)(e)&&e.clone()||new z.Z).timeExtent=r,i&&(e.where=i);const a=e.toJSON();return a.hiddenIds=Array.from(this._visibilityOverrides),a}_addFloorFilterClause(e){const t=this.layer;let r=e||"";if("floorInfo"in t&&t.floorInfo){let i=this.view.floors;if(!i||!i.length)return r;t.floorInfo.viewAllLevelIds?.length&&(i=t.floorInfo.viewAllLevelIds);const s=i.filter(f=>""!==f).map(f=>"'"+f+"'");s.push("''");const a=t.floorInfo.floorField;let c="("+a+" IN ({ids}) OR "+a+" IS NULL)";if(c=c.replace("{ids}",s.join(", ")),(0,l.pC)(r)&&r.includes(a)){let f=new RegExp("AND \\("+a+".*NULL\\)","g");r=r.replace(f,""),f=new RegExp("\\("+a+".*NULL\\)","g"),r=r.replace(f,""),r=r.replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+c:c}return""!==r?r:null}_createConfiguration(e,t,r){const i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,s="feature"===this.layer.type?this.layer.gdbVersion??void 0:void 0,a=new Array(B.m4),c=this._injectOverrides(t);a[0]=c,a[1]=(0,l.pC)(r)?r.toJSON():null;const f=(0,I.Ew)(e);if((0,l.Wi)(f))return null;const h=(0,Ve.hc)("2d");return{availableFields:this.availableFields,gdbVersion:s,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:a,schema:f,supportsTextureFloat:h.supportsTextureFloat,maxTextureSize:h.maxTextureSize}}_hasRequiredSupport(e){return!("renderer"in e)||(0,Q.TT)(e.renderer)}_onceTilesUpdated(){return this.requestUpdate(),(0,U.N1)(()=>!this._pipelineIsUpdating)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){const e=this.layer;return{renderer:"renderer"in e?e.renderer:null,spatialReference:e.spatialReference,timeExtent:"timeExtent"in e?e.timeExtent:null,definitionExpression:e.definitionExpression,featureReduction:this._effectiveFeatureReduction,fields:e.fields,geometryType:e.geometryType,historicMoment:"historicMoment"in e?e.historicMoment:null,labelsVisible:"labelsVisible"in e&&e.labelsVisible,labelingInfo:"labelingInfo"in e?e.labelingInfo:null,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"gdbVersion"in e?e.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in e&&e.orderBy?e.orderBy:null,customParameters:{..."customParameters"in e?e.customParameters:void 0,token:"apiKey"in e?e.apiKey??void 0:void 0},subtypeCode:"subtypeCode"in e?e.subtypeCode:void 0,subtypeField:"subtypeField"in e?e.subtypeField:void 0}}_addHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const r=this._highlightIds.get(t);this._highlightIds.set(t,r+1)}else this._highlightIds.set(t,1);this._updateHighlight().catch(t=>{(0,R.D_)(t)||S.Z.getLogger(this.declaredClass).error(t)})}_removeHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const r=this._highlightIds.get(t)-1;0===r?this._highlightIds.delete(t):this._highlightIds.set(t,r)}this._updateHighlight().catch(t=>{(0,R.D_)(t)||S.Z.getLogger(this.declaredClass).error(t)})}_setLayersForFeature(e){const t=this.layer;e.layer=t,e.sourceLayer=t}_createGraphicHit(e,t){return this._setLayersForFeature(t),(0,l.pC)(t.geometry)&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};(0,u._)([(0,d.Cb)()],w.prototype,"_serviceOptions",void 0),(0,u._)([(0,d.Cb)()],w.prototype,"_proxy",void 0),(0,u._)([(0,d.Cb)()],w.prototype,"_pipelineIsUpdating",void 0),(0,u._)([(0,d.Cb)()],w.prototype,"_effectiveRenderer",void 0),(0,u._)([(0,d.Cb)()],w.prototype,"_effectiveFeatureReduction",null),(0,u._)([(0,d.Cb)()],w.prototype,"_aggregateValueRanges",void 0),(0,u._)([(0,d.Cb)()],w.prototype,"_commandsQueue",void 0),(0,u._)([(0,d.Cb)()],w.prototype,"featureEffectView",void 0),(0,u._)([(0,d.Cb)()],w.prototype,"labelsVisible",null),(0,u._)([(0,d.Cb)({readOnly:!0})],w.prototype,"queryMode",null),(0,u._)([(0,d.Cb)()],w.prototype,"renderingConfigHash",null),(0,u._)([(0,d.Cb)()],w.prototype,"tileRenderer",void 0),(0,u._)([(0,d.Cb)()],w.prototype,"updating",void 0),w=(0,u._)([(0,m.j)("esri.views.2d.layers.FeatureLayerView2D")],w);const Le=w},37384:(Y,L,n)=>{n.d(L,{y:()=>K});var o=n(17626),u=n(74333),Z=n(89726),d=n(26584),g=n(32917),_=n(77712),C=(n(90912),n(85931),n(76898)),J=n(1011),M=n(38093),V=n(86810);let v=class extends V.wq{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};(0,o._)([(0,_.Cb)({readOnly:!0})],v.prototype,"version",null),v=(0,o._)([(0,C.j)("esri.views.layers.support.ClipArea")],v);const N=v;var S;let l=S=class extends N{constructor(B){super(B),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new S({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};(0,o._)([(0,_.Cb)({type:[Number,String],json:{write:!0}})],l.prototype,"left",void 0),(0,o._)([(0,_.Cb)({type:[Number,String],json:{write:!0}})],l.prototype,"right",void 0),(0,o._)([(0,_.Cb)({type:[Number,String],json:{write:!0}})],l.prototype,"top",void 0),(0,o._)([(0,_.Cb)({type:[Number,String],json:{write:!0}})],l.prototype,"bottom",void 0),l=S=(0,o._)([(0,C.j)("esri.views.layers.support.ClipRect")],l);const R=l;n(29132);var z,ne=n(21674),oe=n(91179),T=n(2004),de=n(37118);const X={base:ne.Z,key:"type",typeMap:{extent:T.Z,polygon:de.Z}};let G=z=class extends N{constructor(B){super(B),this.type="geometry",this.geometry=null}clone(){return new z({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};(0,o._)([(0,_.Cb)({types:X,json:{read:oe.im,write:!0}})],G.prototype,"geometry",void 0),G=z=(0,o._)([(0,C.j)("esri.views.layers.support.Geometry")],G);const ee=G;let W=class extends N{constructor(B){super(B),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};(0,o._)([(0,_.Cb)({type:[[[Number]]],json:{write:!0}})],W.prototype,"path",void 0),W=(0,o._)([(0,C.j)("esri.views.layers.support.Path")],W);const te=u.Z.ofType({key:"type",base:null,typeMap:{rect:R,path:W,geometry:ee}}),K=B=>{let A=class extends B{constructor(){super(...arguments),this.attached=!1,this.clips=new te,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this.visibleAtCurrentScale=!1,this.highlightOptions=null}initialize(){this.view?.spatialReference&&(this.view?.spatialReferenceLocked??1)&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new d.Z("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new J.W),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([(0,g.YP)(()=>this.suspended,E=>{this.container&&(this.container.visible=!E),this.view&&!E&&this.updateRequested&&this.view.requestUpdate()},g.tX),(0,g.YP)(()=>this.layer?.opacity??1,E=>{this.container&&(this.container.opacity=E)},g.tX),(0,g.YP)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",E=>{this.container&&(this.container.blendMode=E)},g.tX),(0,g.YP)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,E=>{this.container&&(this.container.effect=E)},g.tX),(0,g.YP)(()=>this.highlightOptions,E=>this.container.highlightOptions=E,g.tX),(0,g.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},g.tX),(0,g.YP)(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:E})=>{const Q=null!=E&&this.isVisibleAtScale(E);Q!==this.visibleAtCurrentScale&&this._set("visibleAtCurrentScale",Q)},g.tX)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(E=>{E===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){const I=this.view?.spatialReference;return null==I||this.supportsSpatialReference(I)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this.updatingHandles?.updating)}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}isVisibleAtScale(I){const D=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!D)return!0;const{minScale:E,maxScale:Q}=D;return(0===E||I<=E)&&(0===Q||I>=Q)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}processUpdate(I){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",I),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(I))):this.updateRequested=!1}hitTest(I,D){return Promise.resolve(null)}supportsSpatialReference(I){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const I=super.getSuspendInfo(),D=!this.spatialReferenceSupported,E=this.visibleAtCurrentScale;return D&&(I.spatialReferenceNotSupported=D),E&&(I.outsideScaleRange=E),I}addAttachHandles(I){this.addHandles(I,"attach")}};return(0,o._)([(0,_.Cb)()],A.prototype,"attached",void 0),(0,o._)([(0,_.Cb)({type:te,set(I){const D=(0,Z.Z)(I,this._get("clips"),te);this._set("clips",D)}})],A.prototype,"clips",void 0),(0,o._)([(0,_.Cb)()],A.prototype,"container",void 0),(0,o._)([(0,_.Cb)()],A.prototype,"moving",void 0),(0,o._)([(0,_.Cb)({readOnly:!0})],A.prototype,"spatialReferenceSupported",null),(0,o._)([(0,_.Cb)({readOnly:!0})],A.prototype,"updateParameters",void 0),(0,o._)([(0,_.Cb)()],A.prototype,"updateRequested",void 0),(0,o._)([(0,_.Cb)()],A.prototype,"updating",null),(0,o._)([(0,_.Cb)()],A.prototype,"view",void 0),(0,o._)([(0,_.Cb)({readOnly:!0})],A.prototype,"visibleAtCurrentScale",void 0),(0,o._)([(0,_.Cb)({type:M.Z})],A.prototype,"highlightOptions",void 0),A=(0,o._)([(0,C.j)("esri.views.2d.layers.LayerView2D")],A),A}},45611:(Y,L,n)=>{n.d(L,{Z:()=>N});var o=n(17626),u=n(14517),Z=n(61885),d=n(80542),g=n(61996),_=n(63290),m=n(62208),P=n(60330),C=n(77712),V=(n(90912),n(85931),n(76898));let v=class extends((0,d.p)((0,g.IG)((0,P.v)(Z.Z.EventedMixin(u.Z))))){constructor(S){super(S),this.layer=null,this.parent=null}initialize(){this.when().catch(S=>{if("layerview:create-error"!==S.name){const l=this.layer&&this.layer.id||"no id",R=this.layer&&this.layer.title||"no title";_.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${R}', id: '${l}')`,S)}})}get fullOpacity(){return(0,m.Pt)(this.get("layer.opacity"),1)*(0,m.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this.updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(S){this._overrideIfSome("visible",S)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const S=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(S.viewNotReady=!0),this.layer&&this.layer.loaded||(S.layerNotLoaded=!0),this.visible||(S.layerInvisible=!0),S}isUpdating(){return!1}};(0,o._)([(0,C.Cb)()],v.prototype,"fullOpacity",null),(0,o._)([(0,C.Cb)()],v.prototype,"layer",void 0),(0,o._)([(0,C.Cb)()],v.prototype,"parent",void 0),(0,o._)([(0,C.Cb)({readOnly:!0})],v.prototype,"suspended",null),(0,o._)([(0,C.Cb)({readOnly:!0})],v.prototype,"suspendInfo",null),(0,o._)([(0,C.Cb)({readOnly:!0})],v.prototype,"legendEnabled",null),(0,o._)([(0,C.Cb)({type:Boolean,readOnly:!0})],v.prototype,"updating",null),(0,o._)([(0,C.Cb)({readOnly:!0})],v.prototype,"updatingProgress",null),(0,o._)([(0,C.Cb)()],v.prototype,"visible",null),(0,o._)([(0,C.Cb)()],v.prototype,"view",void 0),v=(0,o._)([(0,V.j)("esri.views.layers.LayerView")],v);const N=v},94421:(Y,L,n)=>{n.d(L,{Z:()=>C});var o=n(17626),u=n(63290),Z=n(10699),d=n(32917),g=n(77712),P=(n(90912),n(85931),n(76898));const C=J=>{let M=class extends J{initialize(){this.handles.add((0,d.on)(()=>this.layer,"refresh",V=>{this.doRefresh(V.dataChanged).catch(v=>{(0,Z.D_)(v)||u.Z.getLogger(this.declaredClass).error(v)})}),"RefreshableLayerView")}};return(0,o._)([(0,g.Cb)()],M.prototype,"layer",void 0),M=(0,o._)([(0,P.j)("esri.layers.mixins.RefreshableLayerView")],M),M}},10023:(Y,L,n)=>{n.d(L,{V:()=>_,e:()=>d});var o=n(15861),u=n(62208),Z=n(36630);function d(m){return g.apply(this,arguments)}function g(){return(g=(0,o.Z)(function*(m,P=m.popupTemplate){if((0,u.Wi)(P))return[];const C=yield P.getRequiredFields(m.fieldsIndex),{lastEditInfoEnabled:J}=P,{objectIdField:M,typeIdField:V,globalIdField:v,relationships:N}=m;if(C.includes("*"))return["*"];const S=J?yield(0,Z.CH)(m):[],l=(0,Z.Q0)(m.fieldsIndex,[...C,...S]);return V&&l.push(V),l&&M&&m.fieldsIndex?.has(M)&&!l.includes(M)&&l.push(M),l&&v&&m.fieldsIndex?.has(v)&&!l.includes(v)&&l.push(v),N&&N.forEach(R=>{const{keyField:U}=R;l&&U&&m.fieldsIndex?.has(U)&&!l.includes(U)&&l.push(U)}),l})).apply(this,arguments)}function _(m,P){return m.popupTemplate?m.popupTemplate:(0,u.pC)(P)&&P.defaultPopupTemplateEnabled&&(0,u.pC)(m.defaultPopupTemplate)?m.defaultPopupTemplate:null}}}]);